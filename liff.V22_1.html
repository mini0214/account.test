<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>é›¶ç”¨é‡‘æ”¯å‡ºå¸³ç°¿</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    select, input { padding: 6px; margin: 6px 0; width: 100%; }
    button { padding: 8px 14px; font-size: 16px; }
  </style>
</head>

<body>
  <h3>é›¶ç”¨é‡‘æ”¯å‡ºå¸³ç°¿ <span id="version">[V]</span></h3>
  
  <label>æ—¥æœŸï¼š</label>
  <input type="date" id="date"><br>

  <label>åº—å®¶ï¼š</label>
  <input type="text" id="store" placeholder="è¼¸å…¥åº—å®¶åç¨±"><br>

  <label>åˆ†é¡ï¼š</label>
  <select id="type" required></select><br>

  <label>ä»˜æ¬¾æ–¹å¼ï¼š</label>
  <select id="payment" required></select><br>

  <button id="submitBtn">é€å‡º</button>

  <script>
// âœ… åˆå§‹åŒ–è¨­å®š
  async function initApp(){
    try {
      console.log("ğŸš€ åˆå§‹åŒ–é–‹å§‹");
      const settings = await loadSettings();
      if (!settings) throw new Error("è¨­å®šæ ¼å¼éŒ¯èª¤");

      FALLBACK_GAS_SETTINGS_URL = (settings.SETTINGS_URL || FALLBACK_GAS_SETTINGS_URL).trim();
      API_URL = (settings.API_URL || "").trim();
      VERSION = (settings.D10 || "V").trim();
      LIFF_IDa = (settings.D11 || "").trim();
      LIFF_IDq = (settings.D12 || "").trim();

      document.getElementById("version").textContent = VERSION;
      console.log("âœ… è¨­å®šæˆåŠŸ:", { FALLBACK_GAS_SETTINGS_URL, API_URL, LIFF_IDa, VERSION });

      if (!LIFF_IDa) throw new Error("âŒ LIFF ID å°šæœªè¨­å®šï¼Œè«‹ç¢ºèªè¨­å®šè¡¨ D11");

      await liff.init({ liffId: LIFF_IDa });
      if (!liff.isLoggedIn()) liff.login();

      document.getElementById("date").valueAsDate = new Date();

      if (API_URL) {
        console.log("ğŸ” é–‹å§‹è¼‰å…¥åº—å®¶æ¸…å–®...");
        await loadStoreList();
        console.log("ğŸ“‹ åº—å®¶æ¸…å–®è¼‰å…¥å®Œæˆï¼Œå…±", storeList.length, "ç­†");
        if (storeList.length > 0) {
          console.log("ğŸ“¦ ç¬¬ä¸€ç­†è³‡æ–™ç¯„ä¾‹:", storeList[0]);
        } else {
          console.warn("âš ï¸ åº—å®¶æ¸…å–®ç‚ºç©ºï¼Œè«‹æª¢æŸ¥ GAS æ˜¯å¦æœ‰æ­£ç¢ºå›å‚³ storeList");
        }
      }

    } catch (err) {
      console.error("åˆå§‹åŒ–è¨­å®šå¤±æ•—ï¼š", err);
      alert("åˆå§‹åŒ–è¨­å®šå¤±æ•—ï¼š" + err.message);
    }
  }

  // âœ… åº—å®¶æ¸…å–®è®€å–
  let storeList = [];
  const input = document.getElementById("store");
  const sugg = document.getElementById("suggestions");
  const typeSelect = document.getElementById("type");

  async function loadStoreList() {
    try {
      console.log("ğŸ“¡ å‘¼å«åº—å®¶ API:", `${API_URL}?type=query&command=åº—å®¶`);
      const res = await fetch(`${API_URL}?type=query&command=åº—å®¶`);
      const data = await res.json();

      console.log("ğŸ§¾ GAS å›å‚³å…§å®¹:", data);

      if (data.ok && Array.isArray(data.storeList)) {
        storeList = data.storeList;
        console.log("âœ… æˆåŠŸè¼‰å…¥åº—å®¶æ¸…å–®:", storeList.length, "ç­†");
      } else {
        console.error("âŒ GAS å›å‚³æ ¼å¼ä¸æ­£ç¢º:", data);
      }
    } catch (err) {
      console.error("ğŸš« è¼‰å…¥åº—å®¶æ¸…å–®å¤±æ•—:", err);
    }
  }

  // ğŸš€ é é¢è¼‰å…¥è‡ªå‹•åŸ·è¡Œ
  window.addEventListener("load", initApp);
  </script>
</body>
</html>

