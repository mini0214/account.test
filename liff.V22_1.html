<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>零用金支出帳簿</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    select, input { padding: 6px; margin: 6px 0; width: 100%; }
    button { padding: 8px 14px; font-size: 16px; }
  </style>
</head>

<body>
  <h3>零用金支出帳簿 <span id="version">[V]</span></h3>
  
  <label>日期：</label>
  <input type="date" id="date"><br>

  <label>店家：</label>
  <input type="text" id="store" placeholder="輸入店家名稱"><br>

  <label>分類：</label>
  <select id="type" required></select><br>

  <label>付款方式：</label>
  <select id="payment" required></select><br>

  <button id="submitBtn">送出</button>

  <script>
    let API_URL = "";
    let VERSION = "";
    let LIFF_IDa = "";
    let storeList = [];

    // ✅ 讀取設定 (範例用固定 URL，可換成實際 GAS 設定端)
    async function loadSettings() {
      const settingsUrl = "https://script.google.com/macros/s/AKfycbwk0q0U7iSfqX08_A_jhN0e5RPGsJjZ87n7KBK3qvuypRzYwYP2F5yYBPxoja6EJFIg/exec?type=設定";
      const res = await fetch(settingsUrl);
      const data = await res.json();
      if (data.ok && data.type === "設定") return data.data;
      throw new Error("設定格式錯誤");
    }

    // ✅ 載入店家清單
    async function loadStoreList() {
      try {
        const res = await fetch(`${API_URL}?type=query&command=店家`);
        const data = await res.json();
        console.log("GAS 回傳店家:", data);

        if (data.ok && Array.isArray(data.storeList)) {
          storeList = data.storeList;
          console.log("載入店家清單成功:", storeList);
        }
      } catch (err) {
        console.error("載入店家清單失敗:", err);
      }
    }

    // ✅ 載入分類 / 付款清單
    async function loadTypeAndPaymentList() {
      try {
        const listRes = await fetch(`${API_URL}?type=query&command=清單`);
        const listData = await listRes.json();
        console.log("GAS 回傳清單:", listData);

        if (listData.ok) {
          const types = listData.types || [];
          const payments = listData.payments || [];

          const typeSelect = document.getElementById("type");
          const paymentSelect = document.getElementById("payment");

          typeSelect.innerHTML = "";
          paymentSelect.innerHTML = "";

          types.forEach(t => {
            const opt = document.createElement("option");
            opt.value = t;
            opt.textContent = t;
            typeSelect.appendChild(opt);
          });

          payments.forEach(p => {
            const opt = document.createElement("option");
            opt.value = p;
            opt.textContent = p;
            paymentSelect.appendChild(opt);
          });
        }
      } catch (err) {
        console.error("載入清單失敗:", err);
      }
    }

    // ✅ 初始化流程
    async function initApp() {
      try {
        const settings = await loadSettings();
        API_URL = (settings.API_URL || "").trim();
        VERSION = (settings.D10 || "V").trim();
        LIFF_IDa = (settings.D11 || "").trim();

        document.getElementById("version").textContent = VERSION;
        console.log("✅ 設定成功:", { API_URL, VERSION, LIFF_IDa });

        // 初始化 LIFF
        await liff.init({ liffId: LIFF_IDa });
        // if (!liff.isLoggedIn()) liff.login(); // 測試階段先註解

        document.getElementById("date").valueAsDate = new Date();

        if (API_URL) {
          await loadStoreList();          // 店家
          await loadTypeAndPaymentList(); // 分類 + 付款
        }

      } catch (err) {
        console.error("初始化失敗：", err);
        alert("初始化失敗：" + err.message);
      }
    }

    // 🚀 頁面載入後啟動
    window.addEventListener("load", initApp);
  </script>
</body>
</html>
