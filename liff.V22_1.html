<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>零用金支出帳簿</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    select, input { padding: 6px; margin: 6px 0; width: 100%; }
    button { padding: 8px 14px; font-size: 16px; }
  </style>
</head>

<body>
  <h3>零用金支出帳簿 <span id="version">[V]</span></h3>
  
  <label>日期：</label>
  <input type="date" id="date"><br>

  <label>店家：</label>
  <input type="text" id="store" placeholder="輸入店家名稱"><br>

  <label>分類：</label>
  <select id="type" required></select><br>

  <label>付款方式：</label>
  <select id="payment" required></select><br>

  <button id="submitBtn">送出</button>

  <script>
// ✅ 初始化設定
  async function initApp(){
    try {
      console.log("🚀 初始化開始");
      const settings = await loadSettings();
      if (!settings) throw new Error("設定格式錯誤");

      FALLBACK_GAS_SETTINGS_URL = (settings.SETTINGS_URL || FALLBACK_GAS_SETTINGS_URL).trim();
      API_URL = (settings.API_URL || "").trim();
      VERSION = (settings.D10 || "V").trim();
      LIFF_IDa = (settings.D11 || "").trim();
      LIFF_IDq = (settings.D12 || "").trim();

      document.getElementById("version").textContent = VERSION;
      console.log("✅ 設定成功:", { FALLBACK_GAS_SETTINGS_URL, API_URL, LIFF_IDa, VERSION });

      if (!LIFF_IDa) throw new Error("❌ LIFF ID 尚未設定，請確認設定表 D11");

      await liff.init({ liffId: LIFF_IDa });
      if (!liff.isLoggedIn()) liff.login();

      document.getElementById("date").valueAsDate = new Date();

      if (API_URL) {
        console.log("🔍 開始載入店家清單...");
        await loadStoreList();
        console.log("📋 店家清單載入完成，共", storeList.length, "筆");
        if (storeList.length > 0) {
          console.log("📦 第一筆資料範例:", storeList[0]);
        } else {
          console.warn("⚠️ 店家清單為空，請檢查 GAS 是否有正確回傳 storeList");
        }
      }

    } catch (err) {
      console.error("初始化設定失敗：", err);
      alert("初始化設定失敗：" + err.message);
    }
  }

  // ✅ 店家清單讀取
  let storeList = [];
  const input = document.getElementById("store");
  const sugg = document.getElementById("suggestions");
  const typeSelect = document.getElementById("type");

  async function loadStoreList() {
    try {
      console.log("📡 呼叫店家 API:", `${API_URL}?type=query&command=店家`);
      const res = await fetch(`${API_URL}?type=query&command=店家`);
      const data = await res.json();

      console.log("🧾 GAS 回傳內容:", data);

      if (data.ok && Array.isArray(data.storeList)) {
        storeList = data.storeList;
        console.log("✅ 成功載入店家清單:", storeList.length, "筆");
      } else {
        console.error("❌ GAS 回傳格式不正確:", data);
      }
    } catch (err) {
      console.error("🚫 載入店家清單失敗:", err);
    }
  }

  // 🚀 頁面載入自動執行
  window.addEventListener("load", initApp);
  </script>
</body>
</html>

