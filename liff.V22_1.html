<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>é›¶ç”¨é‡‘æ”¯å‡ºå¸³ç°¿</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    select, input { padding: 6px; margin: 6px 0; width: 100%; }
    button { padding: 8px 14px; font-size: 16px; }
  </style>
</head>

<body>
  <h3>é›¶ç”¨é‡‘æ”¯å‡ºå¸³ç°¿ <span id="version">[V]</span></h3>
  
  <label>æ—¥æœŸï¼š</label>
  <input type="date" id="date"><br>

  <label>åº—å®¶ï¼š</label>
  <input type="text" id="store" placeholder="è¼¸å…¥åº—å®¶åç¨±"><br>

  <label>åˆ†é¡ï¼š</label>
  <select id="type" required></select><br>

  <label>ä»˜æ¬¾æ–¹å¼ï¼š</label>
  <select id="payment" required></select><br>

  <button id="submitBtn">é€å‡º</button>

  <script>
    let API_URL = "";
    let VERSION = "";
    let LIFF_IDa = "";
    let storeList = [];

    // âœ… è®€å–è¨­å®š (ç¯„ä¾‹ç”¨å›ºå®š URLï¼Œå¯æ›æˆå¯¦éš› GAS è¨­å®šç«¯)
    async function loadSettings() {
      const settingsUrl = "https://script.google.com/macros/s/AKfycbwk0q0U7iSfqX08_A_jhN0e5RPGsJjZ87n7KBK3qvuypRzYwYP2F5yYBPxoja6EJFIg/exec?type=è¨­å®š";
      const res = await fetch(settingsUrl);
      const data = await res.json();
      if (data.ok && data.type === "è¨­å®š") return data.data;
      throw new Error("è¨­å®šæ ¼å¼éŒ¯èª¤");
    }

    // âœ… è¼‰å…¥åº—å®¶æ¸…å–®
    async function loadStoreList() {
      try {
        const res = await fetch(`${API_URL}?type=query&command=åº—å®¶`);
        const data = await res.json();
        console.log("GAS å›å‚³åº—å®¶:", data);

        if (data.ok && Array.isArray(data.storeList)) {
          storeList = data.storeList;
          console.log("è¼‰å…¥åº—å®¶æ¸…å–®æˆåŠŸ:", storeList);
        }
      } catch (err) {
        console.error("è¼‰å…¥åº—å®¶æ¸…å–®å¤±æ•—:", err);
      }
    }

    // âœ… è¼‰å…¥åˆ†é¡ / ä»˜æ¬¾æ¸…å–®
    async function loadTypeAndPaymentList() {
      try {
        const listRes = await fetch(`${API_URL}?type=query&command=æ¸…å–®`);
        const listData = await listRes.json();
        console.log("GAS å›å‚³æ¸…å–®:", listData);

        if (listData.ok) {
          const types = listData.types || [];
          const payments = listData.payments || [];

          const typeSelect = document.getElementById("type");
          const paymentSelect = document.getElementById("payment");

          typeSelect.innerHTML = "";
          paymentSelect.innerHTML = "";

          types.forEach(t => {
            const opt = document.createElement("option");
            opt.value = t;
            opt.textContent = t;
            typeSelect.appendChild(opt);
          });

          payments.forEach(p => {
            const opt = document.createElement("option");
            opt.value = p;
            opt.textContent = p;
            paymentSelect.appendChild(opt);
          });
        }
      } catch (err) {
        console.error("è¼‰å…¥æ¸…å–®å¤±æ•—:", err);
      }
    }

    // âœ… åˆå§‹åŒ–æµç¨‹
    async function initApp() {
      try {
        const settings = await loadSettings();
        API_URL = (settings.API_URL || "").trim();
        VERSION = (settings.D10 || "V").trim();
        LIFF_IDa = (settings.D11 || "").trim();

        document.getElementById("version").textContent = VERSION;
        console.log("âœ… è¨­å®šæˆåŠŸ:", { API_URL, VERSION, LIFF_IDa });

        // åˆå§‹åŒ– LIFF
        await liff.init({ liffId: LIFF_IDa });
        // if (!liff.isLoggedIn()) liff.login(); // æ¸¬è©¦éšæ®µå…ˆè¨»è§£

        document.getElementById("date").valueAsDate = new Date();

        if (API_URL) {
          await loadStoreList();          // åº—å®¶
          await loadTypeAndPaymentList(); // åˆ†é¡ + ä»˜æ¬¾
        }

      } catch (err) {
        console.error("åˆå§‹åŒ–å¤±æ•—ï¼š", err);
        alert("åˆå§‹åŒ–å¤±æ•—ï¼š" + err.message);
      }
    }

    // ğŸš€ é é¢è¼‰å…¥å¾Œå•Ÿå‹•
    window.addEventListener("load", initApp);
  </script>
</body>
</html>
