<div id="queryResult"></div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<div id="queryResult"></div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzp7z2jx-chJ15TGqCNhDuOaJrV92CEGYU-6XrA_qdIjeEg2lFmKwmPZcjfnBthcndbJw/exec"; // ğŸ‘ˆ æ”¹æˆä½ å¾Œç«¯çš„ API

  async function sendQuery(command) {
  const body = { type: "query", command: command };
  const res = await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify(body)
  });
  const json = await res.json();

  if (!json.ok) {
    document.getElementById("queryResult").innerHTML = `<p style="color:red">âŒ æŸ¥è©¢å¤±æ•—</p>`;
    return;
  }

  let html = "";
  let sortAsc = true;

  // ğŸ‘‰ æœ¬æœˆåˆ†é¡
  if (command === "æœ¬æœˆåˆ†é¡" && json.categories) {
    html += `<div style="border:2px solid #4CAF50; padding:10px; margin-top:15px; border-radius:8px; background:#f9fff9;">`;
    html += `<h4 style="margin:0 0 10px 0;">ğŸ“Š æœ¬æœˆåˆ†é¡çµ±è¨ˆ</h4>`;
    html += `<table><tr><th>åˆ†é¡</th><th>é‡‘é¡</th><th>å æ¯”</th></tr>`;
    for (const [cat, amt] of Object.entries(json.categories)) {
      const percent = ((amt / json.total) * 100).toFixed(1);
      html += `<tr><td>${cat}</td><td>${Number(amt).toLocaleString()}</td><td>${percent}%</td></tr>`;
    }
    html += `</table></div>`;
    html += `<canvas id="typeChart" width="300" height="300" style="margin-top:20px;"></canvas>`;
    html += `<div class="total">ğŸ“Œ æœ¬æœˆç¸½é¡ï¼š${Number(json.total || 0).toLocaleString()} å…ƒ</div>`;
  }

  // ğŸ‘‰ æœ¬æœˆä»˜æ¬¾
  if (command === "æœ¬æœˆä»˜æ¬¾" && json.payments) {
    html += `<div style="border:2px solid #FF9800; padding:10px; margin-top:15px; border-radius:8px; background:#fff8f0;">`;
    html += `<h4 style="margin:0 0 10px 0;">ğŸ’³ æœ¬æœˆä»˜æ¬¾æ–¹å¼</h4>`;
    html += `<table><tr><th>ä»˜æ¬¾æ–¹å¼</th><th>é‡‘é¡</th><th>å æ¯”</th></tr>`;
    for (const [pay, amt] of Object.entries(json.payments)) {
      const percent = ((amt / json.total) * 100).toFixed(1);
      html += `<tr><td>${pay}</td><td>${Number(amt).toLocaleString()}</td><td>${percent}%</td></tr>`;
    }
    html += `</table></div>`;
    html += `<canvas id="payChart" width="300" height="300" style="margin-top:20px;"></canvas>`;
  }

  // ğŸ‘‰ æœ¬æœˆåº—å®¶
  if (command === "æœ¬æœˆåº—å®¶" && json.stores) {
    html += `<div style="border:2px solid #2196F3; padding:10px; margin-top:15px; border-radius:8px; background:#f0f8ff;">`;
    html += `<h4 style="margin:0 0 10px 0;">ğŸ“‹ æœ¬æœˆåº—å®¶çµ±è¨ˆ</h4>`;
    html += `<table id="storeTable"><tr><th onclick="sortStoreTable(0)">åº—å®¶æ–¹å¼ â¬</th><th onclick="sortStoreTable(1)">é‡‘é¡ â¬</th><th>å æ¯”</th></tr>`;
    for (const [store, amt] of Object.entries(json.stores)) {
      const percent = ((amt / json.total) * 100).toFixed(1);
      html += `<tr><td>${store}</td><td>${Number(amt).toLocaleString()}</td><td>${percent}%</td></tr>`;
    }
    html += `</table></div>`;
    html += `<canvas id="storeChart" width="300" height="300" style="margin-top:20px;"></canvas>`;
    const storeCount = Object.keys(json.stores).length;
    html += `<div class="total">ğŸ“Œ æœ¬æœˆç¸½é¡ï¼š${Number(json.total || 0).toLocaleString()} å…ƒï¼ˆå…± ${storeCount} ç¨®åº—å®¶æ–¹å¼ï¼‰</div>`;
  }

  // ğŸ‘‰ æœ¬æœˆæ˜ç´°
  if (command === "æœ¬æœˆ" && json.rows && json.rows.length > 0) {
    json.rows.sort((a, b) => {
      const da = a[4] ? new Date(a[4]) : new Date(0);
      const db = b[4] ? new Date(b[4]) : new Date(0);
      return da - db;
    });
    html += `<div style="border:2px solid #9C27B0; padding:10px; margin-top:15px; border-radius:8px; background:#fdf0ff;">`;
    html += `<h4 style="margin:0 0 10px 0;">ğŸ“… æœ¬æœˆæ¶ˆè²»æ˜ç´°</h4>`;
    html += `<table><tr><th>æ—¥æœŸ</th><th>åˆ†é¡</th><th>åº—å®¶</th><th>é‡‘é¡</th><th>ä»˜æ¬¾</th></tr>`;
    json.rows.forEach(r => {
      let dateStr = "";
      if (r[4]) {
        const d = new Date(r[4]);
        dateStr = d.toLocaleDateString("zh-TW", { timeZone: "Asia/Taipei", year: "numeric", month: "2-digit", day: "2-digit" });
      }
      html += `<tr><td>${dateStr}</td><td>${r[0]}</td><td>${r[1]}</td><td>${Number(r[2]).toLocaleString()}</td><td>${r[3]}</td></tr>`;
    });
    html += `</table></div>`;
  }

  // ğŸš€ ä¸€æ¬¡æ€§è¼¸å‡º
  document.getElementById("queryResult").innerHTML = html;

  // ğŸ‘‰ å†ç•«åœ–ï¼ˆè¦ç­‰ DOM å»ºç«‹å®Œï¼‰
  if (command === "æœ¬æœˆåˆ†é¡" && json.categories) {
    const ctx = document.getElementById("typeChart").getContext("2d");
    new Chart(ctx, {
      type: "pie",
      data: {
        labels: Object.keys(json.categories),
        datasets: [{
          data: Object.values(json.categories),
          backgroundColor: ["#4CAF50","#2196F3","#FF9800","#E91E63","#9C27B0","#00BCD4","#8BC34A","#FFC107","#FF5722","#795548"]
        }]
      },
      options: { responsive: true, plugins: { legend: { position: "bottom" } } }
    });
  }

  if (command === "æœ¬æœˆä»˜æ¬¾" && json.payments) {
    const ctx = document.getElementById("payChart").getContext("2d");
    new Chart(ctx, {
      type: "pie",
      data: {
        labels: Object.keys(json.payments),
        datasets: [{
          data: Object.values(json.payments),
          backgroundColor: ["#4CAF50","#2196F3","#FF9800","#E91E63","#9C27B0","#00BCD4","#8BC34A","#FFC107","#FF5722","#795548"]
        }]
      },
      options: { responsive: true, plugins: { legend: { position: "bottom" } } }
    });
  }

  if (command === "æœ¬æœˆåº—å®¶" && json.stores) {
    const ctx = document.getElementById("storeChart").getContext("2d");
    new Chart(ctx, {
      type: "bar",
      data: {
        labels: Object.keys(json.stores),
        datasets: [{
          data: Object.values(json.stores),
          backgroundColor: "#36A2EB"
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { title: { display: true, text: "åº—å®¶" } },
          y: { title: { display: true, text: "é‡‘é¡ (å…ƒ)" } }
        }
      }
    });
  }
}

// ğŸ‘‰ ç°¡å–®è¡¨æ ¼æ’åºå‡½æ•¸
function sortStoreTable(colIndex) {
  const table = document.getElementById("storeTable");
  const rows = Array.from(table.rows).slice(1);
  const asc = table.getAttribute("data-sort") !== "asc";
  rows.sort((a, b) => {
    const valA = colIndex === 1 ? parseInt(a.cells[colIndex].innerText.replace(/,/g, "")) : a.cells[colIndex].innerText;
    const valB = colIndex === 1 ? parseInt(b.cells[colIndex].innerText.replace(/,/g, "")) : b.cells[colIndex].innerText;
    return asc ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
  });
  rows.forEach(r => table.appendChild(r));
  table.setAttribute("data-sort", asc ? "asc" : "desc");
}
</script>
