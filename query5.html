<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>é›¶ç”¨é‡‘æ”¯å‡ºå¸³ç°¿</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    button { margin: 5px; padding: 8px 12px; }
    table { border-collapse: collapse; margin-top: 15px; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #f2f2f2; cursor: pointer; }
    #chartContainer { width: 90%; max-width: 700px; margin-top: 30px; }
    .error { color: red; }
  </style>
</head>
<body>
  <h2>é›¶ç”¨é‡‘æ”¯å‡ºæŸ¥è©¢</h2>

  <button onclick="fetchData('æœ¬æœˆ')">æœ¬æœˆ</button>
  <button onclick="fetchData('æœ¬æœˆåˆ†é¡')">æœ¬æœˆåˆ†é¡</button>
  <button onclick="fetchData('æœ¬æœˆä»˜æ¬¾')">æœ¬æœˆä»˜æ¬¾</button>
  <button onclick="fetchData('æœ¬æœˆåº—å®¶')">æœ¬æœˆåº—å®¶</button>

  <div id="result"></div>
  <div id="chartContainer">
    <canvas id="myChart"></canvas>
  </div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxxxxxxxxxxxx/exec"; // ä½ çš„ GAS URL
    let currentChart = null;

    async function fetchData(command) {
      document.getElementById("result").innerHTML = "â³ æŸ¥è©¢ä¸­...";
      if (currentChart) { currentChart.destroy(); }

      try {
        const response = await fetch(`${GAS_URL}?command=${command}`);
        if (!response.ok) throw new Error("ç¶²è·¯å›æ‡‰éŒ¯èª¤");
        const json = await response.json();

        if (json.status === "success") {
          renderTable(command, json.rows);
          drawChart(command, json.rows);
        } else {
          document.getElementById("result").innerHTML = "âŒ æŸ¥è©¢å¤±æ•—ï¼š" + json.message;
        }
      } catch (err) {
        document.getElementById("result").innerHTML = "âŒ æŸ¥è©¢å¤±æ•—ï¼š" + err.message;
      }
    }

    function renderTable(command, rows) {
      if (!rows || rows.length === 0) {
        document.getElementById("result").innerHTML = "æ²’æœ‰è³‡æ–™";
        return;
      }

      let headers = [];
      if (command === "æœ¬æœˆ") headers = ["é …æ¬¡", "é …ç›®", "åˆ†é¡", "ä»˜æ¬¾æ–¹å¼", "æ—¥æœŸ", "é‡‘é¡", "åº—å®¶"];
      else if (command === "æœ¬æœˆåˆ†é¡") headers = ["åˆ†é¡", "é‡‘é¡"];
      else if (command === "æœ¬æœˆä»˜æ¬¾") headers = ["ä»˜æ¬¾æ–¹å¼", "é‡‘é¡"];
      else if (command === "æœ¬æœˆåº—å®¶") headers = ["åº—å®¶", "é‡‘é¡"];

      let html = "<table><thead><tr>";
      headers.forEach(h => html += `<th onclick="sortTable(this)">${h}</th>`);
      html += "</tr></thead><tbody>";

      rows.forEach(r => {
        html += "<tr>";
        r.forEach(v => html += `<td>${v}</td>`);
        html += "</tr>";
      });

      html += "</tbody></table>";
      document.getElementById("result").innerHTML = html;
    }

    function drawChart(command, rows) {
      const ctx = document.getElementById("myChart").getContext("2d");
      if (!rows || rows.length === 0) return;

      if (command === "æœ¬æœˆ") {
        // ğŸ”¹ æ—¥æœŸå½™ç¸½
        const dailyTotals = {};
        rows.forEach(r => {
          const dateStr = r[4] ? new Date(r[4]).toLocaleDateString("zh-TW") : "";
          const amount = Number(r[5]) || 0;
          dailyTotals[dateStr] = (dailyTotals[dateStr] || 0) + amount;
        });

        const labels = Object.keys(dailyTotals).sort((a, b) => new Date(a) - new Date(b));
        const values = labels.map(d => dailyTotals[d]);

        currentChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [{ label: "æ¯æ—¥æ”¯å‡ºåŠ ç¸½", data: values, backgroundColor: "rgba(54,162,235,0.6)" }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
              x: { title: { display: true, text: "æ—¥æœŸ" } },
              y: { title: { display: true, text: "é‡‘é¡" }, beginAtZero: true }
            }
          }
        });
      } else {
        // ğŸ”¹ åœ“é¤…åœ–
        const labels = rows.map(r => r[0]);
        const values = rows.map(r => Number(r[1]) || 0);

        currentChart = new Chart(ctx, {
          type: "pie",
          data: {
            labels,
            datasets: [{ data: values, backgroundColor: generateColors(values.length) }]
          },
          options: { responsive: true }
        });
      }
    }

    function generateColors(n) {
      const colors = [];
      for (let i = 0; i < n; i++) {
        const r = Math.floor(Math.random() * 255);
        const g = Math.floor(Math.random() * 255);
        const b = Math.floor(Math.random() * 255);
        colors.push(`rgba(${r},${g},${b},0.6)`);
      }
      return colors;
    }

    // ğŸ”¹ è¡¨æ ¼æ’åº
    function sortTable(th) {
      const table = th.closest("table");
      const tbody = table.querySelector("tbody");
      const index = Array.from(th.parentNode.children).indexOf(th);
      const rows = Array.from(tbody.querySelectorAll("tr"));

      const asc = !th.asc;
      th.asc = asc;

      rows.sort((a, b) => {
        let v1 = a.children[index].innerText;
        let v2 = b.children[index].innerText;

        if (!isNaN(v1) && !isNaN(v2)) {
          return asc ? v1 - v2 : v2 - v1;
        } else if (!isNaN(Date.parse(v1)) && !isNaN(Date.parse(v2))) {
          return asc ? new Date(v1) - new Date(v2) : new Date(v2) - new Date(v1);
        } else {
          return asc ? v1.localeCompare(v2, "zh") : v2.localeCompare(v1, "zh");
        }
      });

      rows.forEach(r => tbody.appendChild(r));
    }
  </script>
</body>
</html>
