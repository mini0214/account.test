<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>零用金查詢</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial; margin: 20px; }
    button { margin: 5px; padding: 5px 10px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }
    th { cursor: pointer; background: #f2f2f2; }
    canvas { margin-top: 20px; max-width: 600px; }
  </style>
</head>
<body>
  <h2>零用金查詢</h2>
  <button onclick="fetchData('month')">本月</button>
  <button onclick="fetchData('category')">本月分類</button>
  <button onclick="fetchData('payment')">本月付款</button>
  <button onclick="fetchData('store')">本月店家</button>

  <div id="result"></div>
  <canvas id="chart"></canvas>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzp7z2jx-chJ15TGqCNhDuOaJrV92CEGYU-6XrA_qdIjeEg2lFmKwmPZcjfnBthcndbJw/exec";
let chartInstance = null;

async function fetchData(type) {
  document.getElementById("result").innerHTML = "查詢中...";
  document.getElementById("chart").style.display = "none";

  try {
    const res = await fetch(`${API_URL}?type=${type}`);
    const data = await res.json();
    if (!data || data.length === 0) throw new Error("沒有資料");

    if (type === "month") {
      const summarized = summarizeByDate(data);   // 日期彙總
      renderTable(summarized);
      renderBarChart(summarized);
    } else {
      renderTable(data); // 其他顯示原始資料
      renderPieChart(type, data);
    }

  } catch (err) {
    document.getElementById("result").innerHTML = `❌ 查詢失敗：${err.message}`;
    console.error(err);
  }
}

// 本月：日期彙總
function summarizeByDate(data) {
  const totals = {};
  data.forEach(row => {
    const date = row["日期"];
    const amount = Number(row["金額"]);
    totals[date] = (totals[date] || 0) + amount;
  });

  return Object.keys(totals).sort().map(d => ({
    "日期": d,
    "金額": totals[d]
  }));
}

// 繪製表格
function renderTable(data) {
  let html = "<table><thead><tr>";
  const keys = Object.keys(data[0]);
  keys.forEach(k => { html += `<th onclick="sortTable(this)">${k}</th>`; });
  html += "</tr></thead><tbody>";

  data.forEach(row => {
    html += "<tr>";
    keys.forEach(k => { html += `<td>${row[k]}</td>`; });
    html += "</tr>";
  });

  html += "</tbody></table>";
  document.getElementById("result").innerHTML = html;
}

// 長條圖
function renderBarChart(data) {
  const labels = data.map(row => row["日期"]);
  const values = data.map(row => row["金額"]);
  drawChart("bar", labels, values, "日期 vs 金額");
}

// 圓餅圖
function renderPieChart(type, data) {
  const keyMap = {
    category: "分類方式",
    payment: "付款方式",
    store: "店家"
  };
  const key = keyMap[type];

  const totals = {};
  data.forEach(row => {
    const label = row[key];
    const amount = Number(row["金額"]);
    totals[label] = (totals[label] || 0) + amount;
  });

  const labels = Object.keys(totals);
  const values = labels.map(l => totals[l]);
  drawChart("pie", labels, values, `${key} vs 金額`);
}

// 繪圖共用
function drawChart(type, labels, values, title) {
  const ctx = document.getElementById("chart").getContext("2d");
  if (chartInstance) chartInstance.destroy();

  chartInstance = new Chart(ctx, {
    type,
    data: {
      labels,
      datasets: [{
        label: title,
        data: values,
        backgroundColor: type === "bar" 
          ? "rgba(75, 192, 192, 0.6)"
          : labels.map((_, i) => `hsl(${i*60},70%,60%)`)
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: true } }
    }
  });

  document.getElementById("chart").style.display = "block";
}

// 表格排序
function sortTable(th) {
  const table = th.closest("table");
  const tbody = table.querySelector("tbody");
  const idx = Array.from(th.parentNode.children).indexOf(th);
  const rows = Array.from(tbody.querySelectorAll("tr"));
  const asc = !th.asc;
  th.asc = asc;

  rows.sort((a, b) => {
    let v1 = a.children[idx].innerText;
    let v2 = b.children[idx].innerText;
    let n1 = parseFloat(v1), n2 = parseFloat(v2);
    if (!isNaN(n1) && !isNaN(n2)) return asc ? n1 - n2 : n2 - n1;
    return asc ? v1.localeCompare(v2) : v2.localeCompare(v1);
  });

  tbody.innerHTML = "";
  rows.forEach(r => tbody.appendChild(r));
}
</script>
</body>
</html>
