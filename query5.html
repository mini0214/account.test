<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>é›¶ç”¨é‡‘æŸ¥è©¢</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 30px; }
    h3 { font-size: 40px; text-align: center; margin-bottom: 30px; }
    button { font-size: 30px; padding: 15px 25px; margin: 5px; border-radius: 8px; cursor: pointer; }
    #queryResult { margin-top: 30px; }
    table { border-collapse: collapse; width: 100%; margin-top: 15px; font-size: 20px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background-color: #f2f2f2; cursor: pointer; }
    th.sort-asc::after { content: " â–²"; }
    th.sort-desc::after { content: " â–¼"; }
    .total { font-size: 28px; font-weight: bold; color: #d9534f; margin-top: 10px; }
    canvas { margin-top: 30px; max-width: 100%; }
  </style>
</head>
<body>

<h3>é›¶ç”¨é‡‘æŸ¥è©¢ [<span id="version"></span>]</h3>

<button id="queryMonthBtn">ğŸ“Š æŸ¥è©¢æœ¬æœˆ</button>
<button id="queryMonthPayBtn">ğŸ’³ æŸ¥è©¢æœ¬æœˆä»˜æ¬¾</button>
<button id="queryMonthtypeBtn">â­• æŸ¥è©¢æœ¬æœˆåˆ†é¡</button>
<button id="queryMonthstoreBtn">ğŸ“‹ æŸ¥è©¢æœ¬æœˆåº—å®¶</button>

<div id="queryResult"></div>
<canvas id="chart"></canvas>

<script>
const LIFF_ID = "2008096451-jPJ50MOY";
const VERSION = "T4"; // å¯æ”¹å›ä½ æƒ³çš„ç‰ˆæœ¬
const API_URL = "https://script.google.com/macros/s/AKfycbzp7z2jx-chJ15TGqCNhDuOaJrV92CEGYU-6XrA_qdIjeEg2lFmKwmPZcjfnBthcndbJw/exec";

document.getElementById("version").textContent = VERSION;

let currentChart = null;

// LIFF åˆå§‹åŒ–ï¼ˆç¶­æŒåŸæœ¬è¡Œç‚ºï¼‰
async function main() {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) liff.login();
  } catch (e) {
    console.warn("LIFF init error:", e);
  }
}
main();

// ç¶å®šæŒ‰éˆ•
document.getElementById("queryMonthBtn").addEventListener("click", () => sendQuery("æœ¬æœˆ"));
document.getElementById("queryMonthtypeBtn").addEventListener("click", () => sendQuery("æœ¬æœˆåˆ†é¡"));
document.getElementById("queryMonthPayBtn").addEventListener("click", () => sendQuery("æœ¬æœˆä»˜æ¬¾"));
document.getElementById("queryMonthstoreBtn").addEventListener("click", () => sendQuery("æœ¬æœˆåº—å®¶"));

/* ---------- è¡¨æ ¼æ’åºå‡½å¼ï¼ˆç©©å®šç‰ˆï¼‰ ---------- */
function makeTableSortable(table) {
  const thead = table.tHead;
  const tbody = table.tBodies[0];
  if (!tbody) return;
  const headers = thead ? Array.from(thead.querySelectorAll("th")) : Array.from(table.querySelectorAll("th"));
  headers.forEach((th, colIndex) => {
    th.style.userSelect = "none";
    th.addEventListener("click", () => {
      const rows = Array.from(tbody.rows);
      // åˆ¤æ–·æ¬„ä½æ˜¯å¦ç‚ºæ•¸å­—ï¼ˆæ‰€æœ‰åˆ—çš†å¯è½‰ç‚ºæ•¸å­—ï¼‰
      const isNumeric = rows.length > 0 && rows.every(r => {
        const v = r.cells[colIndex] ? r.cells[colIndex].innerText.replace(/,/g, "").trim() : "";
        return v === "" ? true : !isNaN(Number(v));
      });
      // å–ç›®å‰ç‹€æ…‹ä¸¦åˆ‡æ›
      const current = th.dataset.order === "asc" ? "asc" : th.dataset.order === "desc" ? "desc" : null;
      headers.forEach(h => { h.classList.remove("sort-asc","sort-desc"); h.dataset.order = ""; });
      const direction = current === "asc" ? "desc" : "asc";
      th.classList.add(direction === "asc" ? "sort-asc" : "sort-desc");
      th.dataset.order = direction;

      rows.sort((a, b) => {
        let A = a.cells[colIndex] ? a.cells[colIndex].innerText.replace(/,/g, "").trim() : "";
        let B = b.cells[colIndex] ? b.cells[colIndex].innerText.replace(/,/g, "").trim() : "";
        if (isNumeric) {
          A = Number(A) || 0;
          B = Number(B) || 0;
          return direction === "asc" ? A - B : B - A;
        }
        // å˜—è©¦æ—¥æœŸæ¯”è¼ƒ
        const dA = Date.parse(A);
        const dB = Date.parse(B);
        if (!isNaN(dA) && !isNaN(dB)) {
          return direction === "asc" ? dA - dB : dB - dA;
        }
        return direction === "asc" ? A.localeCompare(B, "zh-TW") : B.localeCompare(A, "zh-TW");
      });

      // é‡æ–°é™„å› tbody
      rows.forEach(r => tbody.appendChild(r));
    });
  });
}

/* ---------- æŸ¥è©¢ä¸¦é¡¯ç¤ºï¼ˆPOST åˆ° GASï¼‰ ---------- */
async function sendQuery(command){
  const body = { type: "query", command: command, version: VERSION };
  try {
    document.getElementById("queryResult").innerHTML = "æŸ¥è©¢ä¸­...";
    if (currentChart) { currentChart.destroy(); currentChart = null; }

    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    const json = await res.json();
    if (!json.ok) {
      document.getElementById("queryResult").innerHTML = `<p style="color:red">âŒ æŸ¥è©¢å¤±æ•—ï¼ˆä¼ºæœå™¨å›å‚³ï¼‰</p>`;
      return;
    }

    let html = "";

    /* ---------- æœ¬æœˆæ˜ç´°ï¼ˆé¡¯ç¤ºåŸå§‹æ˜ç´°è¡¨æ ¼ï¼‰ ---------- */
    if (command === "æœ¬æœˆ" && json.rows) {
      html += `<table id="dataTable"><thead><tr>
        <th>æ—¥æœŸ</th><th>åº—å®¶</th><th>æ”¶å…¥</th><th>æ”¯å‡º</th>
        <th>å¹£åˆ¥</th><th>é‡‘é¡</th><th>ä»˜æ¬¾</th><th>åˆ†é¡</th><th>é™„è¨»</th><th>å‚™è¨»</th>
      </tr></thead><tbody>`;
      json.rows.forEach(r => {
        const dateStr = r[4] ? new Date(r[4]).toLocaleDateString("zh-TW") : "";
        html += `<tr>
          <td>${dateStr}</td>
          <td>${escapeHtml(r[8])}</td>
          <td>${Number(r[11]||0).toLocaleString()}</td>
          <td>${Number(r[12]||0).toLocaleString()}</td>
          <td>${escapeHtml(r[13]||"")}</td>
          <td>${Number(r[5]||0).toLocaleString()}</td>
          <td>${escapeHtml(r[7]||"")}</td>
          <td>${escapeHtml(r[6]||"")}</td>
          <td>${escapeHtml(r[9]||"")}</td>
          <td>${escapeHtml(r[10]||"")}</td>
        </tr>`;
      });
      html += `</tbody></table>`;
      html += `<div class="total">ğŸ“Œ æœ¬æœˆç¸½é¡ï¼š${Number(json.total || 0).toLocaleString()} å…ƒï¼ˆå…± ${json.rows.length} ç­†ï¼‰</div>`;
    }

    /* ---------- æœ¬æœˆåˆ†é¡ ---------- */
    if (command === "æœ¬æœˆåˆ†é¡" && json.categories) {
      html += `<h4>â­• æœ¬æœˆåˆ†é¡çµ±è¨ˆ</h4>`;
      html += `<table id="dataTable"><thead><tr><th>åˆ†é¡æ–¹å¼</th><th>é‡‘é¡</th><th>å æ¯”</th></tr></thead><tbody>`;
      for (const [cat, amt] of Object.entries(json.categories)) {
        const percent = ((amt / json.total) * 100).toFixed(1);
        html += `<tr><td>${escapeHtml(cat)}</td><td>${Number(amt).toLocaleString()}</td><td>${percent}%</td></tr>`;
      }
      html += `</tbody></table>`;
      html += `<div class="total">ğŸ“Œ æœ¬æœˆç¸½é¡ï¼š${Number(json.total || 0).toLocaleString()} å…ƒï¼ˆå…± ${Object.keys(json.categories).length} ç­†åˆ†é¡ï¼‰</div>`;
    }

    /* ---------- æœ¬æœˆä»˜æ¬¾ ---------- */
    if (command === "æœ¬æœˆä»˜æ¬¾" && json.payments) {
      html += `<h4>ğŸ’³ æœ¬æœˆä»˜æ¬¾çµ±è¨ˆ</h4>`;
      html += `<table id="dataTable"><thead><tr><th>ä»˜æ¬¾æ–¹å¼</th><th>é‡‘é¡</th><th>å æ¯”</th></tr></thead><tbody>`;
      for (const [pay, amt] of Object.entries(json.payments)) {
        const percent = ((amt / json.total) * 100).toFixed(1);
        html += `<tr><td>${escapeHtml(pay)}</td><td>${Number(amt).toLocaleString()}</td><td>${percent}%</td></tr>`;
      }
      html += `</tbody></table>`;
      html += `<div class="total">ğŸ“Œ æœ¬æœˆç¸½é¡ï¼š${Number(json.total || 0).toLocaleString()} å…ƒï¼ˆå…± ${Object.keys(json.payments).length} ç­†ä»˜æ¬¾æ–¹å¼ï¼‰</div>`;
    }

    /* ---------- æœ¬æœˆåº—å®¶ ---------- */
    if (command === "æœ¬æœˆåº—å®¶" && json.stores) {
      html += `<h4>ğŸ“‹ æœ¬æœˆåº—å®¶çµ±è¨ˆ</h4>`;
      html += `<table id="dataTable"><thead><tr><th>åº—å®¶</th><th>é‡‘é¡</th><th>å æ¯”</th></tr></thead><tbody>`;
      for (const [store, amt] of Object.entries(json.stores)) {
        const percent = ((amt / json.total) * 100).toFixed(1);
        html += `<tr><td>${escapeHtml(store)}</td><td>${Number(amt).toLocaleString()}</td><td>${percent}%</td></tr>`;
      }
      html += `</tbody></table>`;
      html += `<div class="total">ğŸ“Œ æœ¬æœˆç¸½é¡ï¼š${Number(json.total || 0).toLocaleString()} å…ƒï¼ˆå…± ${Object.keys(json.stores).length} ç­†åº—å®¶ï¼‰</div>`;
    }

    document.getElementById("queryResult").innerHTML = html;

    // å•Ÿç”¨æ’åºï¼ˆè‹¥æœ‰è¡¨æ ¼ï¼‰
    const dataTable = document.getElementById("dataTable");
    if (dataTable) makeTableSortable(dataTable);

    // ç•«åœ–ï¼ˆåªç¹ªè£½å°æ‡‰æŸ¥è©¢çš„åœ–ï¼‰
    drawChart(command, json);

  } catch(err) {
    console.error(err);
    document.getElementById("queryResult").innerHTML = `<p style="color:red">âŒ æŸ¥è©¢å¤±æ•—ï¼š${escapeHtml(err.message)}</p>`;
  }
}

/* ---------- Chart.js ç•«åœ–ï¼ˆå«æ—¥æœŸå½™ç¸½ï¼‰ ---------- */
function drawChart(command, json) {
  if (currentChart) { currentChart.destroy(); currentChart = null; }
  const canvas = document.getElementById("chart");
  if (!canvas) return;
  const ctx = canvas.getContext("2d");

  // æœ¬æœˆï¼šä¾æ—¥æœŸå½™ç¸½ï¼ˆåŒä¸€å¤©åˆè¨ˆä¸€æ¬¡ï¼‰
  if (command === "æœ¬æœˆ" && json.rows) {
    const dailyTotals = {};
    json.rows.forEach(r => {
      const rawDate = r[4];
      const dateStr = rawDate ? new Date(rawDate).toLocaleDateString("zh-TW") : "";
      const amount = Number(r[5]) || 0;
      dailyTotals[dateStr] = (dailyTotals[dateStr] || 0) + amount;
    });

    const labels = Object.keys(dailyTotals).filter(d => d !== "").sort((a,b) => new Date(a) - new Date(b));
    const values = labels.map(d => dailyTotals[d]);

    currentChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [{ label: "æ¯æ—¥æ”¯å‡ºåŠ ç¸½", data: values, backgroundColor: "rgba(54, 162, 235, 0.6)" }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { title: { display: true, text: "æ—¥æœŸ" } },
          y: { title: { display: true, text: "é‡‘é¡" }, beginAtZero: true }
        }
      }
    });
    return;
  }

  // å…¶ä»–ä¸‰ç¨®ï¼šä½¿ç”¨ json.categories / json.payments / json.storesï¼ˆåœ“é¤…åœ–ï¼‰
  if (command === "æœ¬æœˆåˆ†é¡" && json.categories) {
    const labels = Object.keys(json.categories);
    const values = Object.values(json.categories);
    currentChart = new Chart(ctx, { type: "pie", data: { labels, datasets: [{ data: values }] }, options: { responsive: true } });
    return;
  }

  if (command === "æœ¬æœˆä»˜æ¬¾" && json.payments) {
    const labels = Object.keys(json.payments);
    const values = Object.values(json.payments);
    currentChart = new Chart(ctx, { type: "pie", data: { labels, datasets: [{ data: values }] }, options: { responsive: true } });
    return;
  }

  if (command === "æœ¬æœˆåº—å®¶" && json.stores) {
    const labels = Object.keys(json.stores);
    const values = Object.values(json.stores);
    currentChart = new Chart(ctx, { type: "pie", data: { labels, datasets: [{ data: values }] }, options: { responsive: true } });
    return;
  }

  // è‹¥ç„¡ç¬¦åˆæ¢ä»¶ï¼Œæ¸…ç©ºç•«å¸ƒ
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}

/* ---------- å°å·¥å…·ï¼šé¿å… XSSï¼ˆæœ€åŸºæœ¬ï¼‰ ---------- */
function escapeHtml(str) {
  if (str === null || str === undefined) return "";
  return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
}
</script>

</body>
</html>
