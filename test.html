<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>總額測試</title>
</head>
<body>
  <h2>記帳測試</h2>
  <form id="expenseForm">
    <label>日期：<input type="date" id="date" /></label><br><br>
    <label>店家：<input type="text" id="store" value="7eleven" /></label><br><br>
    <label>收入：<input type="number" id="income" value="0" /></label><br><br>
    <label>支出：<input type="number" id="payout" value="100" /></label><br><br>
    <label>幣別：<input type="text" id="currency" value="TWD" /></label><br><br>
    <label>付款：<input type="text" id="payment" value="現金" /></label><br><br>
    <label>分類：<input type="text" id="type" value="食" /></label><br><br>
    <label>附註：<input type="text" id="note" value="測試" /></label><br><br>
    <button type="submit" id="submitBtn">送出</button>
  </form>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwTh42EN0Oe8YQ8T_LvGG0iIPoNcRfyjJTE22F-AmA_DFlsScwfbzPUlk16aKNr46f6BQ/exec";

    function handleTotalData(totalData, payload) {
      const thisTotal = Number(totalData?.thisMonth?.total) || 0;
      const lastTotal = Number(totalData?.lastMonth?.total) || 0;

      alert(
        `📋 登錄者：${payload.displayName}\n` +
        `📅 日期：${payload.inputDate}\n` +
        `📂 分類：${payload.type}\n` +
        `💰 收支：${payload.amount}\n` +
        `📝 附註：${payload.note}\n\n` +
        `📆 本期總額：💰${thisTotal.toLocaleString()}\n` +
        `📅 上期總額：💰${lastTotal.toLocaleString()}`
      );
    }

    document.getElementById("expenseForm").addEventListener("submit", (e) => {
      e.preventDefault();

      const payload = {
        inputDate: document.getElementById("date").value,
        store: document.getElementById("store").value,
        income: Number(document.getElementById("income").value),
        payout: Number(document.getElementById("payout").value),
        currency: document.getElementById("currency").value,
        amount: Number(document.getElementById("income").value) - Number(document.getElementById("payout").value),
        payment: document.getElementById("payment").value,
        type: document.getElementById("type").value,
        note: document.getElementById("note").value,
        displayName: "Betty Yi" // 測試登入者名稱
      };

      alert("已送出資料給 GAS (模擬)：" + JSON.stringify(payload));

      // 使用 JSONP 方式避免 CORS
      const script = document.createElement("script");
      script.src = `${API_URL}?type=query&command=總額&user=${encodeURIComponent(payload.displayName)}&callback=handleTotalDataWrapper`;
      document.body.appendChild(script);

      // JSONP callback wrapper
      window.handleTotalDataWrapper = function(totalData) {
        handleTotalData(totalData, payload);
        document.body.removeChild(script); // 使用後移除 <script>
      };
    });

    // 頁面載入時自動填入今天日期
    document.getElementById("date").valueAsDate = new Date();
  </script>
</body>
</html>

