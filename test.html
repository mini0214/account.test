<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ç¸½é¡æ¸¬è©¦</title>
</head>
<body>
  <h2>è¨˜å¸³æ¸¬è©¦</h2>
  <form id="expenseForm">
    <label>æ—¥æœŸï¼š<input type="date" id="date" /></label><br><br>
    <label>åº—å®¶ï¼š<input type="text" id="store" value="7eleven" /></label><br><br>
    <label>æ”¶å…¥ï¼š<input type="number" id="income" value="0" /></label><br><br>
    <label>æ”¯å‡ºï¼š<input type="number" id="payout" value="100" /></label><br><br>
    <label>å¹£åˆ¥ï¼š<input type="text" id="currency" value="TWD" /></label><br><br>
    <label>ä»˜æ¬¾ï¼š<input type="text" id="payment" value="ç¾é‡‘" /></label><br><br>
    <label>åˆ†é¡ï¼š<input type="text" id="type" value="é£Ÿ" /></label><br><br>
    <label>é™„è¨»ï¼š<input type="text" id="note" value="æ¸¬è©¦" /></label><br><br>
    <button type="submit" id="submitBtn">é€å‡º</button>
  </form>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwTh42EN0Oe8YQ8T_LvGG0iIPoNcRfyjJTE22F-AmA_DFlsScwfbzPUlk16aKNr46f6BQ/exec";

    function handleTotalData(totalData, payload) {
      const thisTotal = Number(totalData?.thisMonth?.total) || 0;
      const lastTotal = Number(totalData?.lastMonth?.total) || 0;

      alert(
        `ğŸ“‹ ç™»éŒ„è€…ï¼š${payload.displayName}\n` +
        `ğŸ“… æ—¥æœŸï¼š${payload.inputDate}\n` +
        `ğŸ“‚ åˆ†é¡ï¼š${payload.type}\n` +
        `ğŸ’° æ”¶æ”¯ï¼š${payload.amount}\n` +
        `ğŸ“ é™„è¨»ï¼š${payload.note}\n\n` +
        `ğŸ“† æœ¬æœŸç¸½é¡ï¼šğŸ’°${thisTotal.toLocaleString()}\n` +
        `ğŸ“… ä¸ŠæœŸç¸½é¡ï¼šğŸ’°${lastTotal.toLocaleString()}`
      );
    }

    document.getElementById("expenseForm").addEventListener("submit", (e) => {
      e.preventDefault();

      const payload = {
        inputDate: document.getElementById("date").value,
        store: document.getElementById("store").value,
        income: Number(document.getElementById("income").value),
        payout: Number(document.getElementById("payout").value),
        currency: document.getElementById("currency").value,
        amount: Number(document.getElementById("income").value) - Number(document.getElementById("payout").value),
        payment: document.getElementById("payment").value,
        type: document.getElementById("type").value,
        note: document.getElementById("note").value,
        displayName: "Betty Yi" // æ¸¬è©¦ç™»å…¥è€…åç¨±
      };

      alert("å·²é€å‡ºè³‡æ–™çµ¦ GAS (æ¨¡æ“¬)ï¼š" + JSON.stringify(payload));

      // ä½¿ç”¨ JSONP æ–¹å¼é¿å… CORS
      const script = document.createElement("script");
      script.src = `${API_URL}?type=query&command=ç¸½é¡&user=${encodeURIComponent(payload.displayName)}&callback=handleTotalDataWrapper`;
      document.body.appendChild(script);

      // JSONP callback wrapper
      window.handleTotalDataWrapper = function(totalData) {
        handleTotalData(totalData, payload);
        document.body.removeChild(script); // ä½¿ç”¨å¾Œç§»é™¤ <script>
      };
    });

    // é é¢è¼‰å…¥æ™‚è‡ªå‹•å¡«å…¥ä»Šå¤©æ—¥æœŸ
    document.getElementById("date").valueAsDate = new Date();
  </script>
</body>
</html>

