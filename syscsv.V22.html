<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>零用金支出帳簿</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    body { font-family: Arial, sans-serif; padding: 50px; }
    h3 { font-size: 50px; text-align: center; margin-bottom: 50px; }
    .date-inputs { font-size: 50px; text-align: center; margin-bottom: 20px;  }
    .date-inputs input { font-size: 50px; margin: 0 10px;  padding: 5px; }
    h4 { font-size: 36px; text-align: center; margin-bottom: 20px; }
    button { font-size: 40px; margin: 5px; padding: 10px 20px; border-radius: 8px; cursor: pointer; background-color: #4CAF50; color: white; }
    #queryResult { margin-top: 1px; }
    h5 { font-size: 28px; margin: 0; padding: 0; }
    table { font-size: 28px; border-collapse: collapse; width: 100%; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    .numeric { text-align: right; }
    .total { font-size: 28px; font-weight: bold; color: #d9534f; margin-top: 10px; }
    canvas { display: block; margin: 20px auto; width: 850px; height: 600px; }
  </style>
</head>
<body>

<h3>✅非<span style="color: green;">匯</span>不可.[<span id="version"></span>]</h3>

<div class="date-inputs">
  開始日期：<input type="date" id="startDate"><br>
  結束日期：<input type="date" id="endDate">
</div>

<h4>選擇您想要看的(直球對決)</h4>

<div style="text-align:center">
  <button id="queryMonthBtn">📊 明細</button>
  <button id="queryMonthPayBtn">💳 付款</button>
  <button id="queryMonthTypeBtn">📂 分類</button>
  <button id="queryMonthStoreBtn">📋 店家</button>
  <button id="queryMonthUserBtn">👤 記帳者</button>
</div>

<!-- ⏳ 載入提示區 -->
  <div id="loading" style="display:none; text-align:center; margin:20px;">
    <span style="font-size: 38px;">⏳ 載入中，請稍候...</span>
  </div>

<!-- 📊 查詢結果顯示區 -->  
<div id="queryResult"></div>
<canvas id="chartCanvas"></canvas>

<script>
//const LIFF_ID = "2008096451-jPJ50MOY"; // 換成你的 LIFF ID
//const VERSION = "V17_#43";             // 固定版次
//const API_URL = "https://script.google.com/macros/s/AKfycby4mZrwFX52xb7WgBrJIYsG76yvUZkgSadjly-vot-4ajrJ8DV8bemR1EVn_fZKJR_kHA/exec";  // 換成你的 GAS PATH

//let LIFF_ID = "default";   // 先放預設或空字串,從 D12 帶入 query
//let VERSION = "V";      // ✅ 預設顯示版本號，不要等API,從 D10 帶入 版// ----------------------------------------------------
// ✅ 設定,全域設定
// ----------------------------------------------------
// 💡 說明：
// FALLBACK_GAS_SETTINGS_URL 是「啟動保底設定URL」。第一次啟動時用它讀取設定表。所以未來重新部署 GAS，不需修改此行，除非設定表失效。
// 若設定表內有 D5（SETTINGS_URL），會自動更新成 D5。
// 暫時用,後續會自動轉換成設定檔內的固定 D5。這行只是啟動用的臨時鑰匙，真的開門後會自動換成設定表的正式鑰匙。
let FALLBACK_GAS_SETTINGS_URL = "https://script.google.com/macros/s/AKfycbxQ0NbKd-i30VwoyuPMsVgcbQuAaRCq7yTyBPHcaLwMzm6viyqvv2ioKP9rPPvl1e-2Kw/exec";
     
let API_URL = "";    // ✅ 從設定檔 D6
let VERSION = "V";   // ✅ 從設定檔 D10
let LIFF_IDs = "";   // ✅ 從設定檔 D14

let currentUser = null; // ✅ 先定義變數，不要一開始就用 json 登入者的資料
let chartInstance = null;

document.getElementById("version").textContent = VERSION;

// ----------------------------------------------------
// ✅ 設定,設定載入
// ----------------------------------------------------
async function tryFetchText(url){
  const r = await fetch(url, { cache: 'no-store' });
  const text = await r.text();
  try { const j = JSON.parse(text); return { ok: true, json: j }; }
  catch(e){ return { ok: false, text }; }
}

// ----------------------------------------------------
// ✅ 設定,從設定GAS讀取設定
// ----------------------------------------------------
async function loadSettings(){
  // 🔹 直接用 fallback 設定 GAS 查詢
  const res = await tryFetchText(FALLBACK_GAS_SETTINGS_URL + "?type=query&command=設定");
  if (!res.ok) throw new Error("設定 GAS 讀取失敗：" + res.text);
    
  const data = res.json;
  if (!data.ok || !data.data) throw new Error("設定格式錯誤");
    
  return data.data;  // 只回傳 data
}
  
// ----------------------------------------------------
// ✅ 設定,初始化
// ----------------------------------------------------
async function initApp(){
  try {
    const settings = await loadSettings();
    if (!settings) throw new Error("設定格式錯誤");
       
    // 🔹 從設定帶入
    FALLBACK_GAS_SETTINGS_URL = (settings.SETTINGS_URL || FALLBACK_GAS_SETTINGS_URL).trim();// 自動轉換成設定檔內的固定 D5
    API_URL = (settings.API_URL || "").trim();
    VERSION = (settings.D10 || "V").trim();
    LIFF_IDs = (settings.D14 || "").trim();
    
    document.getElementById("version").textContent = VERSION;
    console.log("✅ 設定成功:", { FALLBACK_GAS_SETTINGS_URL, API_URL, LIFF_IDs, VERSION });
    
    if (!LIFF_IDs) throw new Error("❌ LIFF ID 尚未設定，請確認設定表 D14");
    
    await liff.init({ liffId: LIFF_IDs });
    if (!liff.isLoggedIn()) liff.login();
    
    // 抓使用者 LINE 名稱
    try {
      const profile = await liff.getProfile();
      currentUser = profile.displayName;
      console.log("登入使用者:", currentUser);
    } catch (e) {
      console.warn("抓不到 LINE 名稱，會改用資料表第一筆:", e);
    }

    // 日期區間初始化
    setDefaultDateRange();

    // 其他邏輯（例如繪圖或查詢）
    if (API_URL) {
      console.log("📡 已連線到 API_URL:", API_URL);
      // await loadChartData();
    }
    
  } catch (err) {
    console.error("初始化設定失敗：", err);
    alert("初始化設定失敗：" + err.message);
  }
}

// 設定預設日期為本月月初與月底
function setDefaultDateRange() {
  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth(), 1);
  const end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
  document.getElementById("startDate").value = toInputDate(start);
  document.getElementById("endDate").value = toInputDate(end);
}

function toInputDate(d) {
  const m = (d.getMonth() + 1).toString().padStart(2, "0");
  const day = d.getDate().toString().padStart(2, "0");
  return `${d.getFullYear()}-${m}-${day}`;
}

// 按鈕事件
document.getElementById("queryMonthBtn").addEventListener("click", () => sendQuery("明細"));
document.getElementById("queryMonthTypeBtn").addEventListener("click", () => sendQuery("分類"));
document.getElementById("queryMonthPayBtn").addEventListener("click", () => sendQuery("付款"));
document.getElementById("queryMonthStoreBtn").addEventListener("click", () => sendQuery("店家"));
document.getElementById("queryMonthUserBtn").addEventListener("click", () => sendQuery("記帳者"));

// 發送查詢
async function sendQuery(command) {
  const startDate = document.getElementById("startDate").value;
  const endDate = document.getElementById("endDate").value;
  
  if (!startDate || !endDate) {
    alert("請選擇開始與結束日期");
    return;
  }
  
    // ✅ 查詢前清空舊的查詢結果
    document.getElementById("queryResult").innerHTML = "";
  
    // ✅ 如果有舊圖表，銷毀掉
    if (chartInstance) {
      chartInstance.destroy();
      chartInstance = null;
    }
    const ctx = document.getElementById("chartCanvas").getContext("2d");
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
  
    // ✅ 顯示載入中
    document.getElementById("loading").style.display = "block";
    
    const body = {
      type: "query",
      command: command,
      version: VERSION,
      startDate: startDate + " 00:00:00",
      endDate: endDate + " 23:59:59"
    };
 
    try {
      const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(body) });
      const json = await res.json();
      if (!json.ok) {
        document.getElementById("queryResult").innerHTML = `<p style="color:red">❌ 查詢失敗</p>`;
        return;
      }
      renderResult(command, json);
    } catch (err) {
      document.getElementById("queryResult").innerHTML = `<p style="color:red">❌ 查詢失敗：${err.message}</p>`;
    } finally {
      // ✅ 查詢結束後隱藏
      document.getElementById("loading").style.display = "none";
    }
  } // ✅ sendQuery() 結束
// 顯示結果表格與圖表
function renderResult(command, json) {
  let html = "";

  const adminUser = "Betty Yi"; // ✅ 管理者帳號
  
  // ✅ 如果 currentUser 還沒定義，就用資料表第一筆 登入者的資料
  if (!currentUser && json.rows && json.rows.length > 0) {
    currentUser = json.rows[0][3];  // 第 4 欄是 display_name
  }

  // ✅ 統一過濾：管理者看到全部，其它人只看自己
  let filteredRows = json.rows || [];
  if (currentUser && currentUser !== adminUser) {
    filteredRows = filteredRows.filter(r => r[3] === currentUser);
  }
  
  if (command === "明細" && json.rows) {
    // ✅ 這裡不要重新定義 filteredRows，直接用前面已經處理好的
    const rowsForDisplay = (currentUser === adminUser) ? json.rows : filteredRows;
    
    html += `<h5>📊 選擇查詢明細;標題按下即可排序</h5>`;
    html += `<table id="dataTable">
              <tr>
                <th>記帳者</th>
                <th>日期</th>
                <th>店家</th>
                <th class="numeric">收入</th>
                <th class="numeric">支出</th>
                <th>匯率</th>
                <th class="numeric">金額</th>
                <th>付款</th>
                <th>分類</th>
                <th>附註</th>
                <th>備註</th>
              </tr>`;

    // ✅ 表格資料只輸出 rowsForDisplay
    rowsForDisplay.forEach(r => {
      const dateStr = r[4] ? new Date(r[4]).toLocaleDateString("zh-TW") : "";
      html += `<tr>
                <td>${r[3]}</td>
                <td>${dateStr}</td>
                <td>${r[8]}</td>
                <td class="numeric">${Number(r[11]).toLocaleString()}</td>
                <td class="numeric">
                  ${Number(r[12]).toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                </td>
                <td>${r[13]}</td>
                <td class="numeric">${Number(r[5]).toLocaleString()}</td>
                <td>${r[7]}</td>
                <td>${r[6]}</td>
                <td>${r[9]}</td>
                <td>${r[10]}</td>
      </tr>`;
    });
    html += `</table>`;
  
    // ✅ 總額 & 筆數同樣用 rowsForDisplay
    const totalAmount = rowsForDisplay.reduce((sum, r) => sum + Number(r[5] || 0), 0);
    html += `<div class="total">📌 總額：${totalAmount.toLocaleString()} 元（共 ${rowsForDisplay.length} 筆）</div>`;

    // 長條圖資料：金額總和 + 幣別最大值
    const dateSum = {};
    const maxCurrencyByDate = {};
    rowsForDisplay.forEach(r => {
      const d = new Date(r[4]).toLocaleDateString("zh-TW");
      const amount = Number(r[5]);
      const currency = Number(r[13]);

      dateSum[d] = (dateSum[d] || 0) + amount;
      if (!maxCurrencyByDate[d] || currency > maxCurrencyByDate[d]) {
        maxCurrencyByDate[d] = currency;
      }
    });

    const sortedDates = Object.keys(dateSum).sort((a,b)=> new Date(a)-new Date(b));
    const sumValues = sortedDates.map(d=> dateSum[d]);
    const currencyValues = sortedDates.map(d=> maxCurrencyByDate[d] || 0);

    renderChart("bar", sortedDates, [sumValues, currencyValues]);
  }

  // 分類、付款、店家、記帳者
  const sections = [
    { cmd: "分類", key: 6, title: "📂 選擇分類統計;標題按下即可排序" },
    { cmd: "付款", key: 7, title: "💳 選擇付款統計;標題按下即可排序" },
    { cmd: "店家", key: 8, title: "📋 選擇店家統計;標題按下即可排序" },
    { cmd: "記帳者", key: 3, title: "👤 選擇記帳者統計;標題按下即可排序" }
  ];

  sections.forEach(sec => {
    if (command === sec.cmd) {
      
      // ✅ 管理員用全部資料，一般使用者才過濾
      const rowsForCalc = (currentUser === adminUser)
        ? json.rows
        : (json.rows ? json.rows.filter(r => r[3] === currentUser) : []);
      
      // 依 filteredRows 計算統計
      const counts = {};
      filteredRows.forEach(r => {
        const value = r[sec.key] || "未知";
        counts[value] = (counts[value] || 0) + Number(r[5] || 0); // 金額在 r[5]
      });
  
      const labels = Object.keys(counts);
      const values = Object.values(counts);
      const total = values.reduce((a,b)=>a+b,0);

      html += `<h5>${sec.title}</h5>`;
      html += `<table id="dataTable">
                 <tr>
                   <th>${sec.cmd==="店家"?"店家":sec.cmd==="付款"?"付款方式":sec.cmd==="記帳者"?"記帳者":"分類方式"}</th>
                   <th class="numeric">金額</th>
                   <th class="numeric">佔比</th>
                 </tr>`;
      labels.forEach((l,i)=>{
        const percent = ((values[i]/total)*100).toFixed(1);
        html += `<tr>
                   <td>${l}</td>
                   <td class="numeric">${values[i].toLocaleString()}</td>
                   <td class="numeric">${percent}%</td>
                 </tr>`;
      });
      html += `</table>`;
      html += `<div class="total">📌 總額：${total.toLocaleString()} 元（共 ${labels.length} 筆）</div>`;

      // Pie Chart
      renderChart("pie", labels, values);
    }
  });

  document.getElementById("queryResult").innerHTML = html;

  // 表格排序
  const dataTable = document.getElementById("dataTable");
  if (dataTable) makeTableSortable(dataTable);
}

// 通用表格排序（支援數字/百分比/日期）
function makeTableSortable(table) {
  const headers = table.querySelectorAll("th");
  headers.forEach((th, colIndex)=>{
    th.style.cursor = "pointer";
    th.addEventListener("click", ()=>{
      const rows = Array.from(table.querySelectorAll("tr")).slice(1);
      const currentOrder = th.dataset.order || null;
      const newOrder = currentOrder === "asc" ? "desc" : "asc";
      th.dataset.order = newOrder;
      // reset 標記
      headers.forEach(h=>{
        h.classList.remove("sort-asc","sort-desc");
        h.innerHTML = h.innerHTML.replace(/[\u25B2\u25BC]/g,"");
      });
      th.classList.add(newOrder==="asc"?"sort-asc":"sort-desc");
      th.innerHTML += newOrder==="asc"?" ▲":" ▼";

      rows.sort((a,b)=>{
        let aVal = parseCellValue(a.cells[colIndex].innerText, colIndex);
        let bVal = parseCellValue(b.cells[colIndex].innerText, colIndex);
        if (newOrder==="asc") return aVal>bVal?1:-1;
        else return aVal<bVal?1:-1;
      });
      rows.forEach(r=>table.appendChild(r));
    });
  });
}

// 將欄位文字轉為可比較值
function parseCellValue(txt, colIndex) {
  // ✅ 如果是日期欄（第 2 欄，index=1），轉 Date
  if (colIndex === 1) {
    const d = new Date(txt.replace(/\//g, "-")); // "2025/9/2" → Date
    return d.getTime() || 0;
  }
  // 其他照舊：數字/百分比
  let v = txt.replace(/,/g, "").replace("%", "");
  return isNaN(v) ? txt : parseFloat(v);
}

// 畫圖
function renderChart(type, labels, values) {
  const ctx = document.getElementById("chartCanvas").getContext("2d");

  // ✅ 如果有舊圖表，先銷毀
  if (window.currentChart) {
    window.currentChart.destroy();
    window.currentChart = null;
  }
  
  if (type === "pie") {
    // --- PIE ---
    const backgroundColors = labels.map((_, i) =>
      `hsl(${i * 360 / labels.length}, 70%, 60%)`
    );
    chartInstance = new Chart(ctx, {
      type: "pie",
      data: {
        labels,
        datasets: [{
          data: values,
          backgroundColor: backgroundColors
        }]
      },
      options: { responsive: true ,
      plugins: {
        legend: {
          position: "top",   // ✅ 圖例放上方
          labels: {
            font: {
              size: 30       // ✅ 放大圖例字體
            }
          }
        },
        tooltip: {
          titleFont: { size: 30 },  // ✅ Tooltip 標題字體
          bodyFont: { size: 36 },    // ✅ Tooltip 內容字體
          callbacks: {
            label: function(context) {
              const numberFormat = new Intl.NumberFormat("en-US"); // ✅ 千分位
              const dataset = context.dataset;
              const total = dataset.data.reduce((a, b) => a + b, 0);
              const value = dataset.data[context.dataIndex];
              const percentage = ((value / total) * 100).toFixed(1) + "%";// ✅ 一位小數
              return `${context.label}: ${numberFormat.format(value)} (${percentage})`; 
            }
          }
        }
      }
    }    
    });
  } else if (type === "bar") {
    // --- BAR + LINE ---
    const barValues = values[0] || [];
    const lineValues = values[1] || [];

    // 動態計算 min/max
    let validRates = lineValues.filter(v => !isNaN(v));
    let minRate = Math.min(...validRates);
    let maxRate = Math.max(...validRates);

    // 加 buffer（各 ±1）
    minRate = Math.floor(minRate) - 1;
    maxRate = Math.ceil(maxRate) + 1;

chartInstance = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [
          {
            type: "bar",
            label: "金額合計",
            data: barValues,
            backgroundColor: "rgba(54, 162, 235, 0.6)",
            yAxisID: "y"
          },
          {
            type: "line",
            label: "每日匯率最大值",
            data: lineValues,
            borderColor: "red",       // 線條顏色
            backgroundColor: "red",   // 點的填充顏色
            borderWidth: 2,
            fill: false,              // 不要灰色底
            yAxisID: "y1",
            tension: 0.1,
            pointRadius: 3,
            pointBackgroundColor: "red",  // 點顏色
            pointBorderColor: "red"       // 點邊框顏色            
          }
        ]
      },
      options: {
        responsive: true,
        interaction: { mode: "index", intersect: false },
        plugins: {
          legend: {
            position: "top",   // ✅ 把位置放這裡
            labels: {
              font: {
                size: 30       // ✅ 放大「每日匯率最大值」圖例字體
              }
            }
          },
          tooltip: {
            titleFont: { size: 30 },  // ✅ Tooltip 標題字體
            bodyFont: { size: 36 } ,  // ✅ Tooltip 內容字體
            callbacks: {
              label: function (context) {
                const numberFormat = new Intl.NumberFormat("en-US"); // ✅ 千分位
                // 只處理 bar (金額合計)，line 就照舊
                if (context.dataset.type === "bar") {
                  const dataset = context.dataset.data;
                  const total = dataset.reduce((a, b) => a + b, 0);
                  const value = context.parsed.y;
                  const percentage = ((value / total) * 100).toFixed(1) + "%";
                  return `${context.dataset.label}: ${numberFormat.format(value)} (${percentage})`;
                } else {
                  return `${context.dataset.label}: ${context.parsed.y}`;      
                }
              }
            }
          }
        },
        scales: {
          y: {
            type: "linear",
            position: "left",
            title: { display: true, text: "金額" },
            beginAtZero: true
          },
          y1: {
            type: "linear",
            position: "right",
            title: { display: true, text: "匯率", color: "red" },
            grid: { drawOnChartArea: false },
            min: minRate,
            max: maxRate
          }
        }
      }
    });
  }
}
// ✅ 呼叫初始化
initApp();
</script>
</body>
</html>








