<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>é›¶ç”¨é‡‘æ”¯å‡ºå¸³ç°¿</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script> 
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <!-- PDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  
  <style>
    body { font-family: Arial, sans-serif; padding: 50px; }
    h3 { font-size: 50px; text-align: center; margin-bottom: 50px; }
    .date-inputs { font-size: 50px; text-align: center; margin-bottom: 20px;  }
    .date-inputs input { font-size: 50px; margin: 0 10px;  padding: 5px; }
    h4 { font-size: 36px; text-align: center; margin-bottom: 20px; }
    button { font-size: 40px; margin: 5px; padding: 10px 20px; border-radius: 8px; cursor: pointer; background-color: #0056b3; color: white; }/* è—è‰² */
    .date-btn { font-size: 40px; margin: 5px; padding: 10px 20px; border-radius: 8px; cursor: pointer; background-color: #888; color: white; }/* ç°è‰² */
    .date-btn:hover { background-color: #0056b3; } /* æŒ‰ä¸‹è—è‰² */
    .green-btn { font-size: 40px; margin: 5px; padding: 10px 20px; border-radius: 8px; cursor: pointer; background-color: #28a745; color: white; }/* ç¶ è‰² */
    .green-btn:hover { background-color: #0056b3; } /* æŒ‰ä¸‹è—è‰² */
    #queryResult { margin-top: 1px; }
    h5 { font-size: 28px; margin: 0; padding: 0; }
    table { font-size: 28px; border-collapse: collapse; width: 100%; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    .numeric { text-align: right; }
    .total { font-size: 28px; font-weight: bold; color: #d9534f; margin-top: 10px; }
    canvas { display: block; margin: 20px auto; width: 850px; height: 600px; }
  </style>
</head>
<body>

<h3>ğŸ”é<span style="color: blue;">çœ‹</span><span>/</span><span style="color: green;">åŒ¯</span>ä¸å¯.[<span id="version"></span>]</h3>

<div class="date-inputs">
  é–‹å§‹æ—¥æœŸï¼š<input type="date" id="startDate"><br>
  çµæŸæ—¥æœŸï¼š<input type="date" id="endDate"><br>
  <button id="prevMonthBtn" class="date-btn">ä¸Šæœˆ</button>
  <button id="nextMonthBtn" class="date-btn">ä¸‹æœˆ</button>
  <button id="thisYearBtn" class="date-btn">æ•´å¹´</button>
  <button id="lastYearBtn" class="date-btn">å»å¹´</button>
</div>

<h4>é¸æ“‡æ‚¨æƒ³è¦çœ‹çš„(ç›´çƒå°æ±º)</h4>

<div style="text-align:center">
  <button id="queryMonthBtn">ğŸ“Š æ˜ç´°</button>
  <button id="queryMonthPayBtn">ğŸ’³ ä»˜æ¬¾</button>
  <button id="queryMonthTypeBtn">ğŸ“‚ åˆ†é¡</button>
  <button id="queryMonthStoreBtn">ğŸ“‹ åº—å®¶</button>
  <button id="queryMonthUserBtn">ğŸ‘¤ è¨˜å¸³è€…</button>
</div>

<!-- â³ è¼‰å…¥æç¤ºå€ -->
  <div id="loading" style="display:none; text-align:center; margin:20px;">
    <span style="font-size: 38px;">â³ è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</span>
  </div>

<!-- ğŸ“Š æŸ¥è©¢çµæœé¡¯ç¤ºå€ -->  
<div id="queryResult"></div> 
<canvas id="chartCanvas"></canvas>
  
<!-- âœ… åŒ¯å‡ºæŒ‰éˆ•ç¨ç«‹å€å¡Šï¼ˆå›ºå®šä½ç½®ï¼‰ -->
<div id="exportArea" style="text-align:center; margin-top:10px; display:none;">
  <button id="exportCsvBtn" class="green-btn">ğŸ“¤ åŒ¯å‡ºCSV</button>
  <button id="exportExcelBtn" class="green-btn">ğŸ“¤ åŒ¯å‡ºExcel</button>
  <button id="exportPdfBtn" class="green-btn">ğŸ“„ åŒ¯å‡ºPDF</button>
</div>

<script>
//const LIFF_ID = "2008096451-jPJ50MOY"; // æ›æˆä½ çš„ LIFF ID
//const VERSION = "V17_#43";             // å›ºå®šç‰ˆæ¬¡
//const API_URL = "https://script.google.com/macros/s/AKfycby4mZrwFX52xb7WgBrJIYsG76yvUZkgSadjly-vot-4ajrJ8DV8bemR1EVn_fZKJR_kHA/exec";  // æ›æˆä½ çš„ GAS PATH

//let LIFF_ID = "default";   // å…ˆæ”¾é è¨­æˆ–ç©ºå­—ä¸²,å¾ D12 å¸¶å…¥ query
//let VERSION = "V";      // âœ… é è¨­é¡¯ç¤ºç‰ˆæœ¬è™Ÿï¼Œä¸è¦ç­‰API,å¾ D10 å¸¶å…¥ ç‰ˆ// ----------------------------------------------------
// âœ… è¨­å®š,å…¨åŸŸè¨­å®š
// ----------------------------------------------------
// ğŸ’¡ èªªæ˜ï¼š
// FALLBACK_GAS_SETTINGS_URL æ˜¯ã€Œå•Ÿå‹•ä¿åº•è¨­å®šURLã€ã€‚ç¬¬ä¸€æ¬¡å•Ÿå‹•æ™‚ç”¨å®ƒè®€å–è¨­å®šè¡¨ã€‚æ‰€ä»¥æœªä¾†é‡æ–°éƒ¨ç½² GASï¼Œä¸éœ€ä¿®æ”¹æ­¤è¡Œï¼Œé™¤éè¨­å®šè¡¨å¤±æ•ˆã€‚
// è‹¥è¨­å®šè¡¨å…§æœ‰ D5ï¼ˆSETTINGS_URLï¼‰ï¼Œæœƒè‡ªå‹•æ›´æ–°æˆ D5ã€‚
// æš«æ™‚ç”¨,å¾ŒçºŒæœƒè‡ªå‹•è½‰æ›æˆè¨­å®šæª”å…§çš„å›ºå®š D5ã€‚é€™è¡Œåªæ˜¯å•Ÿå‹•ç”¨çš„è‡¨æ™‚é‘°åŒ™ï¼ŒçœŸçš„é–‹é–€å¾Œæœƒè‡ªå‹•æ›æˆè¨­å®šè¡¨çš„æ­£å¼é‘°åŒ™ã€‚
let FALLBACK_GAS_SETTINGS_URL = "https://script.google.com/macros/s/AKfycby2-1JvsriAfskOJXHyMB8HASeuMs7V-mJOQneD73Q_dJN56NhbWH0Dj8Ldu0LcfxMe/exec";
     
let API_URL = "";    // âœ… å¾è¨­å®šæª” D6
let VERSION = "V";   // âœ… å¾è¨­å®šæª” D10
let LIFF_IDq = "";   // âœ… å¾è¨­å®šæª” D12
let htmlUrl = "";    // âœ… å¾è¨­å®šæª” D14

let currentUser = null; // âœ… å…ˆå®šç¾©è®Šæ•¸ï¼Œä¸è¦ä¸€é–‹å§‹å°±ç”¨ json ç™»å…¥è€…çš„è³‡æ–™
let chartInstance = null;

document.getElementById("version").textContent = VERSION;

// ----------------------------------------------------
// âœ… è¨­å®š,è¨­å®šè¼‰å…¥
// ----------------------------------------------------
async function tryFetchText(url){
  const r = await fetch(url, { cache: 'no-store' });
  const text = await r.text();
  try { const j = JSON.parse(text); return { ok: true, json: j }; }
  catch(e){ return { ok: false, text }; }
}

// ----------------------------------------------------
// âœ… è¨­å®š,å¾è¨­å®šGASè®€å–è¨­å®š
// ----------------------------------------------------
async function loadSettings(){
  // ğŸ”¹ ç›´æ¥ç”¨ fallback è¨­å®š GAS æŸ¥è©¢
  const res = await tryFetchText(FALLBACK_GAS_SETTINGS_URL + "?type=query&command=è¨­å®š");
  if (!res.ok) throw new Error("è¨­å®š GAS è®€å–å¤±æ•—ï¼š" + res.text);
    
  const data = res.json;
  if (!data.ok || !data.data) throw new Error("è¨­å®šæ ¼å¼éŒ¯èª¤");
    
  return data.data;  // åªå›å‚³ data
}
  
// ----------------------------------------------------
// âœ… è¨­å®š,åˆå§‹åŒ–
// ----------------------------------------------------
async function initApp(){
  try {
    const settings = await loadSettings();
    if (!settings) throw new Error("è¨­å®šæ ¼å¼éŒ¯èª¤");
       
    // ğŸ”¹ å¾è¨­å®šå¸¶å…¥
    FALLBACK_GAS_SETTINGS_URL = (settings.SETTINGS_URL || FALLBACK_GAS_SETTINGS_URL).trim();// è‡ªå‹•è½‰æ›æˆè¨­å®šæª”å…§çš„å›ºå®š D5
    API_URL = (settings.API_URL || "").trim();
    VERSION = (settings.D10 || "V").trim();
    LIFF_IDq = (settings.D12 || "").trim();
    htmlUrl = (settings.D14 || "").trim();
    
    document.getElementById("version").textContent = VERSION;
    console.log("âœ… è¨­å®šæˆåŠŸ:", { FALLBACK_GAS_SETTINGS_URL, API_URL, LIFF_IDq, htmlUrl, VERSION });
    
    if (!LIFF_IDq) throw new Error("âŒ LIFF ID å°šæœªè¨­å®šï¼Œè«‹ç¢ºèªè¨­å®šè¡¨ D12");
    if (!htmlUrl) throw new Error("âŒ HTML Url å°šæœªè¨­å®šï¼Œè«‹ç¢ºèªè¨­å®šè¡¨ D14");
    
    await liff.init({ liffId: LIFF_IDq });
    if (!liff.isLoggedIn()) liff.login();
    
    // æŠ“ä½¿ç”¨è€… LINE åç¨±
    try {
      const profile = await liff.getProfile();
      currentUser = profile.displayName;
      console.log("ç™»å…¥ä½¿ç”¨è€…:", currentUser);
    } catch (e) {
      console.warn("æŠ“ä¸åˆ° LINE åç¨±ï¼Œæœƒæ”¹ç”¨è³‡æ–™è¡¨ç¬¬ä¸€ç­†:", e);
    }

    // æ—¥æœŸå€é–“åˆå§‹åŒ–
    setDefaultDateRange();

    // å…¶ä»–é‚è¼¯ï¼ˆä¾‹å¦‚ç¹ªåœ–æˆ–æŸ¥è©¢ï¼‰
    if (API_URL) {
      console.log("ğŸ“¡ å·²é€£ç·šåˆ° API_URL:", API_URL);
      // await loadChartData();
    }
    
  } catch (err) {
    console.error("åˆå§‹åŒ–è¨­å®šå¤±æ•—ï¼š", err);
    alert("åˆå§‹åŒ–è¨­å®šå¤±æ•—ï¼š" + err.message);
  }
}

// è¨­å®šé è¨­æ—¥æœŸç‚ºæœ¬æœˆæœˆåˆèˆ‡æœˆåº•
function setDefaultDateRange() {
  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth(), 1);
  const end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
  document.getElementById("startDate").value = toInputDate(start);
  document.getElementById("endDate").value = toInputDate(end);
}

function toInputDate(d) {
  const m = (d.getMonth() + 1).toString().padStart(2, "0");
  const day = d.getDate().toString().padStart(2, "0");
  return `${d.getFullYear()}-${m}-${day}`;
}
  
// ğŸ“… æ—¥æœŸåˆ‡æ›åŠŸèƒ½
const startInput = document.getElementById("startDate");
const endInput = document.getElementById("endDate");

function setDateRange(start, end) {
  startInput.value = toInputDate(start);
  endInput.value = toInputDate(end);
}

// ğŸ“… ä¸Šæœˆ
document.getElementById("prevMonthBtn").addEventListener("click", () => {
  const base = startInput.value ? new Date(startInput.value) : new Date();
  const year = base.getFullYear();
  const month = base.getMonth(); // 0~11

  const start = new Date(year, month - 1, 1);
  const end = new Date(year, month, 0);
  setDateRange(start, end);
});

// ğŸ“… ä¸‹æœˆ
document.getElementById("nextMonthBtn").addEventListener("click", () => {
  const base = startInput.value ? new Date(startInput.value) : new Date();
  const year = base.getFullYear();
  const month = base.getMonth();

  const start = new Date(year, month + 1, 1);
  const end = new Date(year, month + 2, 0);
  setDateRange(start, end);
});

// ğŸ“… å»å¹´
document.getElementById("lastYearBtn").addEventListener("click", () => {
  const base = startInput.value ? new Date(startInput.value) : new Date();
  const year = base.getFullYear() - 1;

  const start = new Date(year, 0, 1);
  const end = new Date(year, 11, 31);
  setDateRange(start, end);
});

// ğŸ“… ä»Šå¹´
document.getElementById("thisYearBtn").addEventListener("click", () => {
  const base = startInput.value ? new Date(startInput.value) : new Date();
  const year = base.getFullYear();

  const start = new Date(year, 0, 1);
  const end = new Date(year, 11, 31);
  setDateRange(start, end);
});
  
// æŒ‰éˆ•äº‹ä»¶
document.getElementById("queryMonthBtn").addEventListener("click", () => sendQuery("æ˜ç´°"));
document.getElementById("queryMonthTypeBtn").addEventListener("click", () => sendQuery("åˆ†é¡"));
document.getElementById("queryMonthPayBtn").addEventListener("click", () => sendQuery("ä»˜æ¬¾"));
document.getElementById("queryMonthStoreBtn").addEventListener("click", () => sendQuery("åº—å®¶"));
document.getElementById("queryMonthUserBtn").addEventListener("click", () => sendQuery("è¨˜å¸³è€…"));

// ç™¼é€æŸ¥è©¢
async function sendQuery(command) {
  const startDate = document.getElementById("startDate").value;
  const endDate = document.getElementById("endDate").value;
  
  if (!startDate || !endDate) {
    alert("è«‹é¸æ“‡é–‹å§‹èˆ‡çµæŸæ—¥æœŸ");
    return;
  }
  
    // âœ… æŸ¥è©¢å‰æ¸…ç©ºèˆŠçš„æŸ¥è©¢çµæœ
    document.getElementById("queryResult").innerHTML = "";

    // âœ… éš±è—åŒ¯å‡ºæŒ‰éˆ•ï¼Œé¿å…èˆŠæŒ‰éˆ•é–ƒç¾
    document.getElementById("exportArea").style.display = "none";
  
    // âœ… å¦‚æœæœ‰èˆŠåœ–è¡¨ï¼ŒéŠ·æ¯€æ‰
    if (chartInstance) {
      chartInstance.destroy();
      chartInstance = null;
    }
    const ctx = document.getElementById("chartCanvas").getContext("2d");
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
  
    // âœ… é¡¯ç¤ºè¼‰å…¥ä¸­
    document.getElementById("loading").style.display = "block";
    
    const body = {
      type: "query",
      command: command,
      version: VERSION,
      startDate: startDate + " 00:00:00",
      endDate: endDate + " 23:59:59"
    };
 
    try {
      const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(body) });
      const json = await res.json();
      if (!json.ok) {
        document.getElementById("queryResult").innerHTML = `<p style="color:red">âŒ æŸ¥è©¢å¤±æ•—</p>`;
        return;
      }
      renderResult(command, json);
    } catch (err) {
      document.getElementById("queryResult").innerHTML = `<p style="color:red">âŒ æŸ¥è©¢å¤±æ•—ï¼š${err.message}</p>`;
    } finally {
      // âœ… æŸ¥è©¢çµæŸå¾Œéš±è—
      document.getElementById("loading").style.display = "none";
    }
  } // âœ… sendQuery() çµæŸ

// é¡¯ç¤ºçµæœè¡¨æ ¼èˆ‡åœ–è¡¨
function renderResult(command, json) {
  let html = "";

  const adminUser = "Betty Yi"; // âœ… ç®¡ç†è€…å¸³è™Ÿ
  
  // âœ… å¦‚æœ currentUser é‚„æ²’å®šç¾©ï¼Œå°±ç”¨è³‡æ–™è¡¨ç¬¬ä¸€ç­† ç™»å…¥è€…çš„è³‡æ–™
  if (!currentUser && json.rows && json.rows.length > 0) {
    currentUser = json.rows[0][3];  // ç¬¬ 4 æ¬„æ˜¯ display_name
  }

  // âœ… çµ±ä¸€éæ¿¾ï¼šç®¡ç†è€…çœ‹åˆ°å…¨éƒ¨ï¼Œå…¶å®ƒäººåªçœ‹è‡ªå·±
  let filteredRows = json.rows || [];
  if (currentUser && currentUser !== adminUser) {
    filteredRows = filteredRows.filter(r => r[3] === currentUser);
  }
  
  if (command === "æ˜ç´°" && json.rows) {
    // âœ… é€™è£¡ä¸è¦é‡æ–°å®šç¾© filteredRowsï¼Œç›´æ¥ç”¨å‰é¢å·²ç¶“è™•ç†å¥½çš„
    const rowsForDisplay = (currentUser === adminUser) ? json.rows : filteredRows;
    
    html += `<h5>ğŸ“Š é¸æ“‡æŸ¥è©¢æ˜ç´°;æ¨™é¡ŒæŒ‰ä¸‹å³å¯æ’åº</h5>`;
    html += `<table id="dataTable">
              <tr>
                <th>è¨˜å¸³è€…</th>
                <th>æ—¥æœŸ</th>
                <th>åº—å®¶</th>
                <th class="numeric">æ”¶å…¥</th>
                <th class="numeric">æ”¯å‡º</th>
                <th>åŒ¯ç‡</th>
                <th class="numeric">é‡‘é¡</th>
                <th>ä»˜æ¬¾</th>
                <th>åˆ†é¡</th>
                <th>é™„è¨»</th>
                <th>å‚™è¨»</th>
                <th>å¹£åˆ¥</th>
              </tr>`;

    // âœ… è¡¨æ ¼è³‡æ–™åªè¼¸å‡º rowsForDisplay
    rowsForDisplay.forEach(r => {
      const dateStr = r[4] ? new Date(r[4]).toLocaleDateString("zh-TW") : "";
      html += `<tr>
                <td>${r[3]}</td>
                <td>${dateStr}</td>
                <td>${r[8]}</td>
                <td class="numeric">
                  ${Number(r[11]).toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                  </td>
                <td class="numeric">
                  ${Number(r[12]).toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                  </td>
                <td>${r[13]}</td>
                <td class="numeric">${Number(r[5]).toLocaleString()}</td>
                <td>${r[7]}</td>
                <td>${r[6]}</td>
                <td>${r[9]}</td>
                <td>${r[10]}</td>
                <td>${r[14]}</td>
      </tr>`;
    });
    html += `</table>`;
  
    // âœ… ç¸½é¡ & ç­†æ•¸åŒæ¨£ç”¨ rowsForDisplay
    const totalAmount = rowsForDisplay.reduce((sum, r) => sum + Number(r[5] || 0), 0);
    html += `<div class="total">ğŸ“Œ ç¸½é¡ï¼š${totalAmount.toLocaleString()} å…ƒï¼ˆå…± ${rowsForDisplay.length} ç­†ï¼‰</div>`;

    // é•·æ¢åœ–è³‡æ–™ï¼šé‡‘é¡ç¸½å’Œ + å¹£åˆ¥æœ€å¤§å€¼
    const dateSum = {};
    const maxCurrencyByDate = {};
    rowsForDisplay.forEach(r => {
      const d = new Date(r[4]).toLocaleDateString("zh-TW");
      const amount = Number(r[5]);
      const currency = Number(r[13]);

      dateSum[d] = (dateSum[d] || 0) + amount;
      if (!maxCurrencyByDate[d] || currency > maxCurrencyByDate[d]) {
        maxCurrencyByDate[d] = currency;
      }
    });

    const sortedDates = Object.keys(dateSum).sort((a,b)=> new Date(a)-new Date(b));
    const sumValues = sortedDates.map(d=> dateSum[d]);
    const currencyValues = sortedDates.map(d=> maxCurrencyByDate[d] || 0);

    renderChart("bar", sortedDates, [sumValues, currencyValues]);
  }

  // åˆ†é¡ã€ä»˜æ¬¾ã€åº—å®¶ã€è¨˜å¸³è€…
  const sections = [
    { cmd: "åˆ†é¡", key: 6, title: "ğŸ“‚ é¸æ“‡åˆ†é¡çµ±è¨ˆ;æ¨™é¡ŒæŒ‰ä¸‹å³å¯æ’åº" },
    { cmd: "ä»˜æ¬¾", key: 7, title: "ğŸ’³ é¸æ“‡ä»˜æ¬¾çµ±è¨ˆ;æ¨™é¡ŒæŒ‰ä¸‹å³å¯æ’åº" },
    { cmd: "åº—å®¶", key: 8, title: "ğŸ“‹ é¸æ“‡åº—å®¶çµ±è¨ˆ;æ¨™é¡ŒæŒ‰ä¸‹å³å¯æ’åº" },
    { cmd: "è¨˜å¸³è€…", key: 3, title: "ğŸ‘¤ é¸æ“‡è¨˜å¸³è€…çµ±è¨ˆ;æ¨™é¡ŒæŒ‰ä¸‹å³å¯æ’åº" }
  ];

  sections.forEach(sec => {
    if (command === sec.cmd) {
      
      // âœ… ç®¡ç†å“¡ç”¨å…¨éƒ¨è³‡æ–™ï¼Œä¸€èˆ¬ä½¿ç”¨è€…æ‰éæ¿¾
      const rowsForCalc = (currentUser === adminUser)
        ? json.rows
        : (json.rows ? json.rows.filter(r => r[3] === currentUser) : []);
      
      // ä¾ filteredRows è¨ˆç®—çµ±è¨ˆ
      const counts = {};
      filteredRows.forEach(r => {
        const value = r[sec.key] || "æœªçŸ¥";
        counts[value] = (counts[value] || 0) + Number(r[5] || 0); // é‡‘é¡åœ¨ r[5]
      });
  
      const labels = Object.keys(counts);
      const values = Object.values(counts);
      const total = values.reduce((a,b)=>a+b,0);

      html += `<h5>${sec.title}</h5>`;
      html += `<table id="dataTable">
                 <tr>
                   <th>${sec.cmd==="åº—å®¶"?"åº—å®¶":sec.cmd==="ä»˜æ¬¾"?"ä»˜æ¬¾æ–¹å¼":sec.cmd==="è¨˜å¸³è€…"?"è¨˜å¸³è€…":"åˆ†é¡æ–¹å¼"}</th>
                   <th class="numeric">é‡‘é¡</th>
                   <th class="numeric">ä½”æ¯”</th>
                 </tr>`;
      labels.forEach((l,i)=>{
        const percent = ((values[i]/total)*100).toFixed(1);
        html += `<tr>
                   <td>${l}</td>
                   <td class="numeric">${values[i].toLocaleString()}</td>
                   <td class="numeric">${percent}%</td>
                 </tr>`;
      });
      html += `</table>`;
      html += `<div class="total">ğŸ“Œ ç¸½é¡ï¼š${total.toLocaleString()} å…ƒï¼ˆå…± ${labels.length} ç­†ï¼‰</div>`;

      // Pie Chart
      renderChart("pie", labels, values);
    }
  });

  document.getElementById("queryResult").innerHTML = html;

  // âœ… è‹¥æ˜¯æ˜ç´°.ä»˜æ¬¾.åˆ†é¡æŸ¥è©¢ï¼Œä¾æ¸…å–®é †åºæ’åºä»˜æ¬¾èˆ‡åˆ†é¡
  if (command === "æ˜ç´°" || command === "ä»˜æ¬¾" || command === "åˆ†é¡") {
    fetch(API_URL + "?type=query&command=æ¸…å–®")
      .then(r => r.json())
      .then(res => {
        const list = res.list || {};
        const paymentOrder = (list.payment || []).map(p => p.name);
        const typeOrder = (list.type || []).map(t => t.name);
  
        const dataTable = document.getElementById("dataTable");
        if (dataTable) {
          makeTableSortable(dataTable, { paymentOrder, typeOrder });
        }
      })
      .catch(err => console.error("æ¸…å–®æ’åºè¼‰å…¥å¤±æ•—:", err));
  } else {
    const dataTable = document.getElementById("dataTable");
    if (dataTable) makeTableSortable(dataTable);
  }
  
  // âœ… æŸ¥è©¢å®Œæˆå¾Œé¡¯ç¤ºåŒ¯å‡ºæŒ‰éˆ•
  document.getElementById("exportArea").style.display = "block";
}

// âœ… é€šç”¨è¡¨æ ¼æ’åºï¼ˆæ”¯æ´å¤–éƒ¨é †åºã€æ•¸å­—ã€ç™¾åˆ†æ¯”ã€æ—¥æœŸï¼‰
function makeTableSortable(table, orderMaps = {}) {
  const headers = table.querySelectorAll("th");

  // ğŸ”¹ è‡ªå‹•æ‰¾å‡ºæ¬„ä½ç´¢å¼•ï¼ˆé¿å…ç¡¬ç·¨ colIndexï¼‰
  let paymentCol = -1, typeCol = -1, dateCol = -1;
  headers.forEach((th, i) => {
    const text = th.innerText.trim();
    if (text.includes("ä»˜æ¬¾")) paymentCol = i;
    if (text.includes("åˆ†é¡")) typeCol = i;
    if (text.includes("æ—¥æœŸ")) dateCol = i;
  });

  headers.forEach((th, colIndex) => {
    th.style.cursor = "pointer";
    th.addEventListener("click", () => {
      const rows = Array.from(table.querySelectorAll("tr")).slice(1);
      const currentOrder = th.dataset.order || null;
      const newOrder = currentOrder === "asc" ? "desc" : "asc";
      th.dataset.order = newOrder;

      // reset æ¨™è¨˜
      headers.forEach(h => {
        h.classList.remove("sort-asc", "sort-desc");
        h.innerHTML = h.innerHTML.replace(/[\u25B2\u25BC]/g, "");
      });
      th.classList.add(newOrder === "asc" ? "sort-asc" : "sort-desc");
      th.innerHTML += newOrder === "asc" ? " â–²" : " â–¼";

      // æ’åºé‚è¼¯
      rows.sort((a, b) => {
        const aVal = parseCellValue(a.cells[colIndex]?.innerText || "", colIndex, {
          paymentCol,
          typeCol,
          dateCol,
          ...orderMaps
        });
        const bVal = parseCellValue(b.cells[colIndex]?.innerText || "", colIndex, {
          paymentCol,
          typeCol,
          dateCol,
          ...orderMaps
        });

        if (aVal === bVal) return 0;
        if (newOrder === "asc") return aVal > bVal ? 1 : -1;
        else return aVal < bVal ? 1 : -1;
      });
      rows.forEach(r => table.appendChild(r));
    });
  });
}

// âœ… å°‡æ¬„ä½æ–‡å­—è½‰ç‚ºå¯æ¯”è¼ƒå€¼ï¼ˆå«ä»˜æ¬¾ / åˆ†é¡çš„é †åºè¡¨ï¼‰
function parseCellValue(txt, colIndex, map) {
  txt = txt.trim();

  // ğŸ”¹ æ—¥æœŸæ¬„ä½
  if (colIndex === map.dateCol) {
    const d = new Date(txt.replace(/\//g, "-"));
    return d.getTime() || 0;
  }

  // ğŸ”¹ ä»˜æ¬¾æ¬„ä½ï¼ˆä¾æ¸…å–®é †åºï¼‰
  if (colIndex === map.paymentCol && map.paymentOrder?.length) {
    const idx = map.paymentOrder.indexOf(txt);
    return idx !== -1 ? idx : 999;
  }

  // ğŸ”¹ åˆ†é¡æ¬„ä½ï¼ˆä¾æ¸…å–®é †åºï¼‰
  if (colIndex === map.typeCol && map.typeOrder?.length) {
    const idx = map.typeOrder.indexOf(txt);
    return idx !== -1 ? idx : 999;
  }

  // ğŸ”¹ å…¶ä»–æ¬„ä½ï¼šè‹¥ç‚ºæ•¸å­—/ç™¾åˆ†æ¯”å‰‡è½‰æ•¸å€¼
  const v = txt.replace(/,/g, "").replace("%", "");
  return isNaN(v) ? txt : parseFloat(v);
}
  
// ç•«åœ–
function renderChart(type, labels, values) {
  const ctx = document.getElementById("chartCanvas").getContext("2d");

  // âœ… å¦‚æœæœ‰èˆŠåœ–è¡¨ï¼Œå…ˆéŠ·æ¯€
  if (window.currentChart) {
    window.currentChart.destroy();
    window.currentChart = null;
  }
  
  if (type === "pie") {
    // --- PIE ---
    // âœ… ä¾é‡‘é¡ç”±å¤§åˆ°å°æ’åºï¼ˆæœƒå½±éŸ¿æ‰‡å½¢èˆ‡åœ–ä¾‹é¡¯ç¤ºé †åºï¼‰
    const dataPairs = labels.map((label, i) => ({
      label,
      value: values[i]
    }));
    dataPairs.sort((a, b) => a.value - b.value); // <-- é‡é»ï¼šè² æ•¸å°çš„æ’å‰é¢
    labels = dataPairs.map(d => d.label);
    values = dataPairs.map(d => d.value);
    
    const backgroundColors = labels.map((_, i) =>
      `hsl(${i * 360 / labels.length}, 70%, 60%)`
    );
    chartInstance = new Chart(ctx, {
      type: "pie",
      data: {
        labels,
        datasets: [{
          data: values,
          backgroundColor: backgroundColors
        }]
      },
      options: { responsive: true ,
      plugins: {
        legend: {
          position: "top",   // âœ… åœ–ä¾‹æ”¾ä¸Šæ–¹
          labels: {
            font: {
              size: 30       // âœ… æ”¾å¤§åœ–ä¾‹å­—é«”
            }
          }
        },
        tooltip: {
          titleFont: { size: 30 },  // âœ… Tooltip æ¨™é¡Œå­—é«”
          bodyFont: { size: 36 },    // âœ… Tooltip å…§å®¹å­—é«”
          callbacks: {
            label: function(context) {
              const numberFormat = new Intl.NumberFormat("en-US"); // âœ… åƒåˆ†ä½
              const dataset = context.dataset;
              const total = dataset.data.reduce((a, b) => a + b, 0);
              const value = dataset.data[context.dataIndex];
              const percentage = ((value / total) * 100).toFixed(1) + "%";// âœ… ä¸€ä½å°æ•¸
              return `${context.label}: ${numberFormat.format(value)} (${percentage})`; 
            }
          }
        }
      }
    }    
    });
  } else if (type === "bar") {
    // --- BAR + LINE ---
    const barValues = values[0] || [];
    const lineValues = values[1] || [];

    // å‹•æ…‹è¨ˆç®— min/max
    let validRates = lineValues.filter(v => !isNaN(v));
    let minRate = Math.min(...validRates);
    let maxRate = Math.max(...validRates);

    // åŠ  bufferï¼ˆå„ Â±1ï¼‰
    minRate = Math.floor(minRate) - 1;
    maxRate = Math.ceil(maxRate) + 1;

chartInstance = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [
          {
            type: "bar",
            label: "é‡‘é¡åˆè¨ˆ",
            data: barValues,
            backgroundColor: "rgba(54, 162, 235, 0.6)",
            yAxisID: "y"
          },
          {
            type: "line",
            label: "æ¯æ—¥åŒ¯ç‡æœ€å¤§å€¼",
            data: lineValues,
            borderColor: "red",       // ç·šæ¢é¡è‰²
            backgroundColor: "red",   // é»çš„å¡«å……é¡è‰²
            borderWidth: 2,
            fill: false,              // ä¸è¦ç°è‰²åº•
            yAxisID: "y1",
            tension: 0.1,
            pointRadius: 3,
            pointBackgroundColor: "red",  // é»é¡è‰²
            pointBorderColor: "red"       // é»é‚Šæ¡†é¡è‰²            
          }
        ]
      },
      options: {
        responsive: true,
        interaction: { mode: "index", intersect: false },
        plugins: {
          legend: {
            position: "top",   // âœ… æŠŠä½ç½®æ”¾é€™è£¡
            labels: {
              font: {
                size: 30       // âœ… æ”¾å¤§ã€Œæ¯æ—¥åŒ¯ç‡æœ€å¤§å€¼ã€åœ–ä¾‹å­—é«”
              }
            }
          },
          tooltip: {
            titleFont: { size: 30 },  // âœ… Tooltip æ¨™é¡Œå­—é«”
            bodyFont: { size: 36 } ,  // âœ… Tooltip å…§å®¹å­—é«”
            callbacks: {
              label: function (context) {
                const numberFormat = new Intl.NumberFormat("en-US"); // âœ… åƒåˆ†ä½
                // åªè™•ç† bar (é‡‘é¡åˆè¨ˆ)ï¼Œline å°±ç…§èˆŠ
                if (context.dataset.type === "bar") {
                  const dataset = context.dataset.data;
                  const total = dataset.reduce((a, b) => a + b, 0);
                  const value = context.parsed.y;
                  const percentage = ((value / total) * 100).toFixed(1) + "%";
                  return `${context.dataset.label}: ${numberFormat.format(value)} (${percentage})`;
                } else {
                  return `${context.dataset.label}: ${context.parsed.y}`;      
                }
              }
            }
          }
        },
        scales: {
          y: {
            type: "linear",
            position: "left",
            title: { display: true, text: "é‡‘é¡" },
            beginAtZero: true
          },
          y1: {
            type: "linear",
            position: "right",
            title: { display: true, text: "åŒ¯ç‡", color: "red" },
            grid: { drawOnChartArea: false },
            min: minRate,
            max: maxRate
          }
        }
      }
    });
  }
}

    // âœ… åŒ¯å‡º CSV åŠŸèƒ½
    document.getElementById("exportCsvBtn").addEventListener("click", async () => {
    const queryDiv = document.getElementById("queryResult");
    if (!queryDiv || queryDiv.innerHTML.trim() === "") {
      alert("ç›®å‰æ²’æœ‰æŸ¥è©¢çµæœ");
      return;
    }
  
    try {
      const tables = queryDiv.querySelectorAll("table");
      if (!tables.length) {
        alert("æ²’æœ‰è¡¨æ ¼å¯ä»¥åŒ¯å‡º");
        return;
      }
  
      let csvContent = "";

      // æ—¥æœŸå€é–“
      const startDate = (document.getElementById("startDate")?.value || "unknown").replace(/-/g, "/");
      const endDate = (document.getElementById("endDate")?.value || "unknown").replace(/-/g, "/");
      const dateRange = `ğŸ“… æ—¥æœŸå€é–“ï¼š${startDate} ~ ${endDate}`;

      let lastTitle = "å ±è¡¨";
      
      tables.forEach((table, idx) => {
        // ğŸ”¹ æŠ“å–æ¨™é¡Œï¼ˆh5ï¼‰
        let rawTitle = table.previousElementSibling && table.previousElementSibling.tagName === "H5"
          ? table.previousElementSibling.textContent
          : `å·¥ä½œè¡¨${idx + 1}`;
        let titleText = rawTitle.split(";")[0].trim();

        // ğŸ”¹ CSV å…§å®¹ä½¿ç”¨åŸå§‹æ¨™é¡Œï¼ˆä¿ç•™ emojiï¼‰
        let csvTitleText = titleText;
  
        // ğŸ”¹ ç§»é™¤ emojiã€ç©ºç™½ã€"é¸æ“‡" ç­‰å­—
        titleText = titleText
          .replace(/^é¸æ“‡/, "")
          .replace(/æŸ¥è©¢$/, "")
          .replace(/[\p{Emoji_Presentation}\p{Extended_Pictographic}]/gu, "")
          .replace(/\s+/g, "")
          .trim();
  
        lastTitle = titleText || lastTitle;

      // ğŸ”¹ æŠ“å–ç¸½é¡è³‡è¨Šï¼ˆè‹¥æœ‰ .total å…ƒç´ ï¼‰
        const totalElement = table.nextElementSibling && table.nextElementSibling.classList.contains("total")
          ? table.nextElementSibling.textContent.trim()
          : "";
  
        // âœ… åŒ¯å‡ºè¡¨é ­è³‡è¨Š
        csvContent += `"${dateRange}"\r\n`;
        csvContent += `"${csvTitleText}"\r\n`; // â† ä¿ç•™ emoji
        if (totalElement) csvContent += `"${totalElement}"\r\n`;
  
        // âœ… åŒ¯å‡ºè¡¨æ ¼è³‡æ–™
        Array.from(table.rows).forEach(row => {
          const rowData = Array.from(row.cells).map(cell => {
            return `"${cell.textContent.trim().replace(/"/g, '""')}"`;
          }).join(",");
          csvContent += rowData + "\r\n";
        });
  
        // ğŸ”¹ å¤šè¡¨æ ¼é–“åŠ ç©ºç™½è¡Œ
        if (idx < tables.length - 1) csvContent += "\r\n";
      });
  
      // æª”å
      const now = new Date();
      const hh = String(now.getHours()).padStart(2, "0");
      const mm = String(now.getMinutes()).padStart(2, "0");
      const ss = String(now.getSeconds()).padStart(2, "0");
      const startDateInput = document.getElementById("startDate")?.value || "unknown";
      const filename = `éåŒ¯ä¸å¯CSV_${lastTitle}_${startDateInput}-${hh}-${mm}-${ss}.csv`;
  
      // âœ… åˆ¤æ–·æ˜¯å¦åœ¨ LINE å…§å»ºç€è¦½å™¨
      if (liff.isInClient()) {
        // é€é LIFF å‚³è¨Šæ¯çµ¦è‡ªå·±
        await liff.sendMessages([{
          type: "text",
          text: `ğŸ“„ CSV æª”æ¡ˆã€Œ${filename}ã€å…§å®¹:\n\n${csvContent}`
        }]);
        alert("âœ… CSV å·²é€é LINE å‚³é€åœ¨èŠå¤©å…§ï¼Œè«‹åœ¨ LINE æŸ¥çœ‹");
      } else {
        // ä¸€èˆ¬ç€è¦½å™¨ä¸‹è¼‰
        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
  
    } catch (err) {
      console.error("âŒ åŒ¯å‡º CSV ç™¼ç”ŸéŒ¯èª¤:", err);
      alert("åŒ¯å‡º CSV å¤±æ•—ï¼š" + (err.message || "æœªå®šç¾©éŒ¯èª¤"));
    }
  });
  
    // âœ… åŒ¯å‡º Excel åŠŸèƒ½
    document.getElementById("exportExcelBtn").addEventListener("click", exportExcel);
    
    async function exportExcel() {
      const queryDiv = document.getElementById("queryResult");
      if (!queryDiv) return alert("ç›®å‰æ²’æœ‰æŸ¥è©¢çµæœ");
    
      const tables = queryDiv.querySelectorAll("table");
      if (tables.length === 0) return alert("æ²’æœ‰å¯åŒ¯å‡ºçš„è¡¨æ ¼");
    
      const wb = XLSX.utils.book_new();
      let lastTitle = "å ±è¡¨";
    
      tables.forEach((table, idx) => {
        const startDate = (document.getElementById("startDate").value || "unknown").replace(/-/g, "/");
        const endDate = (document.getElementById("endDate").value || "unknown").replace(/-/g, "/");
        const dateRange = `ğŸ“… æ—¥æœŸå€é–“ï¼š${startDate} ~ ${endDate}`;
    
        // å–å¾—åŸå§‹æ¨™é¡Œ
        let rawTitle = table.previousElementSibling && table.previousElementSibling.tagName === "H5"
          ? table.previousElementSibling.textContent
          : `å·¥ä½œè¡¨${idx + 1}`;
        let titleElement = rawTitle.split(";")[0].trim();
    
        // â¶ Excel å…§å®¹ä¿ç•™ç¬¦è™Ÿ
        const titleForExcel = titleElement
          .replace(/^é¸æ“‡/, "")
          .replace(/æŸ¥è©¢$/, "")
          .trim();
    
        // â· æª”åèˆ‡å·¥ä½œè¡¨åç¨±ç§»é™¤ç¬¦è™Ÿèˆ‡ emoji
        const titleForFile = titleForExcel
          .replace(/[\p{Emoji_Presentation}\p{Extended_Pictographic}]/gu, "")
          .replace(/\s+/g, "")
          .trim() || `å·¥ä½œè¡¨${idx + 1}`;
    
        lastTitle = titleForFile || lastTitle;
    
        const totalElement = table.nextElementSibling && table.nextElementSibling.classList.contains("total")
          ? table.nextElementSibling.textContent
          : "";
    
        const wsData = [];
        wsData.push([dateRange]);
        wsData.push([titleForExcel]);  // ç¬¬äºŒè¡Œä¿ç•™ç¬¦è™Ÿ
        wsData.push([totalElement]);
    
        const headers = Array.from(table.querySelectorAll("th")).map(th => th.innerText.trim());
        wsData.push(headers);
    
        const rows = Array.from(table.querySelectorAll("tr")).slice(1);
        rows.forEach(row => {
          const rowData = Array.from(row.querySelectorAll("td")).map(td => {
            let text = td.innerText.trim();
            if (/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(text)) {
              const [y, m, d] = text.split("/");
              const mm = m.padStart(2, "0");
              const dd = d.padStart(2, "0");
              text = `${y}/${mm}/${dd}`;
            }
            return text;
          });
          wsData.push(rowData);
        });
    
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        XLSX.utils.book_append_sheet(wb, ws, titleForFile.substring(0, 20));
      });
    
      // ğŸ”¹ æª”å
      const now = new Date();
      const hh = String(now.getHours()).padStart(2, "0");
      const min = String(now.getMinutes()).padStart(2, "0");
      const ss = String(now.getSeconds()).padStart(2, "0");
    
      const startDate = document.getElementById("startDate").value || "unknown";
      const timestamp = `${startDate}-${hh}-${min}-${ss}`;
      const filename = `éåŒ¯ä¸å¯EXCEL_${lastTitle}_${timestamp}.xlsx`;
    
      try {
        if (liff.isInClient()) {
          // ğŸ”¹ LINE å…§åµŒç€è¦½å™¨ï¼šç™¼é€é€£çµè¨Šæ¯
          await liff.sendMessages([
            {
              type: "text",
              text: `${htmlUrl}`
            }
          ]);
          alert(`LINE å…§å»ºç€è¦½å™¨ç„¡æ³•ä¸‹è¼‰ï¼Œç¶²å€å·²åœ¨è¨Šæ¯å…§ï¼Œè«‹è‡ªè¡Œå°‡ç¶²å€COPYè²¼åœ¨æµè¦½å™¨ä¸Šä½¿ç”¨æ­¤åŠŸèƒ½`)
        } else {
          // ğŸ”¹ ä¸€èˆ¬ç€è¦½å™¨ï¼šç›´æ¥ä¸‹è¼‰
          XLSX.writeFile(wb, filename);
        }
      } catch (err) {
        console.error("âŒ åŒ¯å‡º Excel ç™¼ç”ŸéŒ¯èª¤:", err);
        alert("åŒ¯å‡º Excel å¤±æ•—ï¼š" + (err.message || "æœªå®šç¾©éŒ¯èª¤"));
      }
    }
  
    // âœ… åŒ¯å‡º PDFï¼ˆåŒ…å«è¡¨æ ¼ + åœ–è¡¨ + æ©«å¼A4 + è¡¨æ ¼åŠåœ–è¡¨å„è‡ªä¸€é  + å¯è‡ªè¨‚æ–‡å­—å¤§å°ï¼‰
    document.getElementById("exportPdfBtn").addEventListener("click", async () => {
      const { jsPDF } = window.jspdf;
      const queryDiv = document.getElementById("queryResult");
      const chartCanvas = document.getElementById("chartCanvas");
      const fontSize = 14; // è¡¨æ ¼æ–‡å­—å¤§å°
      const headerFontSize = 24; // æ¨™é¡Œèˆ‡æ—¥æœŸå€é–“å­—é«”å¤§å°
    
      if (!queryDiv || queryDiv.innerHTML.trim() === "") {
        alert("ç›®å‰æ²’æœ‰æŸ¥è©¢çµæœ");
        return;
      }
    
      try {
        const pdf = new jsPDF({ orientation: "landscape", unit: "pt", format: "a4" });
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const margin = 20;
    
        // === å–å¾—æ—¥æœŸå€é–“ ===
        const startDateInput = document.getElementById("startDate")?.value || "";
        const endDateInput = document.getElementById("endDate")?.value || "";

        // ç”¨æ–¼ PDF å…§æ–‡é¡¯ç¤ºï¼ˆç”¨ /ï¼‰
        const displayStartDate = startDateInput ? startDateInput.replaceAll("-", "/") : "";
        const displayEndDate = endDateInput ? endDateInput.replaceAll("-", "/") : "";
    
        // ç”¨æ–¼æª”åï¼ˆç”¨ -ï¼‰
        const fileDate = startDateInput || "unknown";
          
        // === å–å¾—è¡¨æ ¼æ¨™é¡Œ ===
        const firstTable = queryDiv.querySelector("table");
        let titleText = "å ±è¡¨";
        if (firstTable) {
          const titleEl =
            firstTable.previousElementSibling && firstTable.previousElementSibling.tagName === "H5"
              ? firstTable.previousElementSibling.textContent
              : "";
          if (titleEl) {
            // å–åˆ†è™Ÿå‰çš„å­—ï¼Œä¾‹å¦‚ã€Œé¸æ“‡æŸ¥è©¢æ˜ç´°;æ¨™é¡ŒæŒ‰ä¸‹å³å¯æ’åºã€â†’ã€Œé¸æ“‡æŸ¥è©¢æ˜ç´°ã€
            titleText = titleEl.split(";")[0].trim();
          }
        }
    
        // --- 1ï¸âƒ£ å»ºç«‹åŒ¯å‡ºå®¹å™¨ ---
        const tableContainer = document.createElement("div");
        tableContainer.style.position = "absolute";
        tableContainer.style.left = "-9999px";
        tableContainer.style.width = "1200px";
        tableContainer.style.background = "#fff";
        tableContainer.style.padding = "10px";
    
        // --- 2ï¸âƒ£ æ—¥æœŸå€é–“ï¼ˆç¬¬ä¸€è¡Œï¼‰ ---
        const dateDiv = document.createElement("div");
        dateDiv.style.textAlign = "left";
        dateDiv.style.fontSize = headerFontSize + "px";
        dateDiv.style.fontWeight = "bold";
        dateDiv.style.marginBottom = "5px";
        dateDiv.textContent =
          displayStartDate && displayEndDate
            ? `ğŸ“… æ—¥æœŸå€é–“: ${displayStartDate} ~ ${displayEndDate}`
            : "ğŸ“… æ—¥æœŸå€é–“: æœªæŒ‡å®š";
    
        // --- 3ï¸âƒ£ æ¨™é¡Œï¼ˆç¬¬äºŒè¡Œï¼‰ ---
        const titleDiv = document.createElement("div");
        titleDiv.style.textAlign = "left";
        titleDiv.style.fontSize = headerFontSize + "px";
        titleDiv.style.fontWeight = "bold";
        titleDiv.style.marginBottom = "10px";
        titleDiv.textContent = titleText;
    
        // --- æ’å…¥é †åºï¼šæ—¥æœŸå€é–“ â†’ æ¨™é¡Œ â†’ è¡¨æ ¼ ---
        tableContainer.appendChild(dateDiv);
        tableContainer.appendChild(titleDiv);
    
        // å…‹éš† queryDivï¼Œä½†ç§»é™¤ H5ï¼ˆé¿å…ã€Œç¬¬ä¸‰è¡Œã€é‡è¤‡å‡ºç¾ï¼‰
        const clonedQuery = queryDiv.cloneNode(true);
        clonedQuery.querySelectorAll("h5").forEach(el => el.remove());
        tableContainer.appendChild(clonedQuery);
    
        // è¨­å®šè¡¨æ ¼å…§æ–‡å­—å¤§å°
        tableContainer.querySelectorAll("table, th, td").forEach(el => {
          el.style.fontSize = fontSize + "px";
        });
    
        document.body.appendChild(tableContainer);
        await new Promise(r => setTimeout(r, 300));
    
        // --- 4ï¸âƒ£ è½‰æˆ Canvas ---
        const tableCanvas = await html2canvas(tableContainer, {
          scale: 2,
          useCORS: true,
          backgroundColor: "#fff"
        });
        document.body.removeChild(tableContainer);
    
        // --- 5ï¸âƒ£ ç¸®æ”¾æˆå–®é  ---
        const maxWidth = pageWidth - margin * 2;
        const maxHeight = pageHeight - margin * 2;
        let imgWidth = tableCanvas.width;
        let imgHeight = tableCanvas.height;
        const ratio = Math.min(maxWidth / imgWidth, maxHeight / imgHeight);
        imgWidth *= ratio;
        imgHeight *= ratio;
    
        pdf.addImage(tableCanvas, "PNG", margin, margin, imgWidth, imgHeight);
    
        // --- 6ï¸âƒ£ åœ–è¡¨ï¼ˆå¯é¸ï¼‰ ---
        if (chartCanvas && chartCanvas.width > 0) {
          pdf.addPage();
          const chartImg = chartCanvas.toDataURL("image/png");
          const chartRatio = Math.min(
            (pageWidth - margin * 2) / chartCanvas.width,
            (pageHeight - margin * 2) / chartCanvas.height
          );
          pdf.addImage(
            chartImg,
            "PNG",
            margin,
            margin,
            chartCanvas.width * chartRatio,
            chartCanvas.height * chartRatio
          );
        }

        // ğŸ”¹ æ¸…ç†æ‰å¤šé¤˜å­—çœ¼èˆ‡ emojiï¼ˆåªç•™ä¸‹ä¸»é¡Œé—œéµè©ï¼‰
        titleText = titleText
          .replace(/^é¸æ“‡/, "")            // ç§»é™¤é–‹é ­ã€Œé¸æ“‡ã€
          .replace(/æŸ¥è©¢$/, "")            // ç§»é™¤çµå°¾ã€ŒæŸ¥è©¢ã€
          .replace(/[\p{Emoji_Presentation}\p{Extended_Pictographic}]/gu, "") // ç§»é™¤æ‰€æœ‰ emoji
          .replace(/\s+/g, "")             // ç§»é™¤å¤šé¤˜ç©ºç™½
          .trim();
        
        // --- 7ï¸âƒ£ æª”å ---
        const now = new Date();
        const hh = String(now.getHours()).padStart(2, "0");
        const mm = String(now.getMinutes()).padStart(2, "0");
        const ss = String(now.getSeconds()).padStart(2, "0");
        const filename = `éåŒ¯ä¸å¯PDF_${titleText || "å ±è¡¨"}_${fileDate}-${hh}-${mm}-${ss}.pdf`;
    
        if (liff.isInClient()) {
          // LINE å…§å»ºç€è¦½å™¨ï¼šé€é LIFF å‚³è¨Šæ¯çµ¦è‡ªå·±ï¼Œè¨Šæ¯ä¸­å¸¶ URL
          await liff.sendMessages([{
            type: "text",
            text: `${htmlUrl}`
          }]);
          // LINE å…§å»ºç€è¦½å™¨ï¼šåªæç¤ºè¨Šæ¯          
          alert(`LINE å…§å»ºç€è¦½å™¨ç„¡æ³•ä¸‹è¼‰ï¼Œç¶²å€å·²åœ¨è¨Šæ¯å…§ï¼Œè«‹è‡ªè¡Œå°‡ç¶²å€COPYè²¼åœ¨æµè¦½å™¨ä¸Šä½¿ç”¨æ­¤åŠŸèƒ½`);                 
        } else {
          // Webï¼šæ­£å¸¸ä¸‹è¼‰
          pdf.save(filename);
        }
    
      } catch (err) {
        console.error("âŒ åŒ¯å‡º PDF ç™¼ç”ŸéŒ¯èª¤:", err);
        alert("åŒ¯å‡º PDF å¤±æ•—ï¼š" + (err.message || "æœªå®šç¾©éŒ¯èª¤"));
      }
    });
  
// âœ… å‘¼å«åˆå§‹åŒ–
initApp();
</script>
</body>
</html>
