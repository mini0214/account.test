<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>é›¶ç”¨é‡‘æ”¯å‡ºå¸³ç°¿</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 30px; background-color: #f9f9f9; }
    h3 { font-size: 50px; text-align: center; margin-bottom: 50px; }
    .date-inputs { font-size: 50px; text-align: center; margin-bottom: 20px; }
    .date-inputs input { font-size: 50px; margin: 0 10px; padding: 5px; }
    button { font-size: 40px; margin: 5px; padding: 10px 20px; border-radius: 8px; cursor: pointer; background-color: #0056b3; color: white; border: none; }
    .date-btn { background-color: #666; }
    .green-btn { background-color: #28a745; }
    .pdf-btn { background-color: #d9534f; }
    .excel-btn { background-color: #1d6f42; }
    .slogan { font-size: 36px; text-align: center; margin: 30px 0 10px 0; color: #333; font-weight: bold; }
    h5 { font-size: 32px; margin: 20px 0 10px 0; padding: 0; }
    table { font-size: 28px; border-collapse: collapse; width: 100%; margin-top: 15px; background: white; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background-color: #eee; cursor: pointer; white-space: nowrap; }
    .total, tfoot { background-color: #eee !important; color: #000 !important; font-weight: bold; }
    .total { font-size: 36px; margin: 20px 0; text-align: center; border: 1px solid #ddd; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    tfoot td { border: 1px solid #ddd !important; color: #000 !important; }
    .numeric { text-align: right; }
    .chart-container { width: 95%; margin: 30px auto; background: white; border: 1px solid #eee; padding: 10px; }
    canvas { width: 100% !important; height: auto !important; display: block; }
    #loading { font-size: 32px; text-align: center; font-weight: bold; margin: 20px; }
    .drill-down-link { color: #0056b3; text-decoration: underline; cursor: pointer; font-weight: bold; }
    #drillDownArea { margin-top: 40px; padding-top: 20px; }
    @media print { button, .date-inputs, h3 { display: none !important; } }

    /* --- æ–°å¢ä¿®æ”¹è¦–çª—æ¨£å¼ --- */
    .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); }
    .modal-content { background-color: white; margin: 2% auto; padding: 40px; border-radius: 20px; width: 85%; max-height: 90vh; overflow-y: auto; }
    .modal-content h3 { font-size: 45px; margin-top: 0; }
    .form-group { margin-bottom: 25px; text-align: left; }
    .form-group label { display: block; font-size: 32px; margin-bottom: 10px; font-weight: bold; }
    .form-group input, .form-group select { width: 100%; font-size: 35px; padding: 15px; border: 2px solid #ccc; border-radius: 10px; box-sizing: border-box; }
    .modal-footer { text-align: right; margin-top: 40px; border-top: 1px solid #eee; padding-top: 20px; }
    .save-btn { background-color: #28a745; margin-left: 20px; }
    .cancel-btn { background-color: #dc3545; }

    /* ä¿®æ”¹éˆ•ï¼šé è¨­ç¶ åº• */
    .btn-edit {
      font-size: 20px;
      padding: 5px 10px;
      cursor: pointer;
      background-color: #28a745; /* ç¶ è‰² */
      color: white;
      border: none;
      border-radius: 4px;
      transition: background-color 0.2s;
    }
    
    /* åˆªé™¤éˆ•ï¼šé è¨­ç´…åº• */
    .btn-delete {
      font-size: 20px;
      padding: 5px 10px;
      cursor: pointer;
      background-color: #d9534f; /* ç´…è‰² */
      color: white;
      border: none;
      border-radius: 4px;
      margin-left: 5px;
      transition: background-color 0.2s;
    }
    
    /* å…±é€šï¼šæ‡¸åœ (hover) æˆ– æŒ‰ä¸‹ (active) æ™‚è®Šè—åº• */
    .btn-edit:hover, .btn-edit:active, 
    .btn-delete:hover, .btn-delete:active {
      background-color: #0056b3 !important; /* è—è‰² */
      color: white;
      outline: none;
    }
  </style>
</head>
<body>

<h3>ğŸ”é<span style="color: blue;">çœ‹</span><span>/</span><span style="color: green;">åŒ¯</span>ä¸å¯.[<span id="version"></span>]</h3>

<div id="editModal" class="modal">
  <div class="modal-content">
    <h3>ğŸ“ ä¿®æ”¹ ID: <span id="displayEditId"></span> è³‡æ–™</h3>
    <input type="hidden" id="editId">
    
    <div class="form-group">
      <label>æ—¥æœŸ</label>
      <input type="date" id="editDate">
    </div>
    <div class="form-group">
      <label>åº—å®¶</label>
      <input type="text" id="editStore">
    </div>
    <div class="form-group">
      <label>é‡‘é¡ (æ”¯å‡º)</label>
      <input type="number" id="editAmount">
    </div>
    <div class="form-group">
      <label>å¹£åˆ¥</label>
      <select id="editCurr"></select>
    </div>
    <div class="form-group">
      <label>ä»˜æ¬¾æ–¹å¼</label>
      <select id="editPay"></select>
    </div>
    <div class="form-group">
      <label>åˆ†é¡</label>
      <select id="editType"></select>
    </div>
    <div class="form-group">
      <label>é™„è¨»</label>
      <input type="text" id="editNote">
    </div>
    <div class="form-group">
      <label>å‚™è¨»</label>
      <input type="text" id="editMemo">
    </div>

    <div class="modal-footer">
      <button class="cancel-btn" onclick="closeEditModal()">å–æ¶ˆ</button>
      <button class="save-btn" onclick="confirmUpdate()">ç¢ºå®šå„²å­˜</button>
    </div>
  </div>
</div>

<div class="date-inputs">
  é–‹å§‹æ—¥æœŸï¼š<input type="date" id="startDate"><br>
  çµæŸæ—¥æœŸï¼š<input type="date" id="endDate"><br>
  <button id="prevMonthBtn" class="date-btn">ä¸Šæœˆ</button>
  <button id="nextMonthBtn" class="date-btn">ä¸‹æœˆ</button>
  <button id="thisYearBtn" class="date-btn">æ•´å¹´</button>
  <button id="lastYearBtn" class="date-btn">å»å¹´</button>
</div>

<div class="slogan">é¸æ“‡æ‚¨æƒ³è¦çœ‹çš„(ç›´çƒå°æ±º)</div>
    
<div style="text-align:center">
  <button id="queryMonthBtn">ğŸ“Š æ˜ç´°</button>
  <button id="queryMonthExchangeBtn">ğŸ’° å¹£åˆ¥</button>
  <button id="queryMonthPayBtn">ğŸ’³ ä»˜æ¬¾</button>
  <button id="queryMonthTypeBtn">ğŸ“‚ åˆ†é¡</button>
  <button id="queryMonthUserBtn">ğŸ‘¤ è¨˜å¸³è€…</button>
  <button id="queryMonthStoreBtn">ğŸ  åº—å®¶</button>
</div>

<div id="loading" style="display:none; font-size:40px; color:red; text-align:center; margin-top:20px;">â³ æ­£åœ¨è¼‰å…¥ä¸­ï¼Œè«‹ç¨ä¾¯...</div>
<div id="queryResult"></div>
<div id="drillDownArea"></div>
<div class="chart-container"><canvas id="chartCanvas"></canvas></div>
<div id="sixMonthArea"></div>
<div class="chart-container" id="trendContainer" style="display:none;"><canvas id="categoryTrendCanvas"></canvas></div>

<div id="exportArea" style="text-align:center; margin-top:40px; display:none; padding-bottom: 100px;">
  <button id="exportCsvBtn" class="green-btn">ğŸ“¤ åŒ¯å‡º CSV</button>
  <button id="exportExcelBtn" class="excel-btn">ğŸ“Š åŒ¯å‡º Excel</button>
  <button id="exportPdfBtn" class="pdf-btn">ğŸ“„ åŒ¯å‡º PDF</button>
</div>

<script>
const LIFF_IDq = "2008096451-jPJ50MOY";
const API_URL = "https://script.google.com/macros/s/AKfycbwxqIKuk4VqHeib3Mi_xxE6yS5R8V55wyiQVIS6VgF6PEnNa93lVSoBBiX4OYksDuaiUw/exec";
const VERSION = "V30_#260128"; 

let currentUser = null; 
let chartInstance = null; 
let trendChartInstance = null;
let currentFullLabel = ""; 
let currentCommandName = ""; 
let globalStats = { total: 0, count: 0 };
let orderMaps = { "ä»˜æ¬¾": [], "åˆ†é¡": [], "å¹£åˆ¥": [], "è¨˜å¸³è€…": [] };
let lastFetchedRows = []; 

// ----------------------------------------------------
// âœ… æ ¸å¿ƒå•Ÿå‹•é‚è¼¯ï¼šæ—¥æœŸå…ˆè¡Œï¼Œç¶²è·¯éš¨å¾Œ
// ----------------------------------------------------
async function initApp() {
  // 1. ç«‹å³è¨ˆç®—æ—¥æœŸ (å®Œå…¨ä¸éœ€ç¶²è·¯ï¼Œé«”æ„Ÿ 0 ç§’)
  setDefaultDateRange();

  try {
    const versionEl = document.getElementById("version");
    if (versionEl) versionEl.textContent = VERSION;

    // 2. èƒŒæ™¯è·‘ LIFF èˆ‡ æ¸…å–®æŠ“å–
    await Promise.all([
      liff.init({ liffId: LIFF_IDq }).then(async () => {
        if (!liff.isLoggedIn()) {
          liff.login();
        } else {
          const profile = await liff.getProfile();
          currentUser = profile.displayName;
        }
      }),
      fetchOrderLists() 
    ]);

    console.log("âœ¨ ç³»çµ±èƒŒæ™¯åˆå§‹åŒ–å®Œæˆ");
  } catch (e) {
    console.error("âŒ åˆå§‹åŒ–å¤±æ•—:", e);
  }
}

// ----------------------------------------------------
// âœ… æ—¥æœŸè™•ç†å·¥å…· (ä¿®æ­£ç„¡æ³•åŸ·è¡Œçš„é—œéµ)
// ----------------------------------------------------
function toInputDate(d) {
  return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
}

function setDefaultDateRange() {
  const now = new Date();
  const y = now.getFullYear();
  const m = now.getMonth();
  
  const firstDay = new Date(y, m, 1);
  const lastDay = new Date(y, m + 1, 0);
  
  document.getElementById("startDate").value = toInputDate(firstDay);
  document.getElementById("endDate").value = toInputDate(lastDay);
  
  // ç«‹å³é¡¯ç¤ºç›®å‰é¸æ“‡çš„æœˆä»½å¤§æ¨™é¡Œ
  updateQueryTitle(y, m + 1);
}

function updateQueryTitle(y, m) {
  const resultDiv = document.getElementById('queryResult');
  if (resultDiv) {
    resultDiv.innerHTML = `<h3 style="color:#666; font-size:40px;">ğŸ“… é è¨­ç¯„åœï¼š${y}å¹´ ${m}æœˆ</h3>`;
  }
}

// ----------------------------------------------------
// âœ… æœˆä»½åˆ‡æ›æŒ‰éˆ•é‚è¼¯
// ----------------------------------------------------
function changeMonth(offset) {
  const current = new Date(document.getElementById("startDate").value);
  const newFirst = new Date(current.getFullYear(), current.getMonth() + offset, 1);
  const newLast = new Date(newFirst.getFullYear(), newFirst.getMonth() + 1, 0);
  
  document.getElementById("startDate").value = toInputDate(newFirst);
  document.getElementById("endDate").value = toInputDate(newLast);
  
  updateQueryTitle(newFirst.getFullYear(), newFirst.getMonth() + 1);
}

document.getElementById("prevMonthBtn").onclick = () => changeMonth(-1);
document.getElementById("nextMonthBtn").onclick = () => changeMonth(1);
document.getElementById("thisYearBtn").onclick = () => {
  const y = new Date().getFullYear();
  document.getElementById("startDate").value = `${y}-01-01`;
  document.getElementById("endDate").value = `${y}-12-31`;
  const res = document.getElementById('queryResult');
  if(res) res.innerHTML = `<h3 style="color:#666; font-size:40px;">ğŸ“… ç¯„åœï¼š${y} æ•´å¹´åº¦</h3>`;
};
document.getElementById("lastYearBtn").onclick = () => {
  const y = new Date().getFullYear() - 1;
  document.getElementById("startDate").value = `${y}-01-01`;
  document.getElementById("endDate").value = `${y}-12-31`;
  const res = document.getElementById('queryResult');
  if(res) res.innerHTML = `<h3 style="color:#666; font-size:40px;">ğŸ“… ç¯„åœï¼š${y} å»å¹´å…¨å¹´åº¦</h3>`;
};

// ----------------------------------------------------
// âœ… ç¶²è·¯è«‹æ±‚èˆ‡ Loading è™•ç†
// ----------------------------------------------------
async function fetchOrderLists() {
  try {
    const res = await fetch(`${API_URL}?type=query&command=æ¸…å–®`);
    const json = await res.json();
    if (json.list) {
      orderMaps["ä»˜æ¬¾"] = (json.list.payment || []).map(item => item.name);
      orderMaps["åˆ†é¡"] = (json.list.type || []).map(item => item.name);
      orderMaps["å¹£åˆ¥"] = (json.list.currency || []).map(item => item.name);
      orderMaps["è¨˜å¸³è€…"] = (json.list.user || []).map(item => item.name);
      refreshSelects();
    }
  } catch (e) { console.error("âŒ æ¸…å–®ç²å–å¤±æ•—", e); }
}

let timerInterval;
let seconds = 0;

function startLoading() {
  const loadingDiv = document.getElementById('loading');
  clearInterval(timerInterval);
  seconds = 0;
  loadingDiv.style.display = 'block';
  loadingDiv.innerText = `â³ æ­£åœ¨è¼‰å…¥ä¸­...${seconds}s`;
  timerInterval = setInterval(() => {
    seconds++;
    loadingDiv.innerText = `â³ æ­£åœ¨è¼‰å…¥ä¸­...${seconds}s`;
  }, 1000);
}

function stopLoading() {
  clearInterval(timerInterval);
  document.getElementById('loading').style.display = 'none';
}

// ç¶å®šæŸ¥è©¢æŒ‰éˆ•
document.querySelectorAll("button[id^='queryMonth']").forEach(btn => {
  btn.onclick = () => {
    startLoading();
    currentFullLabel = btn.innerText; 
    currentCommandName = btn.innerText.replace(/[^\u4e00-\u9fa5]/g, '');
    // é€™è£¡æ‡‰æ¥æ‚¨çš„ sendQuery(currentCommandName) å‡½å¼
    console.log("åŸ·è¡ŒæŒ‡ä»¤:", currentCommandName);
  };
});

function refreshSelects() {
    updateSelectOptions("editType", orderMaps["åˆ†é¡"]);
    updateSelectOptions("editPay", orderMaps["ä»˜æ¬¾"]);
    updateSelectOptions("editCurr", orderMaps["å¹£åˆ¥"]);
}

function updateSelectOptions(elementId, list) {
    const el = document.getElementById(elementId);
    if (!el) return;
    el.innerHTML = "";
    list.forEach(item => {
        let opt = document.createElement("option");
        opt.value = item; opt.innerText = item;
        el.appendChild(opt);
    });
}

// å•Ÿå‹•
window.addEventListener("load", initApp);
</script>
</body>
</html>









