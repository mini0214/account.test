<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>é›¶ç”¨é‡‘æ”¯å‡ºå¸³ç°¿</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 50px; }
    h3 { font-size: 50px; text-align: center; margin-bottom: 50px; }
    .date-inputs { font-size: 50px; text-align: center; margin-bottom: 20px; }
    .date-inputs input { font-size: 50px; margin: 0 10px; padding: 5px; }
    h4 { font-size: 36px; text-align: center; margin-bottom: 20px; }
    button { font-size: 40px; margin: 5px; padding: 10px 20px; border-radius: 8px; cursor: pointer; background-color: #0056b3; color: white; }
    .date-btn { font-size: 40px; margin: 5px; padding: 10px 20px; border-radius: 8px; cursor: pointer; background-color: #888; color: white; }
    .green-btn { font-size: 40px; margin: 5px; padding: 10px 20px; border-radius: 8px; cursor: pointer; background-color: #28a745; color: white; }
    #queryResult { margin-top: 1px; }
    h5 { font-size: 28px; margin: 30px 0 10px 0; text-align: center; font-weight: bold; }
    table { font-size: 28px; border-collapse: collapse; width: 100%; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
    th { background-color: #f2f2f2; cursor: pointer; position: relative; }
    th:hover { background-color: #e0e0e0; }
    .numeric { text-align: right; }
    .total { font-size: 32px; font-weight: bold; color: #d9534f; margin: 20px 0; text-align: center; border: 3px solid #d9534f; padding: 15px; border-radius: 12px; }
    canvas { display: block; margin: 20px auto; width: 850px; height: 600px; }
    #sixMonthTableArea { margin-top: 50px; }
  </style>
</head>
<body>

<h3>ğŸ”é<span style="color: blue;">çœ‹</span><span>/</span><span style="color: green;">åŒ¯</span>ä¸å¯.[<span id="version"></span>]</h3>

<div class="date-inputs">
  é–‹å§‹æ—¥æœŸï¼š<input type="date" id="startDate"><br>
  çµæŸæ—¥æœŸï¼š<input type="date" id="endDate"><br>
  <button id="prevMonthBtn" class="date-btn">ä¸Šæœˆ</button>
  <button id="nextMonthBtn" class="date-btn">ä¸‹æœˆ</button>
  <button id="thisYearBtn" class="date-btn">æ•´å¹´</button>
  <button id="lastYearBtn" class="date-btn">å»å¹´</button>
</div>

<div style="text-align:center">
  <button id="queryMonthBtn">ğŸ“Š æ˜ç´°</button>
  <button id="queryMonthPayBtn">ğŸ’³ ä»˜æ¬¾</button>
  <button id="queryMonthTypeBtn">ğŸ“‚ åˆ†é¡</button>
  <button id="queryMonthStoreBtn">ğŸ“‹ åº—å®¶</button>
  <button id="queryMonthExchangeBtn">ğŸ’° å¹£åˆ¥</button>
  <button id="queryMonthUserBtn">ğŸ‘¤ è¨˜å¸³è€…</button>
</div>

<div id="loading" style="display:none; text-align:center; margin:20px;">
  <span style="font-size: 38px;">â³ è¼‰å…¥ä¸­...</span>
</div>

<div id="queryResult"></div> <canvas id="chartCanvas"></canvas> <div id="sixMonthTableArea"></div> <canvas id="categoryTrendCanvas"></canvas> <div id="exportArea" style="text-align:center; margin-top:10px; display:none;">
  <button id="exportCsvBtn" class="green-btn">ğŸ“¤ åŒ¯å‡ºCSV</button>
  <button id="exportExcelBtn" class="green-btn">ğŸ“¤ åŒ¯å‡ºExcel</button>
</div>

<script>
let FALLBACK_GAS_SETTINGS_URL = "https://script.google.com/macros/s/AKfycby2-1JvsriAfskOJXHyMB8HASeuMs7V-mJOQneD73Q_dJN56NhbWH0Dj8Ldu0LcfxMe/exec";
let API_URL = ""; let VERSION = "V"; let LIFF_IDq = ""; let currentUser = null; let chartInstance = null;

async function initApp(){
  try {
    const res = await fetch(FALLBACK_GAS_SETTINGS_URL + "?type=query&command=è¨­å®š");
    const json = await res.json();
    const settings = json.data;
    API_URL = settings.API_URL.trim();
    VERSION = settings.D10.trim();
    LIFF_IDq = settings.D12.trim();
    document.getElementById("version").textContent = VERSION;
    await liff.init({ liffId: LIFF_IDq });
    if (!liff.isLoggedIn()) liff.login();
    const profile = await liff.getProfile();
    currentUser = profile.displayName;
    setDefaultDateRange();
  } catch (e) { console.error(e); }
}
initApp();

function setDefaultDateRange() {
  const now = new Date();
  document.getElementById("startDate").value = toInputDate(new Date(now.getFullYear(), now.getMonth(), 1));
  document.getElementById("endDate").value = toInputDate(new Date(now.getFullYear(), now.getMonth() + 1, 0));
}
function toInputDate(d) { return d.toISOString().split('T')[0]; }

// æŸ¥è©¢äº‹ä»¶ç¶å®š
document.querySelectorAll("button[id^='queryMonth']").forEach(btn => {
  btn.addEventListener("click", () => sendQuery(btn.innerText.replace(/[^\u4e00-\u9fa5]/g, '')));
});

async function sendQuery(command) {
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;
  document.getElementById("loading").style.display = "block";
  document.getElementById("queryResult").innerHTML = "";
  document.getElementById("sixMonthTableArea").innerHTML = "";
  if(chartInstance) chartInstance.destroy();
  if(window.categoryTrendChart) window.categoryTrendChart.destroy();

  try {
    const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({
      type: "query", command, version: VERSION, startDate: start + " 00:00:00", endDate: end + " 23:59:59"
    })});
    const json = await res.json();
    renderResult(command, json);
  } catch (e) { alert("æŸ¥è©¢å¤±æ•—"); }
  finally { document.getElementById("loading").style.display = "none"; }
}

function renderResult(command, json) {
  let mainHtml = "";
  let sixMonthHtml = "";
  const adminUser = "Betty Yi";
  let filteredRows = (currentUser === adminUser) ? json.rows : (json.rows || []).filter(r => r[3] === currentUser);

  // 1. ç”¢ç”Ÿç•¶å‰çµ±è¨ˆè¡¨æ ¼
  if (command === "æ˜ç´°") {
    mainHtml += `<h5>ğŸ“Š æŸ¥è©¢æ˜ç´° (é»æ“Šæ¨™é¡Œæ’åº)</h5><table id="dataTable"><thead><tr><th>è¨˜å¸³è€…</th><th>æ—¥æœŸ</th><th>åº—å®¶</th><th class="numeric">é‡‘é¡</th><th>ä»˜æ¬¾</th><th>åˆ†é¡</th><th>å¹£åˆ¥</th></tr></thead><tbody>`;
    filteredRows.forEach(r => {
      mainHtml += `<tr><td>${r[3]}</td><td>${new Date(r[4]).toLocaleDateString()}</td><td>${r[8]}</td><td class="numeric">${Number(r[5]).toLocaleString()}</td><td>${r[7]}</td><td>${r[6]}</td><td>${r[14]}</td></tr>`;
    });
    mainHtml += `</tbody></table>`;
    const total = filteredRows.reduce((sum, r) => sum + Number(r[5] || 0), 0);
    mainHtml += `<div class="total">ğŸ“Œ ç¸½é¡ï¼š${total.toLocaleString()} å…ƒ</div>`;
    document.getElementById("queryResult").innerHTML = mainHtml;
  } else {
    const sections = { "åˆ†é¡":6, "ä»˜æ¬¾":7, "åº—å®¶":8, "å¹£åˆ¥":14, "è¨˜å¸³è€…":3 };
    const key = sections[command];
    const counts = {};
    filteredRows.forEach(r => { const v = r[key] || "æœªçŸ¥"; counts[v] = (counts[v] || 0) + Number(r[5] || 0); });
    const labels = Object.keys(counts);
    const values = Object.values(counts);
    const total = values.reduce((a,b)=>a+b,0);

    mainHtml += `<h5>ğŸ“‚ ${command}çµ±è¨ˆ (é»æ“Šæ¨™é¡Œæ’åº)</h5><table id="dataTable"><thead><tr><th>${command}</th><th class="numeric">é‡‘é¡</th><th class="numeric">ä½”æ¯”</th></tr></thead><tbody>`;
    labels.forEach((l, i) => {
      mainHtml += `<tr><td>${l}</td><td class="numeric">${values[i].toLocaleString()}</td><td class="numeric">${((values[i]/total)*100).toFixed(1)}%</td></tr>`;
    });
    mainHtml += `</tbody></table><div class="total">ğŸ“Œ ç¸½é¡ï¼š${total.toLocaleString()} å…ƒ</div>`;
    
    document.getElementById("queryResult").innerHTML = mainHtml;
    renderChart("pie", labels, values); // ç•«åœ“é¤…åœ–

    // 2. ç”¢ç”Ÿ 6 å€‹æœˆçµ±è¨ˆè¡¨
    const dataMapKey = { "åˆ†é¡":"categories_6m", "ä»˜æ¬¾":"payments_6m", "åº—å®¶":"stores_6m", "å¹£åˆ¥":"exchanges_6m", "è¨˜å¸³è€…":"users_6m" }[command];
    if (json.months_6m && json[dataMapKey]) {
      const months = json.months_6m;
      const dataMap = json[dataMapKey];
      sixMonthHtml += `<h5>ğŸ“… æœ€è¿‘ 6 å€‹æœˆ${command}çµ±è¨ˆè¡¨</h5><table id="table6m"><thead><tr><th>${command}</th>`;
      months.forEach(m => sixMonthHtml += `<th>${m}</th>`);
      sixMonthHtml += `<th>ç¸½é¡</th></tr></thead><tbody>`;
      Object.keys(dataMap).forEach(k => {
        let rTotal = 0;
        sixMonthHtml += `<tr><td>${k}</td>`;
        months.forEach(m => { const v = dataMap[k][m] || 0; rTotal += v; sixMonthHtml += `<td class="numeric">${v.toLocaleString()}</td>`; });
        sixMonthHtml += `<td class="numeric"><strong>${rTotal.toLocaleString()}</strong></td></tr>`;
      });
      sixMonthHtml += `</tbody></table>`;
      document.getElementById("sixMonthTableArea").innerHTML = sixMonthHtml;
      renderCategoryTrend(months, dataMap); // ç•«è¶¨å‹¢åœ–
    }
  }

  // 3. æ¢å¾©æ’åºåŠŸèƒ½
  initSorting(command);
  document.getElementById("exportArea").style.display = "block";
}

// æ’åºåˆå§‹åŒ–èˆ‡é‚è¼¯
function initSorting(command) {
  fetch(API_URL + "?type=query&command=æ¸…å–®")
    .then(r => r.json())
    .then(res => {
      const list = res.list || {};
      const orderMaps = {
        paymentOrder: (list.payment || []).map(p => p.name),
        typeOrder: (list.type || []).map(t => t.name),
        exchangeOrder: (list.currency || []).map(c => c.name)
      };
      const table = document.getElementById("dataTable");
      if (table) makeTableSortable(table, orderMaps);
    });
}

function makeTableSortable(table, orderMaps) {
  const headers = table.querySelectorAll("th");
  let paymentCol = -1, typeCol = -1, dateCol = -1, exchangeCol = -1;
  headers.forEach((th, i) => {
    const txt = th.innerText;
    if (txt.includes("ä»˜æ¬¾")) paymentCol = i;
    if (txt.includes("åˆ†é¡")) typeCol = i;
    if (txt.includes("æ—¥æœŸ")) dateCol = i;
    if (txt.includes("å¹£åˆ¥")) exchangeCol = i;
  });

  headers.forEach((th, colIdx) => {
    th.addEventListener("click", () => {
      const rows = Array.from(table.querySelectorAll("tbody tr"));
      const isAsc = th.dataset.order !== "asc";
      th.dataset.order = isAsc ? "asc" : "desc";
      
      rows.sort((a, b) => {
        const aVal = parseCellValue(a.cells[colIdx].innerText, colIdx, { paymentCol, typeCol, dateCol, exchangeCol, ...orderMaps });
        const bVal = parseCellValue(b.cells[colIdx].innerText, colIdx, { paymentCol, typeCol, dateCol, exchangeCol, ...orderMaps });
        return isAsc ? (aVal > bVal ? 1 : -1) : (aVal < bVal ? 1 : -1);
      });
      
      const tbody = table.querySelector("tbody");
      rows.forEach(r => tbody.appendChild(r));
      headers.forEach(h => h.innerText = h.innerText.replace(/ [â–²â–¼]/, ""));
      th.innerText += isAsc ? " â–²" : " â–¼";
    });
  });
}

function parseCellValue(txt, idx, map) {
  txt = txt.trim().replace(/,/g, '');
  if (idx === map.dateCol) return new Date(txt).getTime() || 0;
  if (idx === map.paymentCol && map.paymentOrder) return map.paymentOrder.indexOf(txt);
  if (idx === map.typeCol && map.typeOrder) return map.typeOrder.indexOf(txt);
  const n = parseFloat(txt.replace('%', ''));
  return isNaN(n) ? txt : n;
}

function renderChart(type, labels, values) {
  const ctx = document.getElementById("chartCanvas").getContext("2d");
  chartInstance = new Chart(ctx, {
    type: type,
    data: { labels, datasets: [{ data: values, backgroundColor: labels.map((_,i)=>`hsl(${i*360/labels.length},70%,60%)`) }] },
    options: { plugins: { legend: { labels: { font: { size: 24 } } } } }
  });
}

function renderCategoryTrend(months, map) {
  const ctx = document.getElementById("categoryTrendCanvas").getContext("2d");
  const datasets = Object.keys(map).map((k, i) => ({
    label: k, data: months.map(m => map[k][m] || 0), borderColor: `hsl(${i*360/Object.keys(map).length},70%,50%)`, tension: 0.2
  }));
  window.categoryTrendChart = new Chart(ctx, { type: "line", data: { labels: months, datasets } });
}
</script>
</body>
</html>
