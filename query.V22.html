<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>é›¶ç”¨é‡‘æ”¯å‡ºå¸³ç°¿</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 50px; background-color: #f9f9f9; }
    h3 { font-size: 50px; text-align: center; margin-bottom: 50px; }
    .date-inputs { font-size: 50px; text-align: center; margin-bottom: 20px; }
    .date-inputs input { font-size: 50px; margin: 0 10px; padding: 5px; }
    button { font-size: 40px; margin: 5px; padding: 10px 20px; border-radius: 8px; cursor: pointer; background-color: #0056b3; color: white; border: none; }
    .date-btn { background-color: #666; }
    .green-btn { background-color: #28a745; }
    .pdf-btn { background-color: #d9534f; }
    
    h5 { font-size: 32px; margin: 40px 0 10px 0; text-align: center; font-weight: bold; color: #333; }
    table { font-size: 26px; border-collapse: collapse; width: 100%; margin-top: 15px; background: white; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
    th { background-color: #eee; cursor: pointer; }
    
    /* ç¸½é¡èˆ‡ 6 å€‹æœˆçµ±è¨ˆè¡¨åº•éƒ¨çš„ç°åº•ç™½ç·šæ¨£å¼ */
    .total, tfoot { 
      background-color: #888 !important; 
      color: white !important; 
      font-weight: bold; 
    }
    .total {
      font-size: 36px; 
      margin: 20px 0; 
      text-align: center; 
      border: 3px solid white; 
      padding: 20px; 
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    tfoot td { border: 1px solid white !important; }

    .numeric { text-align: right; }
    canvas { display: block; margin: 30px auto; width: 900px; height: 600px; }
    #loading { font-size: 40px; text-align: center; color: #0056b3; font-weight: bold; margin: 30px; }
    
    /* åˆ—å° PDF æ™‚éš±è—æŒ‰éˆ• */
    @media print {
      button, .date-inputs, h3 { display: none !important; }
    }
  </style>
</head>
<body>

<h3>ğŸ”é<span style="color: blue;">çœ‹</span><span>/</span><span style="color: green;">åŒ¯</span>ä¸å¯.[<span id="version"></span>]</h3>

<div class="date-inputs">
  é–‹å§‹æ—¥æœŸï¼š<input type="date" id="startDate"><br>
  çµæŸæ—¥æœŸï¼š<input type="date" id="endDate"><br>
  <button id="prevMonthBtn" class="date-btn" onclick="changeMonth(-1)">ä¸Šæœˆ</button>
  <button id="nextMonthBtn" class="date-btn" onclick="changeMonth(1)">ä¸‹æœˆ</button>
</div>

<div style="text-align:center">
  <button id="queryMonthBtn">ğŸ“Š æ˜ç´°</button>
  <button id="queryMonthPayBtn">ğŸ’³ ä»˜æ¬¾</button>
  <button id="queryMonthTypeBtn">ğŸ“‚ åˆ†é¡</button>
  <button id="queryMonthStoreBtn">ğŸ“‹ åº—å®¶</button>
</div>

<div id="loading" style="display:none;">â³ æ­£åœ¨è¨ˆç®—æ•¸æ“šï¼Œè«‹ç¨å€™...</div>

<div id="queryResult"></div>
<canvas id="chartCanvas"></canvas>
<div id="sixMonthArea"></div>
<canvas id="categoryTrendCanvas"></canvas>

<div id="exportArea" style="text-align:center; margin-top:40px; display:none; padding-bottom: 100px;">
  <button id="exportCsvBtn" class="green-btn">ğŸ“¤ åŒ¯å‡º CSV</button>
  <button id="exportPdfBtn" class="pdf-btn">ğŸ“„ åŒ¯å‡º PDF</button>
</div>

<script>
let API_URL = ""; let VERSION = "V"; let LIFF_IDq = ""; let currentUser = null; 
let chartInstance = null; let trendChartInstance = null;
let FALLBACK_GAS_SETTINGS_URL = "https://script.google.com/macros/s/AKfycby2-1JvsriAfskOJXHyMB8HASeuMs7V-mJOQneD73Q_dJN56NhbWH0Dj8Ldu0LcfxMe/exec";

// åˆå§‹åŒ–
async function initApp(){
  try {
    const res = await fetch(FALLBACK_GAS_SETTINGS_URL + "?type=query&command=è¨­å®š");
    const json = await res.json();
    API_URL = json.data.API_URL.trim();
    VERSION = json.data.D10.trim();
    LIFF_IDq = json.data.D12.trim();
    document.getElementById("version").textContent = VERSION;
    
    await liff.init({ liffId: LIFF_IDq });
    if (!liff.isLoggedIn()) liff.login();
    const profile = await liff.getProfile();
    currentUser = profile.displayName;
    setDefaultDateRange();
  } catch (e) { console.error("åˆå§‹åŒ–å¤±æ•—", e); }
}
initApp();

function setDefaultDateRange() {
  const now = new Date();
  const first = new Date(now.getFullYear(), now.getMonth(), 1);
  const last = new Date(now.getFullYear(), now.getMonth() + 1, 0);
  document.getElementById("startDate").value = toInputDate(first);
  document.getElementById("endDate").value = toInputDate(last);
}

function toInputDate(d) {
  return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
}

function changeMonth(offset) {
  const startInp = document.getElementById("startDate");
  const d = new Date(startInp.value);
  const newFirst = new Date(d.getFullYear(), d.getMonth() + offset, 1);
  const newLast = new Date(d.getFullYear(), newFirst.getMonth() + 1, 0);
  startInp.value = toInputDate(newFirst);
  document.getElementById("endDate").value = toInputDate(newLast);
}

// æŸ¥è©¢äº‹ä»¶ç¶å®š
document.querySelectorAll("button[id^='queryMonth']").forEach(btn => {
  btn.onclick = () => sendQuery(btn.innerText.replace(/[^\u4e00-\u9fa5]/g, ''));
});

async function sendQuery(command) {
  document.getElementById("loading").style.display = "block";
  document.getElementById("queryResult").innerHTML = "";
  document.getElementById("sixMonthArea").innerHTML = "";
  if(chartInstance) chartInstance.destroy();
  if(trendChartInstance) trendChartInstance.destroy();

  const body = {
    type: "query", command, version: VERSION,
    startDate: document.getElementById("startDate").value + " 00:00:00",
    endDate: document.getElementById("endDate").value + " 23:59:59"
  };

  try {
    const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(body) });
    const json = await res.json();
    renderResult(command, json);
  } catch (e) { alert("è®€å–å¤±æ•—"); }
  finally { document.getElementById("loading").style.display = "none"; }
}

function renderResult(command, json) {
  let mainHtml = "";
  let adminUser = "Betty Yi";
  let rows = (currentUser === adminUser) ? json.rows : (json.rows || []).filter(r => r[3] === currentUser);

  // 1. è™•ç†ä¸»çµ±è¨ˆè¡¨æ ¼èˆ‡ã€Œç°åº•ç™½ç·šã€ç¸½é¡å€å¡Š
  if (command === "æ˜ç´°") {
    mainHtml += `<h5>ğŸ“Š æŸ¥è©¢æ˜ç´° (é»æ“Šæ¨™é¡Œæ’åº)</h5><table id="mainTable"><thead><tr><th>æ—¥æœŸ</th><th>åº—å®¶</th><th class="numeric">é‡‘é¡</th><th>ä»˜æ¬¾</th><th>åˆ†é¡</th></tr></thead><tbody>`;
    rows.forEach(r => {
      mainHtml += `<tr><td>${new Date(r[4]).toLocaleDateString()}</td><td>${r[8]}</td><td class="numeric">${Number(r[5]).toLocaleString()}</td><td>${r[7]}</td><td>${r[6]}</td></tr>`;
    });
    mainHtml += `</tbody></table>`;
    const total = rows.reduce((s, r) => s + Number(r[5] || 0), 0);
    mainHtml += `<div class="total">ğŸ’° ç¸½é¡ï¼š${total.toLocaleString()} å…ƒ | ğŸ“ ç­†æ•¸ï¼š${rows.length} ç­†</div>`;
  } else {
    const keyMap = { "åˆ†é¡":6, "ä»˜æ¬¾":7, "åº—å®¶":8 };
    const colIdx = keyMap[command];
    let counts = {};
    rows.forEach(r => { let v = r[colIdx] || "æœªåˆ†é¡"; counts[v] = (counts[v] || 0) + Number(r[5] || 0); });
    let labels = Object.keys(counts);
    let values = Object.values(counts);
    let totalSum = values.reduce((a, b) => a + b, 0);

    mainHtml += `<h5>ğŸ“‚ ${command}åˆ†æçµ±è¨ˆ</h5><table id="mainTable"><thead><tr><th>${command}</th><th class="numeric">é‡‘é¡</th><th class="numeric">ä½”æ¯”</th></tr></thead><tbody>`;
    labels.forEach((l, i) => {
      mainHtml += `<tr><td>${l}</td><td class="numeric">${values[i].toLocaleString()}</td><td class="numeric">${((values[i]/totalSum)*100).toFixed(1)}%</td></tr>`;
    });
    mainHtml += `</tbody></table>`;
    mainHtml += `<div class="total">ğŸ’° ${command}ç¸½é¡ï¼š${totalSum.toLocaleString()} å…ƒ | ğŸ“ ç­†æ•¸ï¼š${rows.length} ç­†</div>`;
    renderChart("pie", labels, values);
  }
  document.getElementById("queryResult").innerHTML = mainHtml;
  makeTableSortable(document.getElementById("mainTable"));

  // 2. è™•ç† 6 å€‹æœˆè¡¨æ ¼ (åº•éƒ¨ç°åº•ç™½ç·š)
  const sixKey = { "åˆ†é¡":"categories_6m", "ä»˜æ¬¾":"payments_6m", "åº—å®¶":"stores_6m" }[command];
  if (json.months_6m && json[sixKey]) {
    const months = json.months_6m;
    const dataMap = json[sixKey];
    let monthlySums = new Array(months.length).fill(0);
    let grandTotal = 0;

    let sixHtml = `<h5>ğŸ“… æœ€è¿‘ 6 å€‹æœˆ${command}çµ±è¨ˆ (é»æ“Šæ¨™é¡Œæ’åº)</h5>`;
    sixHtml += `<table id="table6m"><thead><tr><th>${command}</th>`;
    months.forEach(m => sixHtml += `<th>${m}</th>`);
    sixHtml += `<th>ç¸½é¡</th></tr></thead><tbody>`;

    Object.keys(dataMap).forEach(item => {
      let rSum = 0;
      sixHtml += `<tr><td>${item}</td>`;
      months.forEach((m, i) => {
        let val = dataMap[item][m] || 0;
        rSum += val; monthlySums[i] += val;
        sixHtml += `<td class="numeric">${val.toLocaleString()}</td>`;
      });
      grandTotal += rSum;
      sixHtml += `<td class="numeric"><strong>${rSum.toLocaleString()}</strong></td></tr>`;
    });
    sixHtml += `</tbody><tfoot><tr><td>æ¯æœˆç¸½è¨ˆ</td>`;
    monthlySums.forEach(sum => sixHtml += `<td class="numeric">${sum.toLocaleString()}</td>`);
    sixHtml += `<td class="numeric">${grandTotal.toLocaleString()}</td></tr></tfoot></table>`;

    document.getElementById("sixMonthArea").innerHTML = sixHtml;
    makeTableSortable(document.getElementById("table6m"));
    renderCategoryTrend(months, dataMap);
  }
  
  document.getElementById("exportArea").style.display = "block";
}

function makeTableSortable(table) {
  if (!table) return;
  const headers = table.querySelectorAll("thead th");
  headers.forEach((th, i) => {
    th.addEventListener("click", () => {
      const tbody = table.querySelector("tbody");
      const rows = Array.from(tbody.querySelectorAll("tr"));
      const isAsc = th.dataset.order !== "asc";
      th.dataset.order = isAsc ? "asc" : "desc";
      rows.sort((a, b) => {
        let v1 = a.cells[i].innerText.replace(/,/g, '');
        let v2 = b.cells[i].innerText.replace(/,/g, '');
        return isAsc ? (parseFloat(v1) - parseFloat(v2) || v1.localeCompare(v2)) : (parseFloat(v2) - parseFloat(v1) || v2.localeCompare(v1));
      });
      rows.forEach(r => tbody.appendChild(r));
    });
  });
}

function renderChart(type, labels, values) {
  const ctx = document.getElementById("chartCanvas").getContext("2d");
  chartInstance = new Chart(ctx, {
    type: type,
    data: { labels, datasets: [{ data: values, backgroundColor: labels.map((_,i)=>`hsl(${i*360/labels.length},70%,60%)`) }] },
    options: { plugins: { legend: { labels: { font: { size: 24 } } } } }
  });
}

function renderCategoryTrend(months, map) {
  const ctx = document.getElementById("categoryTrendCanvas").getContext("2d");
  const datasets = Object.keys(map).map((k, i) => ({
    label: k, data: months.map(m => map[k][m] || 0), borderColor: `hsl(${i*360/Object.keys(map).length},70%,50%)`, tension: 0.2
  }));
  trendChartInstance = new Chart(ctx, { type: "line", data: { labels: months, datasets } });
}

// --- åŒ¯å‡ºåŠŸèƒ½ ---
document.getElementById("exportCsvBtn").onclick = () => {
  const table = document.getElementById("mainTable");
  let csv = "\ufeff"; // BOM
  for (let row of table.rows) {
    let rowData = [];
    for (let cell of row.cells) rowData.push('"' + cell.innerText + '"');
    csv += rowData.join(",") + "\n";
  }
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `æ”¯å‡ºçµ±è¨ˆ_${new Date().getTime()}.csv`;
  link.click();
};

document.getElementById("exportPdfBtn").onclick = () => {
  window.print(); // ä½¿ç”¨ç€è¦½å™¨å…§å»ºåˆ—å°åŠŸèƒ½è¼¸å‡ºç‚º PDF
};
</script>
</body>
</html>
