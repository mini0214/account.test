<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>é›¶ç”¨é‡‘æ”¯å‡ºå¸³ç°¿</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script> 
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 50px; }
    h3 { font-size: 50px; text-align: center; margin-bottom: 50px; }
    .date-inputs { font-size: 50px; text-align: center; margin-bottom: 20px;  }
    .date-inputs input { font-size: 50px; margin: 0 10px;  padding: 5px; }
    h4 { font-size: 36px; text-align: center; margin-bottom: 20px; }
    button { font-size: 40px; margin: 5px; padding: 10px 20px; border-radius: 8px; cursor: pointer; background-color: #0056b3; color: white; }
    .date-btn { font-size: 40px; margin: 5px; padding: 10px 20px; border-radius: 8px; cursor: pointer; background-color: #888; color: white; }
    .date-btn:hover { background-color: #0056b3; }
    .green-btn { font-size: 40px; margin: 5px; padding: 10px 20px; border-radius: 8px; cursor: pointer; background-color: #28a745; color: white; }
    .green-btn:hover { background-color: #0056b3; }
    #queryResult { margin-top: 1px; }
    h5 { font-size: 28px; margin: 20px 0 10px 0; padding: 0; text-align: center; color: #333; }
    table { font-size: 28px; border-collapse: collapse; width: 100%; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    .numeric { text-align: right; }
    .total { font-size: 32px; font-weight: bold; color: #d9534f; margin: 20px 0; text-align: center; border: 2px solid #d9534f; padding: 10px; border-radius: 10px; }
    canvas { display: block; margin: 20px auto; width: 850px; height: 600px; }
    #sixMonthTableArea { margin-top: 30px; }
  </style>
</head>
<body>

<h3>ğŸ”é<span style="color: blue;">çœ‹</span><span>/</span><span style="color: green;">åŒ¯</span>ä¸å¯.[<span id="version"></span>]</h3>

<div class="date-inputs">
  é–‹å§‹æ—¥æœŸï¼š<input type="date" id="startDate"><br>
  çµæŸæ—¥æœŸï¼š<input type="date" id="endDate"><br>
  <button id="prevMonthBtn" class="date-btn">ä¸Šæœˆ</button>
  <button id="nextMonthBtn" class="date-btn">ä¸‹æœˆ</button>
  <button id="thisYearBtn" class="date-btn">æ•´å¹´</button>
  <button id="lastYearBtn" class="date-btn">å»å¹´</button>
</div>

<h4>é¸æ“‡æ‚¨æƒ³è¦çœ‹çš„(ç›´çƒå°æ±º)</h4>

<div style="text-align:center">
  <button id="queryMonthBtn">ğŸ“Š æ˜ç´°</button>
  <button id="queryMonthPayBtn">ğŸ’³ ä»˜æ¬¾</button>
  <button id="queryMonthTypeBtn">ğŸ“‚ åˆ†é¡</button>
  <button id="queryMonthStoreBtn">ğŸ“‹ åº—å®¶</button>
  <button id="queryMonthExchangeBtn">ğŸ’° å¹£åˆ¥</button>
  <button id="queryMonthUserBtn">ğŸ‘¤ è¨˜å¸³è€…</button>
</div>

<div id="loading" style="display:none; text-align:center; margin:20px;">
  <span style="font-size: 38px;">â³ è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</span>
</div>

<div id="queryResult"></div> <canvas id="chartCanvas"></canvas> <div id="sixMonthTableArea"></div> <canvas id="categoryTrendCanvas"></canvas> <div id="exportArea" style="text-align:center; margin-top:10px; display:none;">
  <button id="exportCsvBtn" class="green-btn">ğŸ“¤ åŒ¯å‡ºCSV</button>
  <button id="exportExcelBtn" class="green-btn">ğŸ“¤ åŒ¯å‡ºExcel</button>
  <button id="exportPdfBtn" class="green-btn">ğŸ“„ åŒ¯å‡ºPDF</button>
</div>

<script>
let FALLBACK_GAS_SETTINGS_URL = "https://script.google.com/macros/s/AKfycby2-1JvsriAfskOJXHyMB8HASeuMs7V-mJOQneD73Q_dJN56NhbWH0Dj8Ldu0LcfxMe/exec";
let API_URL = "";    
let VERSION = "V";   
let LIFF_IDq = "";   
let htmlUrl = "";    
let currentUser = null; 
let chartInstance = null;

document.getElementById("version").textContent = VERSION;

async function tryFetchText(url){
  const r = await fetch(url, { cache: 'no-store' });
  const text = await r.text();
  try { const j = JSON.parse(text); return { ok: true, json: j }; }
  catch(e){ return { ok: false, text }; }
}

async function loadSettings(){
  const res = await tryFetchText(FALLBACK_GAS_SETTINGS_URL + "?type=query&command=è¨­å®š");
  if (!res.ok) throw new Error("è¨­å®š GAS è®€å–å¤±æ•—ï¼š" + res.text);
  const data = res.json;
  if (!data.ok || !data.data) throw new Error("è¨­å®šæ ¼å¼éŒ¯èª¤");
  return data.data;
}
  
async function initApp(){
  try {
    const settings = await loadSettings();
    FALLBACK_GAS_SETTINGS_URL = (settings.SETTINGS_URL || FALLBACK_GAS_SETTINGS_URL).trim();
    API_URL = (settings.API_URL || "").trim();
    VERSION = (settings.D10 || "V").trim();
    LIFF_IDq = (settings.D12 || "").trim();
    htmlUrl = (settings.D14 || "").trim();
    document.getElementById("version").textContent = VERSION;
    await liff.init({ liffId: LIFF_IDq });
    if (!liff.isLoggedIn()) liff.login();
    const profile = await liff.getProfile();
    currentUser = profile.displayName;
    setDefaultDateRange();
  } catch (err) {
    console.error("åˆå§‹åŒ–å¤±æ•—ï¼š", err);
  }
}

initApp();

function setDefaultDateRange() {
  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth(), 1);
  const end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
  document.getElementById("startDate").value = toInputDate(start);
  document.getElementById("endDate").value = toInputDate(end);
}

function toInputDate(d) {
  const m = (d.getMonth() + 1).toString().padStart(2, "0");
  const day = d.getDate().toString().padStart(2, "0");
  return `${d.getFullYear()}-${m}-${day}`;
}

const startInput = document.getElementById("startDate");
const endInput = document.getElementById("endDate");

function setDateRange(start, end) {
  startInput.value = toInputDate(start);
  endInput.value = toInputDate(end);
}

document.getElementById("prevMonthBtn").addEventListener("click", () => {
  const base = new Date(startInput.value);
  setDateRange(new Date(base.getFullYear(), base.getMonth() - 1, 1), new Date(base.getFullYear(), base.getMonth(), 0));
});
document.getElementById("nextMonthBtn").addEventListener("click", () => {
  const base = new Date(startInput.value);
  setDateRange(new Date(base.getFullYear(), base.getMonth() + 1, 1), new Date(base.getFullYear(), base.getMonth() + 2, 0));
});
document.getElementById("thisYearBtn").addEventListener("click", () => {
  const y = new Date().getFullYear();
  setDateRange(new Date(y, 0, 1), new Date(y, 11, 31));
});
document.getElementById("lastYearBtn").addEventListener("click", () => {
  const y = new Date().getFullYear() - 1;
  setDateRange(new Date(y, 0, 1), new Date(y, 11, 31));
});

document.getElementById("queryMonthBtn").addEventListener("click", () => sendQuery("æ˜ç´°"));
document.getElementById("queryMonthTypeBtn").addEventListener("click", () => sendQuery("åˆ†é¡"));
document.getElementById("queryMonthPayBtn").addEventListener("click", () => sendQuery("ä»˜æ¬¾"));
document.getElementById("queryMonthStoreBtn").addEventListener("click", () => sendQuery("åº—å®¶"));
document.getElementById("queryMonthExchangeBtn").addEventListener("click", () => sendQuery("å¹£åˆ¥"));
document.getElementById("queryMonthUserBtn").addEventListener("click", () => sendQuery("è¨˜å¸³è€…"));

async function sendQuery(command) {
  const startDate = document.getElementById("startDate").value;
  const endDate = document.getElementById("endDate").value;
  if (!startDate || !endDate) return alert("è«‹é¸æ“‡æ—¥æœŸ");

  // æ¸…ç©ºèˆŠå…§å®¹
  document.getElementById("queryResult").innerHTML = "";
  document.getElementById("sixMonthTableArea").innerHTML = "";
  document.getElementById("exportArea").style.display = "none";
  if (chartInstance) chartInstance.destroy();
  if (window.categoryTrendChart) window.categoryTrendChart.destroy();
  
  document.getElementById("loading").style.display = "block";
  
  try {
    const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({
      type: "query", command, version: VERSION, startDate: startDate + " 00:00:00", endDate: endDate + " 23:59:59"
    })});
    const json = await res.json();
    if (json.ok) renderResult(command, json);
  } catch (err) {
    alert("æŸ¥è©¢å¤±æ•—ï¼š" + err.message);
  } finally {
    document.getElementById("loading").style.display = "none";
  }
}

function renderResult(command, json) {
  let mainHtml = ""; // ç¬¬ä¸€éƒ¨åˆ†ï¼šæ¨™é¡Œ + ç•¶å‰çµ±è¨ˆè¡¨ + ç¸½é¡
  let sixMonthHtml = ""; // ç¬¬äºŒéƒ¨åˆ†ï¼š6å€‹æœˆçµ±è¨ˆè¡¨
  const adminUser = "Betty Yi";
  
  if (!currentUser && json.rows && json.rows.length > 0) currentUser = json.rows[0][3];
  let filteredRows = (currentUser === adminUser) ? json.rows : (json.rows || []).filter(r => r[3] === currentUser);

  // --- è™•ç†ï¼šæ˜ç´° ---
  if (command === "æ˜ç´°") {
    mainHtml += `<h5>ğŸ“Š æŸ¥è©¢æ˜ç´°</h5><table id="dataTable"><tr><th>è¨˜å¸³è€…</th><th>æ—¥æœŸ</th><th>åº—å®¶</th><th class="numeric">é‡‘é¡</th><th>ä»˜æ¬¾</th><th>åˆ†é¡</th><th>å¹£åˆ¥</th></tr>`;
    filteredRows.forEach(r => {
      mainHtml += `<tr><td>${r[3]}</td><td>${new Date(r[4]).toLocaleDateString()}</td><td>${r[8]}</td><td class="numeric">${Number(r[5]).toLocaleString()}</td><td>${r[7]}</td><td>${r[6]}</td><td>${r[14]}</td></tr>`;
    });
    mainHtml += `</table>`;
    const total = filteredRows.reduce((sum, r) => sum + Number(r[5] || 0), 0);
    mainHtml += `<div class="total">ğŸ“Œ ç¸½é¡ï¼š${total.toLocaleString()} å…ƒï¼ˆå…± ${filteredRows.length} ç­†ï¼‰</div>`;
    document.getElementById("queryResult").innerHTML = mainHtml;
    // é•·æ¢åœ– (ç•¥, èˆ‡åŸé‚è¼¯åŒ)
  }

  // --- è™•ç†ï¼šçµ±è¨ˆé¡ (åˆ†é¡, ä»˜æ¬¾, åº—å®¶, å¹£åˆ¥, è¨˜å¸³è€…) ---
  const sections = [
    { cmd: "åˆ†é¡", key: 6, title: "ğŸ“‚ é¸æ“‡åˆ†é¡çµ±è¨ˆ", dataKey: "categories_6m" },
    { cmd: "ä»˜æ¬¾", key: 7, title: "ğŸ’³ é¸æ“‡ä»˜æ¬¾çµ±è¨ˆ", dataKey: "payments_6m" },
    { cmd: "åº—å®¶", key: 8, title: "ğŸ“‹ é¸æ“‡åº—å®¶çµ±è¨ˆ", dataKey: "stores_6m" },
    { cmd: "å¹£åˆ¥", key: 14, title: "ğŸ’° é¸æ“‡å¹£åˆ¥çµ±è¨ˆ", dataKey: "exchanges_6m" },
    { cmd: "è¨˜å¸³è€…", key: 3, title: "ğŸ‘¤ é¸æ“‡è¨˜å¸³è€…çµ±è¨ˆ", dataKey: "users_6m" }
  ];

  sections.forEach(sec => {
    if (command === sec.cmd) {
      const counts = {};
      filteredRows.forEach(r => {
        const val = r[sec.key] || "æœªçŸ¥";
        counts[val] = (counts[val] || 0) + Number(r[5] || 0);
      });
      const labels = Object.keys(counts);
      const values = Object.values(counts);
      const total = values.reduce((a,b)=>a+b,0);

      mainHtml += `<h5>${sec.title}</h5>`;
      mainHtml += `<table id="dataTable"><tr><th>${sec.cmd}</th><th class="numeric">é‡‘é¡</th><th class="numeric">ä½”æ¯”</th></tr>`;
      labels.forEach((l, i) => {
        mainHtml += `<tr><td>${l}</td><td class="numeric">${values[i].toLocaleString()}</td><td class="numeric">${((values[i]/total)*100).toFixed(1)}%</td></tr>`;
      });
      mainHtml += `</table>`;
      mainHtml += `<div class="total">ğŸ“Œ ç¸½é¡ï¼š${total.toLocaleString()} å…ƒ</div>`;
      
      // å…ˆå¡«å…¥ç¬¬ä¸€éƒ¨åˆ† (æ¨™é¡Œ+è¡¨æ ¼+ç¸½é¡)
      document.getElementById("queryResult").innerHTML = mainHtml;
      
      // ç•«åœ“é¤…åœ– (åœ¨ queryResult ä¸‹æ–¹)
      renderChart("pie", labels, values);

      // è™•ç† 6 å€‹æœˆè³‡æ–™ (åœ¨åœ“é¤…åœ–ä¸‹æ–¹)
      if (json.months_6m && json[sec.dataKey]) {
        const months = json.months_6m;
        const dataMap = json[sec.dataKey];
        sixMonthHtml += `<h5>ğŸ“… æœ€è¿‘ 6 å€‹æœˆ${sec.cmd}çµ±è¨ˆè¡¨</h5>`;
        sixMonthHtml += `<table><tr><th>${sec.cmd}</th>`;
        months.forEach(m => sixMonthHtml += `<th>${m}</th>`);
        sixMonthHtml += `<th>ç¸½é¡</th></tr>`;
        
        Object.keys(dataMap).forEach(key => {
          sixMonthHtml += `<tr><td>${key}</td>`;
          let rowTotal = 0;
          months.forEach(m => {
            const v = dataMap[key][m] || 0;
            rowTotal += v;
            sixMonthHtml += `<td class="numeric">${v.toLocaleString()}</td>`;
          });
          sixMonthHtml += `<td class="numeric"><strong>${rowTotal.toLocaleString()}</strong></td></tr>`;
        });
        sixMonthHtml += `</table>`;
        
        // å¡«å…¥ç¬¬äºŒéƒ¨åˆ† (6å€‹æœˆçµ±è¨ˆè¡¨)
        document.getElementById("sixMonthTableArea").innerHTML = sixMonthHtml;
        
        // ç•«è¶¨å‹¢åœ– (åœ¨ sixMonthTableArea ä¸‹æ–¹)
        renderCategoryTrend(months, dataMap);
      }
    }
  });

  document.getElementById("exportArea").style.display = "block";
}

function renderChart(type, labels, values) {
  const ctx = document.getElementById("chartCanvas").getContext("2d");
  if (chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    type: type,
    data: {
      labels: labels,
      datasets: [{
        data: values,
        backgroundColor: labels.map((_, i) => `hsl(${i * 360 / labels.length}, 70%, 60%)`)
      }]
    },
    options: { 
      responsive: true,
      plugins: {
        legend: { position: 'top', labels: { font: { size: 24 } } }
      }
    }
  });
}

function renderCategoryTrend(months, categoryMonthMap) {
  const ctx = document.getElementById("categoryTrendCanvas").getContext("2d");
  if (window.categoryTrendChart) window.categoryTrendChart.destroy();
  
  const datasets = Object.keys(categoryMonthMap).map((cat, idx) => ({
    label: cat,
    data: months.map(m => categoryMonthMap[cat][m] || 0),
    borderColor: `hsl(${idx * 360 / Object.keys(categoryMonthMap).length}, 70%, 50%)`,
    tension: 0.2,
    fill: false
  }));

  window.categoryTrendChart = new Chart(ctx, {
    type: "line",
    data: { labels: months, datasets: datasets },
    options: {
      responsive: true,
      plugins: {
        legend: { position: "top", labels: { font: { size: 20 } } }
      }
    }
  });
}
</script>
</body>
</html>
