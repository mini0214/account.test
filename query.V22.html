<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>é›¶ç”¨é‡‘æ”¯å‡ºå¸³ç°¿</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 30px; background-color: #f9f9f9; }
    h3 { font-size: 50px; text-align: center; margin-bottom: 50px; }
    .date-inputs { font-size: 50px; text-align: center; margin-bottom: 20px; }
    .date-inputs input { font-size: 50px; margin: 0 10px; padding: 5px; }
    button { font-size: 40px; margin: 5px; padding: 10px 20px; border-radius: 8px; cursor: pointer; background-color: #0056b3; color: white; border: none; }
    .date-btn { background-color: #666; }
    .green-btn { background-color: #28a745; }
    .pdf-btn { background-color: #d9534f; }
    .excel-btn { background-color: #1d6f42; }

    .slogan { font-size: 36px; text-align: center; margin: 30px 0 10px 0; color: #333; font-weight: bold; }
    h5 { font-size: 32px; margin: 20px 0 10px 0; padding: 0; }
    table { font-size: 28px; border-collapse: collapse; width: 100%; margin-top: 15px; background: white; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background-color: #eee; cursor: pointer; white-space: nowrap; }
    
    .total, tfoot { background-color: #eee !important; color: #000 !important; font-weight: bold; }
    .total { 
      font-size: 36px; margin: 20px 0; text-align: center; 
      border: 1px solid #ddd; padding: 20px; border-radius: 12px; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
    }
    tfoot td { border: 1px solid #ddd !important; color: #000 !important; }

    .numeric { text-align: right; }
    
    .chart-container { width: 95%; margin: 30px auto; background: white; border: 1px solid #eee; padding: 10px; }
    canvas { width: 100% !important; height: auto !important; display: block; }
    
    #loading { font-size: 32px; text-align: center; font-weight: bold; margin: 20px; }
    
    .drill-down-link { color: #0056b3; text-decoration: underline; cursor: pointer; font-weight: bold; }
    #drillDownArea { margin-top: 40px; padding-top: 20px; }

    @media print { button, .date-inputs, h3 { display: none !important; } }
  </style>
</head>
<body>

<h3>ğŸ”é<span style="color: blue;">çœ‹</span><span>/</span><span style="color: green;">åŒ¯</span>ä¸å¯.[<span id="version"></span>]</h3>

<div class="date-inputs">
  é–‹å§‹æ—¥æœŸï¼š<input type="date" id="startDate"><br>
  çµæŸæ—¥æœŸï¼š<input type="date" id="endDate"><br>
  <button id="prevMonthBtn" class="date-btn">ä¸Šæœˆ</button>
  <button id="nextMonthBtn" class="date-btn">ä¸‹æœˆ</button>
  <button id="thisYearBtn" class="date-btn">æ•´å¹´</button>
  <button id="lastYearBtn" class="date-btn">å»å¹´</button>
</div>

<div class="slogan">é¸æ“‡æ‚¨æƒ³è¦çœ‹çš„(ç›´çƒå°æ±º)</div>
    
<div style="text-align:center">
  <button id="queryMonthBtn">ğŸ“Š æ˜ç´°</button>
  <button id="queryMonthExchangeBtn">ğŸ’° å¹£åˆ¥</button>
  <button id="queryMonthPayBtn">ğŸ’³ ä»˜æ¬¾</button>
  <button id="queryMonthTypeBtn">ğŸ“‚ åˆ†é¡</button>
  <button id="queryMonthUserBtn">ğŸ‘¤ è¨˜å¸³è€…</button>
  <button id="queryMonthStoreBtn">ğŸ“‹ åº—å®¶</button>
</div>

<div id="loading" style="display:none;">â³ æ­£åœ¨è¼‰å…¥ä¸­,è«‹ç¨ä¾¯...</div>

<div id="queryResult"></div>

<div id="drillDownArea"></div>

<div class="chart-container">
  <canvas id="chartCanvas"></canvas>
</div>

<div id="sixMonthArea"></div>

<div class="chart-container" id="trendContainer" style="display:none;">
  <canvas id="categoryTrendCanvas"></canvas>
</div>

<div id="exportArea" style="text-align:center; margin-top:40px; display:none; padding-bottom: 100px;">
  <button id="exportCsvBtn" class="green-btn">ğŸ“¤ åŒ¯å‡º CSV</button>
  <button id="exportExcelBtn" class="excel-btn">ğŸ“Š åŒ¯å‡º Excel</button>
  <button id="exportPdfBtn" class="pdf-btn">ğŸ“„ åŒ¯å‡º PDF</button>
</div>

<script>
let API_URL = ""; let VERSION = "V"; let LIFF_IDq = ""; let currentUser = null; 
let chartInstance = null; let trendChartInstance = null;
let currentFullLabel = ""; 
let currentCommandName = ""; 
let globalStats = { total: 0, count: 0 };
let orderMaps = { "ä»˜æ¬¾": [], "åˆ†é¡": [], "å¹£åˆ¥": [], "è¨˜å¸³è€…": [] };
let lastFetchedRows = []; // å„²å­˜æœ€å¾Œä¸€æ¬¡æŠ“å–çš„åŸå§‹è³‡æ–™ä¾›ä¸‹é‘½ä½¿ç”¨

const SETTINGS_URL = "https://script.google.com/macros/s/AKfycby2-1JvsriAfskOJXHyMB8HASeuMs7V-mJOQneD73Q_dJN56NhbWH0Dj8Ldu0LcfxMe/exec";

async function initApp(){
  try {
    const res = await fetch(SETTINGS_URL + "?type=query&command=è¨­å®š");
    const json = await res.json();
    API_URL = json.data.API_URL.trim();
    VERSION = json.data.D10.trim();
    LIFF_IDq = json.data.D12.trim();
    document.getElementById("version").textContent = VERSION;
    fetchOrderLists();
    await liff.init({ liffId: LIFF_IDq });
    if (!liff.isLoggedIn()) liff.login();
    const profile = await liff.getProfile();
    currentUser = profile.displayName;
    setDefaultDateRange();
  } catch (e) { console.error(e); }
}
initApp();

async function fetchOrderLists() {
  try {
    const res = await fetch(API_URL + "?type=query&command=æ¸…å–®");
    const json = await res.json();
    if (json.list) {
      orderMaps["ä»˜æ¬¾"] = (json.list.payment || []).map(item => item.name);
      orderMaps["åˆ†é¡"] = (json.list.type || []).map(item => item.name);
      orderMaps["å¹£åˆ¥"] = (json.list.currency || []).map(item => item.name);
      orderMaps["è¨˜å¸³è€…"] = (json.list.user || []).map(item => item.name);
    }
  } catch (e) {}
}

function setDefaultDateRange() {
  const now = new Date();
  document.getElementById("startDate").value = toInputDate(new Date(now.getFullYear(), now.getMonth(), 1));
  document.getElementById("endDate").value = toInputDate(new Date(now.getFullYear(), now.getMonth() + 1, 0));
}
function toInputDate(d) { return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; }

function changeMonth(offset) {
  const current = new Date(document.getElementById("startDate").value);
  const newFirst = new Date(current.getFullYear(), current.getMonth() + offset, 1);
  const newLast = new Date(newFirst.getFullYear(), newFirst.getMonth() + 1, 0);
  document.getElementById("startDate").value = toInputDate(newFirst);
  document.getElementById("endDate").value = toInputDate(newLast);
}
document.getElementById("prevMonthBtn").onclick = () => changeMonth(-1);
document.getElementById("nextMonthBtn").onclick = () => changeMonth(1);
document.getElementById("thisYearBtn").onclick = () => {
  const y = new Date().getFullYear();
  document.getElementById("startDate").value = `${y}-01-01`; document.getElementById("endDate").value = `${y}-12-31`;
};
document.getElementById("lastYearBtn").onclick = () => {
  const y = new Date().getFullYear() - 1;
  document.getElementById("startDate").value = `${y}-01-01`; document.getElementById("endDate").value = `${y}-12-31`;
};

document.querySelectorAll("button[id^='queryMonth']").forEach(btn => {
  btn.onclick = () => {
    currentFullLabel = btn.innerText; 
    currentCommandName = btn.innerText.replace(/[^\u4e00-\u9fa5]/g, '');
    sendQuery(currentCommandName);
  };
});

async function sendQuery(command) {
  document.getElementById("loading").style.display = "block";
  document.getElementById("queryResult").innerHTML = "";
  document.getElementById("drillDownArea").innerHTML = ""; // æ¸…ç©ºä¸‹é‘½å€åŸŸ
  document.getElementById("sixMonthArea").innerHTML = "";
  document.getElementById("trendContainer").style.display = "none";
  if(chartInstance) chartInstance.destroy();
  if(trendChartInstance) trendChartInstance.destroy();

  const body = { type: "query", command, version: VERSION, startDate: document.getElementById("startDate").value + " 00:00:00", endDate: document.getElementById("endDate").value + " 23:59:59" };
  try {
    const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(body) });
    const json = await res.json();
    renderResult(command, json);
  } catch (e) { alert("è®€å–å¤±æ•—"); }
  finally { document.getElementById("loading").style.display = "none"; }
}

function renderResult(command, json) {
  let mainHtml = "";
  const adminUser = "Betty Yi";
  
  // 1. æ¬Šé™éæ¿¾ä¸¦å¿«å– rows ä¾›é»æ“Šä½¿ç”¨
  let rows = (currentUser === adminUser) ? (json.rows || []) : (json.rows || []).filter(r => r[3] === currentUser);
  lastFetchedRows = rows; 

  const filterStart = new Date(document.getElementById("startDate").value + " 00:00:00");
  const filterEnd = new Date(document.getElementById("endDate").value + " 23:59:59");

  const allChartContainers = document.querySelectorAll(".chart-container");
  const mainChartContainer = allChartContainers[0]; 
  const trendContainer = document.getElementById("trendContainer");

  if (command === "æ˜ç´°") {
    let displayRows = rows.filter(r => {
      const d = new Date(r[4]);
      return d >= filterStart && d <= filterEnd;
    });

    if (displayRows.length > 0) {
      if (mainChartContainer) mainChartContainer.style.display = "block";
      mainHtml += `<h5>${currentFullLabel}æŸ¥è©¢;æ¨™é¡ŒæŒ‰ä¸‹å³å¯æ’åº</h5><table id="mainTable"><thead><tr><th>è¨˜å¸³è€…</th><th>æ—¥æœŸ</th><th>åº—å®¶</th><th>æ”¶å…¥</th><th>æ”¯å‡º</th><th>åŒ¯ç‡</th><th>é‡‘é¡</th><th>ä»˜æ¬¾</th><th>åˆ†é¡</th><th>é™„è¨»</th><th>å‚™è¨»</th><th>å¹£åˆ¥</th></tr></thead><tbody>`;
      displayRows.forEach(r => { 
        mainHtml += `<tr><td>${r[3]||''}</td><td>${new Date(r[4]).toLocaleDateString()}</td><td>${r[8]||''}</td><td class="numeric">${(Number(r[11])||0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td><td class="numeric">${(Number(r[12])||0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td><td>${r[13]||1}</td><td class="numeric">${(Number(r[5])||0).toLocaleString()}</td><td>${r[7]||''}</td><td>${r[6]||''}</td><td>${r[9]||''}</td><td>${r[10]||''}</td><td>${r[14]||''}</td></tr>`; 
      });
      mainHtml += `</tbody></table>`;
      globalStats.total = displayRows.reduce((s, r) => s + Number(r[5] || 0), 0);
      globalStats.count = displayRows.length;
      mainHtml += `<div class="total">ğŸ“Œ ç¸½é‡‘é¡ï¼š${globalStats.total.toLocaleString()} å…ƒ ğŸ“ ç¸½ç­†æ•¸ï¼š${globalStats.count} ç­†</div>`;

      const dailyData = {};
      displayRows.forEach(r => {
        const d = new Date(r[4]).toLocaleDateString();
        if(!dailyData[d]) dailyData[d] = { sum: 0, ex: Number(r[13]||1) };
        dailyData[d].sum += Number(r[5]||0);
      });
      const sortedDates = Object.keys(dailyData).sort((a,b)=>new Date(a)-new Date(b));
      renderDetailChart(sortedDates, sortedDates.map(d=>dailyData[d].sum), sortedDates.map(d=>dailyData[d].ex));
    } else {
      if (mainChartContainer) mainChartContainer.style.display = "none";
      mainHtml = `<div class="total" style="background-color: #f8f9fa !important; color: #666 !important;">ğŸ”˜ æ‰€é¸å€é–“ ${document.getElementById("startDate").value} è‡³ ${document.getElementById("endDate").value} ç„¡æ˜ç´°è³‡æ–™</div>`;
    }
    
  } else {
    // 2. çµ±è¨ˆæ¨¡å¼
    const keyMap = { "åˆ†é¡":6, "ä»˜æ¬¾":7, "åº—å®¶":8, "å¹£åˆ¥":14, "è¨˜å¸³è€…":3 };
    const idx = keyMap[command];
    
    let counts = {};
    let itemCounts = {};
    let totalItems = 0;
    
    rows.forEach(r => { 
      const d = new Date(r[4]);
      if (d >= filterStart && d <= filterEnd) {
        let v = (r[idx] && String(r[idx]).trim() !== "") ? String(r[idx]).trim() : "æœªçŸ¥";
        counts[v] = (counts[v] || 0) + Number(r[5] || 0); 
        itemCounts[v] = (itemCounts[v] || 0) + 1;
        totalItems++;
      }
    });
    
    let labels = Object.keys(counts);
    let values = Object.values(counts);
    let totalSum = values.reduce((a, b) => a + b, 0);

    if (totalSum !== 0) {
      if (mainChartContainer) mainChartContainer.style.display = "block";

      mainHtml += `<h5>${currentFullLabel}åˆ†æçµ±è¨ˆ;æ¨™é¡ŒæŒ‰ä¸‹å³å¯æ’åº</h5><table id="mainTable"><thead><tr><th>${command}</th><th class="numeric">é‡‘é¡</th><th class="numeric">ä½”æ¯”</th><th class="numeric">ç­†æ•¸(æ˜ç´°)</th></tr></thead><tbody>`;
      
      labels.forEach((l) => { 
        let val = counts[l];
        let count = itemCounts[l];
        // ç­†æ•¸åŠ ä¸Š onclick äº‹ä»¶å‘¼å« showDrillDown
        mainHtml += `<tr><td>${l}</td><td class="numeric">${val.toLocaleString()}</td><td class="numeric">${((val/totalSum)*100).toFixed(1)}%</td><td class="numeric"><span class="drill-down-link" onclick="showDrillDown('${command}', '${l}')">${count.toLocaleString()}</span></td></tr>`; 
      });
      mainHtml += `</tbody></table>`;
      
      globalStats.total = totalSum;
      globalStats.count = labels.length; 
      mainHtml += `<div class="total"> ğŸ·ï¸ ${command}ç¸½é …ç›®ï¼š${globalStats.count} é … ğŸ“Œ ç¸½é‡‘é¡ï¼š${globalStats.total.toLocaleString()} å…ƒ  ğŸ“ ç¸½ç­†æ•¸ï¼š${totalItems.toLocaleString()} ç­†  </div>`;
      renderChart("pie", labels, values);
    } else {
      if (mainChartContainer) mainChartContainer.style.display = "none";
      mainHtml = `<div class="total" style="background-color: #f8f9fa !important; color: #666 !important;">ğŸ”˜ æ‰€é¸å€é–“ ${document.getElementById("startDate").value} è‡³ ${document.getElementById("endDate").value} ç„¡çµ±è¨ˆæ•¸æ“š</div>`;
    }

    // 3. ğŸ“… è¿‘ 6 å€‹æœˆè¶¨å‹¢
    if (json.months_6m) {
      const months = json.months_6m;
      const dataMap = {};
      rows.forEach(r => {
        let key = (r[idx] && String(r[idx]).trim() !== "") ? String(r[idx]).trim() : "æœªçŸ¥";
        const d = new Date(r[4]);
        const ym = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        if (months.includes(ym)) {
          if (!dataMap[key]) {
            dataMap[key] = {};
            months.forEach(m => dataMap[key][m] = 0);
          }
          dataMap[key][ym] += (Number(r[5]) || 0);
        }
      });
      let monthlySums = new Array(months.length).fill(0);
      let grandTotal = 0;
      let sixHtml = `<h5>ğŸ“… ä¾çµæŸæ—¥æœŸçš„è¿‘ 6 å€‹æœˆ${currentCommandName}çµ±è¨ˆ</h5><table id="table6m"><thead><tr><th>${currentCommandName}</th>`;
      months.forEach(m => sixHtml += `<th>${m}</th>`);
      sixHtml += `<th>ç¸½é¡</th></tr></thead><tbody>`;
      Object.keys(dataMap).forEach(item => {
        let rSum = 0; 
        sixHtml += `<tr><td>${item}</td>`;
        months.forEach((m, i) => { 
          let val = dataMap[item][m] || 0; 
          rSum += val; 
          monthlySums[i] += val; 
          sixHtml += `<td class="numeric">${val.toLocaleString()}</td>`; 
        });
        grandTotal += rSum; 
        sixHtml += `<td class="numeric"><strong>${rSum.toLocaleString()}</strong></td></tr>`;
      });
      sixHtml += `</tbody><tfoot><tr><td>æ¯æœˆç¸½è¨ˆ</td>`;
      monthlySums.forEach(sum => sixHtml += `<td class="numeric">${sum.toLocaleString()}</td>`);
      sixHtml += `<td class="numeric">${grandTotal.toLocaleString()}</td></tr></tfoot></table>`;
      document.getElementById("sixMonthArea").innerHTML = sixHtml;
      makeTableSortable(document.getElementById("table6m"), command);
      document.getElementById("trendContainer").style.display = "block";
      renderCategoryTrend(months, dataMap);
    }
  }
  document.getElementById("queryResult").innerHTML = mainHtml;
  makeTableSortable(document.getElementById("mainTable"), command);
  document.getElementById("exportArea").style.display = "block";
}

// æ–°å¢å‡½æ•¸ï¼šé¡¯ç¤ºä¸‹é‘½æ˜ç´°è³‡æ–™æµ
function showDrillDown(command, itemValue) {
  const keyMap = { "åˆ†é¡":6, "ä»˜æ¬¾":7, "åº—å®¶":8, "å¹£åˆ¥":14, "è¨˜å¸³è€…":3 };
  const idx = keyMap[command];
  const filterStart = new Date(document.getElementById("startDate").value + " 00:00:00");
  const filterEnd = new Date(document.getElementById("endDate").value + " 23:59:59");

  // 1. éæ¿¾å‡ºç¬¦åˆæ¢ä»¶çš„åŸå§‹è³‡æ–™
  let filteredRows = lastFetchedRows.filter(r => {
    const d = new Date(r[4]);
    let v = (r[idx] && String(r[idx]).trim() !== "") ? String(r[idx]).trim() : "æœªçŸ¥";
    return (d >= filterStart && d <= filterEnd) && (v === itemValue);
  });
  
  // 2. è¨ˆç®—è©²é …ç›®çš„å°è¨ˆèˆ‡ç­†æ•¸
  let subTotal = filteredRows.reduce((sum, r) => sum + Number(r[5] || 0), 0);
  let subCount = filteredRows.length;

  // 3. çµ„è£æ¨™é¡Œ (åŠ ä¸Šé‡‘é¡åŠç­†æ•¸)
  let drillHtml = `<h5>ğŸ“‡ ${command}æ˜ç´°ï¼š<span style="color: blue; font-weight: bold;">${itemValue}</span>ğŸ“ é‡‘é¡ï¼š${subTotal.toLocaleString()} å…ƒ ğŸ“ ç­†æ•¸ï¼š${subCount.toLocaleString()} ç­†</h5>`;
  
  // 4. ç”Ÿæˆè¡¨æ ¼
  drillHtml += `<table id="drillTable"><thead><tr><th>è¨˜å¸³è€…</th><th>æ—¥æœŸ</th><th>åº—å®¶</th><th>æ”¶å…¥</th><th>æ”¯å‡º</th><th>åŒ¯ç‡</th><th>é‡‘é¡</th><th>ä»˜æ¬¾</th><th>åˆ†é¡</th><th>é™„è¨»</th><th>å‚™è¨»</th><th>å¹£åˆ¥</th></tr></thead><tbody>`;
  
  filteredRows.forEach(r => {
    // åˆ¤æ–·å“ªäº›æ¬„ä½éœ€è¦è®Šè—è‰²åŠ ç²—
    const isUser = (command === "è¨˜å¸³è€…");
    const isStore = (command === "åº—å®¶");
    const isPay = (command === "ä»˜æ¬¾");
    const isType = (command === "åˆ†é¡");
    const isCurr = (command === "å¹£åˆ¥");

    drillHtml += `<tr>
      <td style="${isUser ? 'color: blue; font-weight: bold;' : ''}">${r[3]||''}</td>
      <td>${new Date(r[4]).toLocaleDateString()}</td>
      <td style="${isStore ? 'color: blue; font-weight: bold;' : ''}">${r[8]||''}</td>
      <td class="numeric">${(Number(r[11])||0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
      <td class="numeric">${(Number(r[12])||0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
      <td>${r[13]||1}</td>
      <td class="numeric">${(Number(r[5])||0).toLocaleString()}</td>
      <td style="${isPay ? 'color: blue; font-weight: bold;' : ''}">${r[7]||''}</td>
      <td style="${isType ? 'color: blue; font-weight: bold;' : ''}">${r[6]||''}</td>
      <td>${r[9]||''}</td>
      <td>${r[10]||''}</td>
      <td style="${isCurr ? 'color: blue; font-weight: bold;' : ''}">${r[14]||''}</td>
    </tr>`;
  });
  
  drillHtml += `</tbody></table>`;
  const drillArea = document.getElementById("drillDownArea");
  drillArea.innerHTML = drillHtml;
  
  makeTableSortable(document.getElementById("drillTable"), "æ˜ç´°");
  drillArea.scrollIntoView({ behavior: 'smooth' });
}

function renderDetailChart(labels, sums, rates) {
  const ctx = document.getElementById("chartCanvas").getContext("2d");
  chartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'é‡‘é¡åˆè¨ˆ', data: sums, backgroundColor: 'rgba(54, 162, 235, 0.6)', yAxisID: 'y' },
        { label: 'æ¯æ—¥åŒ¯ç‡æœ€å¤§å€¼', data: rates, type: 'line', borderColor: '#d9534f', borderWidth: 4, yAxisID: 'y1', pointRadius: 5 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: 2,
      animation: false,
      scales: {
        y: { type: 'linear', position: 'left', title: { display: true, text: 'é‡‘é¡', font: {size:20} } },
        y1: { type: 'linear', position: 'right', title: { display: true, text: 'åŒ¯ç‡', font: {size:20}, color: "red" }, grid: { drawOnChartArea: false } }
      },
      plugins: { legend: { labels: { font: { size: 24, weight: 'bold' } } } }
    }
  });
}

function renderChart(type, labels, values) {
  const ctx = document.getElementById("chartCanvas").getContext("2d");
  chartInstance = new Chart(ctx, {
    type,
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: labels.map((_, i) => `hsl(${i * 360 / labels.length}, 70%, 60%)`)
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: 1.5,
      animation: false,
      plugins: {
        legend: { labels: { font: { size: 28, weight: 'bold' }, color: '#333' } },
        tooltip: { bodyFont: { size: 24 }, titleFont: { size: 26, weight: 'bold' } }
      }
    }
  });
}

function renderCategoryTrend(months, map) {
  const ctx = document.getElementById("categoryTrendCanvas").getContext("2d");
  const datasets = Object.keys(map).map((k, i) => {
    const color = `hsl(${i * 360 / Object.keys(map).length}, 70%, 50%)`;
    return {
      label: k,
      data: months.map(m => map[k][m] || 0),
      borderColor: color,
      backgroundColor: color,
      fill: false,
      tension: 0.1,
      pointRadius: 6,
      pointStyle: 'circle'
    };
  });
  trendChartInstance = new Chart(ctx, {
    type: "line",
    data: { labels: months, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: 1.8,
      animation: false,
      plugins: {
        legend: { 
          labels: { 
            font: { size: 24, weight: 'bold' },
            usePointStyle: true,
            boxWidth: 20
          } 
        },
        tooltip: { 
          bodyFont: { size: 22 },
          intersect: false,
          mode: 'index'
        }
      },
      scales: {
        x: { ticks: { font: { size: 20, weight: 'bold' } } },
        y: { ticks: { font: { size: 20, weight: 'bold' } } }
      }
    }
  });
}

function makeTableSortable(table, currentCommand) { 
  if (!table) return; 
  const headers = table.querySelectorAll("thead th"); 
  headers.forEach((th, i) => { 
    th.addEventListener("click", () => { 
      const tbody = table.querySelector("tbody"); 
      const rows = Array.from(tbody.querySelectorAll("tr")); 
      const isAsc = th.dataset.order !== "asc"; 
      th.dataset.order = isAsc ? "asc" : "desc"; 
      const colTitle = th.innerText.replace(/[â–²â–¼]/g, '').trim(); 
      rows.sort((a, b) => { 
        let v1 = a.cells[i].innerText.replace(/,/g, '').replace('%',''); 
        let v2 = b.cells[i].innerText.replace(/,/g, '').replace('%',''); 
        const orderList = orderMaps[colTitle] || (colTitle === currentCommand ? orderMaps[currentCommand] : null); 
        if (orderList && orderList.length > 0) { 
          let idx1 = orderList.indexOf(v1); let idx2 = orderList.indexOf(v2); 
          idx1 = idx1 === -1 ? 999 : idx1; idx2 = idx2 === -1 ? 999 : idx2; 
          return isAsc ? idx1 - idx2 : idx2 - idx1; 
        } 
        if (!isNaN(parseFloat(v1)) && !isNaN(parseFloat(v2))) return isAsc ? parseFloat(v1) - parseFloat(v2) : parseFloat(v2) - parseFloat(v1); 
        return isAsc ? v1.localeCompare(v2) : v2.localeCompare(v1); 
      }); 
      rows.forEach(r => tbody.appendChild(r)); 
      headers.forEach(h => h.innerText = h.innerText.replace(/[â–²â–¼]/g, '')); 
      th.innerText += isAsc ? " â–²" : " â–¼"; 
    }); 
  }); 
}

function getExportFilename(type) {
  const now = new Date();
  const Y = now.getFullYear();
  const M = String(now.getMonth() + 1).padStart(2, '0');
  const D = String(now.getDate()).padStart(2, '0');
  const h = String(now.getHours()).padStart(2, '0');
  const m = String(now.getMinutes()).padStart(2, '0');
  const s = String(now.getSeconds()).padStart(2, '0');
  const ts = `${Y}-${M}-${D}-${h}-${m}-${s}`;
  return `éåŒ¯ä¸å¯${type}_${currentCommandName}çµ±è¨ˆ_${ts}`;
}

function getExportHeader() {
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;
  return [["ğŸ” éåŒ¯ä¸å¯çµ±è¨ˆå ±è¡¨"], [`åŒ¯å‡ºæ™‚é–“ï¼š${new Date().toLocaleString()}`], [`æ—¥æœŸå€é–“ï¼š${start} ~ ${end}`], [`çµ±è¨ˆå ±è¡¨ï¼šé¸æ“‡${currentCommandName}çµ±è¨ˆ`], []];
}

function getTableData(tableId, isMain = false) {
  const table = document.getElementById(tableId);
  if (!table) return null;
  const data = [];
  const tbody = table.querySelector("tbody");
  const headers = [];
  for (let cell of table.querySelector("thead").rows[0].cells) headers.push(cell.innerText.replace(/[â–²â–¼]/g, '').trim());
  data.push(headers);
  Array.from(tbody.rows).forEach(row => {
    const rowData = [];
    for (let cell of row.cells) rowData.push(cell.innerText);
    data.push(rowData);
  });
  if (isMain) {
    data.push([`ç•¶æœŸ${currentCommandName}çµ±è¨ˆç¸½é¡`, globalStats.total.toLocaleString()]);
    data.push([`ç•¶æœŸ${currentCommandName}çµ±è¨ˆç­†æ•¸`, globalStats.count]);
  }
  const tfoot = table.querySelector("tfoot");
  if (tfoot) { for (let row of tfoot.rows) { const rowData = []; for (let cell of row.cells) rowData.push(cell.innerText); data.push(rowData); } }
  return data;
}

document.getElementById("exportExcelBtn").onclick = () => {
  const header = getExportHeader();
  const mainData = getTableData("mainTable", true);
  const sixMonthData = getTableData("table6m");
  let allRows = [...header];
  if (mainData) { allRows.push([`[ ç•¶æœŸ${currentCommandName}çµ±è¨ˆ ]`]); allRows = allRows.concat(mainData); }
  if (sixMonthData) { allRows.push([], [`[ æœ€è¿‘ 6 å€‹æœˆ${currentCommandName}è¶¨å‹¢çµ±è¨ˆ ]`]); allRows = allRows.concat(sixMonthData); }
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(allRows);
  XLSX.utils.book_append_sheet(wb, ws, `${currentCommandName}çµ±è¨ˆ`); 
  XLSX.writeFile(wb, `${getExportFilename('EXCEL')}.xlsx`);
};

document.getElementById("exportCsvBtn").onclick = () => {
  let content = "\ufeff";
  const header = getExportHeader();
  const mainData = getTableData("mainTable", true);
  const sixMonthData = getTableData("table6m");
  let allRows = [...header];
  if (mainData) { allRows.push([`[ ç•¶å‰${currentCommandName}çµ±è¨ˆ ]`]); allRows = allRows.concat(mainData); }
  if (sixMonthData) { allRows.push([], [`[ æœ€è¿‘ 6 å€‹æœˆ${currentCommandName}è¶¨å‹¢çµ±è¨ˆ ]`]); allRows = allRows.concat(sixMonthData); }
  content += allRows.map(row => row.map(cell => `"${cell}"`).join(",")).join("\n");
  const blob = new Blob([content], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a"); link.href = URL.createObjectURL(blob);
  link.download = `${getExportFilename('CSV')}.csv`; link.click();
};

document.getElementById("exportPdfBtn").onclick = async () => {
  const originalTitle = document.title;
  const now = new Date();
  const Y = now.getFullYear();
  const M = String(now.getMonth() + 1).padStart(2, '0');
  const D = String(now.getDate()).padStart(2, '0');
  const h = String(now.getHours()).padStart(2, '0');
  const m = String(now.getMinutes()).padStart(2, '0');
  const s = String(now.getSeconds()).padStart(2, '0');
  const ts = `${Y}-${M}-${D}-${h}-${m}-${s}`;
  const newTitle = `éåŒ¯ä¸å¯PDF_${currentCommandName}çµ±è¨ˆ_${ts}`;
  document.title = newTitle;
  setTimeout(() => {
    window.print();
    setTimeout(() => { document.title = originalTitle; }, 2000);
  }, 250);
};
</script>
</body>
</html>
