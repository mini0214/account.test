<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>é›¶ç”¨é‡‘æ”¯å‡ºå¸³ç°¿</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 50px; }
    h3 { font-size: 50px; text-align: center; margin-bottom: 50px; }
    .date-inputs { font-size: 50px; text-align: center; margin-bottom: 20px; }
    .date-inputs input { font-size: 50px; margin: 0 10px; padding: 5px; }
    button { font-size: 40px; margin: 5px; padding: 10px 20px; border-radius: 8px; cursor: pointer; background-color: #0056b3; color: white; }
    .date-btn { font-size: 40px; margin: 5px; padding: 10px 20px; border-radius: 8px; cursor: pointer; background-color: #888; color: white; }
    .green-btn { font-size: 40px; margin: 5px; padding: 10px 20px; border-radius: 8px; cursor: pointer; background-color: #28a745; color: white; }
    h5 { font-size: 28px; margin: 40px 0 10px 0; text-align: center; font-weight: bold; color: #333; }
    table { font-size: 26px; border-collapse: collapse; width: 100%; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
    th { background-color: #f2f2f2; cursor: pointer; }
    th:hover { background-color: #e9e9e9; }
    tfoot { background-color: #fff9c4; font-weight: bold; }
    .numeric { text-align: right; }
    .total { font-size: 32px; font-weight: bold; color: #d9534f; margin: 20px 0; text-align: center; border: 3px solid #d9534f; padding: 15px; border-radius: 12px; background-color: #fff5f5; }
    canvas { display: block; margin: 20px auto; width: 850px; height: 600px; }
    #loading { font-size: 38px; text-align: center; margin: 20px; }
  </style>
</head>
<body>

<h3>ğŸ”é<span style="color: blue;">çœ‹</span><span>/</span><span style="color: green;">åŒ¯</span>ä¸å¯.[<span id="version"></span>]</h3>

<div class="date-inputs">
  é–‹å§‹æ—¥æœŸï¼š<input type="date" id="startDate"><br>
  çµæŸæ—¥æœŸï¼š<input type="date" id="endDate"><br>
  <button id="prevMonthBtn" class="date-btn">ä¸Šæœˆ</button>
  <button id="nextMonthBtn" class="date-btn">ä¸‹æœˆ</button>
</div>

<div style="text-align:center">
  <button id="queryMonthBtn">ğŸ“Š æ˜ç´°</button>
  <button id="queryMonthPayBtn">ğŸ’³ ä»˜æ¬¾</button>
  <button id="queryMonthTypeBtn">ğŸ“‚ åˆ†é¡</button>
  <button id="queryMonthStoreBtn">ğŸ“‹ åº—å®¶</button>
</div>

<div id="loading" style="display:none;">â³ è¼‰å…¥ä¸­...</div>

<div id="queryResult"></div>
<canvas id="chartCanvas"></canvas>
<div id="sixMonthArea"></div>
<canvas id="categoryTrendCanvas"></canvas>

<div id="exportArea" style="text-align:center; margin-top:20px; display:none;">
  <button id="exportCsvBtn" class="green-btn">ğŸ“¤ åŒ¯å‡ºCSV</button>
</div>

<script>
let API_URL = ""; 
let VERSION = "V"; 
let LIFF_IDq = "";
let currentUser = null; 
let chartInstance = null;
let FALLBACK_GAS_SETTINGS_URL = "https://script.google.com/macros/s/AKfycby2-1JvsriAfskOJXHyMB8HASeuMs7V-mJOQneD73Q_dJN56NhbWH0Dj8Ldu0LcfxMe/exec";

async function initApp(){
  try {
    const res = await fetch(FALLBACK_GAS_SETTINGS_URL + "?type=query&command=è¨­å®š");
    const json = await res.json();
    const settings = json.data;
    API_URL = settings.API_URL.trim();
    VERSION = settings.D10.trim();
    LIFF_IDq = settings.D12.trim();
    document.getElementById("version").textContent = VERSION;
    
    await liff.init({ liffId: LIFF_IDq });
    if (!liff.isLoggedIn()) liff.login();
    const profile = await liff.getProfile();
    currentUser = profile.displayName;
    
    setDefaultDateRange(); // åˆå§‹åŒ–æ—¥æœŸ
  } catch (e) { console.error(e); }
}
initApp();

// --- ä¿®æ­£å¾Œçš„æ—¥æœŸè™•ç† ---
function setDefaultDateRange() {
  const now = new Date();
  // æœ¬æœˆç¬¬ä¸€å¤©
  const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
  // æœ¬æœˆæœ€å¾Œä¸€å¤©
  const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
  
  document.getElementById("startDate").value = toInputDate(firstDay);
  document.getElementById("endDate").value = toInputDate(lastDay);
}

function toInputDate(d) {
  // ä¿®æ­£ï¼šæ‰‹å‹•æ‹¼æ¥æœ¬åœ°æ—¥æœŸçš„ YYYY-MM-DDï¼Œé¿å… toISOString() çš„æ™‚å€åç§»å•é¡Œ
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${y}-${m}-${day}`;
}

// æŸ¥è©¢äº‹ä»¶
document.querySelectorAll("button[id^='queryMonth']").forEach(btn => {
  btn.onclick = () => sendQuery(btn.innerText.replace(/[^\u4e00-\u9fa5]/g, ''));
});

async function sendQuery(command) {
  document.getElementById("loading").style.display = "block";
  document.getElementById("queryResult").innerHTML = "";
  document.getElementById("sixMonthArea").innerHTML = "";
  if(chartInstance) chartInstance.destroy();
  if(window.categoryTrendChart) window.categoryTrendChart.destroy();

  const body = {
    type: "query", command, version: VERSION,
    startDate: document.getElementById("startDate").value + " 00:00:00",
    endDate: document.getElementById("endDate").value + " 23:59:59"
  };

  try {
    const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(body) });
    const json = await res.json();
    renderResult(command, json);
  } catch (e) { alert("ç³»çµ±å¿™ç¢Œä¸­"); }
  finally { document.getElementById("loading").style.display = "none"; }
}

function renderResult(command, json) {
  let mainHtml = "";
  const adminUser = "Betty Yi";
  let rows = (currentUser === adminUser) ? json.rows : (json.rows || []).filter(r => r[3] === currentUser);

  // 1. ç•¶æœˆçµ±è¨ˆ
  if (command === "æ˜ç´°") {
    mainHtml += `<h5>ğŸ“Š æŸ¥è©¢æ˜ç´°</h5><table id="mainTable"><thead><tr><th>è¨˜å¸³è€…</th><th>æ—¥æœŸ</th><th>åº—å®¶</th><th class="numeric">é‡‘é¡</th><th>ä»˜æ¬¾</th><th>åˆ†é¡</th></tr></thead><tbody>`;
    rows.forEach(r => {
      mainHtml += `<tr><td>${r[3]}</td><td>${new Date(r[4]).toLocaleDateString()}</td><td>${r[8]}</td><td class="numeric">${Number(r[5]).toLocaleString()}</td><td>${r[7]}</td><td>${r[6]}</td></tr>`;
    });
    mainHtml += `</tbody></table>`;
  } else {
    const keyMap = { "åˆ†é¡":6, "ä»˜æ¬¾":7, "åº—å®¶":8 };
    const colKey = keyMap[command];
    let counts = {};
    rows.forEach(r => { let v = r[colKey] || "å…¶ä»–"; counts[v] = (counts[v] || 0) + Number(r[5] || 0); });
    let labels = Object.keys(counts);
    let values = Object.values(counts);
    let totalSum = values.reduce((a, b) => a + b, 0);

    mainHtml += `<h5>ğŸ“‚ ${command}çµ±è¨ˆ</h5><table id="mainTable"><thead><tr><th>${command}</th><th class="numeric">é‡‘é¡</th><th class="numeric">ä½”æ¯”</th></tr></thead><tbody>`;
    labels.forEach((l, i) => {
      mainHtml += `<tr><td>${l}</td><td class="numeric">${values[i].toLocaleString()}</td><td class="numeric">${((values[i]/totalSum)*100).toFixed(1)}%</td></tr>`;
    });
    mainHtml += `</tbody></table>`;
    mainHtml += `<div class="total">ğŸ’° ç¸½é¡ï¼š${totalSum.toLocaleString()} å…ƒ</div>`;
    renderChart("pie", labels, values);
  }
  document.getElementById("queryResult").innerHTML = mainHtml;
  makeTableSortable(document.getElementById("mainTable"));

  // 2. 6 å€‹æœˆçµ±è¨ˆè¡¨ (å«ç¸½é¡èˆ‡æ’åº)
  const sixKey = { "åˆ†é¡":"categories_6m", "ä»˜æ¬¾":"payments_6m", "åº—å®¶":"stores_6m" }[command];
  if (json.months_6m && json[sixKey]) {
    const months = json.months_6m;
    const dataMap = json[sixKey];
    let monthlySums = new Array(months.length).fill(0);
    let grandTotal = 0;

    let sixHtml = `<h5>ğŸ“… æœ€è¿‘ 6 å€‹æœˆ${command}çµ±è¨ˆ (é»æ“Šæ¨™é¡Œæ’åº)</h5>`;
    sixHtml += `<table id="table6m"><thead><tr><th>${command}</th>`;
    months.forEach(m => sixHtml += `<th>${m}</th>`);
    sixHtml += `<th>ç¸½é¡</th></tr></thead><tbody>`;

    Object.keys(dataMap).forEach(itemKey => {
      let rowSum = 0;
      sixHtml += `<tr><td>${itemKey}</td>`;
      months.forEach((m, idx) => {
        let val = dataMap[itemKey][m] || 0;
        rowSum += val; monthlySums[idx] += val;
        sixHtml += `<td class="numeric">${val.toLocaleString()}</td>`;
      });
      grandTotal += rowSum;
      sixHtml += `<td class="numeric"><strong>${rowSum.toLocaleString()}</strong></td></tr>`;
    });
    sixHtml += `</tbody><tfoot><tr><td>æ¯æœˆç¸½è¨ˆ</td>`;
    monthlySums.forEach(sum => sixHtml += `<td class="numeric">${sum.toLocaleString()}</td>`);
    sixHtml += `<td class="numeric">${grandTotal.toLocaleString()}</td></tr></tfoot></table>`;

    document.getElementById("sixMonthArea").innerHTML = sixHtml;
    makeTableSortable(document.getElementById("table6m"));
    renderCategoryTrend(months, dataMap);
  }
  document.getElementById("exportArea").style.display = "block";
}

function makeTableSortable(table) {
  if (!table) return;
  const headers = table.querySelectorAll("thead th");
  headers.forEach((th, colIdx) => {
    th.addEventListener("click", () => {
      const tbody = table.querySelector("tbody");
      const rows = Array.from(tbody.querySelectorAll("tr"));
      const isAsc = th.dataset.order !== "asc";
      th.dataset.order = isAsc ? "asc" : "desc";
      rows.sort((a, b) => {
        let aVal = a.cells[colIdx].innerText.replace(/,/g, '');
        let bVal = b.cells[colIdx].innerText.replace(/,/g, '');
        return isAsc ? (parseFloat(aVal) - parseFloat(bVal) || aVal.localeCompare(bVal)) : (parseFloat(bVal) - parseFloat(aVal) || bVal.localeCompare(aVal));
      });
      rows.forEach(r => tbody.appendChild(r));
    });
  });
}

function renderChart(type, labels, values) {
  const ctx = document.getElementById("chartCanvas").getContext("2d");
  chartInstance = new Chart(ctx, {
    type: type,
    data: { labels, datasets: [{ data: values, backgroundColor: labels.map((_,i)=>`hsl(${i*360/labels.length},70%,60%)`) }] },
    options: { plugins: { legend: { labels: { font: { size: 24 } } } } }
  });
}

function renderCategoryTrend(months, map) {
  const ctx = document.getElementById("categoryTrendCanvas").getContext("2d");
  const datasets = Object.keys(map).map((k, i) => ({
    label: k, data: months.map(m => map[k][m] || 0), borderColor: `hsl(${i*360/Object.keys(map).length},70%,50%)`, tension: 0.2
  }));
  window.categoryTrendChart = new Chart(ctx, { type: "line", data: { labels: months, datasets } });
}
</script>
</body>
</html>
