<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>é›¶ç”¨é‡‘æ”¯å‡ºå¸³ç°¿</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 30px; background-color: #f9f9f9; }
    h3 { font-size: 50px; text-align: center; margin-bottom: 50px; }
    .date-inputs { font-size: 40px; text-align: center; margin-bottom: 20px; }
    .date-inputs input { font-size: 40px; margin: 0 10px; padding: 5px; }
    button { font-size: 36px; margin: 5px; padding: 10px 20px; border-radius: 8px; cursor: pointer; background-color: #0056b3; color: white; border: none; }
    .date-btn { background-color: #666; }
    .green-btn { background-color: #28a745; }
    .pdf-btn { background-color: #d9534f; }
    .excel-btn { background-color: #1d6f42; }
    
    h5 { font-size: 32px; margin: 40px 0 10px 0; text-align: center; font-weight: bold; }
    table { font-size: 22px; border-collapse: collapse; width: 100%; margin-top: 15px; background: white; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background-color: #eee; cursor: pointer; white-space: nowrap; position: relative; }
    th:hover { background-color: #ddd; }
    
    .total, tfoot { background-color: #888 !important; color: white !important; font-weight: bold; }
    .total {
      font-size: 36px; margin: 20px 0; text-align: center; 
      border: 3px solid white; padding: 20px; border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    tfoot td { border: 1px solid white !important; }

    .numeric { text-align: right; }
    canvas { display: block; margin: 30px auto; width: 900px; height: 600px; }
    #loading { font-size: 40px; text-align: center; color: #0056b3; font-weight: bold; margin: 30px; }
    
    @media print { button, .date-inputs, h3 { display: none !important; } }
  </style>
</head>
<body>

<h3>ğŸ”é<span style="color: blue;">çœ‹</span><span>/</span><span style="color: green;">åŒ¯</span>ä¸å¯.[<span id="version"></span>]</h3>

<div class="date-inputs">
  é–‹å§‹æ—¥æœŸï¼š<input type="date" id="startDate"><br>
  çµæŸæ—¥æœŸï¼š<input type="date" id="endDate"><br>
  <button id="prevMonthBtn" class="date-btn">ä¸Šæœˆ</button>
  <button id="nextMonthBtn" class="date-btn">ä¸‹æœˆ</button>
  <button id="thisYearBtn" class="date-btn">æ•´å¹´</button>
  <button id="lastYearBtn" class="date-btn">å»å¹´</button>
</div>

<div style="text-align:center">
  <button id="queryMonthBtn">ğŸ“Š æ˜ç´°</button>
  <button id="queryMonthPayBtn">ğŸ’³ ä»˜æ¬¾</button>
  <button id="queryMonthTypeBtn">ğŸ“‚ åˆ†é¡</button>
  <button id="queryMonthStoreBtn">ğŸ“‹ åº—å®¶</button>
  <button id="queryMonthExchangeBtn">ğŸ’° å¹£åˆ¥</button>
  <button id="queryMonthUserBtn">ğŸ‘¤ è¨˜å¸³è€…</button>
</div>

<div id="loading" style="display:none;">â³ æ­£åœ¨å¥—ç”¨æ¬Šé‡æ’åºä¸­...</div>

<div id="queryResult"></div>
<canvas id="chartCanvas"></canvas>
<div id="sixMonthArea"></div>
<canvas id="categoryTrendCanvas"></canvas>

<div id="exportArea" style="text-align:center; margin-top:40px; display:none; padding-bottom: 100px;">
  <button id="exportCsvBtn" class="green-btn">ğŸ“¤ åŒ¯å‡º CSV</button>
  <button id="exportExcelBtn" class="excel-btn">ğŸ“Š åŒ¯å‡º Excel</button>
  <button id="exportPdfBtn" class="pdf-btn">ğŸ“„ åŒ¯å‡º PDF</button>
</div>

<script>
let API_URL = ""; let VERSION = "V"; let LIFF_IDq = ""; let currentUser = null; 
let chartInstance = null; let trendChartInstance = null;
let orderMaps = { "ä»˜æ¬¾": [], "åˆ†é¡": [], "å¹£åˆ¥": [], "è¨˜å¸³è€…": [] }; // å­˜å„²å¾Œå°æ¬Šé‡é †åº

const SETTINGS_URL = "https://script.google.com/macros/s/AKfycby2-1JvsriAfskOJXHyMB8HASeuMs7V-mJOQneD73Q_dJN56NhbWH0Dj8Ldu0LcfxMe/exec";

async function initApp(){
  try {
    const res = await fetch(SETTINGS_URL + "?type=query&command=è¨­å®š");
    const json = await res.json();
    API_URL = json.data.API_URL.trim();
    VERSION = json.data.D10.trim();
    LIFF_IDq = json.data.D12.trim();
    document.getElementById("version").textContent = VERSION;
    
    // åŒæ­¥æŠ“å–å¾Œå°ã€Œæ¸…å–®ã€å®šç¾©çš„é †åº
    fetchOrderLists();

    await liff.init({ liffId: LIFF_IDq });
    if (!liff.isLoggedIn()) liff.login();
    const profile = await liff.getProfile();
    currentUser = profile.displayName;
    setDefaultDateRange();
  } catch (e) { console.error(e); }
}
initApp();

async function fetchOrderLists() {
  try {
    const res = await fetch(API_URL + "?type=query&command=æ¸…å–®");
    const json = await res.json();
    if (json.list) {
      orderMaps["ä»˜æ¬¾"] = (json.list.payment || []).map(item => item.name);
      orderMaps["åˆ†é¡"] = (json.list.type || []).map(item => item.name);
      orderMaps["å¹£åˆ¥"] = (json.list.currency || []).map(item => item.name);
      orderMaps["è¨˜å¸³è€…"] = (json.list.user || []).map(item => item.name);
    }
  } catch (e) { console.log("ç„¡æ³•ç²å–æ¬Šé‡æ¸…å–®ï¼Œå°‡æ¡ç”¨ä¸€èˆ¬æ’åº"); }
}

function setDefaultDateRange() {
  const now = new Date();
  document.getElementById("startDate").value = toInputDate(new Date(now.getFullYear(), now.getMonth(), 1));
  document.getElementById("endDate").value = toInputDate(new Date(now.getFullYear(), now.getMonth() + 1, 0));
}

function toInputDate(d) {
  return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
}

// æ—¥æœŸæ§åˆ¶é‚è¼¯
document.getElementById("prevMonthBtn").onclick = () => changeMonth(-1);
document.getElementById("nextMonthBtn").onclick = () => changeMonth(1);
document.getElementById("thisYearBtn").onclick = () => {
  const y = new Date().getFullYear();
  document.getElementById("startDate").value = `${y}-01-01`;
  document.getElementById("endDate").value = `${y}-12-31`;
};
document.getElementById("lastYearBtn").onclick = () => {
  const y = new Date().getFullYear() - 1;
  document.getElementById("startDate").value = `${y}-01-01`;
  document.getElementById("endDate").value = `${y}-12-31`;
};

function changeMonth(offset) {
  const current = new Date(document.getElementById("startDate").value);
  const newFirst = new Date(current.getFullYear(), current.getMonth() + offset, 1);
  const newLast = new Date(newFirst.getFullYear(), newFirst.getMonth() + 1, 0);
  document.getElementById("startDate").value = toInputDate(newFirst);
  document.getElementById("endDate").value = toInputDate(newLast);
}

document.querySelectorAll("button[id^='queryMonth']").forEach(btn => {
  btn.onclick = () => sendQuery(btn.innerText.replace(/[^\u4e00-\u9fa5]/g, ''));
});

async function sendQuery(command) {
  document.getElementById("loading").style.display = "block";
  document.getElementById("queryResult").innerHTML = "";
  document.getElementById("sixMonthArea").innerHTML = "";
  if(chartInstance) chartInstance.destroy();
  if(trendChartInstance) trendChartInstance.destroy();

  const body = {
    type: "query", command, version: VERSION,
    startDate: document.getElementById("startDate").value + " 00:00:00",
    endDate: document.getElementById("endDate").value + " 23:59:59"
  };

  try {
    const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(body) });
    const json = await res.json();
    renderResult(command, json);
  } catch (e) { alert("è®€å–å¤±æ•—"); }
  finally { document.getElementById("loading").style.display = "none"; }
}

function renderResult(command, json) {
  let mainHtml = "";
  const adminUser = "Betty Yi";
  let rows = (currentUser === adminUser) ? json.rows : (json.rows || []).filter(r => r[3] === currentUser);

  // 1. æ¸²æŸ“ä¸»çµ±è¨ˆè¡¨ (åŒ…å« 12 æ¬„ä½æ˜ç´°)
  if (command === "æ˜ç´°") {
    mainHtml += `<h5>ğŸ“Š æŸ¥è©¢æ˜ç´° (ä¾å¾Œå°é †åºæ’åº)</h5><table id="mainTable"><thead><tr>
      <th>è¨˜å¸³è€…</th><th>æ—¥æœŸ</th><th>åº—å®¶</th><th>æ”¶å…¥</th><th>æ”¯å‡º</th><th>åŒ¯ç‡</th><th>é‡‘é¡</th><th>ä»˜æ¬¾</th><th>åˆ†é¡</th><th>é™„è¨»</th><th>å‚™è¨»</th><th>å¹£åˆ¥</th>
    </tr></thead><tbody>`;
    rows.forEach(r => {
      mainHtml += `<tr>
        <td>${r[3]}</td><td>${new Date(r[4]).toLocaleDateString()}</td><td>${r[8]}</td>
        <td class="numeric">${(Number(r[12])||0).toLocaleString()}</td>
        <td class="numeric">${(Number(r[5])||0).toLocaleString()}</td>
        <td>${r[13]||1}</td><td class="numeric">${(Number(r[11])||0).toLocaleString()}</td>
        <td>${r[7]}</td><td>${r[6]}</td><td>${r[9]||''}</td><td>${r[10]||''}</td><td>${r[14]}</td>
      </tr>`;
    });
    mainHtml += `</tbody></table>`;
    const total = rows.reduce((s, r) => s + Number(r[5] || 0), 0);
    mainHtml += `<div class="total">ğŸ’° æ”¯å‡ºç¸½é¡ï¼š${total.toLocaleString()} å…ƒ | ğŸ“ ç­†æ•¸ï¼š${rows.length} ç­†</div>`;
  } else {
    const keyMap = { "åˆ†é¡":6, "ä»˜æ¬¾":7, "åº—å®¶":8, "å¹£åˆ¥":14, "è¨˜å¸³è€…":3 };
    const idx = keyMap[command];
    let counts = {};
    rows.forEach(r => { let v = r[idx] || "å…¶ä»–"; counts[v] = (counts[v] || 0) + Number(r[5] || 0); });
    let labels = Object.keys(counts);
    let values = Object.values(counts);
    let totalSum = values.reduce((a, b) => a + b, 0);

    mainHtml += `<h5>ğŸ“‚ ${command}åˆ†æçµ±è¨ˆ</h5><table id="mainTable"><thead><tr><th>${command}</th><th class="numeric">é‡‘é¡</th><th class="numeric">ä½”æ¯”</th></tr></thead><tbody>`;
    labels.forEach((l, i) => {
      mainHtml += `<tr><td>${l}</td><td class="numeric">${values[i].toLocaleString()}</td><td class="numeric">${((values[i]/totalSum)*100).toFixed(1)}%</td></tr>`;
    });
    mainHtml += `</tbody></table><div class="total">ğŸ’° ${command}ç¸½é¡ï¼š${totalSum.toLocaleString()} å…ƒ | ğŸ“ ç­†æ•¸ï¼š${rows.length} ç­†</div>`;
    renderChart("pie", labels, values);
  }
  document.getElementById("queryResult").innerHTML = mainHtml;
  makeTableSortable(document.getElementById("mainTable"), command);

  // 2. 6 å€‹æœˆè¡¨æ ¼æ¸²æŸ“
  const sixKey = { "åˆ†é¡":"categories_6m", "ä»˜æ¬¾":"payments_6m", "åº—å®¶":"stores_6m", "å¹£åˆ¥":"exchanges_6m", "è¨˜å¸³è€…":"users_6m" }[command];
  if (json.months_6m && json[sixKey]) {
    const months = json.months_6m;
    const dataMap = json[sixKey];
    let monthlySums = new Array(months.length).fill(0);
    let grandTotal = 0;

    let sixHtml = `<h5>ğŸ“… æœ€è¿‘ 6 å€‹æœˆ${command}çµ±è¨ˆ (å«è‡ªè‡ªå®šç¾©æ’åº)</h5><table id="table6m"><thead><tr><th>${command}</th>`;
    months.forEach(m => sixHtml += `<th>${m}</th>`);
    sixHtml += `<th>ç¸½é¡</th></tr></thead><tbody>`;

    Object.keys(dataMap).forEach(item => {
      let rSum = 0;
      sixHtml += `<tr><td>${item}</td>`;
      months.forEach((m, i) => {
        let val = dataMap[item][m] || 0;
        rSum += val; monthlySums[i] += val;
        sixHtml += `<td class="numeric">${val.toLocaleString()}</td>`;
      });
      grandTotal += rSum;
      sixHtml += `<td class="numeric"><strong>${rSum.toLocaleString()}</strong></td></tr>`;
    });
    sixHtml += `</tbody><tfoot><tr><td>æ¯æœˆç¸½è¨ˆ</td>`;
    monthlySums.forEach(sum => sixHtml += `<td class="numeric">${sum.toLocaleString()}</td>`);
    sixHtml += `<td class="numeric">${grandTotal.toLocaleString()}</td></tr></tfoot></table>`;
    document.getElementById("sixMonthArea").innerHTML = sixHtml;
    makeTableSortable(document.getElementById("table6m"), command);
    renderCategoryTrend(months, dataMap);
  }
  document.getElementById("exportArea").style.display = "block";
}

// --- é€²éšæ’åºé‚è¼¯ï¼šåŒ…å«æ¬Šé‡æª¢æŸ¥ ---
function makeTableSortable(table, currentCommand) {
  if (!table) return;
  const headers = table.querySelectorAll("thead th");
  headers.forEach((th, i) => {
    th.addEventListener("click", () => {
      const tbody = table.querySelector("tbody");
      const rows = Array.from(tbody.querySelectorAll("tr"));
      const isAsc = th.dataset.order !== "asc";
      th.dataset.order = isAsc ? "asc" : "desc";
      
      const colTitle = th.innerText.replace(/[â–²â–¼]/g, '').trim();

      rows.sort((a, b) => {
        let v1 = a.cells[i].innerText.replace(/,/g, '').replace('%','');
        let v2 = b.cells[i].innerText.replace(/,/g, '').replace('%','');

        // 1. æª¢æŸ¥æ˜¯å¦ç‚ºã€Œæœ‰æ¬Šé‡å®šç¾©ã€çš„æ¬„ä½ (ä»˜æ¬¾æ–¹å¼ã€åˆ†é¡ã€å¹£åˆ¥ã€è¨˜å¸³è€…)
        const orderList = orderMaps[colTitle] || (colTitle === currentCommand ? orderMaps[currentCommand] : null);
        
        if (orderList && orderList.length > 0) {
          let idx1 = orderList.indexOf(v1);
          let idx2 = orderList.indexOf(v2);
          // è‹¥ä¸åœ¨æ¸…å–®ä¸­ï¼Œæ”¾åˆ°æœ€å¾Œé¢
          idx1 = idx1 === -1 ? 999 : idx1;
          idx2 = idx2 === -1 ? 999 : idx2;
          return isAsc ? idx1 - idx2 : idx2 - idx1;
        }

        // 2. ä¸€èˆ¬æ•¸å€¼æ’åº
        if (!isNaN(parseFloat(v1)) && !isNaN(parseFloat(v2))) {
          return isAsc ? parseFloat(v1) - parseFloat(v2) : parseFloat(v2) - parseFloat(v1);
        }

        // 3. ä¸€èˆ¬æ–‡å­—æ’åº
        return isAsc ? v1.localeCompare(v2) : v2.localeCompare(v1);
      });

      rows.forEach(r => tbody.appendChild(r));
      headers.forEach(h => h.innerText = h.innerText.replace(/[â–²â–¼]/g, ''));
      th.innerText += isAsc ? " â–²" : " â–¼";
    });
  });
}

function renderChart(type, labels, values) {
  const ctx = document.getElementById("chartCanvas").getContext("2d");
  chartInstance = new Chart(ctx, {
    type: type,
    data: { labels, datasets: [{ data: values, backgroundColor: labels.map((_,i)=>`hsl(${i*360/labels.length},70%,60%)`) }] },
    options: { plugins: { legend: { labels: { font: { size: 22 } } } } }
  });
}

function renderCategoryTrend(months, map) {
  const ctx = document.getElementById("categoryTrendCanvas").getContext("2d");
  const datasets = Object.keys(map).map((k, i) => ({
    label: k, data: months.map(m => map[k][m] || 0), borderColor: `hsl(${i*360/Object.keys(map).length},70%,50%)`, tension: 0.2
  }));
  trendChartInstance = new Chart(ctx, { type: "line", data: { labels: months, datasets } });
}

// åŒ¯å‡ºåŠŸèƒ½
document.getElementById("exportCsvBtn").onclick = () => {
  const table = document.getElementById("mainTable");
  let csv = "\ufeff";
  for (let row of table.rows) {
    let rowData = [];
    for (let cell of row.cells) rowData.push('"' + cell.innerText + '"');
    csv += rowData.join(",") + "\n";
  }
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `æ”¯å‡ºçµ±è¨ˆ_${new Date().getTime()}.csv`;
  link.click();
};

document.getElementById("exportExcelBtn").onclick = () => {
  const table = document.getElementById("mainTable");
  const wb = XLSX.utils.table_to_book(table, { sheet: "æ˜ç´°è³‡æ–™" });
  XLSX.writeFile(wb, `æ”¯å‡ºçµ±è¨ˆ_${new Date().getTime()}.xlsx`);
};

document.getElementById("exportPdfBtn").onclick = () => window.print();
</script>
</body>
</html>
