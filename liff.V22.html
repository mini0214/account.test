<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>é›¶ç”¨é‡‘æ”¯å‡ºå¸³ç°¿</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    /* ä¿æŒæ‚¨åŸå§‹çš„ 50px å¤§å­—é«”é¢¨æ ¼ï¼Œé©åˆé•·è¼©æˆ–æ‰‹æ©Ÿæ“ä½œ */
    body { font-family: Arial, sans-serif; padding: 30px; }
    h3 { font-size: 50px; text-align: center; margin-bottom: 40px; }
    label { font-size: 45px; font-weight: bold; margin-top: 25px; display: inline-block; }
    input, select { font-size: 45px; padding: 20px; width: 100%; margin-top: 10px; border-radius: 12px; border: 1px solid #ccc; box-sizing: border-box; }
    button { font-size: 50px; padding: 25px; border-radius: 12px; background-color: #4CAF50; color: white; border: none; width: 100%; margin-top: 30px; cursor: pointer; }
    .toggle-btn { width: 48%; opacity: 0.6; }
    .active { opacity: 1; border: 5px solid #333; }
    #loadingMsg { display: none; font-size: 40px; color: red; text-align: center; margin-top: 20px; }
    #suggestions { position: absolute; background: white; border: 1px solid #ccc; max-height: 400px; overflow-y: auto; z-index: 1000; width: 90%; }
    #suggestions div { padding: 20px; font-size: 40px; border-bottom: 1px solid #eee; }
  </style>
</head>
<body>

  <h3>ğŸ’°é<span style="color: red;">è¨˜</span>ä¸å¯.[<span id="version">V</span>]</h3>

  <form id="expenseForm">
    <div class="form-row"><label>æ—¥æœŸï¼š</label><input type="date" id="date"></div>
    
    <div class="form-row" style="position:relative;">
      <label>åº—å®¶ï¼š</label>
      <input type="text" id="store" placeholder="é¸å¡«;è‡ªå‹•æç¤º" autocomplete="off">
      <div id="suggestions"></div>
    </div>

    <div style="display: flex; justify-content: space-between; gap: 10px;">
      <button type="button" id="btnIncome" class="toggle-btn" style="background:#000080;">æ”¶å…¥</button>
      <button type="button" id="btnPayout" class="toggle-btn active" style="background:#f44336;">æ”¯å‡º</button>
    </div>

    <input type="number" id="income" placeholder="è«‹è¼¸å…¥æ”¶å…¥" style="display:none; color:blue;" step="0.01">
    <input type="number" id="payout" placeholder="è«‹è¼¸å…¥æ”¯å‡º" style="display:block; color:red;" step="0.01">

    <label>å¹£åˆ¥ï¼š</label><select id="currency" required></select>
    <label>ä»˜æ¬¾ï¼š</label><select id="payment" required></select>
    <label>åˆ†é¡ï¼š</label><select id="type" required></select>
    
    <label>é™„è¨»ï¼š</label><input type="text" id="note" placeholder="é¸å¡«">
    <label>å‚™è¨»ï¼š</label><input type="text" id="memo" placeholder="é¸å¡«">

    <button type="submit" id="submitBtn">é€å‡º</button>
    <div id="loadingMsg">â³ è³‡æ–™å‚³è¼¸ä¸­ï¼Œè«‹ç¨å€™...</div>
  </form>

  <script>
    let API_URL = "";
    let VERSION = "";
    let LIFF_ID = "";
    let USER_PROFILE = null;
    let SETTINGS_URL = "https://script.google.com/macros/s/AKfycbxRBB4WtTy1DTG57vQPQzNdX1NxF_RG-iMVGR28SrQlRqf7bkbtBbgmgAWJcFRgq01hAw/exec";
    let STORE_LIST = [];

    // ğŸš€ å„ªåŒ– 1: åˆå§‹åŒ–ä¸¦è¡Œè™•ç†
    async function initApp() {
      try {
        // å…ˆæ‹¿åŸºç¤è¨­å®š
        const res = await fetch(`${SETTINGS_URL}?type=query&command=è¨­å®š`);
        const result = await res.json();
        API_URL = result.data.API_URL;
        VERSION = result.data.D10;
        LIFF_ID = result.data.D11;
        document.getElementById("version").textContent = VERSION;

        // ä¸¦è¡Œå•Ÿå‹• LIFF èˆ‡ è¼‰å…¥æ¸…å–®
        await Promise.all([
          liff.init({ liffId: LIFF_ID }).then(async () => {
            if (!liff.isLoggedIn()) liff.login();
            USER_PROFILE = await liff.getProfile();
          }),
          loadLists()
        ]);
      } catch (err) { alert("åˆå§‹åŒ–å¤±æ•—: " + err.message); }
    }

    async function loadLists() {
      const [listRes, storeRes] = await Promise.all([
        fetch(`${API_URL}?type=query&command=æ¸…å–®`),
        fetch(`${API_URL}?type=query&command=åº—å®¶`)
      ]);
      const listData = await listRes.json();
      const storeData = await storeRes.json();

      window.otherList = listData.list;
      STORE_LIST = storeData.storeList;

      // å¡«å……ä¸‹æ‹‰é¸å–® (ä¿ç•™æ‚¨çš„åŒ¯ç‡é‚è¼¯)
      renderSelect("currency", listData.list.currency, c => `${c.name}:${c.exchange}`, c => c.exchange, true);
      renderSelect("payment", listData.list.payment, p => p.name, p => p.name);
      renderSelect("type", listData.list.type, t => t.name, t => t.name);
    }

    function renderSelect(id, data, textFn, valFn, isCur = false) {
      const el = document.getElementById(id);
      el.innerHTML = '<option value="">è«‹é¸æ“‡</option>';
      data.forEach(item => {
        const opt = document.createElement("option");
        opt.value = valFn(item);
        opt.textContent = textFn(item);
        if(isCur) opt.dataset.name = item.name;
        el.appendChild(opt);
      });
    }

    // ğŸš€ å„ªåŒ– 2: é€å‡ºèˆ‡æŸ¥è©¢é‚è¼¯ï¼ˆå®Œæ•´ä¿ç•™æ‰€æœ‰æ¬„ä½åŠŸèƒ½ï¼‰
    document.getElementById("expenseForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const submitBtn = document.getElementById("submitBtn");
      const loadingMsg = document.getElementById("loadingMsg");

      submitBtn.disabled = true;
      loadingMsg.style.display = "block";

      try {
        const currencySelect = document.getElementById("currency");
        const incomeVal = document.getElementById("income").value || 0;
        const payoutVal = document.getElementById("payout").value || 0;
        const exchangeRate = Number(currencySelect.value);
        const exchangeName = currencySelect.selectedOptions[0]?.dataset.name || "";

        const payload = {
          version: VERSION,
          userId: USER_PROFILE.userId,
          displayName: USER_PROFILE.displayName,
          inputDate: document.getElementById("date").value,
          store: document.getElementById("store").value,
          income: incomeVal,
          payout: payoutVal,
          currency: exchangeRate,
          amount: Math.round((incomeVal - payoutVal) * exchangeRate),
          payment: document.getElementById("payment").value,
          type: document.getElementById("type").value,
          note: document.getElementById("note").value,
          memo: document.getElementById("memo").value,
          createdAt: new Date().toLocaleString(),
          exchange: exchangeName
        };

        // 1. é€å‡ºè³‡æ–™
        const postRes = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
        const postResult = await postRes.json();

        if (postResult.ok) {
          // 2. å®Œæ•´æŸ¥è©¢ç¸½é¡ (ä¿ç•™æ‰€æœ‰æ‚¨åŸæœ¬è¦æ±‚çš„æ¬„ä½)
          const userEnc = encodeURIComponent(payload.displayName);
          const totalRes = await fetch(`${API_URL}?type=query&command=ç¸½é¡&user=${userEnc}`);
          const totalData = await totalRes.json();

          // âœ… é€™è£¡å®Œæ•´æ‰¾å›æ‚¨è¦çš„è®Šæ•¸
          const thisTotal = totalData?.thisMonth?.total ?? 0;
          const lastTotal = totalData?.lastMonth?.total ?? 0;
          const changeText = totalData?.changeText || "";
          const changetxt = totalData?.changetxt || "";
          const types = totalData?.types || [];
          const payments = totalData?.payments || [];

          // 3. çµ„åˆè¨Šæ¯ (ä¿ç•™å®Œæ•´æ ¼å¼)
          let msg = `éè¨˜ä¸å¯.è¨˜å¸³æˆåŠŸï¼\n` +
                    `ğŸ‘¤ è¨˜å¸³è€…ï¼š${payload.displayName}\n` +
                    `ğŸ’° é‡‘é¡ï¼š${payload.amount}\n` +
                    `ğŸ“† æœ¬æœŸç¸½é¡ï¼šğŸ’°${thisTotal}\n`;

          if (lastTotal !== 0) {
            msg += `ğŸ“† ä¸ŠæœŸç¸½é¡ï¼šğŸ’°${lastTotal}\nğŸ§® ç¸½é¡ä½”æ¯”ï¼š${changeText}\nğŸ“¢ ${changetxt}\n`;
          }

          // ğŸ”¹ ä»˜æ¬¾çµ±è¨ˆ
          if (payments.length && window.otherList.payment) {
            msg += `\nğŸ’³ ä»˜æ¬¾æœ¬æœŸç¸½é¡:\n`;
            window.otherList.payment.forEach(ref => {
              const found = payments.find(p => p.payment === ref.name);
              if (found) msg += `â–¶ï¸ ${ref.name}ï¼šğŸ’°${found.thisTotal}\n`;
            });
          }

          // ğŸ”¹ åˆ†é¡çµ±è¨ˆ
          if (types.length && window.otherList.type) {
            msg += `\nğŸ“‚ åˆ†é¡æœ¬æœŸç¸½é¡:\n`;
            window.otherList.type.forEach(ref => {
              const found = types.find(t => t.type === ref.name);
              if (found) msg += `â–¶ï¸ ${ref.name}ï¼šğŸ’°${found.thisTotal}\n`;
            });
          }

          alert(msg);
          if (liff.isInClient()) {
            await liff.sendMessages([{ type: "text", text: msg }]);
          }

          document.getElementById("expenseForm").reset();
          document.getElementById("date").valueAsDate = new Date();
        }
      } catch (err) {
        alert("éŒ¯èª¤: " + err.message);
      } finally {
        submitBtn.disabled = false;
        loadingMsg.style.display = "none";
      }
    });

    // åº—å®¶æç¤ºé‚è¼¯ (ä¿ç•™ä¸¦å„ªåŒ–)
    document.getElementById("store").addEventListener("input", (e) => {
      const val = e.target.value.toLowerCase();
      const sugg = document.getElementById("suggestions");
      sugg.innerHTML = "";
      if (!val) return;
      const matches = STORE_LIST.filter(s => s.store.toLowerCase().includes(val));
      matches.forEach(m => {
        const div = document.createElement("div");
        div.textContent = m.store;
        div.onclick = () => {
          document.getElementById("store").value = m.store;
          if (m.type) document.getElementById("type").value = m.type;
          sugg.innerHTML = "";
        };
        sugg.appendChild(div);
      });
    });

    // æŒ‰éˆ•åˆ‡æ›
    document.getElementById("btnIncome").onclick = () => {
      document.getElementById("btnIncome").classList.add("active");
      document.getElementById("btnPayout").classList.remove("active");
      document.getElementById("income").style.display = "block";
      document.getElementById("payout").style.display = "none";
    };
    document.getElementById("btnPayout").onclick = () => {
      document.getElementById("btnPayout").classList.add("active");
      document.getElementById("btnIncome").classList.remove("active");
      document.getElementById("payout").style.display = "block";
      document.getElementById("income").style.display = "none";
    };

    window.onload = initApp;
  </script>
</body>
</html>
