<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>é›¶ç”¨é‡‘æ”¯å‡ºå¸³ç°¿</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* ä¿æŒæ‚¨åŸæœ‰çš„ CSS ä¸è®Š */
    body { font-family: Arial, sans-serif; padding: 50px; }
    h3 { font-size: 50px; text-align: center; margin-bottom: 50px; }
    label { font-size: 50px; font-weight: bold; display: inline-block; margin-top: 25px; white-space: nowrap; }
    input, select  { font-size: 50px; padding: 25px; width: 70%; margin-top: 5px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
    .form-row, .form-block { display: flex; align-items: center; margin: 20px 0; white-space: nowrap; }     
    button { font-size: 50px; padding: 25px; border-radius: 8px; background-color: #4CAF50; color: white; border: none; width: 100%; margin-top: 25px; transition: transform 0.2s ease, box-shadow 0.2s ease; cursor: pointer; }
    button:hover { transform: scale(1.05); }
    button:active { transform: scale(0.97); box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); }
    .toggle-btn { padding: 8px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 30px; opacity: 0.6; transition: opacity 0.2s, box-shadow 0.2s; }
    #btnIncome { background: #000080; color: white; }
    #btnPayout { background: #f44336; color: white; }
    .active { opacity: 1; box-shadow: 0 0 6px rgba(0,0,0,0.3); }
    .input-wrapper { position: relative; flex: 1; }
    #store { width: 100%; padding: 25px; font-size: 50px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
    #suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ccc; max-height: 200px; overflow-y: auto; display: none; z-index: 1000; }
    #suggestions div { padding: 20px; font-size: 50px; cursor: pointer; }
    #suggestions div:hover { background-color: #eee; }
  </style>
</head>
<body>

  <h3>ğŸ’°é<span style="color: red;">è¨˜</span>ä¸å¯.[<span id="version">V</span>]</h3>

  <form id="expenseForm">
    <div class="form-row">
      <label for="date">æ—¥æœŸï¼š</label>
      <input type="date" id="date">
    </div>    
  
    <div class="form-row store-row">
      <label for="store">åº—å®¶ï¼š</label>
      <div class="input-wrapper">
        <input type="text" id="store" placeholder="é¸å¡«;å¯è‡ªå‹•æç¤º">
        <div id="suggestions"></div>
      </div>
    </div>

    <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
      <button type="button" id="btnIncome" class="toggle-btn">æ”¶å…¥</button>
      <button type="button" id="btnPayout" class="toggle-btn active">æ”¯å‡º</button>
      <input type="number" id="income" placeholder="æ”¶å…¥é‡‘é¡" style="width:550px; color:blue; display:none;" step="0.01">
      <input type="number" id="payout" placeholder="æ”¯å‡ºé‡‘é¡" style="width:550px; color:red; display:inline-block;" step="0.01">
    </div>   

    <div class="form-row">
      <label for="currency">å¹£åˆ¥ï¼š</label>
      <select id="currency" required><option value="">è¼‰å…¥ä¸­...</option></select>
    </div>

    <div class="form-row">
      <label for="payment">ä»˜æ¬¾ï¼š</label>
      <select id="payment" required><option value="">è¼‰å…¥ä¸­...</option></select>
    </div>

    <div class="form-block">
      <label for="type">åˆ†é¡ï¼š</label>
      <select id="type" required><option value="">è¼‰å…¥ä¸­...</option></select>
    </div>

    <div class="form-row">
      <label for="note">é™„è¨»ï¼š</label>
      <input type="text" id="note" placeholder="é¸å¡«">
    </div>

    <div class="form-row">
      <label for="memo">å‚™è¨»ï¼š</label>
      <input type="text" id="memo" placeholder="é¸å¡«">
    </div>

    <button type="submit" id="submitBtn">é€å‡º</button>
    <div id="loadingMsg" style="display:none; font-size:40px; color:red; text-align:center; margin-top:20px;">
      â³ è³‡æ–™é€å‡ºä¸­ï¼Œè«‹ç¨å€™...
    </div>
  </form>

  <script>
    // 1. ä»‹é¢æ§åˆ¶é‚è¼¯
    const btnIncome = document.getElementById("income") ? document.getElementById("btnIncome") : null;
    const btnPayout = document.getElementById("payout") ? document.getElementById("btnPayout") : null;
    
    if(btnIncome && btnPayout) {
      btnIncome.addEventListener("click", () => {
        btnIncome.classList.add("active"); btnPayout.classList.remove("active");
        document.getElementById("income").style.display = "inline-block";
        document.getElementById("payout").style.display = "none";
      });
      btnPayout.addEventListener("click", () => {
        btnPayout.classList.add("active"); btnIncome.classList.remove("active");
        document.getElementById("payout").style.display = "inline-block";
        document.getElementById("income").style.display = "none";
      });
    }

    // 2. å…¨åŸŸè®Šæ•¸
    let FALLBACK_GAS_SETTINGS_URL = "https://script.google.com/macros/s/AKfycbwxqIKuk4VqHeib3Mi_xxE6yS5R8V55wyiQVIS6VgF6PEnNa93lVSoBBiX4OYksDuaiUw/exec";
    let API_URL = "";
    let VERSION = "V";
    let LIFF_IDa = "";
    let storeList = [];

    // ğŸ’¡ æ–°å¢ï¼šè¼”åŠ©ç¶²è·¯è«‹æ±‚å‡½å¼ (åŸæœ¬æ¼æ‰çš„)
    async function tryFetchText(url){
      const r = await fetch(url, { cache: 'no-store' });
      const text = await r.text();
      try { return { ok: true, json: JSON.parse(text) }; }
      catch(e){ return { ok: false, text }; }
    }

    // 3. è¨­å®šèˆ‡åˆå§‹åŒ–
    async function applySettings(settings) {
      API_URL = (settings.API_URL || "").trim();
      VERSION = (settings.D10 || "V").trim();
      LIFF_IDa = (settings.D11 || "").trim();
      document.getElementById("version").textContent = VERSION;
    }

    async function loadSettings() {
      const cached = localStorage.getItem("expense_main_settings");
      if (cached) {
        applySettings(JSON.parse(cached));
        updateSettingsInBackground(); 
        return;
      }
      return await updateSettingsInBackground();
    }

    async function updateSettingsInBackground() {
      const res = await tryFetchText(FALLBACK_GAS_SETTINGS_URL + "?type=query&command=è¨­å®š");
      if (res.ok && res.json.data) {
        localStorage.setItem("expense_main_settings", JSON.stringify(res.json.data));
        applySettings(res.json.data);
      }
    }

    async function initApp() {
      try {
        document.getElementById("date").valueAsDate = new Date();
        await loadSettings();

        // ğŸ’¡ ä¿®æ”¹ï¼šç¢ºä¿æ‹¿åˆ° LIFF ID æ‰åŸ·è¡Œ
        if (!LIFF_IDa) {
            // å¦‚æœå¿«å–æ²’æ‹¿åˆ°ï¼Œç­‰ 1 ç§’å†è©¦ä¸€æ¬¡
            await new Promise(r => setTimeout(r, 1000));
        }

        await liff.init({ liffId: LIFF_IDa });
        if (!liff.isLoggedIn()) liff.login();

        if (API_URL) {
          await Promise.all([loadListData(), loadStoreList()]);
        }
      } catch (err) {
        console.error("åˆå§‹åŒ–å¤±æ•—", err);
      }
    }

// 4. è³‡æ–™è¼‰å…¥é‚è¼¯ (å«å°æ•¸é»è‡ªå‹•ç¯©é¸å¹£åˆ¥åŠŸèƒ½)
    async function loadListData() {
      try {
        const res = await fetch(`${API_URL}?type=query&command=æ¸…å–®`);
        const data = await res.json();
        if (data.ok && data.list) {
          window.otherList = data.list;
          const currencySelect = document.getElementById("currency");
          const typeSelect = document.getElementById("type");
          const paymentSelect = document.getElementById("payment");
          const incomeInput = document.getElementById("income");
          const payoutInput = document.getElementById("payout");

          // ç‚ºæ¯å€‹å¹£åˆ¥åŠ ä¸Šæ˜¯å¦å…è¨±å°æ•¸çš„æ¨™è¨˜
          window.otherList.currency.forEach(c => {
            c.allowDecimal = c.exchange.toString().includes('.');
          });

          // âœ… æ¸²æŸ“å¹£åˆ¥é¸é …çš„å‡½å¼
          function renderCurrencyOptions(hasDecimal = false) {
            const currentVal = currencySelect.value;
            currencySelect.innerHTML = '<option value="">è«‹é¸æ“‡å¹£åˆ¥</option>';
            
            window.otherList.currency.forEach(c => {
              // ğŸ’¡ é—œéµé‚è¼¯ï¼šå¦‚æœæœ‰å°æ•¸é»ï¼Œåªé¡¯ç¤ºåŒ¯ç‡ä¹Ÿæœ‰å°æ•¸é»çš„å¹£åˆ¥
              if (hasDecimal && !c.allowDecimal) return; 

              const opt = document.createElement("option");
              opt.value = c.exchange;
              opt.textContent = `${c.name}:${c.exchange}`;
              opt.dataset.name = c.name;
              currencySelect.appendChild(opt);
            });
            // ç›¡é‡ä¿ç•™åŸæœ¬é¸å–çš„é …
            if (currentVal) currencySelect.value = currentVal;
          }

          // âœ… ç›£è½é‡‘é¡è¼¸å…¥ï¼Œæ±ºå®šæ˜¯å¦ç¯©é¸å¹£åˆ¥
          const handleAmountInput = (e) => {
            const hasDecimal = e.target.value.includes(".");
            renderCurrencyOptions(hasDecimal);
          };

          incomeInput.addEventListener("input", handleAmountInput);
          payoutInput.addEventListener("input", handleAmountInput);

          // åˆå§‹æ¸²æŸ“
          renderCurrencyOptions(false);

          // æ¸²æŸ“ åˆ†é¡ èˆ‡ ä»˜æ¬¾
          const fillSelect = (el, items) => {
            el.innerHTML = `<option value="">è«‹é¸æ“‡${el.id === 'type' ? 'åˆ†é¡' : 'ä»˜æ¬¾'}</option>`;
            items.forEach(i => {
              const opt = document.createElement("option");
              opt.value = i.name;
              opt.textContent = i.name;
              el.appendChild(opt);
            });
          };
          fillSelect(typeSelect, data.list.type);
          fillSelect(paymentSelect, data.list.payment);
        }
      } catch (err) {
        console.error("è¼‰å…¥æ¸…å–®å¤±æ•—", err);
      }
    }

    // 5. åº—å®¶æç¤ºé‚è¼¯ (ä¿æŒåŸæœ‰)
    document.getElementById("store").addEventListener("input", (e) => {
      const val = e.target.value.toLowerCase();
      const sugg = document.getElementById("suggestions");
      sugg.innerHTML = "";
      if (!val) { sugg.style.display = "none"; return; }
      const matches = storeList.filter(s => s.store && s.store.toLowerCase().includes(val));
      matches.forEach(m => {
        const div = document.createElement("div");
        div.textContent = m.store + (m.type ? `ï¼ˆ${m.type}ï¼‰` : "");
        div.onclick = () => {
          document.getElementById("store").value = m.store;
          if (m.type) document.getElementById("type").value = m.type;
          sugg.style.display = "none";
        };
        sugg.appendChild(div);
      });
      sugg.style.display = matches.length ? "block" : "none";
    });

    // 6. é€å‡ºé‚è¼¯
    document.getElementById("expenseForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const submitBtn = document.getElementById("submitBtn");
      submitBtn.disabled = true;
      document.getElementById("loadingMsg").style.display = "block";

      try {
        const profile = await liff.getProfile();
        const currencySelect = document.getElementById("currency");
        const incomeVal = document.getElementById("income").value || 0;
        const payoutVal = document.getElementById("payout").value || 0;
        const exchangeRate = Number(currencySelect.value);

        // âœ… æ‰‹å‹•æ ¼å¼åŒ–æ—¥æœŸï¼Œå›ºå®šç‚º YYYY-MM-DD HH:mm:ss
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const dd = String(now.getDate()).padStart(2, '0');
        const hh = String(now.getHours()).padStart(2, '0');
        const min = String(now.getMinutes()).padStart(2, '0');
        const ss = String(now.getSeconds()).padStart(2, '0');
        const formattedTime = `${yyyy}-${mm}-${dd} ${hh}:${min}:${ss}`;

        const payload = {
          version: VERSION,
          userId: profile.userId,
          displayName: profile.displayName,
          inputDate: document.getElementById("date").value,
          store: document.getElementById("store").value,
          income: incomeVal,
          payout: payoutVal,
          currency: exchangeRate,
          amount: Math.round((incomeVal - payoutVal) * exchangeRate),
          payment: document.getElementById("payment").value,
          type: document.getElementById("type").value,
          note: document.getElementById("note").value,
          memo: document.getElementById("memo").value,
          exchange: currencySelect.selectedOptions[0]?.dataset.name || "",
          createdAt: formattedTime // âœ… ä½¿ç”¨å›ºå®šæ ¼å¼
        };

        const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
        const result = await res.json();
        if (result.ok) {
          alert("è¨˜å¸³æˆåŠŸï¼");
          document.getElementById("expenseForm").reset();
          document.getElementById("date").valueAsDate = new Date();
        }
      } catch (err) {
        alert("é€å‡ºå¤±æ•—: " + err.message);
      } finally {
        submitBtn.disabled = false;
        document.getElementById("loadingMsg").style.display = "none";
      }
    });

    window.addEventListener("load", initApp);
  </script>
</body>
</html>

