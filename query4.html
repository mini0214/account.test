<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>é›¶ç”¨é‡‘æŸ¥è©¢</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial, sans-serif; padding: 30px; }
  h3 { font-size: 40px; text-align: center; margin-bottom: 30px; }
  button { font-size: 30px; padding: 15px 25px; margin: 5px; border-radius: 8px; cursor: pointer; }
  #queryResult { margin-top: 30px; }
  table { border-collapse: collapse; width: 100%; margin-top: 15px; font-size: 20px; }
  th, td { border: 1px solid #ddd; padding: 10px; text-align: center; cursor: pointer; }
  th { background-color: #f2f2f2; }
  .total { font-size: 28px; font-weight: bold; color: #d9534f; margin-top: 10px; }
</style>
</head>
<body>

<h3>é›¶ç”¨é‡‘æŸ¥è©¢ [<span id="version"></span>]</h3>

<button id="queryMonthBtn">ğŸ“Š æŸ¥è©¢æœ¬æœˆ</button>
<button id="queryMonthPayBtn">ğŸ’³ æŸ¥è©¢æœ¬æœˆä»˜æ¬¾</button>
<button id="queryMonthtypeBtn">â­• æŸ¥è©¢æœ¬æœˆåˆ†é¡</button>
<button id="queryMonthstoreBtn">ğŸ“‹ æŸ¥è©¢æœ¬æœˆåº—å®¶</button>

<div id="queryResult"></div>

<script>
const LIFF_ID = "2008096451-jPJ50MOY";
const VERSION = "T3";
const API_URL = "https://script.google.com/macros/s/AKfycbzp7z2jx-chJ15TGqCNhDuOaJrV92CEGYU-6XrA_qdIjeEg2lFmKwmPZcjfnBthcndbJw/exec";

document.getElementById("version").textContent = VERSION;

async function main() {
  await liff.init({ liffId: LIFF_ID });
  if (!liff.isLoggedIn()) liff.login();
}
main();

document.getElementById("queryMonthBtn").addEventListener("click", () => sendQuery("æœ¬æœˆ"));
document.getElementById("queryMonthtypeBtn").addEventListener("click", () => sendQuery("æœ¬æœˆåˆ†é¡"));
document.getElementById("queryMonthPayBtn").addEventListener("click", () => sendQuery("æœ¬æœˆä»˜æ¬¾"));
document.getElementById("queryMonthstoreBtn").addEventListener("click", () => sendQuery("æœ¬æœˆåº—å®¶"));

// ------------------ è¡¨æ ¼æ’åºå‡½æ•¸ ------------------
function sortTable(tableId, colIndex, numeric=false) {
  const table = document.getElementById(tableId);
  if (!table) return;
  let switching = true;
  let dir = "asc";
  while (switching) {
    switching = false;
    const rows = table.rows;
    for (let i = 1; i < rows.length - 1; i++) {
      let shouldSwitch = false;
      let x = rows[i].cells[colIndex].innerText.replace(/,/g,'');
      let y = rows[i + 1].cells[colIndex].innerText.replace(/,/g,'');
      if (numeric) { x = parseFloat(x); y = parseFloat(y); }
      if (dir === "asc" && x > y) { shouldSwitch = true; break; }
      if (dir === "desc" && x < y) { shouldSwitch = true; break; }
    }
    if (shouldSwitch) {
      rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
      switching = true;
    } else if (dir === "asc") { dir = "desc"; switching = true; }
  }
}

// ------------------ æŸ¥è©¢å‡½æ•¸ ------------------
async function sendQuery(command){
  const url = `${API_URL}?type=query&command=${encodeURIComponent(command)}&version=${VERSION}`;
  try {
    const res = await fetch(url);
    const json = await res.json();

    if (!json.ok) {
      document.getElementById("queryResult").innerHTML = `<p style="color:red">âŒ æŸ¥è©¢å¤±æ•—</p>`;
      return;
    }

    let html = "";

    // ---------------- æœ¬æœˆæ˜ç´° ----------------
    if (command === "æœ¬æœˆ" && json.rows) {
      html += `<table id="tableMain"><tr>
        <th onclick="sortTable('tableMain',0)">æ—¥æœŸ</th>
        <th onclick="sortTable('tableMain',1)">åº—å®¶</th>
        <th onclick="sortTable('tableMain',2,true)">æ”¶å…¥</th>
        <th onclick="sortTable('tableMain',3,true)">æ”¯å‡º</th>
        <th>å¹£åˆ¥</th><th onclick="sortTable('tableMain',5,true)">é‡‘é¡</th>
        <th>ä»˜æ¬¾</th><th>åˆ†é¡</th><th>é™„è¨»</th><th>å‚™è¨»</th>
      </tr>`;
      json.rows.forEach(r => {
        const dateStr = r[4] ? new Date(r[4]).toLocaleDateString("zh-TW") : "";
        html += `<tr>
          <td>${dateStr}</td>
          <td>${r[8]}</td>
          <td>${Number(r[11]).toLocaleString()}</td>
          <td>${Number(r[12]).toLocaleString()}</td>
          <td>${r[13]}</td>
          <td>${Number(r[5]).toLocaleString()}</td>
          <td>${r[7]}</td>
          <td>${r[6]}</td>
          <td>${r[9]}</td>
          <td>${r[10]}</td>
        </tr>`;
      });
      html += `</table>`;
      if (json.categories) html += `<canvas id="typeChart" width="400" height="300" style="margin-top:20px;"></canvas>`;
      html += `<div class="total">ğŸ“Œ æœ¬æœˆç¸½é¡ï¼š${Number(json.total || 0).toLocaleString()} å…ƒï¼ˆå…± ${json.rows.length} ç­†ï¼‰</div>`;
    }

    // ---------------- æœ¬æœˆåˆ†é¡ ----------------
    if (command === "æœ¬æœˆåˆ†é¡" && json.categories) {
      html += `<h4>â­• æœ¬æœˆåˆ†é¡çµ±è¨ˆ</h4>`;
      html += `<table id="tableType"><tr>
        <th onclick="sortTable('tableType',0)">åˆ†é¡æ–¹å¼</th>
        <th onclick="sortTable('tableType',1,true)">é‡‘é¡</th>
        <th>å æ¯”</th></tr>`;
      for (const [cat, amt] of Object.entries(json.categories)) {
        const percent = ((amt / json.total) * 100).toFixed(1);
        html += `<tr><td>${cat}</td><td>${Number(amt).toLocaleString()}</td><td>${percent}%</td></tr>`;
      }
      html += `</table>`;
      html += `<canvas id="typeChart" width="400" height="400" style="margin-top:20px;"></canvas>`;
      html += `<div class="total">ğŸ“Œ æœ¬æœˆç¸½é¡ï¼š${Number(json.total || 0).toLocaleString()} å…ƒï¼ˆå…± ${Object.keys(json.categories).length} ç­†åˆ†é¡ï¼‰</div>`;
    }

    // ---------------- æœ¬æœˆä»˜æ¬¾ ----------------
    if (command === "æœ¬æœˆä»˜æ¬¾" && json.payments) {
      html += `<h4>ğŸ’³ æœ¬æœˆä»˜æ¬¾çµ±è¨ˆ</h4>`;
      html += `<table id="tablePay"><tr>
        <th onclick="sortTable('tablePay',0)">ä»˜æ¬¾æ–¹å¼</th>
        <th onclick="sortTable('tablePay',1,true)">é‡‘é¡</th>
        <th>å æ¯”</th></tr>`;
      for (const [pay, amt] of Object.entries(json.payments)) {
        const percent = ((amt / json.total) * 100).toFixed(1);
        html += `<tr><td>${pay}</td><td>${Number(amt).toLocaleString()}</td><td>${percent}%</td></tr>`;
      }
      html += `</table>`;
      html += `<canvas id="payChart" width="300" height="300" style="margin-top:20px;"></canvas>`;
      html += `<div class="total">ğŸ“Œ æœ¬æœˆç¸½é¡ï¼š${Number(json.total || 0).toLocaleString()} å…ƒï¼ˆå…± ${Object.keys(json.payments).length} ç­†ä»˜æ¬¾æ–¹å¼ï¼‰</div>`;
    }

    // ---------------- æœ¬æœˆåº—å®¶ ----------------
    if (command === "æœ¬æœˆåº—å®¶" && json.stores) {
      html += `<h4>ğŸ“‹ æœ¬æœˆåº—å®¶çµ±è¨ˆ</h4>`;
      html += `<table id="tableStore"><tr>
        <th onclick="sortTable('tableStore',0)">åº—å®¶</th>
        <th onclick="sortTable('tableStore',1,true)">é‡‘é¡</th>
        <th>å æ¯”</th></tr>`;
      for (const [store, amt] of Object.entries(json.stores)) {
        const percent = ((amt / json.total) * 100).toFixed(1);
        html += `<tr><td>${store}</td><td>${Number(amt).toLocaleString()}</td><td>${percent}%</td></tr>`;
      }
      html += `</table>`;
      html += `<canvas id="storeChart" width="300" height="300" style="margin-top:20px;"></canvas>`;
      html += `<div class="total">ğŸ“Œ æœ¬æœˆç¸½é¡ï¼š${Number(json.total || 0).toLocaleString()} å…ƒï¼ˆå…± ${Object.keys(json.stores).length} ç­†åº—å®¶ï¼‰</div>`;
    }

    document.getElementById("queryResult").innerHTML = html;

    // ---------------- ç•«åœ–è¡¨ ----------------
    if (command === "æœ¬æœˆ" && json.categories) {
      new Chart(document.getElementById('typeChart').getContext('2d'), {
        type: 'bar',
        data: { labels: Object.keys(json.categories), datasets: [{ data: Object.values(json.categories), backgroundColor:'#36A2EB' }] }
      });
    }
    if (command === "æœ¬æœˆåˆ†é¡" && json.categories) {
      new Chart(document.getElementById('typeChart').getContext('2d'), {
        type: 'pie',
        data: { labels: Object.keys(json.categories), datasets: [{ data: Object.values(json.categories), backgroundColor:['#FF6384','#36A2EB','#FFCE56','#4CAF50','#FF9800','#9C27B0','#00BCD4'] }] }
      });
    }
    if (command === "æœ¬æœˆä»˜æ¬¾" && json.payments) {
      new Chart(document.getElementById('payChart').getContext('2d'), {
        type: 'pie',
        data: { labels: Object.keys(json.payments), datasets: [{ data: Object.values(json.payments), backgroundColor:['#FF9800','#2196F3','#4CAF50','#9C27B0','#00BCD4','#FF6384'] }] }
      });
    }
    if (command === "æœ¬æœˆåº—å®¶" && json.stores) {
      new Chart(document.getElementById('storeChart').getContext('2d'), {
        type: 'pie',
        data: { labels: Object.keys(json.stores), datasets: [{ data: Object.values(json.stores), backgroundColor:['#FF9800','#2196F3','#4CAF50','#9C27B0','#00BCD4','#FF6384'] }] }
      });
    }

  } catch(err) {
    document.getElementById("queryResult").innerHTML = `<p style="color:red">âŒ æŸ¥è©¢å¤±æ•—ï¼š${err.message}</p>`;
  }
}
</script>

</body>
</html>
