<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>é›¶ç”¨é‡‘æ”¯å‡ºå¸³ç°¿</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 50px; }
    h2 { font-size: 40px; text-align: center; margin-bottom: 40px; }
    h3 { font-size: 50px; text-align: center; margin-bottom: 50px; }
    label, select, input { font-size: 50px; text-align: left; margin-bottom: 20px;  }
    button { font-size: 32px; text-align: center; margin: 5px; padding: 10px 20px; border-radius: 8px; cursor: pointer; background-color: #4CAF50; color: white; border: none; }
    button:hover { background-color: #0056b3; }
    table { font-size: 32px; border-collapse: collapse; width: 100%; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    .action-btn { background: #dc3545; margin: 0 2px; }
    .edit-btn { background: #28a745; }
    .action-btn:hover, .edit-btn:hover { opacity: 0.8; }
    .total { font-size: 28px; font-weight: bold; color: #d9534f; margin-top: 10px; }
  </style>
</head>
<body>

    <h3>âš™ï¸é<span style="color: gray;">è¨­</span>ä¸å¯.[<span id="version">V</span>]</h3>
    
    <label>é¡åˆ¥ï¼š</label>
    <select id="classify">
      <option value="currency">åŒ¯ç‡ currency</option>
      <option value="payment">ä»˜æ¬¾ payment</option>
      <option value="type">åˆ†é¡ type</option>
    </select><br>

    <label>ç·¨è™Ÿï¼š</label>
    <input type="text" id="number" placeholder="è«‹è¼¸å…¥ç·¨è™Ÿ,æ’åºç”¨c001..." required><br>

    <label>åç¨±ï¼š</label>
    <input type="text" id="name" placeholder="è«‹è¼¸å…¥åç¨±" required><br>

    <label>å‚™è¨»ï¼š</label>
    <input type="text" id="note" placeholder="é¸å¡«"><br>

    <label>åŒ¯ç‡ï¼š</label>
    <input type="text" id="exchange" placeholder="è½‰æ›å¹£åˆ¥å¿…å¡«"><br>

    <div style="text-align: center; margin-bottom: 20px;">
      <button onclick="saveOther()">ğŸ“¤ å„²å­˜</button>
      <button onclick="loadOther()">ğŸ“– æŸ¥è©¢</button>
    </div>

    <table id="otherTable">
      <thead>
        <tr><th>é¡åˆ¥</th><th>ç·¨è™Ÿ</th><th>åç¨±</th><th>å‚™è¨»</th><th>åŒ¯ç‡</th><th>åŠŸèƒ½</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="summary" class="total"></div>

    <div style="text-align: center; margin-top: 20px; padding: 20px; border-top: 1px solid #ccc;"> 
        <div class="links">
          <h2>
            <a href="liff.html" target="_blank" style="margin: 0 10px;">ğŸ’°é<span style="color: red;">è¨˜</span>ä¸å¯</a> 
            <a href="query.html" target="_blank" style="margin: 0 10px;">ğŸ”é<span style="color: blue;">çœ‹</span><span>/</span><span style="color: green;">åŒ¯</span>ä¸å¯</a> 
            <a href="other.html" target="_blank" style="margin: 0 10px;">âš™ï¸é<span style="color: gray;">è¨­</span>ä¸å¯</a>
          </h2>
        </div>
    
        <div style="font-size: 20px; text-align: center; color: #666; margin-top: 20px;">
            Copyright Â© Betty Yi. All Right Reserved.
        </div>
    </div>
    
<script>
const LIFF_IDo = "2008096451-Olb1l39P";
const API_URL = "https://script.google.com/macros/s/AKfycbwxqIKuk4VqHeib3Mi_xxE6yS5R8V55wyiQVIS6VgF6PEnNa93lVSoBBiX4OYksDuaiUw/exec";
const VERSION = "V29_#260129"; 

let userProfile = null;
let editIndex = -1; 
window.otherDataCache = []; 

// âœ… å„ªåŒ–å¾Œçš„åˆå§‹åŒ– (å…¨ä¸¦è¡Œæ¨¡å¼)
async function initApp() {
  try {
    document.getElementById("version").textContent = VERSION;
    await liff.init({ liffId: LIFF_IDo });

    if (!liff.isLoggedIn()) {
      liff.login();
      return; 
    }

    // ğŸš€ åŒæ™‚åŸ·è¡Œï¼šProfile æŠ“å– + åˆå§‹è³‡æ–™æŸ¥è©¢
    const [profile] = await Promise.all([
      liff.getProfile(),
      loadOther() 
    ]);

    userProfile = profile;
    console.log("âœ… æ­¡è¿ " + userProfile.displayName);

  } catch (err) {
    if (err.message.includes("authorization")) {
      liff.logout();
      location.reload();
    } else {
      alert("âŒ åˆå§‹åŒ–å¤±æ•—ï¼š" + err.message);
    }
  }
}

// ğŸš€ å„ªåŒ– 1: æ¸›å°‘é©—è­‰è«‹æ±‚æ¬¡æ•¸çš„é‚è¼¯ (å°è£å¸¸ç”¨æª¢æŸ¥)
async function checkDuplicate(targetName, oldName) {
  const [exchangeRes, typeRes, paymentRes] = await Promise.all([
    fetch(`${API_URL}?type=query&command=cashdate.exchange`),
    fetch(`${API_URL}?type=query&command=cashdate.type`),
    fetch(`${API_URL}?type=query&command=cashdate.payment`)
  ]);

  const [e, t, p] = await Promise.all([exchangeRes.json(), typeRes.json(), paymentRes.json()]);
  const allNames = [...(e.exchanges || []), ...(t.types || []), ...(p.payments || [])];
  
  const checkList = oldName ? allNames.filter(n => n !== oldName) : allNames;
  return checkList.includes(targetName);
}

// 1ï¸âƒ£ å„²å­˜/ä¿®æ”¹
async function saveOther() {
  const payload = {
    type: "other",
    command: editIndex === -1 ? "add" : "update",
    classify: document.getElementById("classify").value,
    number: document.getElementById("number").value.trim(),
    name: document.getElementById("name").value.trim(),
    note: (document.getElementById("note")?.value || "").trim(),
    exchange: (document.getElementById("exchange")?.value || "").trim(),
    oldNumber: window.oldNumber || undefined
  };

  if (!payload.classify || !payload.number || !payload.name) {
    alert("â—åˆ†é¡ã€ç·¨è™Ÿèˆ‡åç¨±ä¸å¾—ç‚ºç©º");
    return;
  }

  if (payload.classify === "currency" && !payload.exchange) {
    alert("â—åŒ¯ç‡ currency é¡åˆ¥ï¼ŒåŒ¯ç‡æ¬„ä½å¿…å¡«ï¼");
    return;
  }
  
  try {
    const isDup = await checkDuplicate(payload.name, window.oldName);
    if (isDup) {
      alert(`âš ï¸ã€Œ${payload.name}ã€å·²å­˜åœ¨æ–¼ç³»çµ±åŒ¯ç‡.åˆ†é¡.ä»˜æ¬¾æ–¹å¼ä¸­ï¼Œç„¡æ³•æ–°å¢/ä¿®æ”¹`);
      return;
    }

    const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
    const result = await res.json();

    if (result.ok) {
      alert(editIndex === -1 ? `âœ… å·²æ–°å¢ ${payload.name} æ­¤ç­†è³‡æ–™` : `âœ… å·²ä¿®æ”¹ ${payload.name} æ­¤ç­†è³‡æ–™`);
      clearForm();
      loadOther();
    } else {
      alert(`âŒ å¤±æ•—ï¼š${result.msg || "æœªçŸ¥éŒ¯èª¤"} (${payload.name})`);
    }
  } catch (err) {
    alert(`âš ï¸ ç™¼ç”ŸéŒ¯èª¤ï¼š${err} (${payload.name})`);
  }
}

// ğŸš€ å„ªåŒ– 2: æŸ¥è©¢æ¸²æŸ“æ•ˆç‡ (ä½¿ç”¨ DocumentFragment)
async function loadOther() {
  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({ type: "other", command: "query" })
    });
    const result = await res.json();
    
    const tbody = document.querySelector("#otherTable tbody");
    if (result.ok && Array.isArray(result.list)) {
      
      // æ’åºé‚è¼¯ (ä¿æŒåŸæ¨£)
      result.list.sort((a, b) => {
        if (a.classify < b.classify) return -1;
        if (a.classify > b.classify) return 1;
        const numA = parseInt(a.number.replace(/[^\d]/g, ""), 10) || 0;
        const numB = parseInt(b.number.replace(/[^\d]/g, ""), 10) || 0;
        return numA - numB;
      });

      // ğŸš€ æ ¸å¿ƒå„ªåŒ–ï¼šä½¿ç”¨ fragment æ¸›å°‘é é¢é‡ç¹ª
      const fragment = document.createDocumentFragment();
      result.list.forEach((row, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.classify}</td>
          <td>${row.number}</td>
          <td>${row.name}</td>
          <td>${row.note || ""}</td>
          <td>${row.exchange}</td>
          <td>
            <button class="edit-btn" onclick="editOther(${idx})">ğŸ“ ä¿®æ”¹</button>
            <button class="action-btn" onclick="deleteOther(${idx})">ğŸ—‘ï¸ åˆªé™¤</button>
          </td>
        `;
        fragment.appendChild(tr);
      });
      
      tbody.innerHTML = "";
      tbody.appendChild(fragment);

      window.otherDataCache = result.list;
      
      const counts = result.list.reduce((acc, r) => {
        acc[r.classify] = (acc[r.classify] || 0) + 1;
        return acc;
      }, {});

      document.getElementById("summary").innerHTML = `
      <table>
        <tr>
          <td>åŒ¯ç‡ currency<br>ğŸ’° ${counts.currency || 0} ç­†</td>      
          <td>ä»˜æ¬¾ payment<br>ğŸ’³ ${counts.payment || 0} ç­†</td>
          <td>åˆ†é¡ type<br>ğŸ“‚ ${counts.type || 0} ç­†</td>
          <td>ç¸½è¨ˆ<br>ğŸ“Œ ${result.list.length} ç­†</td>
        </tr>
      </table>`;
    }
  } catch (err) {
    alert("âš ï¸ æŸ¥è©¢å¤±æ•—ï¼š" + err.message);
  }
}

// 3ï¸âƒ£ ä¿®æ”¹
function editOther(idx) {
  const row = window.otherDataCache[idx];
  if (!row) return;
  document.getElementById("classify").value = row.classify;
  document.getElementById("number").value = row.number;
  document.getElementById("name").value = row.name;
  document.getElementById("note").value = row.note;
  document.getElementById("exchange").value = row.exchange || "";
  editIndex = idx;
  window.oldNumber = row.number; 
  window.oldName = row.name;     
  window.scrollTo(0,0); // è‡ªå‹•æ²åˆ°ä¸Šæ–¹æ–¹ä¾¿æ“ä½œ
}

// 4ï¸âƒ£ åˆªé™¤
async function deleteOther(idx) {
  const row = window.otherDataCache[idx];
  if (!row || !confirm(`â—ç¢ºå®šè¦åˆªé™¤ ${row.name} é€™ç­†è³‡æ–™å—ï¼Ÿ`)) return;
  
  try {
    const isUsed = await checkDuplicate(row.name, null);
    if (isUsed) {
      alert(`âš ï¸ã€Œ${row.name}ã€å·²è¢«ä½¿ç”¨æ–¼åŒ¯ç‡.åˆ†é¡.ä»˜æ¬¾æ–¹å¼ä¸­ï¼Œç„¡æ³•åˆªé™¤ï¼`);
      return;
    }

    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({ type: "other", command: "delete", number: row.number })
    });

    const resDel = await res.json();
    if (resDel.ok) {
      alert(`âœ… ${row.name} åˆªé™¤æˆåŠŸï¼`);
      clearForm();
      loadOther();
    }
  } catch (err) {
    alert(`âš ï¸ åˆªé™¤éŒ¯èª¤ï¼š${err.message}`);
  }
}

function clearForm() {
  document.getElementById("number").value = "";
  document.getElementById("name").value = "";
  document.getElementById("note").value = "";
  document.getElementById("exchange").value = "";
  editIndex = -1;
  window.oldNumber = undefined;
  window.oldName = undefined;
}

initApp();
</script>
</body>
</html>

