<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <title>ä¸‹è¼‰ PDF</title>
</head>
<body style="font-family:sans-serif;text-align:center;padding-top:100px;">
  <h2>ðŸ“„ ä¸‹è¼‰å ±è¡¨</h2>
  <p>è‹¥æœªè‡ªå‹•ä¸‹è¼‰ï¼Œè«‹é»žä¸‹æ–¹æŒ‰éˆ•ï¼š</p>
  <button id="downloadBtn" style="font-size:18px;padding:10px 30px;">ä¸‹è¼‰ PDF</button>

  <script>
    console.log("âœ… download.html å·²è¼‰å…¥");

    const urlParams = new URLSearchParams(window.location.search);
    const base64Data = urlParams.get("data");
    const filename = urlParams.get("name") || "report.pdf";

    function downloadPDF(data, name) {
      try {
        const byteChars = atob(data);
        const byteNumbers = new Array(byteChars.length);
        for (let i = 0; i < byteChars.length; i++) byteNumbers[i] = byteChars.charCodeAt(i);
        const blob = new Blob([new Uint8Array(byteNumbers)], { type: "application/pdf" });
        const blobUrl = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = blobUrl;
        a.download = name;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        // ç­‰å¾…ä¸‹è¼‰å®Œæˆå¾Œè‡ªå‹•é—œé–‰é é¢
        setTimeout(() => {
          window.close();
        }, 500);
      } catch (err) {
        console.error("âŒ PDF ä¸‹è¼‰å¤±æ•—", err);
        alert("PDF ä¸‹è¼‰å¤±æ•—");
      }
    }

    if (base64Data) {
      // è‡ªå‹•ä¸‹è¼‰
      downloadPDF(base64Data, filename);
    } else {
      alert("âŒ æ²’æœ‰æŽ¥æ”¶åˆ° PDF è³‡æ–™");
    }

    document.getElementById("downloadBtn").addEventListener("click", () => {
      if (base64Data) downloadPDF(base64Data, filename);
    });
  </script>
</body>
</html>
