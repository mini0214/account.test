<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>é›¶ç”¨é‡‘æ”¯å‡ºå¸³ç°¿</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: Arial; padding: 50px; }
    label { font-size: 30px; font-weight: bold; display: inline-block; margin-top: 20px; }
    input, select { font-size: 28px; padding: 10px; width: 70%; margin-top: 5px; border-radius: 6px; border: 1px solid #ccc; }
    button { font-size: 28px; padding: 15px; border-radius: 8px; background-color: #4CAF50; color: white; border: none; width: 100%; margin-top: 20px; cursor:pointer; }
    button:active { transform: scale(0.97); }
  </style>
</head>
<body>

<h2>é›¶ç”¨é‡‘æ”¯å‡ºå¸³ç°¿</h2>

<form id="expenseForm">
  <label>æ—¥æœŸï¼š</label>
  <input type="date" id="date">

  <label>åº—å®¶ï¼š</label>
  <input list="storeList" id="store" placeholder="é¸å¡«">
  <datalist id="storeList"></datalist>

  <label>é‡‘é¡ï¼š</label>
  <input type="number" id="amount" placeholder="è¼¸å…¥é‡‘é¡" step="0.01">

  <label>åˆ†é¡ï¼š</label>
  <select id="type">
    <option value="">è«‹é¸æ“‡åˆ†é¡</option>
    <option value="é£Ÿ">é£Ÿ</option>
    <option value="è¡£">è¡£</option>
    <option value="ä½">ä½</option>
    <option value="è¡Œ">è¡Œ</option>
    <option value="è‚²">è‚²</option>
    <option value="æ¨‚">æ¨‚</option>
    <option value="å…¶ä»–">å…¶ä»–</option>
  </select>

  <button type="submit">é€å‡º</button>
  <div id="loadingMsg" style="display:none; color:red; margin-top:10px;">â³ è³‡æ–™é€å‡ºä¸­...</div>
</form>

<script>
const LIFF_ID = "ä½ çš„LIFF_ID";
const API_URL = "ä½ çš„GAS_URL";

async function main() {
  await liff.init({ liffId: LIFF_ID });
  if (!liff.isLoggedIn()) liff.login();
  document.getElementById("date").valueAsDate = new Date();

  // ğŸ”¹ è®€å– storeList
  fetch(`${API_URL}?type=query&command=åº—å®¶`)
    .then(res => res.json())
    .then(result => {
      if(result.ok && result.storeList && result.storeList.length > 0){
        const datalist = document.getElementById("storeList");
        datalist.innerHTML = "";
        result.storeList.forEach(store => {
          const option = document.createElement("option");
          option.value = store;
          datalist.appendChild(option);
        });
      }
    })
    .catch(err => console.error("è®€å–åº—å®¶æ¸…å–®å¤±æ•—:", err));
}

main();

document.getElementById("expenseForm").addEventListener("submit", async e => {
  e.preventDefault();
  const submitBtn = e.target.querySelector("button");
  const loadingMsg = document.getElementById("loadingMsg");

  submitBtn.disabled = true;
  loadingMsg.style.display = "block";

  const profile = await liff.getProfile();
  const now = new Date();
  const taiwanTime = new Date(now.getTime() + 8*60*60*1000)
    .toISOString().replace("T"," ").split(".")[0];

  const payload = {
    userId: profile.userId,
    displayName: profile.displayName,
    date: document.getElementById("date").value,
    store: document.getElementById("store").value,
    amount: document.getElementById("amount").value,
    type: document.getElementById("type").value,
    createdAt: taiwanTime
  };

  try {
    const res = await fetch(API_URL, { method:"POST", body: JSON.stringify(payload) });
    const data = await res.json();
    alert("âœ… å·²é€å‡ºï¼š" + JSON.stringify(payload));
    e.target.reset();
    document.getElementById("date").valueAsDate = new Date();
  } catch(err) {
    alert("âŒ é€å‡ºå¤±æ•—ï¼š" + err.message);
  } finally {
    submitBtn.disabled = false;
    loadingMsg.style.display = "none";
  }
});
</script>

</body>
</html>
