<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>零用金支出帳簿</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: Arial; padding: 50px; }
    label { font-size: 30px; font-weight: bold; display: inline-block; margin-top: 20px; }
    input, select { font-size: 28px; padding: 10px; width: 70%; margin-top: 5px; border-radius: 6px; border: 1px solid #ccc; }
    button { font-size: 28px; padding: 15px; border-radius: 8px; background-color: #4CAF50; color: white; border: none; width: 100%; margin-top: 20px; cursor:pointer; }
    button:active { transform: scale(0.97); }
  </style>
</head>
<body>

<h2>零用金支出帳簿</h2>

<form id="expenseForm">
  <label>日期：</label>
  <input type="date" id="date">

  <label>店家：</label>
  <input list="storeList" id="store" placeholder="選填">
  <datalist id="storeList"></datalist>

  <label>金額：</label>
  <input type="number" id="amount" placeholder="輸入金額" step="0.01">

  <label>分類：</label>
  <select id="type">
    <option value="">請選擇分類</option>
    <option value="食">食</option>
    <option value="衣">衣</option>
    <option value="住">住</option>
    <option value="行">行</option>
    <option value="育">育</option>
    <option value="樂">樂</option>
    <option value="其他">其他</option>
  </select>

  <button type="submit">送出</button>
  <div id="loadingMsg" style="display:none; color:red; margin-top:10px;">⏳ 資料送出中...</div>
</form>

<script>
const LIFF_ID = "你的LIFF_ID";
const API_URL = "你的GAS_URL";

async function main() {
  await liff.init({ liffId: LIFF_ID });
  if (!liff.isLoggedIn()) liff.login();
  document.getElementById("date").valueAsDate = new Date();

  // 🔹 讀取 storeList
  fetch(`${API_URL}?type=query&command=店家`)
    .then(res => res.json())
    .then(result => {
      if(result.ok && result.storeList && result.storeList.length > 0){
        const datalist = document.getElementById("storeList");
        datalist.innerHTML = "";
        result.storeList.forEach(store => {
          const option = document.createElement("option");
          option.value = store;
          datalist.appendChild(option);
        });
      }
    })
    .catch(err => console.error("讀取店家清單失敗:", err));
}

main();

document.getElementById("expenseForm").addEventListener("submit", async e => {
  e.preventDefault();
  const submitBtn = e.target.querySelector("button");
  const loadingMsg = document.getElementById("loadingMsg");

  submitBtn.disabled = true;
  loadingMsg.style.display = "block";

  const profile = await liff.getProfile();
  const now = new Date();
  const taiwanTime = new Date(now.getTime() + 8*60*60*1000)
    .toISOString().replace("T"," ").split(".")[0];

  const payload = {
    userId: profile.userId,
    displayName: profile.displayName,
    date: document.getElementById("date").value,
    store: document.getElementById("store").value,
    amount: document.getElementById("amount").value,
    type: document.getElementById("type").value,
    createdAt: taiwanTime
  };

  try {
    const res = await fetch(API_URL, { method:"POST", body: JSON.stringify(payload) });
    const data = await res.json();
    alert("✅ 已送出：" + JSON.stringify(payload));
    e.target.reset();
    document.getElementById("date").valueAsDate = new Date();
  } catch(err) {
    alert("❌ 送出失敗：" + err.message);
  } finally {
    submitBtn.disabled = false;
    loadingMsg.style.display = "none";
  }
});
</script>

</body>
</html>
