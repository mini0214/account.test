<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>零用金支出帳簿</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; }
    th { background: #f2f2f2; }
    td.numeric, th.numeric { text-align: right; }
    .total { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <h3>查詢結果</h3>
  <div id="queryResult"></div>
  <canvas id="chartCanvas"></canvas>

<script>
const VERSION = "1.0";
const API_URL = "https://script.google.com/macros/s/AKfycbwQ1t5wHfjAqrtH0_ijNNWtlE5Q0R-g8fwb5htWQoCXKXxSukVX9qVnrfuyoXOyKkGXdw/exec";
let chartInstance = null;

/* 將欄位文字轉為可比較的值（數字、百分比、文字） */
function parseCellValue(cellText) {
  let v = cellText.trim().replace(/,/g, "").replace("%", "");
  if (!isNaN(v) && v !== "") {
    return parseFloat(v);
  }
  return cellText.toLowerCase(); // 統一小寫做文字比較
}

/* 通用表格排序 */
function makeTableSortable(table) {
  const headers = table.querySelectorAll("th");

  headers.forEach((th, colIndex) => {
    th.style.cursor = "pointer";

    th.addEventListener("click", () => {
      const rows = Array.from(table.querySelectorAll("tr")).slice(1);

      // 🔹清掉其他欄位的排序符號
      headers.forEach((h, idx) => {
        if (idx !== colIndex) {
          h.dataset.order = "";
          h.innerHTML = h.innerHTML.replace(/[\u25B2\u25BC]/g, "");
        }
      });

      const currentOrder = th.dataset.order || "";
      const newOrder = currentOrder === "asc" ? "desc" : "asc";
      th.dataset.order = newOrder;

      // 🔹加上符號
      th.innerHTML = th.innerHTML.replace(/[\u25B2\u25BC]/g, "");
      th.innerHTML += newOrder === "asc" ? " ▲" : " ▼";

      // 🔹排序
      rows.sort((a, b) => {
        let aText = parseCellValue(a.cells[colIndex].innerText);
        let bText = parseCellValue(b.cells[colIndex].innerText);

        if (typeof aText === "number" && typeof bText === "number") {
          return newOrder === "asc" ? aText - bText : bText - aText;
        } else {
          return newOrder === "asc"
            ? aText.localeCompare(bText, "zh-Hant")
            : bText.localeCompare(aText, "zh-Hant");
        }
      });

      rows.forEach(r => table.appendChild(r));
    });
  });
}

// 發送查詢
async function sendQuery(command) {
  const startDate = document.getElementById("startDate")?.value || "2025-09-01";
  const endDate   = document.getElementById("endDate")?.value || "2025-09-30";

  const body = {
    type: "query",
    command: command,
    version: VERSION,
    startDate: startDate + " 00:00:00",
    endDate: endDate + " 23:59:59"
  };

  try {
    const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(body) });
    const json = await res.json();
    if (!json.ok) {
      document.getElementById("queryResult").innerHTML = `<p style="color:red">❌ 查詢失敗</p>`;
      return;
    }
    renderResult(command, json);
  } catch (err) {
    document.getElementById("queryResult").innerHTML = `<p style="color:red">❌ 查詢失敗：${err.message}</p>`;
  }
}

// 顯示結果表格與圖表
function renderResult(command, json) {
  let html = "";

  // 📊 明細
  if (command === "明細" && json.rows) {
    html += `<h4>📊 查詢明細</h4>`;
    html += `<table id="dataTable">
              <tr>
                <th>日期</th>
                <th>店家</th>
                <th class="numeric">收入</th>
                <th class="numeric">支出</th>
                <th>幣別</th>
                <th class="numeric">金額</th>
                <th>付款</th>
                <th>分類</th>
                <th>附註</th>
                <th>備註</th>
              </tr>`;
    json.rows.sort((a,b)=> new Date(a[4]) - new Date(b[4])); // 日期排序
    json.rows.forEach(r => {
      const dateStr = r[4] ? new Date(r[4]).toLocaleDateString("zh-TW") : "";
      html += `<tr>
                <td>${dateStr}</td>
                <td>${r[8]}</td>
                <td class="numeric">${Number(r[11]).toLocaleString()}</td>
                <td class="numeric">${Number(r[12]).toLocaleString()}</td>
                <td>${r[13]}</td>
                <td class="numeric">${Number(r[5]).toLocaleString()}</td>
                <td>${r[7]}</td>
                <td>${r[6]}</td>
                <td>${r[9]}</td>
                <td>${r[10]}</td>
      </tr>`;
    });
    html += `</table>`;
    html += `<div class="total">📌 總額：${Number(json.total||0).toLocaleString()} 元（共 ${json.rows.length} 筆）</div>`;

    // 長條圖：日期彙總
    const grouped = {};
    json.rows.forEach(r => {
      const d = new Date(r[4]).toLocaleDateString("zh-TW");
      grouped[d] = (grouped[d] || 0) + (Number(r[5]) || 0);
    });
    const labels = Object.keys(grouped).sort((a,b)=> new Date(a)-new Date(b));
    const values = labels.map(l => grouped[l]);
    renderChart("bar", labels, values);
  }

  // ⭕ 分類
  if (command === "分類" && json.categories) {
    const labels = Object.keys(json.categories);
    const values = Object.values(json.categories);
    const total = values.reduce((a,b)=>a+b,0);
    const count = values.length;

    html += `<h4>⭕ 分類統計</h4>`;
    html += `<table id="dataTable">
              <tr>
                <th>分類方式</th>
                <th class="numeric">金額</th>
                <th class="numeric">占比</th>
              </tr>`;
    labels.forEach((l,i)=> {
      const percent = ((values[i]/total)*100).toFixed(1);
      html += `<tr>
                <td>${l}</td>
                <td class="numeric">${values[i].toLocaleString()}</td>
                <td class="numeric">${percent}%</td>
              </tr>`;
    });
    html += `</table>`;
    html += `<div class="total">📌 總額：${total.toLocaleString()} 元（共 ${count} 種分類）</div>`;
    renderChart("pie", labels, values);
  }

  // 💳 付款
  if (command === "付款" && json.payments) {
    const labels = Object.keys(json.payments);
    const values = Object.values(json.payments);
    const total = values.reduce((a,b)=>a+b,0);
    const count = values.length;

    html += `<h4>💳 付款統計</h4>`;
    html += `<table id="dataTable">
              <tr>
                <th>付款方式</th>
                <th class="numeric">金額</th>
                <th class="numeric">占比</th>
              </tr>`;
    labels.forEach((l,i)=> {
      const percent = ((values[i]/total)*100).toFixed(1);
      html += `<tr>
                <td>${l}</td>
                <td class="numeric">${values[i].toLocaleString()}</td>
                <td class="numeric">${percent}%</td>
              </tr>`;
    });
    html += `</table>`;
    html += `<div class="total">📌 總額：${total.toLocaleString()} 元（共 ${count} 種付款）</div>`;
    renderChart("pie", labels, values);
  }

  // 📋 店家
  if (command === "店家" && json.stores) {
    const labels = Object.keys(json.stores);
    const values = Object.values(json.stores);
    const total = values.reduce((a,b)=>a+b,0);
    const count = values.length;

    html += `<h4>📋 店家統計</h4>`;
    html += `<table id="dataTable">
              <tr>
                <th>店家</th>
                <th class="numeric">金額</th>
                <th class="numeric">占比</th>
              </tr>`;
    labels.forEach((l,i)=> {
      const percent = ((values[i]/total)*100).toFixed(1);
      html += `<tr>
                <td>${l}</td>
                <td class="numeric">${values[i].toLocaleString()}</td>
                <td class="numeric">${percent}%</td>
              </tr>`;
    });
    html += `</table>`;
    html += `<div class="total">📌 總額：${total.toLocaleString()} 元（共 ${count} 筆店家）</div>`;
    renderChart("pie", labels, values);
  }

  document.getElementById("queryResult").innerHTML = html;

  // 表格排序
  const dataTable = document.getElementById("dataTable");
  if (dataTable) makeTableSortable(dataTable);
}

// 畫圖
function renderChart(type, labels, values) {
  const ctx = document.getElementById("chartCanvas").getContext("2d");
  if (chartInstance) chartInstance.destroy();

  let datasetConfig = {
    label: "金額",
    data: values
  };

  if (type === "pie") {
    datasetConfig.backgroundColor = values.map((_, i) =>
      `hsl(${(i*60) % 360}, 70%, 60%)`
    );
  } else {
    datasetConfig.backgroundColor = "rgba(54, 162, 235, 0.6)";
  }

  chartInstance = new Chart(ctx, {
    type: type,
    data: { labels: labels, datasets: [datasetConfig] },
    options: { responsive: true }
  });
}
</script>
</body>
</html>
