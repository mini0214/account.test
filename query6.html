<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>é›¶ç”¨é‡‘æŸ¥è©¢</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 30px; }
    h3 { font-size: 40px; text-align: center; margin-bottom: 10px; }
    #dateRange { font-size: 24px; text-align: center; margin-bottom: 20px; }
    button { font-size: 28px; padding: 10px 20px; margin: 5px; border-radius: 8px; cursor: pointer; }
    #queryResult { margin-top: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 15px; font-size: 18px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; cursor: pointer; }
    th { background-color: #f2f2f2; }
    th.sort-asc::after { content: " â–²"; }
    th.sort-desc::after { content: " â–¼"; }
    .total { font-size: 22px; font-weight: bold; color: #d9534f; margin-top: 10px; }
    canvas { margin-top: 20px; max-width: 800px; }
  </style>
</head>
<body>

<h3>é›¶ç”¨é‡‘æŸ¥è©¢ [<span id="version"></span>]</h3>
<div id="dateRange">ğŸ“… æŸ¥è©¢å€é–“ï¼š<span id="startDateLabel"></span> ~ <span id="endDateLabel"></span></div>

<button id="queryMonthBtn">ğŸ“Š æŸ¥è©¢æœ¬æœˆ</button>
<button id="queryMonthPayBtn">ğŸ’³ æŸ¥è©¢æœ¬æœˆä»˜æ¬¾</button>
<button id="queryMonthTypeBtn">â­• æŸ¥è©¢æœ¬æœˆåˆ†é¡</button>
<button id="queryMonthStoreBtn">ğŸ“‹ æŸ¥è©¢æœ¬æœˆåº—å®¶</button>

<div id="queryResult"></div>
<canvas id="chartCanvas"></canvas>

<script>
const LIFF_ID = "2008096451-jPJ50MOY";
const VERSION = "T4";
const API_URL = "https://script.google.com/macros/s/YOUR_GAS_ID/exec"; // æ”¹æˆä½ çš„GASç¶²å€

let startDate, endDate;
let chartInstance = null;

document.getElementById("version").textContent = VERSION;

// åˆå§‹åŒ– LIFF
async function main() {
  await liff.init({ liffId: LIFF_ID });
  if (!liff.isLoggedIn()) liff.login();
  setDefaultDateRange();
}
main();

// è¨­å®šæ¯æœˆ 1 è™Ÿåˆ°æœˆåº•
function setDefaultDateRange() {
  const now = new Date();
  startDate = new Date(now.getFullYear(), now.getMonth(), 1);
  endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0); // æœˆåº•
  document.getElementById("startDateLabel").textContent = formatDate(startDate);
  document.getElementById("endDateLabel").textContent = formatDate(endDate);
}

function formatDate(d) {
  const m = (d.getMonth() + 1).toString().padStart(2, "0");
  const day = d.getDate().toString().padStart(2, "0");
  return `${d.getFullYear()}/${m}/${day}`;
}

// æŸ¥è©¢æŒ‰éˆ•äº‹ä»¶
document.getElementById("queryMonthBtn").addEventListener("click", () => sendQuery("æœ¬æœˆ"));
document.getElementById("queryMonthTypeBtn").addEventListener("click", () => sendQuery("æœ¬æœˆåˆ†é¡"));
document.getElementById("queryMonthPayBtn").addEventListener("click", () => sendQuery("æœ¬æœˆä»˜æ¬¾"));
document.getElementById("queryMonthStoreBtn").addEventListener("click", () => sendQuery("æœ¬æœˆåº—å®¶"));

// ç™¼é€æŸ¥è©¢
async function sendQuery(command) {
  const body = {
    type: "query",
    command: command,
    version: VERSION,
    startDate: formatDate(startDate),
    endDate: formatDate(endDate)
  };

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify(body)
    });
    const json = await res.json();
    if (!json.ok) {
      document.getElementById("queryResult").innerHTML = `<p style="color:red">âŒ æŸ¥è©¢å¤±æ•—</p>`;
      return;
    }
    renderResult(command, json);
  } catch (err) {
    document.getElementById("queryResult").innerHTML = `<p style="color:red">âŒ æŸ¥è©¢å¤±æ•—ï¼š${err.message}</p>`;
  }
}

// é¡¯ç¤ºçµæœè¡¨æ ¼ & åœ–è¡¨
function renderResult(command, json) {
  let html = "";

  if (command === "æœ¬æœˆ" && json.rows) {
    html += `<table id="dataTable"><tr>
      <th>æ—¥æœŸ</th><th>åº—å®¶</th><th>æ”¶å…¥</th><th>æ”¯å‡º</th>
      <th>å¹£åˆ¥</th><th>é‡‘é¡</th><th>ä»˜æ¬¾</th><th>åˆ†é¡</th><th>é™„è¨»</th><th>å‚™è¨»</th>
    </tr>`;
    json.rows.forEach(r => {
      const dateStr = r[4] ? new Date(r[4]).toLocaleDateString("zh-TW") : "";
      html += `<tr>
        <td>${dateStr}</td><td>${r[8]}</td><td>${Number(r[11]).toLocaleString()}</td>
        <td>${Number(r[12]).toLocaleString()}</td><td>${r[13]}</td><td>${Number(r[5]).toLocaleString()}</td>
        <td>${r[7]}</td><td>${r[6]}</td><td>${r[9]}</td><td>${r[10]}</td>
      </tr>`;
    });
    html += `</table>`;
    html += `<div class="total">ğŸ“Œ æœ¬æœˆç¸½é¡ï¼š${Number(json.total||0).toLocaleString()} å…ƒï¼ˆå…± ${json.rows.length} ç­†ï¼‰</div>`;
    renderChart("bar", json.rows.map(r => new Date(r[4]).toLocaleDateString("zh-TW")),
                json.rows.map(r => Number(r[5]) || 0));
  }

  if (command === "æœ¬æœˆåˆ†é¡" && json.categories) {
    const labels = Object.keys(json.categories);
    const values = Object.values(json.categories);
    html += `<h4>â­• æœ¬æœˆåˆ†é¡çµ±è¨ˆ</h4>`;
    html += `<table id="dataTable"><tr><th>åˆ†é¡æ–¹å¼</th><th>é‡‘é¡</th></tr>`;
    labels.forEach((l,i)=> html += `<tr><td>${l}</td><td>${values[i].toLocaleString()}</td></tr>`);
    html += `</table>`;
    html += `<div class="total">ğŸ“Œ æœ¬æœˆç¸½é¡ï¼š${values.reduce((a,b)=>a+b,0).toLocaleString()} å…ƒ</div>`;
    renderChart("pie", labels, values);
  }

  if (command === "æœ¬æœˆä»˜æ¬¾" && json.payments) {
    const labels = Object.keys(json.payments);
    const values = Object.values(json.payments);
    html += `<h4>ğŸ’³ æœ¬æœˆä»˜æ¬¾çµ±è¨ˆ</h4>`;
    html += `<table id="dataTable"><tr><th>ä»˜æ¬¾æ–¹å¼</th><th>é‡‘é¡</th></tr>`;
    labels.forEach((l,i)=> html += `<tr><td>${l}</td><td>${values[i].toLocaleString()}</td></tr>`);
    html += `</table>`;
    html += `<div class="total">ğŸ“Œ æœ¬æœˆç¸½é¡ï¼š${values.reduce((a,b)=>a+b,0).toLocaleString()} å…ƒ</div>`;
    renderChart("pie", labels, values);
  }

  if (command === "æœ¬æœˆåº—å®¶" && json.stores) {
    const labels = Object.keys(json.stores);
    const values = Object.values(json.stores);
    html += `<h4>ğŸ“‹ æœ¬æœˆåº—å®¶çµ±è¨ˆ</h4>`;
    html += `<table id="dataTable"><tr><th>åº—å®¶</th><th>é‡‘é¡</th></tr>`;
    labels.forEach((l,i)=> html += `<tr><td>${l}</td><td>${values[i].toLocaleString()}</td></tr>`);
    html += `</table>`;
    html += `<div class="total">ğŸ“Œ æœ¬æœˆç¸½é¡ï¼š${values.reduce((a,b)=>a+b,0).toLocaleString()} å…ƒ</div>`;
    renderChart("pie", labels, values);
  }

  document.getElementById("queryResult").innerHTML = html;
}

// ç•«åœ–
function renderChart(type, labels, values) {
  const ctx = document.getElementById("chartCanvas").getContext("2d");
  if (chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    type: type,
    data: { labels: labels, datasets: [{ label: "é‡‘é¡", data: values, backgroundColor: "rgba(54, 162, 235, 0.6)" }] },
    options: { responsive: true }
  });
}
</script>

</body>
</html>
