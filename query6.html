<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>零用金支出帳簿</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .controls { margin-bottom: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f0f0f0; }
    canvas { margin-top: 20px; }
  </style>
</head>
<body>
  <h2>零用金支出查詢</h2>

  <div class="controls">
    <label>開始日期：
      <input type="date" id="startDate">
    </label>
    <label>結束日期：
      <input type="date" id="endDate">
    </label>
    <button onclick="queryData('本月')">查詢本月</button>
    <button onclick="queryData('本月分類')">查詢分類</button>
    <button onclick="queryData('本月付款')">查詢付款</button>
    <button onclick="queryData('本月店家')">查詢店家</button>
  </div>

  <div id="result"></div>
  <canvas id="chart"></canvas>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyfGl3Jhw6iO0-RH_z7hPwxqhKdRswZyMlvNZcWaFYRXVSSvaKlYT2Rs7mambS1BmYqtg/exec"; // 換成你的 GAS 網址
    let chartInstance = null;

    // ✅ 自動帶入本月日期區間
    document.addEventListener("DOMContentLoaded", () => {
      const today = new Date();
      const start = new Date(today.getFullYear(), today.getMonth(), 1);       // 本月第一天
      const end = new Date(today.getFullYear(), today.getMonth() + 1, 0);     // 本月最後一天

      function formatDate(d) {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        return `${y}-${m}-${day}`;
      }

      document.getElementById("startDate").value = formatDate(start);
      document.getElementById("endDate").value = formatDate(end);
    });

    // ✅ 查詢函式
    async function queryData(command) {
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;

      const payload = {
        type: "query",
        command: command,
        startDate: startDate,
        endDate: endDate
      };

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify(payload),
          headers: { "Content-Type": "application/json" }
        });

        const data = await res.json();
        console.log("查詢結果：", data);
        renderResult(data);

      } catch (err) {
        document.getElementById("result").innerHTML = `<p style="color:red;">查詢失敗：${err.message}</p>`;
      }
    }

    // ✅ 顯示結果（表格 + 圖表）
    function renderResult(data) {
      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = "";

      if (!data.ok) {
        resultDiv.innerHTML = `<p style="color:red;">錯誤：${data.error}</p>`;
        return;
      }

      // 顯示表格（若有 rows）
      if (data.rows) {
        let html = "<table><tr>";
        const header = ["日期", "金額", "分類", "付款方式", "店家", "備註"];
        html += header.map(h => `<th>${h}</th>`).join("") + "</tr>";

        data.rows.forEach(r => {
          html += `<tr>
            <td>${r[4]}</td>
            <td>${r[5]}</td>
            <td>${r[6]}</td>
            <td>${r[7]}</td>
            <td>${r[8]}</td>
            <td>${r[9]}</td>
          </tr>`;
        });
        html += "</table>";
        resultDiv.innerHTML = html;
      }

      // 顯示圖表（依不同查詢）
      let labels = [];
      let values = [];
      if (data.categories) {
        labels = Object.keys(data.categories);
        values = Object.values(data.categories);
      } else if (data.payments) {
        labels = Object.keys(data.payments);
        values = Object.values(data.payments);
      } else if (data.stores) {
        labels = Object.keys(data.stores);
        values = Object.values(data.stores);
      } else if (data.dates) {
        labels = Object.keys(data.dates);
        values = Object.values(data.dates);
      }

      if (labels.length > 0) {
        const ctx = document.getElementById("chart").getContext("2d");
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [{
              label: "金額",
              data: values
            }]
          }
        });
      }
    }
  </script>
</body>
</html>
