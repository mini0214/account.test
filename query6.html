<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>é›¶ç”¨é‡‘æ”¯å‡ºæŸ¥è©¢</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { margin-top: 30px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    .date-range { margin: 15px 0; font-weight: bold; color: #333; }
    .buttons { margin-bottom: 20px; }
    button { margin-right: 10px; padding: 8px 12px; }
    canvas { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>ğŸ’° é›¶ç”¨é‡‘æ”¯å‡ºæŸ¥è©¢</h1>

  <!-- æ—¥æœŸå€é–“é¡¯ç¤º -->
  <div class="date-range" id="dateRangeLabel">ğŸ“… æŸ¥è©¢å€é–“ï¼š</div>

  <!-- æŸ¥è©¢æŒ‰éˆ• -->
  <div class="buttons">
    <button onclick="queryData('æœ¬æœˆ')">æŸ¥è©¢æœ¬æœˆ</button>
    <button onclick="queryData('æœ¬æœˆä»˜æ¬¾')">æŸ¥è©¢æœ¬æœˆä»˜æ¬¾</button>
    <button onclick="queryData('æœ¬æœˆåˆ†é¡')">æŸ¥è©¢æœ¬æœˆåˆ†é¡</button>
    <button onclick="queryData('æœ¬æœˆåº—å®¶')">æŸ¥è©¢æœ¬æœˆåº—å®¶</button>
  </div>

  <!-- æŸ¥è©¢çµæœ -->
  <div id="result"></div>
  <canvas id="chartCanvas"></canvas>

  <script>
    const GAS_URL = "ä½ çš„GASç¶²å€"; // âš ï¸ æ›æˆä½ çš„ GAS éƒ¨ç½²ç¶²å€

    // é è¨­æœ¬æœˆçš„æ—¥æœŸå€é–“
    function getDefaultDateRange() {
      const today = new Date();
      const year = today.getFullYear();
      const month = today.getMonth(); // 0-based

      // æœˆåˆ
      const startDate = new Date(year, month, 1);
      // æœˆåº•ï¼ˆä¸‹ä¸€å€‹æœˆçš„0è™Ÿå°±æ˜¯é€™å€‹æœˆæœ€å¾Œä¸€å¤©ï¼‰
      const endDate = new Date(year, month + 1, 0);

      return {
        start: formatDate(startDate),
        end: formatDate(endDate)
      };
    }

    // æ ¼å¼åŒ– yyyy/MM/dd
    function formatDate(d) {
      const y = d.getFullYear();
      const m = ("0" + (d.getMonth() + 1)).slice(-2);
      const day = ("0" + d.getDate()).slice(-2);
      return `${y}/${m}/${day}`;
    }

    // æ›´æ–°ç•«é¢ä¸Šçš„æŸ¥è©¢å€é–“æ¨™ç±¤
    function updateDateLabel(start, end) {
      document.getElementById("dateRangeLabel").innerText =
        `ğŸ“… æŸ¥è©¢å€é–“ï¼š${start} ~ ${end}`;
    }

    // æŸ¥è©¢è³‡æ–™
    async function queryData(command) {
      const { start, end } = getDefaultDateRange();
      updateDateLabel(start, end);

      try {
        const res = await fetch(GAS_URL, {
          method: "POST",
          body: JSON.stringify({
            type: "query",
            command: command,
            startDate: start,
            endDate: end
          })
        });

        const data = await res.json();
        if (!data.ok) {
          document.getElementById("result").innerHTML = "âŒ æŸ¥è©¢å¤±æ•—";
          return;
        }

        renderResult(data);
      } catch (err) {
        document.getElementById("result").innerHTML = "âŒ æŸ¥è©¢å¤±æ•—ï¼š" + err;
      }
    }

    // é¡¯ç¤ºæŸ¥è©¢çµæœï¼ˆè¡¨æ ¼ + åœ–è¡¨ï¼‰
    function renderResult(data) {
      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = "";
      let labels = [];
      let values = [];
      let chartType = "bar";

      // æœ¬æœˆ â†’ é¡¯ç¤ºæ˜ç´°è¡¨ + æ—¥æœŸé•·æ¢åœ–
      if (data.command === "æœ¬æœˆ") {
        let html = `<h2>ğŸ“‹ æ˜ç´°è¡¨ (å…± ${data.count} ç­†ï¼Œç¸½é‡‘é¡ ${data.total})</h2>`;
        html += "<table><tr><th>æ—¥æœŸ</th><th>é‡‘é¡</th><th>åˆ†é¡</th><th>ä»˜æ¬¾æ–¹å¼</th><th>åº—å®¶</th></tr>";
        data.rows.forEach(r => {
          html += `<tr><td>${r[4]}</td><td>${r[5]}</td><td>${r[6]}</td><td>${r[7]}</td><td>${r[8]}</td></tr>`;
        });
        html += "</table>";
        resultDiv.innerHTML = html;

        labels = Object.keys(data.dates);
        values = Object.values(data.dates);
        chartType = "bar";
      }

      // æœ¬æœˆåˆ†é¡ â†’ åœ“é¤…åœ–
      if (data.command === "æœ¬æœˆåˆ†é¡") {
        resultDiv.innerHTML = "<h2>ğŸ“Š åˆ†é¡çµ±è¨ˆ</h2>";
        labels = Object.keys(data.categories);
        values = Object.values(data.categories);
        chartType = "pie";
      }

      // æœ¬æœˆä»˜æ¬¾ â†’ åœ“é¤…åœ–
      if (data.command === "æœ¬æœˆä»˜æ¬¾") {
        resultDiv.innerHTML = "<h2>ğŸ’³ ä»˜æ¬¾æ–¹å¼çµ±è¨ˆ</h2>";
        labels = Object.keys(data.payments);
        values = Object.values(data.payments);
        chartType = "pie";
      }

      // æœ¬æœˆåº—å®¶ â†’ é•·æ¢åœ–
      if (data.command === "æœ¬æœˆåº—å®¶") {
        resultDiv.innerHTML = "<h2>ğŸ¬ åº—å®¶çµ±è¨ˆ</h2>";
        labels = Object.keys(data.shops);
        values = Object.values(data.shops);
        chartType = "bar";
      }

      renderChart(labels, values, chartType);
    }

    // ç•«åœ–
    let chartInstance = null;
    function renderChart(labels, values, type) {
      const ctx = document.getElementById("chartCanvas").getContext("2d");
      if (chartInstance) {
        chartInstance.destroy();
      }
      chartInstance = new Chart(ctx, {
        type: type,
        data: {
          labels: labels,
          datasets: [{
            label: "é‡‘é¡",
            data: values,
            backgroundColor: type === "bar"
              ? "rgba(54, 162, 235, 0.6)"
              : [
                  "rgba(255, 99, 132, 0.6)",
                  "rgba(54, 162, 235, 0.6)",
                  "rgba(255, 206, 86, 0.6)",
                  "rgba(75, 192, 192, 0.6)",
                  "rgba(153, 102, 255, 0.6)",
                  "rgba(255, 159, 64, 0.6)"
                ]
          }]
        }
      });
    }

    // ä¸€é€²é é¢å°±é è¨­æŸ¥è©¢ã€Œæœ¬æœˆã€
    window.onload = () => {
      queryData("æœ¬æœˆ");
    };
  </script>
</body>
</html>
