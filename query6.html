<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>零用金支出查詢</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { margin-top: 30px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    .date-range { margin: 15px 0; font-weight: bold; color: #333; }
    .buttons { margin-bottom: 20px; }
    button { margin-right: 10px; padding: 8px 12px; }
    canvas { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>💰 零用金支出查詢</h1>

  <!-- 日期區間顯示 -->
  <div class="date-range" id="dateRangeLabel">📅 查詢區間：</div>

  <!-- 查詢按鈕 -->
  <div class="buttons">
    <button onclick="queryData('本月')">查詢本月</button>
    <button onclick="queryData('本月付款')">查詢本月付款</button>
    <button onclick="queryData('本月分類')">查詢本月分類</button>
    <button onclick="queryData('本月店家')">查詢本月店家</button>
  </div>

  <!-- 查詢結果 -->
  <div id="result"></div>
  <canvas id="chartCanvas"></canvas>

  <script>
    const GAS_URL = "你的GAS網址"; // ⚠️ 換成你的 GAS 部署網址

    // 預設本月的日期區間
    function getDefaultDateRange() {
      const today = new Date();
      const year = today.getFullYear();
      const month = today.getMonth(); // 0-based

      // 月初
      const startDate = new Date(year, month, 1);
      // 月底（下一個月的0號就是這個月最後一天）
      const endDate = new Date(year, month + 1, 0);

      return {
        start: formatDate(startDate),
        end: formatDate(endDate)
      };
    }

    // 格式化 yyyy/MM/dd
    function formatDate(d) {
      const y = d.getFullYear();
      const m = ("0" + (d.getMonth() + 1)).slice(-2);
      const day = ("0" + d.getDate()).slice(-2);
      return `${y}/${m}/${day}`;
    }

    // 更新畫面上的查詢區間標籤
    function updateDateLabel(start, end) {
      document.getElementById("dateRangeLabel").innerText =
        `📅 查詢區間：${start} ~ ${end}`;
    }

    // 查詢資料
    async function queryData(command) {
      const { start, end } = getDefaultDateRange();
      updateDateLabel(start, end);

      try {
        const res = await fetch(GAS_URL, {
          method: "POST",
          body: JSON.stringify({
            type: "query",
            command: command,
            startDate: start,
            endDate: end
          })
        });

        const data = await res.json();
        if (!data.ok) {
          document.getElementById("result").innerHTML = "❌ 查詢失敗";
          return;
        }

        renderResult(data);
      } catch (err) {
        document.getElementById("result").innerHTML = "❌ 查詢失敗：" + err;
      }
    }

    // 顯示查詢結果（表格 + 圖表）
    function renderResult(data) {
      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = "";
      let labels = [];
      let values = [];
      let chartType = "bar";

      // 本月 → 顯示明細表 + 日期長條圖
      if (data.command === "本月") {
        let html = `<h2>📋 明細表 (共 ${data.count} 筆，總金額 ${data.total})</h2>`;
        html += "<table><tr><th>日期</th><th>金額</th><th>分類</th><th>付款方式</th><th>店家</th></tr>";
        data.rows.forEach(r => {
          html += `<tr><td>${r[4]}</td><td>${r[5]}</td><td>${r[6]}</td><td>${r[7]}</td><td>${r[8]}</td></tr>`;
        });
        html += "</table>";
        resultDiv.innerHTML = html;

        labels = Object.keys(data.dates);
        values = Object.values(data.dates);
        chartType = "bar";
      }

      // 本月分類 → 圓餅圖
      if (data.command === "本月分類") {
        resultDiv.innerHTML = "<h2>📊 分類統計</h2>";
        labels = Object.keys(data.categories);
        values = Object.values(data.categories);
        chartType = "pie";
      }

      // 本月付款 → 圓餅圖
      if (data.command === "本月付款") {
        resultDiv.innerHTML = "<h2>💳 付款方式統計</h2>";
        labels = Object.keys(data.payments);
        values = Object.values(data.payments);
        chartType = "pie";
      }

      // 本月店家 → 長條圖
      if (data.command === "本月店家") {
        resultDiv.innerHTML = "<h2>🏬 店家統計</h2>";
        labels = Object.keys(data.shops);
        values = Object.values(data.shops);
        chartType = "bar";
      }

      renderChart(labels, values, chartType);
    }

    // 畫圖
    let chartInstance = null;
    function renderChart(labels, values, type) {
      const ctx = document.getElementById("chartCanvas").getContext("2d");
      if (chartInstance) {
        chartInstance.destroy();
      }
      chartInstance = new Chart(ctx, {
        type: type,
        data: {
          labels: labels,
          datasets: [{
            label: "金額",
            data: values,
            backgroundColor: type === "bar"
              ? "rgba(54, 162, 235, 0.6)"
              : [
                  "rgba(255, 99, 132, 0.6)",
                  "rgba(54, 162, 235, 0.6)",
                  "rgba(255, 206, 86, 0.6)",
                  "rgba(75, 192, 192, 0.6)",
                  "rgba(153, 102, 255, 0.6)",
                  "rgba(255, 159, 64, 0.6)"
                ]
          }]
        }
      });
    }

    // 一進頁面就預設查詢「本月」
    window.onload = () => {
      queryData("本月");
    };
  </script>
</body>
</html>
