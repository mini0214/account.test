<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>é›¶ç”¨é‡‘æŸ¥è©¢</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 30px; }
    h3 { font-size: 40px; text-align: center; margin-bottom: 30px; }
    button { font-size: 30px; padding: 15px 25px; margin: 5px; border-radius: 8px; cursor: pointer; }
    #queryResult { margin-top: 30px; }
    table { border-collapse: collapse; width: 100%; margin-top: 15px; font-size: 20px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background-color: #f2f2f2; }
    .total { font-size: 28px; font-weight: bold; color: #d9534f; margin-top: 10px; }
    canvas { margin-top: 20px; display: block; }
  </style>
</head>
<body>

<h3>é›¶ç”¨é‡‘æŸ¥è©¢ [<span id="version"></span>]</h3>

<button id="queryMonthBtn">ğŸ“Š æŸ¥è©¢æœ¬æœˆ</button>
<button id="queryMonthPayBtn">ğŸ’³ æŸ¥è©¢æœ¬æœˆä»˜æ¬¾</button>
<button id="queryMonthtypeBtn">â­• æŸ¥è©¢æœ¬æœˆåˆ†é¡</button>
<button id="queryMonthstoreBtn">ğŸ“‹ æŸ¥è©¢æœ¬æœˆåº—å®¶</button>

<div id="queryResult"></div>

<script>
const LIFF_ID = "2008096451-jPJ50MOY";
const VERSION = "T3";
const API_URL = "https://script.google.com/macros/s/AKfycbzp7z2jx-chJ15TGqCNhDuOaJrV92CEGYU-6XrA_qdIjeEg2lFmKwmPZcjfnBthcndbJw/exec";

document.getElementById("version").textContent = VERSION;

// LIFF åˆå§‹åŒ–
async function main() {
  await liff.init({ liffId: LIFF_ID });
  if (!liff.isLoggedIn()) liff.login();
}
main();

// æŒ‰éˆ•äº‹ä»¶
document.getElementById("queryMonthBtn").addEventListener("click", () => sendQuery("æœ¬æœˆ"));
document.getElementById("queryMonthtypeBtn").addEventListener("click", () => sendQuery("æœ¬æœˆåˆ†é¡"));
document.getElementById("queryMonthPayBtn").addEventListener("click", () => sendQuery("æœ¬æœˆä»˜æ¬¾"));
document.getElementById("queryMonthstoreBtn").addEventListener("click", () => sendQuery("æœ¬æœˆåº—å®¶"));

// ç”Ÿæˆ canvas
function createCanvas(id, width=400, height=300){
  const container = document.getElementById("queryResult");
  const old = document.getElementById(id);
  if(old) old.remove();
  const canvas = document.createElement("canvas");
  canvas.id = id;
  canvas.width = width;
  canvas.height = height;
  container.appendChild(canvas);
  return canvas;
}

// æŸ¥è©¢å‡½æ•¸
async function sendQuery(command){
  const container = document.getElementById("queryResult");
  container.innerHTML = "<p>è®€å–ä¸­...</p>";
  const url = `${API_URL}?type=query&command=${encodeURIComponent(command)}&version=${VERSION}`;
  
  try{
    const res = await fetch(url);
    const json = await res.json();
    if(!json.ok){ container.innerHTML="<p style='color:red'>âŒ æŸ¥è©¢å¤±æ•—</p>"; return; }
    
    container.innerHTML = ""; // æ¸…ç©º container
    let html = "";

    // è¡¨æ ¼ç”Ÿæˆ
    if(command==="æœ¬æœˆ" && json.rows){
      html += `<table><tr>
        <th>æ—¥æœŸ</th><th>åº—å®¶</th><th>æ”¶å…¥</th><th>æ”¯å‡º</th><th>å¹£åˆ¥</th>
        <th>é‡‘é¡</th><th>ä»˜æ¬¾</th><th>åˆ†é¡</th><th>é™„è¨»</th><th>å‚™è¨»</th>
      </tr>`;
      json.rows.forEach(r=>{
        const dateStr = r[4]?new Date(r[4]).toLocaleDateString("zh-TW"):"";
        html += `<tr>
          <td>${dateStr}</td><td>${r[8]}</td><td>${Number(r[11]).toLocaleString()}</td>
          <td>${Number(r[12]).toLocaleString()}</td><td>${r[13]}</td><td>${Number(r[5]).toLocaleString()}</td>
          <td>${r[7]}</td><td>${r[6]}</td><td>${r[9]}</td><td>${r[10]}</td>
        </tr>`;
      });
      html += `</table>`;
      html += `<div class="total">ğŸ“Œ æœ¬æœˆç¸½é¡ï¼š${Number(json.total||0).toLocaleString()} å…ƒ</div>`;
      container.innerHTML = html;

      // é•·æ¢åœ–ï¼ˆåˆ†é¡çµ±è¨ˆï¼‰
      if(json.categories){
        const ctx = createCanvas("barChart").getContext("2d");
        new Chart(ctx,{
          type:'bar',
          data:{
            labels: Object.keys(json.categories),
            datasets:[{label:'é‡‘é¡', data:Object.values(json.categories), backgroundColor:'#36A2EB'}]
          },
          options:{responsive:true, plugins:{legend:{display:false}}}
        });
      }
      return;
    }

    // å…¶ä»–ä¸‰å€‹æŸ¥è©¢ï¼šè¡¨æ ¼ + åœ“é¤…åœ–
    let pieData = null;
    let title = "";
    if(command==="æœ¬æœˆåˆ†é¡"){ pieData=json.categories; title="â­• æœ¬æœˆåˆ†é¡çµ±è¨ˆ"; }
    if(command==="æœ¬æœˆä»˜æ¬¾"){ pieData=json.payments; title="ğŸ’³ æœ¬æœˆä»˜æ¬¾çµ±è¨ˆ"; }
    if(command==="æœ¬æœˆåº—å®¶"){ pieData=json.stores; title="ğŸ“‹ æœ¬æœˆåº—å®¶çµ±è¨ˆ"; }

    if(pieData){
      html += `<h4>${title}</h4>`;
      html += `<table><tr><th>é …ç›®</th><th>é‡‘é¡</th><th>å æ¯”</th></tr>`;
      for(const [k,v] of Object.entries(pieData)){
        const percent = ((v/json.total)*100).toFixed(1);
        html += `<tr><td>${k}</td><td>${Number(v).toLocaleString()}</td><td>${percent}%</td></tr>`;
      }
      html += `</table>`;
      html += `<div class="total">ğŸ“Œ æœ¬æœˆç¸½é¡ï¼š${Number(json.total||0).toLocaleString()} å…ƒ</div>`;
      container.innerHTML = html;

      // åœ“é¤…åœ–
      const ctx = createCanvas("pieChart").getContext("2d");
      new Chart(ctx,{
        type:'pie',
        data:{
          labels: Object.keys(pieData),
          datasets:[{
            data: Object.values(pieData),
            backgroundColor:['#FF6384','#36A2EB','#FFCE56','#4CAF50','#FF9800','#9C27B0','#00BCD4','#2196F3','#8BC34A','#FFC107']
          }]
        },
        options:{responsive:true, plugins:{legend:{position:'bottom'}}}
      });
    }

  }catch(err){
    container.innerHTML = `<p style="color:red">âŒ æŸ¥è©¢å¤±æ•—ï¼š${err.message}</p>`;
  }
}
</script>

</body>
</html>
