<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>é›¶ç”¨é‡‘æŸ¥è©¢</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial, sans-serif; padding: 30px; }
  h3 { font-size: 36px; text-align: center; margin-bottom: 20px; }
  button { font-size: 20px; padding: 10px 20px; margin: 5px; border-radius: 6px; cursor: pointer; }
  #queryResult { margin-top: 20px; }
  table { border-collapse: collapse; width: 100%; margin-top: 15px; font-size: 16px; }
  th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
  th { background-color: #f2f2f2; }
  .total { font-size: 18px; font-weight: bold; color: #d9534f; margin-top: 10px; }
</style>
</head>
<body>

<h3>é›¶ç”¨é‡‘æŸ¥è©¢ [<span id="version"></span>]</h3>

<button id="queryMonthBtn">ğŸ“Š æŸ¥è©¢æœ¬æœˆ</button>
<button id="queryMonthPayBtn">ğŸ’³ æŸ¥è©¢æœ¬æœˆä»˜æ¬¾</button>
<button id="queryMonthtypeBtn">â­• æŸ¥è©¢æœ¬æœˆåˆ†é¡</button>
<button id="queryMonthstoreBtn">ğŸ“‹ æŸ¥è©¢æœ¬æœˆåº—å®¶</button>

<div id="queryResult"></div>

<script>
const LIFF_ID = "2008096451-jPJ50MOY"; // ä½ çš„ LIFF ID
const VERSION = "T3";
const API_URL = "https://script.google.com/macros/s/AKfycbzp7z2jx-chJ15TGqCNhDuOaJrV92CEGYU-6XrA_qdIjeEg2lFmKwmPZcjfnBthcndbJw/exec";

document.getElementById("version").textContent = VERSION;

// åˆå§‹åŒ– LIFF
async function main() {
  await liff.init({ liffId: LIFF_ID });
  if (!liff.isLoggedIn()) liff.login();
}
main();

// ç¶å®šæŒ‰éˆ•
document.getElementById("queryMonthBtn").addEventListener("click", () => sendQuery("æœ¬æœˆ"));
document.getElementById("queryMonthtypeBtn").addEventListener("click", () => sendQuery("æœ¬æœˆåˆ†é¡"));
document.getElementById("queryMonthPayBtn").addEventListener("click", () => sendQuery("æœ¬æœˆä»˜æ¬¾"));
document.getElementById("queryMonthstoreBtn").addEventListener("click", () => sendQuery("æœ¬æœˆåº—å®¶"));

// ç™¼é€æŸ¥è©¢
async function sendQuery(command) {
  const body = { type: "query", command: command, version: VERSION };

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify(body)
    });
    const json = await res.json();

    if (!json.ok) {
      document.getElementById("queryResult").innerHTML = `<p style="color:red">âŒ æŸ¥è©¢å¤±æ•—</p>`;
      return;
    }

    let html = "";

    // === æœ¬æœˆæ˜ç´° + é•·æ¢åœ–ï¼ˆåˆ†é¡çµ±è¨ˆï¼‰ ===
    if (command === "æœ¬æœˆ" && json.rows) {
      html += `<table><tr><th>æ—¥æœŸ</th><th>åº—å®¶</th><th>æ”¶å…¥</th><th>æ”¯å‡º</th><th>å¹£åˆ¥</th><th>é‡‘é¡</th><th>ä»˜æ¬¾</th><th>åˆ†é¡</th><th>é™„è¨»</th><th>å‚™è¨»</th></tr>`;
      json.rows.forEach(r => {
        const dateStr = r[4] ? new Date(r[4]).toLocaleDateString("zh-TW") : "";
        html += `<tr>
          <td>${dateStr}</td>
          <td>${r[8]}</td>
          <td>${Number(r[11]).toLocaleString()}</td>
          <td>${Number(r[12]).toLocaleString()}</td>
          <td>${r[13]}</td>
          <td>${Number(r[5]).toLocaleString()}</td>
          <td>${r[7]}</td>
          <td>${r[6]}</td>
          <td>${r[9]}</td>
          <td>${r[10]}</td>
        </tr>`;
      });
      html += `</table>`;
      html += `<canvas id="barChart" width="600" height="300" style="margin-top:20px;"></canvas>`;
      html += `<div class="total">ğŸ“Œ æœ¬æœˆç¸½é¡ï¼š${Number(json.total || 0).toLocaleString()} å…ƒ</div>`;
      document.getElementById("queryResult").innerHTML = html;

      // é•·æ¢åœ–ç”¨åˆ†é¡çµ±è¨ˆ
      if (json.categories) {
        const ctx = document.getElementById('barChart').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: Object.keys(json.categories),
            datasets: [{
              label: 'åˆ†é¡é‡‘é¡',
              data: Object.values(json.categories),
              backgroundColor: '#36A2EB'
            }]
          },
          options: { responsive:true }
        });
      }
      return;
    }

    // === å…¶ä»–ä¸‰å€‹æŸ¥è©¢ ===
    let dataKey = '';
    let chartId = '';
    let chartTitle = '';

    if (command === "æœ¬æœˆåˆ†é¡" && json.categories) { dataKey = 'categories'; chartId = 'pieChart'; chartTitle='â­• æœ¬æœˆåˆ†é¡çµ±è¨ˆ'; }
    if (command === "æœ¬æœˆä»˜æ¬¾" && json.payments) { dataKey = 'payments'; chartId = 'pieChart'; chartTitle='ğŸ’³ æœ¬æœˆä»˜æ¬¾çµ±è¨ˆ'; }
    if (command === "æœ¬æœˆåº—å®¶" && json.stores) { dataKey = 'stores'; chartId = 'pieChart'; chartTitle='ğŸ“‹ æœ¬æœˆåº—å®¶çµ±è¨ˆ'; }

    if (dataKey) {
      const dataObj = json[dataKey];
      html += `<h4>${chartTitle}</h4>`;
      html += `<table><tr><th>é …ç›®</th><th>é‡‘é¡</th><th>å æ¯”</th></tr>`;
      for (const [k, v] of Object.entries(dataObj)) {
        const percent = ((v / json.total)*100).toFixed(1);
        html += `<tr><td>${k}</td><td>${Number(v).toLocaleString()}</td><td>${percent}%</td></tr>`;
      }
      html += `</table>`;
      html += `<canvas id="${chartId}" width="400" height="400" style="margin-top:20px;"></canvas>`;
      html += `<div class="total">ğŸ“Œ æœ¬æœˆç¸½é¡ï¼š${Number(json.total || 0).toLocaleString()} å…ƒ</div>`;
      document.getElementById("queryResult").innerHTML = html;

      // åœ“é¤…åœ–
      const ctx = document.get
