<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>é›¶ç”¨é‡‘æ”¯å‡ºå¸³ç°¿</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    body { font-family: Arial, sans-serif; padding: 50px; }
    h3 { font-size: 50px; text-align: center; margin-bottom: 50px; }
    .date-inputs { font-size: 50px; text-align: center; margin-bottom: 20px;  }
    .date-inputs input { font-size: 50px; margin: 0 10px;  padding: 5px; }
    h4 { font-size: 36px; text-align: center; margin-bottom: 20px; }
    button { font-size: 40px; margin: 5px; padding: 10px 20px; border-radius: 8px; cursor: pointer; background-color: #4CAF50; color: white; }
    #queryResult { margin-top: 1px; }
    h5 { font-size: 28px; margin: 0; padding: 0; }
    table { font-size: 28px; border-collapse: collapse; width: 100%; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    .numeric { text-align: right; }
    .total { font-size: 28px; font-weight: bold; color: #d9534f; margin-top: 10px; }
    canvas { display: block; margin: 20px auto; width: 850px; height: 600px; }
  </style>
</head>
<body>

<h3>éçœ‹ä¸å¯.[<span id="version"></span>]</h3>

<div class="date-inputs">
  é–‹å§‹æ—¥æœŸï¼š<input type="date" id="startDate"><br>
  çµæŸæ—¥æœŸï¼š<input type="date" id="endDate">
</div>

<h4>é¸æ“‡æ‚¨æƒ³è¦çœ‹çš„(ç›´çƒå°æ±º)</h4>

<div style="text-align:center">
  <button id="queryMonthBtn">ğŸ“Š æ˜ç´°</button>
  <button id="queryMonthPayBtn">ğŸ’³ ä»˜æ¬¾</button>
  <button id="queryMonthTypeBtn">â­• åˆ†é¡</button>
  <button id="queryMonthStoreBtn">ğŸ“‹ åº—å®¶</button>
</div>

<div id="loading" style="display:none; text-align:center; margin:20px;">
  <span>â³ è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</span>
</div>

<div id="queryResult"></div>
<canvas id="chartCanvas"></canvas>

<script>
const LIFF_ID = "2008096451-jPJ50MOY";
const VERSION = "V16_#12";
const API_URL = "https://script.google.com/macros/s/AKfycbwyWN-amLqH2mGL1qWC3X6hV82oXiihPYUPqJR_NMOMOnRUo7wsgop-W10IhlW6glCB3w/exec";

let chartInstance = null;
let currentUser = null;

document.getElementById("version").textContent = VERSION;

// åˆå§‹åŒ– LIFF
async function main() {
  await liff.init({ liffId: LIFF_ID });
  if (!liff.isLoggedIn()) liff.login();
  try { currentUser = (await liff.getProfile()).displayName; }
  catch(e) { console.warn("æŠ“ä¸åˆ° LINE åç¨±ï¼Œæœƒæ”¹ç”¨è³‡æ–™è¡¨ç¬¬ä¸€ç­†:", e); }
  setDefaultDateRange();
}
main();

function setDefaultDateRange() {
  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth(), 1);
  const end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
  document.getElementById("startDate").value = toInputDate(start);
  document.getElementById("endDate").value = toInputDate(end);
}
function toInputDate(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

// æŒ‰éˆ•äº‹ä»¶
document.getElementById("queryMonthBtn").addEventListener("click", () => sendQuery("æ˜ç´°"));
document.getElementById("queryMonthTypeBtn").addEventListener("click", () => sendQuery("åˆ†é¡"));
document.getElementById("queryMonthPayBtn").addEventListener("click", () => sendQuery("ä»˜æ¬¾"));
document.getElementById("queryMonthStoreBtn").addEventListener("click", () => sendQuery("åº—å®¶"));

// ç™¼é€æŸ¥è©¢
async function sendQuery(command) {
  const startDate = document.getElementById("startDate").value;
  const endDate = document.getElementById("endDate").value;
  if (!startDate || !endDate) { alert("è«‹é¸æ“‡é–‹å§‹èˆ‡çµæŸæ—¥æœŸ"); return; }

  // âœ… æŸ¥è©¢å‰æ¸…ç©ºèˆŠè³‡æ–™ & åœ–è¡¨
  document.getElementById("queryResult").innerHTML = "";
  if (chartInstance) { chartInstance.destroy(); chartInstance = null; }
  const ctx = document.getElementById("chartCanvas").getContext("2d");
  ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);

  document.getElementById("loading").style.display = "block";

  const body = { type:"query", command, version:VERSION, startDate: startDate+" 00:00:00", endDate: endDate+" 23:59:59" };
  
  try {
    const res = await fetch(API_URL, { method:"POST", body: JSON.stringify(body) });
    const json = await res.json();
    if (!json.ok) { document.getElementById("queryResult").innerHTML = `<p style="color:red">âŒ æŸ¥è©¢å¤±æ•—</p>`; return; }
    renderResult(command, json);
  } catch(err) {
    document.getElementById("queryResult").innerHTML = `<p style="color:red">âŒ æŸ¥è©¢å¤±æ•—ï¼š${err.message}</p>`;
  } finally { document.getElementById("loading").style.display = "none"; }
}

// é¡¯ç¤ºçµæœ
function renderResult(command, json) {
  let html = "";
  const adminUser = "Betty Yi";
  if (!currentUser && json.rows?.length>0) currentUser = json.rows[0][3];

  let filteredRows = json.rows || [];
  if (currentUser && currentUser!==adminUser) filteredRows = filteredRows.filter(r=>r[3]===currentUser);

  if (command==="æ˜ç´°") {
    const rowsForDisplay = (currentUser===adminUser) ? json.rows : filteredRows;
    html += `<h5>ğŸ“Š é¸æ“‡æŸ¥è©¢æ˜ç´°;æ¨™é¡ŒæŒ‰ä¸‹å³å¯æ’åº</h5><table id="dataTable">
              <tr>
                <th>è¨˜å¸³è€…</th><th>æ—¥æœŸ</th><th>åº—å®¶</th><th class="numeric">æ”¶å…¥</th>
                <th class="numeric">æ”¯å‡º</th><th>åŒ¯ç‡</th><th class="numeric">é‡‘é¡</th>
                <th>ä»˜æ¬¾</th><th>åˆ†é¡</th><th>é™„è¨»</th><th>å‚™è¨»</th>
              </tr>`;
    rowsForDisplay.forEach(r=>{
      const dateStr = r[4]?new Date(r[4]).toLocaleDateString("zh-TW"):"";
      html += `<tr>
                <td>${r[3]}</td><td>${dateStr}</td><td>${r[8]}</td>
                <td class="numeric">${Number(r[11]).toLocaleString()}</td>
                <td class="numeric">${Number(r[12]).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}</td>
                <td>${r[13]}</td><td class="numeric">${Number(r[5]).toLocaleString()}</td>
                <td>${r[7]}</td><td>${r[6]}</td><td>${r[9]}</td><td>${r[10]}</td>
              </tr>`;
    });
    html += `</table>`;
    const totalAmount = rowsForDisplay.reduce((sum,r)=>sum+Number(r[5]||0),0);
    html += `<div class="total">ğŸ“Œ ç¸½é¡ï¼š${totalAmount.toLocaleString()} å…ƒï¼ˆå…± ${rowsForDisplay.length} ç­†ï¼‰</div>`;

    const dateSum = {}, maxCurrencyByDate = {};
    rowsForDisplay.forEach(r=>{
      const d = new Date(r[4]).toLocaleDateString("zh-TW");
      const amount = Number(r[5]);
      const currency = Number(r[13]);
      dateSum[d] = (dateSum[d]||0)+amount;
      if(!maxCurrencyByDate[d]||currency>maxCurrencyByDate[d]) maxCurrencyByDate[d]=currency;
    });
    const sortedDates = Object.keys(dateSum).sort((a,b)=>new Date(a)-new Date(b));
    renderChart("bar", sortedDates, [sortedDates.map(d=>dateSum[d]), sortedDates.map(d=>maxCurrencyByDate[d]||0)]);
  }

  const sections = [
    { cmd:"åˆ†é¡", key:6, title:"â­• é¸æ“‡åˆ†é¡çµ±è¨ˆ;æ¨™é¡ŒæŒ‰ä¸‹å³å¯æ’åº" },
    { cmd:"ä»˜æ¬¾", key:7, title:"ğŸ’³ é¸æ“‡ä»˜æ¬¾çµ±è¨ˆ;æ¨™é¡ŒæŒ‰ä¸‹å³å¯æ’åº" },
    { cmd:"åº—å®¶", key:8, title:"ğŸ“‹ é¸æ“‡åº—å®¶çµ±è¨ˆ;æ¨™é¡ŒæŒ‰ä¸‹å³å¯æ’åº" }
  ];

  sections.forEach(sec=>{
    if(command===sec.cmd){
      const counts = {};
      filteredRows.forEach(r=>{
        const value = r[sec.key]||"æœªçŸ¥";
        counts[value] = (counts[value]||0)+Number(r[5]||0);
      });
      const labels = Object.keys(counts), values = Object.values(counts), total = values.reduce((a,b)=>a+b,0);
      html += `<h5>${sec.title}</h5><table id="dataTable">
                 <tr><th>${sec.cmd==="åº—å®¶"?"åº—å®¶":sec.cmd==="ä»˜æ¬¾"?"ä»˜æ¬¾æ–¹å¼":"åˆ†é¡æ–¹å¼"}</th>
                 <th class="numeric">é‡‘é¡</th><th class="numeric">å æ¯”</th></tr>`;
      labels.forEach((l,i)=>{ html+=`<tr><td>${l}</td><td class="numeric">${values[i].toLocaleString()}</td><td class="numeric">${((values[i]/total)*100).toFixed(1)}%</td></tr>`; });
      html += `</table><div class="total">ğŸ“Œ ç¸½é¡ï¼š${total.toLocaleString()} å…ƒï¼ˆå…± ${labels.length} ç­†ï¼‰</div>`;
      renderChart("pie", labels, values);
    }
  });

  document.getElementById("queryResult").innerHTML = html;

  const dataTable = document.getElementById("dataTable");
  if(dataTable) makeTableSortable(dataTable);
}

// è¡¨æ ¼æ’åº
function makeTableSortable(table) {
  const headers = table.querySelectorAll("th");
  headers.forEach((th, colIndex)=>{
    th.style.cursor="pointer";
    th.addEventListener("click", ()=>{
      const rows = Array.from(table.querySelectorAll("tr")).slice(1);
      const newOrder = th.dataset.order==="asc"?"desc":"asc";
      th.dataset.order=newOrder;
      rows.sort((a,b)=>{
        let aVal=parseCellValue(a.cells[colIndex].innerText);
        let bVal=parseCellValue(b.cells[colIndex].innerText);
        return newOrder==="asc"?aVal-bVal:bVal-aVal;
      });
      rows.forEach(r=>table.appendChild(r));
    });
  });
}
function parseCellValue(txt){ let v=txt.replace(/,/g,"").replace("%",""); return isNaN(v)?txt:parseFloat(v); }

// ç•«åœ–
function renderChart(type, labels, values){
  const ctx = document.getElementById("chartCanvas").getContext("2d");
  if(chartInstance){ chartInstance.destroy(); chartInstance=null; }
  
  if(type==="pie"){
    const colors = labels.map((_,i)=>`hsl(${i*360/labels.length},70%,60%)`);
    chartInstance=new Chart(ctx,{
      type:"pie",
      data:{ labels, datasets:[{ data:values, backgroundColor:colors }] },
      options:{ responsive:true }
    });
  } else if(type==="bar"){
    const barValues = values[0]||[], lineValues = values[1]||[];
    const minRate=Math.floor(Math.min(...lineValues))-1;
    const maxRate=Math.ceil(Math.max(...lineValues))+1;
    chartInstance=new Chart(ctx,{
      type:"bar",
      data:{
        labels,
        datasets:[
          { type:"bar", label:"é‡‘é¡åˆè¨ˆ", data:barValues, backgroundColor:"rgba(54,162,235,0.6)", yAxisID:"y" },
          { type:"line", label:"æ¯æ—¥åŒ¯ç‡æœ€å¤§å€¼", data:lineValues, borderColor:"red", backgroundColor:"red", fill:false, yAxisID:"y1", tension:0.1, pointRadius:3, pointBackgroundColor:"red", pointBorderColor:"red" }
        ]
      },
      options:{
        responsive:true,
        interaction:{ mode:"index", intersect:false },
        scales:{
          y:{ type:"linear", position:"left", title:{ display:true, text:"é‡‘é¡" }, beginAtZero:true },
          y1:{ type:"linear", position:"right", title:{ display:true, text:"åŒ¯ç‡", color:"red" }, grid:{ drawOnChartArea:false }, min:minRate, max:maxRate }
        }
      }
    });
  }
}
</script>

</body>
</html>
