<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>é›¶ç”¨é‡‘æ”¯å‡ºå¸³ç°¿</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    body { font-family: Arial, sans-serif; padding: 30px; }
    h3 { font-size: 36px; text-align: center; margin-bottom: 15px; }
    .date-inputs { text-align: center; margin-bottom: 20px; font-size: 20px; }
    .date-inputs input { margin: 0 10px; font-size: 18px; padding: 5px; }
    button { font-size: 26px; padding: 10px 20px; margin: 5px; border-radius: 8px; cursor: pointer; }
    #queryResult { margin-top: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 15px; font-size: 18px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    .total { font-size: 22px; font-weight: bold; color: #d9534f; margin-top: 10px; }
    canvas { margin-top: 20px; max-width: 800px; }
    
    /* æ•¸å­—æ¬„ä½é å³ ... */  
    #dataTable th.numeric,
    #dataTable td.numeric {
      text-align: right;
    }

  </style>
</head>
<body>

<h3>éçœ‹ä¸å¯.[<span id="version"></span>]</h3>

<div class="date-inputs">
  é–‹å§‹æ—¥æœŸï¼š<input type="date" id="startDate">
  çµæŸæ—¥æœŸï¼š<input type="date" id="endDate">
</div>

<div style="text-align:center">
  <button id="queryMonthBtn">ğŸ“Š æŸ¥è©¢æ˜ç´°</button>
  <button id="queryMonthPayBtn">ğŸ’³ æŸ¥è©¢ä»˜æ¬¾</button>
  <button id="queryMonthTypeBtn">â­• æŸ¥è©¢åˆ†é¡</button>
  <button id="queryMonthStoreBtn">ğŸ“‹ æŸ¥è©¢åº—å®¶</button>
</div>

<div id="queryResult"></div>
<canvas id="chartCanvas"></canvas>

<script>
const LIFF_ID = "2008096451-jPJ50MOY";
const VERSION = "T9";
const API_URL = "https://script.google.com/macros/s/AKfycbwQ1t5wHfjAqrtH0_ijNNWtlE5Q0R-g8fwb5htWQoCXKXxSukVX9qVnrfuyoXOyKkGXdw/exec"; // æ”¹æˆä½ çš„GASç¶²å€

let chartInstance = null;

document.getElementById("version").textContent = VERSION;

// åˆå§‹åŒ– LIFF
async function main() {
  await liff.init({ liffId: LIFF_ID });
  if (!liff.isLoggedIn()) liff.login();
  setDefaultDateRange();
}
main();

// è¨­å®šé è¨­æ—¥æœŸç‚ºæœ¬æœˆæœˆåˆèˆ‡æœˆåº•
function setDefaultDateRange() {
  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth(), 1);
  const end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
  document.getElementById("startDate").value = toInputDate(start);
  document.getElementById("endDate").value = toInputDate(end);
}

function toInputDate(d) {
  const m = (d.getMonth() + 1).toString().padStart(2, "0");
  const day = d.getDate().toString().padStart(2, "0");
  return `${d.getFullYear()}-${m}-${day}`;
}

// æŒ‰éˆ•äº‹ä»¶
document.getElementById("queryMonthBtn").addEventListener("click", () => sendQuery("æ˜ç´°"));
document.getElementById("queryMonthTypeBtn").addEventListener("click", () => sendQuery("åˆ†é¡"));
document.getElementById("queryMonthPayBtn").addEventListener("click", () => sendQuery("ä»˜æ¬¾"));
document.getElementById("queryMonthStoreBtn").addEventListener("click", () => sendQuery("åº—å®¶"));

/* è§£æå„²å­˜æ ¼æ–‡å­—æˆæ•¸å­—æˆ–æ–‡å­— */
function parseCellValue(text) {
  let v = text.replace(/,/g, "").trim();
  if (v.endsWith("%")) {
    return parseFloat(v.replace("%", "")) || 0;
  }
  if (!isNaN(v) && v !== "") {
    return parseFloat(v);
  }
  return v.toLowerCase(); // æ–‡å­—æ¯”å°
}
  
/* é€šç”¨è¡¨æ ¼æ’åº */
function makeTableSortable(table) {
  const headers = table.querySelectorAll("th");
  headers.forEach((th, colIndex) => {
    th.addEventListener("click", () => {
      const rows = Array.from(table.querySelectorAll("tr")).slice(1); // ç¬¬ä¸€åˆ—æ˜¯è¡¨é ­

      // æ¸…æ‰å…¶ä»–è¡¨é ­ç¬¦è™Ÿ
      headers.forEach(h => {
        if (h !== th) {
          h.dataset.order = "";
          h.innerHTML = h.innerHTML.replace(/[\u25B2\u25BC]/g, "");
        }
      });
      
      const currentOrder = th.dataset.order || "none";
      const newOrder = currentOrder === "asc" ? "desc" : "asc";
      th.dataset.order = newOrder;

      // ğŸ”¹åŠ ä¸Šç¬¦è™Ÿ
      th.innerHTML = th.innerHTML.replace(/[\u25B2\u25BC]/g, "");
      th.innerHTML += newOrder === "asc" ? " â–²" : " â–¼";
      
      // ğŸ”¹æ’åº
      rows.sort((a, b) => {
        let aVal = parseCellValue(a.cells[colIndex].innerText);
        let bVal = parseCellValue(b.cells[colIndex].innerText);

        if (typeof aVal === "number" && typeof bVal === "number") {
          return newOrder === "asc" ? aVal - bVal : bVal - aVal;
        }
        return newOrder === "asc"
          ? aVal.localeCompare(bVal, "zh-Hant")
          : bVal.localeCompare(aVal, "zh-Hant");
      });
      
      // ğŸ”¹æŠŠæ’åºå¾Œçš„åˆ—æ”¾å›è¡¨æ ¼
      rows.forEach(r => table.appendChild(r));
    });
  });
}
  
// ç™¼é€æŸ¥è©¢
async function sendQuery(command) {
  const startDate = document.getElementById("startDate").value;
  const endDate = document.getElementById("endDate").value;
  
  if (!startDate || !endDate) {
    alert("è«‹é¸æ“‡é–‹å§‹èˆ‡çµæŸæ—¥æœŸ");
    return;
  }

  const body = {
    type: "query",
    command: command,
    version: VERSION,
    startDate: startDate + " 00:00:00",  // ğŸ”¹å¼·åˆ¶å¾ç•¶æ—¥é›¶é»é–‹å§‹
    endDate: endDate + " 23:59:59"       // ğŸ”¹å¼·åˆ¶åˆ°ç•¶æ—¥æœ€å¾Œä¸€ç§’
  };

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify(body)
    });
    
    const json = await res.json();
    if (!json.ok) {
      document.getElementById("queryResult").innerHTML = `<p style="color:red">âŒ æŸ¥è©¢å¤±æ•—</p>`;
      return;
    }
    
    renderResult(command, json);
  } catch (err) {
    document.getElementById("queryResult").innerHTML = `<p style="color:red">âŒ æŸ¥è©¢å¤±æ•—ï¼š${err.message}</p>`;
  }
}

// é¡¯ç¤ºçµæœè¡¨æ ¼èˆ‡åœ–è¡¨
function renderResult(command, json) {
  let html = "";
 
  if (command === "æ˜ç´°" && json.rows) {
    html += `<h4>ğŸ“Š æŸ¥è©¢æ˜ç´°</h4>`;
    html += `<table id="dataTable">
              <tr>
                <th>æ—¥æœŸ</th>
                <th>åº—å®¶</th>
                <th class="numeric">æ”¶å…¥</th>
                <th class="numeric">æ”¯å‡º</th>
                <th>å¹£åˆ¥</th>
                <th class="numeric">é‡‘é¡</th>
                <th>ä»˜æ¬¾</th>
                <th>åˆ†é¡</th>
                <th>é™„è¨»</th>
                <th>å‚™è¨»</th>
              </tr>`;
    json.rows.forEach(r => {
      const dateStr = r[4] ? new Date(r[4]).toLocaleDateString("zh-TW") : "";
      html += `<tr>
                <td>${dateStr}</td>
                <td>${r[8]}</td>
                <td class="numeric">${Number(r[11]).toLocaleString()}</td>
                <td class="numeric">${Number(r[12]).toLocaleString()}</td>
                <td>${r[13]}</td>
                <td class="numeric">${Number(r[5]).toLocaleString()}</td>
                <td>${r[7]}</td>
                <td>${r[6]}</td>
                <td>${r[9]}</td>
                <td>${r[10]}</td>
      </tr>`;
    });
    html += `</table>`;
    html += `<div class="total">ğŸ“Œ ç¸½é¡ï¼š${Number(json.total||0).toLocaleString()} å…ƒï¼ˆå…± ${json.rows.length} ç­†ï¼‰</div>`;
    
    // ğŸ”¹ä¾æ—¥æœŸå½™ç¸½é•·æ¢åœ–
    const dailyMap = {};
    json.rows.forEach(r => {
      const dateStr = r[4] ? new Date(r[4]).toLocaleDateString("zh-TW") : "";
      const amount = Number(r[5]) || 0;
      dailyMap[dateStr] = (dailyMap[dateStr] || 0) + amount;
    });
    renderChart("bar", Object.keys(dailyMap), Object.values(dailyMap));
  }

  // åˆ†é¡
  if (command === "åˆ†é¡" && json.categories) {
    const labels = Object.keys(json.categories);
    const values = Object.values(json.categories);
    const total = values.reduce((a,b)=>a+b,0);
    const count = values.length; // ç­†æ•¸ = æœ‰å¹¾å€‹
    
    html += `<h4>â­• åˆ†é¡çµ±è¨ˆ</h4>`;
    html += `<table id="dataTable">
                <tr>
                  <th>åˆ†é¡æ–¹å¼</th>
                  <th class="numeric">é‡‘é¡</th>
                  <th class="numeric">å æ¯”</th>
                </tr>`;
    
    labels.forEach((l,i)=> {
      const percent = ((values[i] / total) * 100).toFixed(1); // å æ¯”è¨ˆç®—
      html += `<tr>
                 <td>${l}</td>
                 <td class="numeric">${values[i].toLocaleString()}</td>
                 <td class="numeric">${percent}%</td>
               </tr>`;
    });
  
    html += `</table>`;
    html += `<div class="total">ğŸ“Œ ç¸½é¡ï¼š${total.toLocaleString()} å…ƒï¼ˆå…± ${count} ç¨®åˆ†é¡ï¼‰</div>`;
    renderChart("pie", labels, values);
  }

  // ä»˜æ¬¾
  if (command === "ä»˜æ¬¾" && json.payments) {
    const labels = Object.keys(json.payments);
    const values = Object.values(json.payments);
    const total = values.reduce((a,b)=>a+b,0);
    const count = values.length; // ç­†æ•¸ = æœ‰å¹¾å€‹
    
    html += `<h4>ğŸ’³ ä»˜æ¬¾çµ±è¨ˆ</h4>`;
    html += `<table id="dataTable">
              <tr>
                <th>ä»˜æ¬¾æ–¹å¼</th>
                <th class="numeric">é‡‘é¡</th>
                <th class="numeric">å æ¯”</th>
              </tr>`;
    
    labels.forEach((l,i)=> {
      const percent = ((values[i] / total) * 100).toFixed(1); // å æ¯”è¨ˆç®—
      html += `<tr>
                 <td>${l}</td>
                 <td class="numeric">${values[i].toLocaleString()}</td>
                 <td class="numeric">${percent}%</td>
               </tr>`;
    });
  
    html += `</table>`;
    html += `<div class="total">ğŸ“Œ ç¸½é¡ï¼š${total.toLocaleString()} å…ƒï¼ˆå…± ${count} ç¨®ä»˜æ¬¾ï¼‰</div>`;
    renderChart("pie", labels, values);
  }

  // åº—å®¶
  if (command === "åº—å®¶" && json.stores) {
    const labels = Object.keys(json.stores);
    const values = Object.values(json.stores);
    const total = values.reduce((a,b)=>a+b,0);
    const count = values.length; // ç­†æ•¸ = æœ‰å¹¾å€‹
    
    html += `<h4>ğŸ“‹ åº—å®¶çµ±è¨ˆ</h4>`;
    html += `<table id="dataTable">
              <tr>
                <th>åº—å®¶</th>
                <th class="numeric">é‡‘é¡</th>
                <th class="numeric">å æ¯”</th>
              </tr>`;
    
    labels.forEach((l,i)=> {
      const percent = ((values[i] / total) * 100).toFixed(1); // å æ¯”è¨ˆç®—
      html += `<tr>
                 <td>${l}</td>
                 <td class="numeric">${values[i].toLocaleString()}</td>
                 <td class="numeric">${percent}%</td>
               </tr>`;
    });
  
    html += `</table>`;
    html += `<div class="total">ğŸ“Œ ç¸½é¡ï¼š${total.toLocaleString()} å…ƒï¼ˆå…± ${count} ç­†åº—å®¶ï¼‰</div>`;
    renderChart("pie", labels, values);
  }

  document.getElementById("queryResult").innerHTML = html;

  // è¡¨æ ¼æ’åº
  const dataTable = document.getElementById("dataTable");
  if (dataTable) makeTableSortable(dataTable);
  }

// ç•«åœ–
function renderChart(type, labels, values) {
  const ctx = document.getElementById("chartCanvas").getContext("2d");
  if (chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    type: type,
    data: { labels: labels, datasets: [{ label: "é‡‘é¡", data: values, backgroundColor: "rgba(54, 162, 235, 0.6)" }] },
    options: { responsive: true }
  });
}
</script>

</body>
</html>






