<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>é›¶ç”¨é‡‘æ”¯å‡ºå¸³ç°¿</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    body { font-family: Arial, sans-serif; padding: 50px; }
    h3 { font-size: 50px; text-align: center; margin-bottom: 50px; }
    .date-inputs { font-size: 50px; text-align: center; margin-bottom: 20px;  }
    .date-inputs input { font-size: 50px; margin: 0 10px;  padding: 5px; }
    h4 { font-size: 36px; text-align: center; margin-bottom: 20px; }
    button { font-size: 40px; margin: 5px; padding: 10px 20px; border-radius: 8px; cursor: pointer; background-color: #4CAF50; color: white; }
    #queryResult { margin-top: 1px; }
    h5 { font-size: 28px; margin: 0; padding: 0; }
    table { font-size: 28px; border-collapse: collapse; width: 100%; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    .numeric { text-align: right; }
    .total { font-size: 28px; font-weight: bold; color: #d9534f; margin-top: 10px; }
    canvas { display: block; margin: 20px auto; width: 850px; height: 600px; }
  </style>
</head>
<body>

<h3>éçœ‹ä¸å¯.[<span id="version"></span>]</h3>

<div class="date-inputs">
  é–‹å§‹æ—¥æœŸï¼š<input type="date" id="startDate"><br>
  çµæŸæ—¥æœŸï¼š<input type="date" id="endDate">
</div>

<h4>é¸æ“‡æ‚¨æƒ³è¦çœ‹çš„(ç›´çƒå°æ±º)</h4>

<div style="text-align:center">
  <button id="queryMonthBtn">ğŸ“Š æ˜ç´°</button>
  <button id="queryMonthPayBtn">ğŸ’³ ä»˜æ¬¾</button>
  <button id="queryMonthTypeBtn">â­• åˆ†é¡</button>
  <button id="queryMonthStoreBtn">ğŸ“‹ åº—å®¶</button>
</div>

<!-- â³ è¼‰å…¥æç¤ºå€ -->
  <div id="loading" style="display:none; text-align:center; margin:20px;">
    <span>â³ è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</span>
  </div>

<!-- ğŸ“Š æŸ¥è©¢çµæœé¡¯ç¤ºå€ -->  
<div id="queryResult"></div>
<canvas id="chartCanvas"></canvas>

<script>
const LIFF_ID = "2008096451-jPJ50MOY"; // æ›æˆä½ çš„ LIFF ID
const VERSION = "V16_#12";             // å›ºå®šç‰ˆæ¬¡
const API_URL = "https://script.google.com/macros/s/AKfycbwyWN-amLqH2mGL1qWC3X6hV82oXiihPYUPqJR_NMOMOnRUo7wsgop-W10IhlW6glCB3w/exec";  // æ›æˆä½ çš„ GAS PATH

let chartInstance = null;
let currentUser = null;   // âœ… å…ˆå®šç¾©è®Šæ•¸ï¼Œä¸è¦ä¸€é–‹å§‹å°±ç”¨ json ç™»å…¥è€…çš„è³‡æ–™
  
document.getElementById("version").textContent = VERSION;

// åˆå§‹åŒ– LIFF
async function main() {
  await liff.init({ liffId: LIFF_ID });
  if (!liff.isLoggedIn()) liff.login();

  // é€™è£¡ä¹Ÿå¯ä»¥å¾ LINE å¸³è™Ÿè‡ªå‹•æŠ“åç¨± ç™»å…¥è€…çš„è³‡æ–™
  try {
    const profile = await liff.getProfile();
    currentUser = profile.displayName;
    console.log("ç™»å…¥ä½¿ç”¨è€…:", currentUser);
  } catch (e) {
    console.warn("æŠ“ä¸åˆ° LINE åç¨±ï¼Œæœƒæ”¹ç”¨è³‡æ–™è¡¨ç¬¬ä¸€ç­†:", e);
  }  
  setDefaultDateRange();
}
main();

// è¨­å®šé è¨­æ—¥æœŸç‚ºæœ¬æœˆæœˆåˆèˆ‡æœˆåº•
function setDefaultDateRange() {
  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth(), 1);
  const end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
  document.getElementById("startDate").value = toInputDate(start);
  document.getElementById("endDate").value = toInputDate(end);
}

function toInputDate(d) {
  const m = (d.getMonth() + 1).toString().padStart(2, "0");
  const day = d.getDate().toString().padStart(2, "0");
  return `${d.getFullYear()}-${m}-${day}`;
}

// æŒ‰éˆ•äº‹ä»¶
document.getElementById("queryMonthBtn").addEventListener("click", () => sendQuery("æ˜ç´°"));
document.getElementById("queryMonthTypeBtn").addEventListener("click", () => sendQuery("åˆ†é¡"));
document.getElementById("queryMonthPayBtn").addEventListener("click", () => sendQuery("ä»˜æ¬¾"));
document.getElementById("queryMonthStoreBtn").addEventListener("click", () => sendQuery("åº—å®¶"));

// ç™¼é€æŸ¥è©¢
async function sendQuery(command) {
  const startDate = document.getElementById("startDate").value;
  const endDate = document.getElementById("endDate").value;
  
  if (!startDate || !endDate) {
    alert("è«‹é¸æ“‡é–‹å§‹èˆ‡çµæŸæ—¥æœŸ");
    return;
  }
  
    // âœ… æŸ¥è©¢å‰æ¸…ç©ºèˆŠçš„æŸ¥è©¢çµæœ
    document.getElementById("queryResult").innerHTML = "";
  
    // âœ… å¦‚æœæœ‰èˆŠåœ–è¡¨ï¼ŒéŠ·æ¯€æ‰
    if (chartInstance) {
      chartInstance.destroy();
      chartInstance = null;
    }
    const ctx = document.getElementById("chartCanvas").getContext("2d");
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
  
    // âœ… é¡¯ç¤ºè¼‰å…¥ä¸­
    document.getElementById("loading").style.display = "block";
    
    const body = {
      type: "query",
      command: command,
      version: VERSION,
      startDate: startDate + " 00:00:00",
      endDate: endDate + " 23:59:59"
    };
 
    try {
      const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(body) });
      const json = await res.json();
      if (!json.ok) {
        document.getElementById("queryResult").innerHTML = `<p style="color:red">âŒ æŸ¥è©¢å¤±æ•—</p>`;
        return;
      }
      renderResult(command, json);
    } catch (err) {
      document.getElementById("queryResult").innerHTML = `<p style="color:red">âŒ æŸ¥è©¢å¤±æ•—ï¼š${err.message}</p>`;
    } finally {
      // âœ… æŸ¥è©¢çµæŸå¾Œéš±è—
      document.getElementById("loading").style.display = "none";
    }
  } // âœ… sendQuery() çµæŸ
// é¡¯ç¤ºçµæœè¡¨æ ¼èˆ‡åœ–è¡¨
function renderResult(command, json) {
  let html = "";

  const adminUser = "Betty Yi"; // âœ… ç®¡ç†è€…å¸³è™Ÿ
  
  // âœ… å¦‚æœ currentUser é‚„æ²’å®šç¾©ï¼Œå°±ç”¨è³‡æ–™è¡¨ç¬¬ä¸€ç­† ç™»å…¥è€…çš„è³‡æ–™
  if (!currentUser && json.rows && json.rows.length > 0) {
    currentUser = json.rows[0][3];  // ç¬¬ 4 æ¬„æ˜¯ display_name
  }

  // âœ… çµ±ä¸€éæ¿¾ï¼šç®¡ç†è€…çœ‹åˆ°å…¨éƒ¨ï¼Œå…¶å®ƒäººåªçœ‹è‡ªå·±
  let filteredRows = json.rows || [];
  if (currentUser && currentUser !== adminUser) {
    filteredRows = filteredRows.filter(r => r[3] === currentUser);
  }
  
  if (command === "æ˜ç´°" && json.rows) {
    // âœ… é€™è£¡ä¸è¦é‡æ–°å®šç¾© filteredRowsï¼Œç›´æ¥ç”¨å‰é¢å·²ç¶“è™•ç†å¥½çš„
    const rowsForDisplay = (currentUser === adminUser) ? json.rows : filteredRows;
    
    html += `<h5>ğŸ“Š é¸æ“‡æŸ¥è©¢æ˜ç´°;æ¨™é¡ŒæŒ‰ä¸‹å³å¯æ’åº</h5>`;
    html += `<table id="dataTable">
              <tr>
                <th>è¨˜å¸³è€…</th>
                <th>æ—¥æœŸ</th>
                <th>åº—å®¶</th>
                <th class="numeric">æ”¶å…¥</th>
                <th class="numeric">æ”¯å‡º</th>
                <th>åŒ¯ç‡</th>
                <th class="numeric">é‡‘é¡</th>
                <th>ä»˜æ¬¾</th>
                <th>åˆ†é¡</th>
                <th>é™„è¨»</th>
                <th>å‚™è¨»</th>
              </tr>`;

    // âœ… è¡¨æ ¼è³‡æ–™åªè¼¸å‡º rowsForDisplay
    rowsForDisplay.forEach(r => {
      const dateStr = r[4] ? new Date(r[4]).toLocaleDateString("zh-TW") : "";
      html += `<tr>
                <td>${r[3]}</td>
                <td>${dateStr}</td>
                <td>${r[8]}</td>
                <td class="numeric">${Number(r[11]).toLocaleString()}</td>
                <td class="numeric">
                  ${Number(r[12]).toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                </td>
                <td>${r[13]}</td>
                <td class="numeric">${Number(r[5]).toLocaleString()}</td>
                <td>${r[7]}</td>
                <td>${r[6]}</td>
                <td>${r[9]}</td>
                <td>${r[10]}</td>
      </tr>`;
    });
    html += `</table>`;
  
    // âœ… ç¸½é¡ & ç­†æ•¸åŒæ¨£ç”¨ rowsForDisplay
    const totalAmount = rowsForDisplay.reduce((sum, r) => sum + Number(r[5] || 0), 0);
    html += `<div class="total">ğŸ“Œ ç¸½é¡ï¼š${totalAmount.toLocaleString()} å…ƒï¼ˆå…± ${rowsForDisplay.length} ç­†ï¼‰</div>`;

    // é•·æ¢åœ–è³‡æ–™ï¼šé‡‘é¡ç¸½å’Œ + å¹£åˆ¥æœ€å¤§å€¼
    const dateSum = {};
    const maxCurrencyByDate = {};
    rowsForDisplay.forEach(r => {
      const d = new Date(r[4]).toLocaleDateString("zh-TW");
      const amount = Number(r[5]);
      const currency = Number(r[13]);

      dateSum[d] = (dateSum[d] || 0) + amount;
      if (!maxCurrencyByDate[d] || currency > maxCurrencyByDate[d]) {
        maxCurrencyByDate[d] = currency;
      }
    });

    const sortedDates = Object.keys(dateSum).sort((a,b)=> new Date(a)-new Date(b));
    const sumValues = sortedDates.map(d=> dateSum[d]);
    const currencyValues = sortedDates.map(d=> maxCurrencyByDate[d] || 0);

    renderChart("bar", sortedDates, [sumValues, currencyValues]);
  }

  // åˆ†é¡ã€ä»˜æ¬¾ã€åº—å®¶
  const sections = [
    { cmd: "åˆ†é¡", key: 6, title: "â­• é¸æ“‡åˆ†é¡çµ±è¨ˆ;æ¨™é¡ŒæŒ‰ä¸‹å³å¯æ’åº" },
    { cmd: "ä»˜æ¬¾", key: 7, title: "ğŸ’³ é¸æ“‡ä»˜æ¬¾çµ±è¨ˆ;æ¨™é¡ŒæŒ‰ä¸‹å³å¯æ’åº" },
    { cmd: "åº—å®¶", key: 8, title: "ğŸ“‹ é¸æ“‡åº—å®¶çµ±è¨ˆ;æ¨™é¡ŒæŒ‰ä¸‹å³å¯æ’åº" }
  ];

  sections.forEach(sec => {
    if (command === sec.cmd) {
      
      // âœ… ç®¡ç†å“¡ç”¨å…¨éƒ¨è³‡æ–™ï¼Œä¸€èˆ¬ä½¿ç”¨è€…æ‰éæ¿¾
      const rowsForCalc = (currentUser === adminUser)
        ? json.rows
        : (json.rows ? json.rows.filter(r => r[3] === currentUser) : []);
      
      // ä¾ filteredRows è¨ˆç®—çµ±è¨ˆ
      const counts = {};
      filteredRows.forEach(r => {
        const value = r[sec.key] || "æœªçŸ¥";
        counts[value] = (counts[value] || 0) + Number(r[5] || 0); // é‡‘é¡åœ¨ r[5]
      });
    
      const labels = Object.keys(counts);
      const values = Object.values(counts);
      const total = values.reduce((a,b)=>a+b,0);

      html += `<h5>${sec.title}</h5>`;
      html += `<table id="dataTable">
                 <tr>
                   <th>${sec.cmd==="åº—å®¶"?"åº—å®¶":sec.cmd==="ä»˜æ¬¾"?"ä»˜æ¬¾æ–¹å¼":"åˆ†é¡æ–¹å¼"}</th>
                   <th class="numeric">é‡‘é¡</th>
                   <th class="numeric">å æ¯”</th>
                 </tr>`;
      labels.forEach((l,i)=>{
        const percent = ((values[i]/total)*100).toFixed(1);
        html += `<tr>
                   <td>${l}</td>
                   <td class="numeric">${values[i].toLocaleString()}</td>
                   <td class="numeric">${percent}%</td>
                 </tr>`;
      });
      html += `</table>`;
      html += `<div class="total">ğŸ“Œ ç¸½é¡ï¼š${total.toLocaleString()} å…ƒï¼ˆå…± ${labels.length} ç­†ï¼‰</div>`;

      // Pie Chart
      renderChart("pie", labels, values);
    }
  });

  document.getElementById("queryResult").innerHTML = html;

  // è¡¨æ ¼æ’åº
  const dataTable = document.getElementById("dataTable");
  if (dataTable) makeTableSortable(dataTable);
}

// é€šç”¨è¡¨æ ¼æ’åºï¼ˆæ”¯æ´æ•¸å­—/ç™¾åˆ†æ¯”ï¼‰
function makeTableSortable(table) {
  const headers = table.querySelectorAll("th");
  headers.forEach((th, colIndex)=>{
    th.style.cursor = "pointer";
    th.addEventListener("click", ()=>{
      const rows = Array.from(table.querySelectorAll("tr")).slice(1);
      const currentOrder = th.dataset.order || null;
      const newOrder = currentOrder === "asc" ? "desc" : "asc";
      th.dataset.order = newOrder;
      headers.forEach(h=>{
        h.classList.remove("sort-asc","sort-desc");
        h.innerHTML = h.innerHTML.replace(/[\u25B2\u25BC]/g,"");
      });
      th.classList.add(newOrder==="asc"?"sort-asc":"sort-desc");
      th.innerHTML += newOrder==="asc"?" â–²":" â–¼";

      rows.sort((a,b)=>{
        let aVal = parseCellValue(a.cells[colIndex].innerText, colIndex);
        let bVal = parseCellValue(b.cells[colIndex].innerText, colIndex);
        if (newOrder==="asc") return aVal>bVal?1:-1;
        else return aVal<bVal?1:-1;
      });
      rows.forEach(r=>table.appendChild(r));
    });
  });
}

// ä¾ç…§æ¬„ä½é¡å‹è§£æ
function parseCellValue(txt, colIndex) {
  txt = txt.trim();
  
  // æ—¥æœŸæ¬„ (ç¬¬äºŒæ¬„)
  if (colIndex === 1) {
    return new Date(txt);
  }
  // é‡‘é¡æ¬„ (3,4,6) æˆ–ç™¾åˆ†æ¯”æ¬„ (æœ€å¾Œä¸€æ¬„)
  if ([3,4,6].includes(colIndex)) {
    const v = txt.replace(/,/g,"").replace("%","");
    return parseFloat(v) || 0;
  }
  // æ–‡å­—æ¬„
  return txt.toLowerCase(); // çµ±ä¸€å°å¯«æ¯”è¼ƒ
}
  
// ç•«åœ–
function renderChart(type, labels, values) {
  const ctx = document.getElementById("chartCanvas").getContext("2d");

  // âœ… å¦‚æœæœ‰èˆŠåœ–è¡¨ï¼Œå…ˆéŠ·æ¯€
  if (window.currentChart) {
    window.currentChart.destroy();
    window.currentChart = null;
  }
  
  if (type === "pie") {
    // --- PIE ---
    const backgroundColors = labels.map((_, i) =>
      `hsl(${i * 360 / labels.length}, 70%, 60%)`
    );
    chartInstance = new Chart(ctx, {
      type: "pie",
      data: {
        labels,
        datasets: [{
          data: values,
          backgroundColor: backgroundColors
        }]
      },
      options: { responsive: true ,
      plugins: {
        legend: {
          position: "top",   // âœ… åœ–ä¾‹æ”¾ä¸Šæ–¹
          labels: {
            font: {
              size: 30       // âœ… æ”¾å¤§åœ–ä¾‹å­—é«”
            }
          }
        },
        tooltip: {
          titleFont: { size: 30 },  // âœ… Tooltip æ¨™é¡Œå­—é«”
          bodyFont: { size: 36 },    // âœ… Tooltip å…§å®¹å­—é«”
          callbacks: {
            label: function(context) {
              const numberFormat = new Intl.NumberFormat("en-US"); // âœ… åƒåˆ†ä½
              const dataset = context.dataset;
              const total = dataset.data.reduce((a, b) => a + b, 0);
              const value = dataset.data[context.dataIndex];
              const percentage = ((value / total) * 100).toFixed(1) + "%";// âœ… ä¸€ä½å°æ•¸
              return `${context.label}: ${numberFormat.format(value)} (${percentage})`; 
            }
          }
        }
      }
    }    
    });
  } else if (type === "bar") {
    // --- BAR + LINE ---
    const barValues = values[0] || [];
    const lineValues = values[1] || [];

    // å‹•æ…‹è¨ˆç®— min/max
    let validRates = lineValues.filter(v => !isNaN(v));
    let minRate = Math.min(...validRates);
    let maxRate = Math.max(...validRates);

    // åŠ  bufferï¼ˆå„ Â±1ï¼‰
    minRate = Math.floor(minRate) - 1;
    maxRate = Math.ceil(maxRate) + 1;

chartInstance = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [
          {
            type: "bar",
            label: "é‡‘é¡åˆè¨ˆ",
            data: barValues,
            backgroundColor: "rgba(54, 162, 235, 0.6)",
            yAxisID: "y"
          },
          {
            type: "line",
            label: "æ¯æ—¥åŒ¯ç‡æœ€å¤§å€¼",
            data: lineValues,
            borderColor: "red",       // ç·šæ¢é¡è‰²
            backgroundColor: "red",   // é»çš„å¡«å……é¡è‰²
            borderWidth: 2,
            fill: false,              // ä¸è¦ç°è‰²åº•
            yAxisID: "y1",
            tension: 0.1,
            pointRadius: 3,
            pointBackgroundColor: "red",  // é»é¡è‰²
            pointBorderColor: "red"       // é»é‚Šæ¡†é¡è‰²            
          }
        ]
      },
      options: {
        responsive: true,
        interaction: { mode: "index", intersect: false },
        plugins: {
          legend: {
            position: "top",   // âœ… æŠŠä½ç½®æ”¾é€™è£¡
            labels: {
              font: {
                size: 30       // âœ… æ”¾å¤§ã€Œæ¯æ—¥åŒ¯ç‡æœ€å¤§å€¼ã€åœ–ä¾‹å­—é«”
              }
            }
          },
          tooltip: {
            titleFont: { size: 30 },  // âœ… Tooltip æ¨™é¡Œå­—é«”
            bodyFont: { size: 36 } ,  // âœ… Tooltip å…§å®¹å­—é«”
            callbacks: {
              label: function (context) {
                const numberFormat = new Intl.NumberFormat("en-US"); // âœ… åƒåˆ†ä½
                // åªè™•ç† bar (é‡‘é¡åˆè¨ˆ)ï¼Œline å°±ç…§èˆŠ
                if (context.dataset.type === "bar") {
                  const dataset = context.dataset.data;
                  const total = dataset.reduce((a, b) => a + b, 0);
                  const value = context.parsed.y;
                  const percentage = ((value / total) * 100).toFixed(1) + "%";
                  return `${context.dataset.label}: ${numberFormat.format(value)} (${percentage})`;
                } else {
                  return `${context.dataset.label}: ${context.parsed.y}`;      
                }
              }
            }
          }
        },
        scales: {
          y: {
            type: "linear",
            position: "left",
            title: { display: true, text: "é‡‘é¡" },
            beginAtZero: true
          },
          y1: {
            type: "linear",
            position: "right",
            title: { display: true, text: "åŒ¯ç‡", color: "red" },
            grid: { drawOnChartArea: false },
            min: minRate,
            max: maxRate
          }
        }
      }
    });
  }
}
</script>

</body>
</html>









