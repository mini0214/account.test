<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>é›¶ç”¨é‡‘æŸ¥è©¢</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    table { border-collapse: collapse; width: 100%; margin: 10px 0; }
    th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
    th.numeric, td.numeric { text-align: right; }
    th.sort-asc::after { content: " â–²"; }
    th.sort-desc::after { content: " â–¼"; }
    .total { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
<div>
  é–‹å§‹æ—¥æœŸ <input type="date" id="startDate">
  çµæŸæ—¥æœŸ <input type="date" id="endDate">
  <span>ç‰ˆæœ¬ï¼š<span id="version"></span></span>
</div>

<div style="text-align:center">
  <button id="queryMonthBtn">ğŸ“Š æ˜ç´°</button>
  <button id="queryMonthPayBtn">ğŸ’³ ä»˜æ¬¾</button>
  <button id="queryMonthTypeBtn">â­• åˆ†é¡</button>
  <button id="queryMonthStoreBtn">ğŸ“‹ åº—å®¶</button>
</div>

<div id="queryResult"></div>
<canvas id="chartCanvas"></canvas>

<script>
const LIFF_ID = "2008096451-jPJ50MOY";   // æ›æˆä½ çš„ LIFF ID
const VERSION = "V16_9";                 
const API_URL = "https://script.google.com/macros/s/AKfycbwQ1t5wHfjAqrtH0_ijNNWtlE5Q0R-g8fwb5htWQoCXKXxSukVX9qVnrfuyoXOyKkGXdw/exec";  // æ›æˆä½ çš„ GAS

let chartInstance = null;
document.getElementById("version").textContent = VERSION;

async function main() {
  await liff.init({ liffId: LIFF_ID });
  if (!liff.isLoggedIn()) liff.login();
  setDefaultDateRange();
}
main();

function setDefaultDateRange() {
  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth(), 1);
  const end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
  document.getElementById("startDate").value = toInputDate(start);
  document.getElementById("endDate").value = toInputDate(end);
}
function toInputDate(d) {
  const m = (d.getMonth() + 1).toString().padStart(2, "0");
  const day = d.getDate().toString().padStart(2, "0");
  return `${d.getFullYear()}-${m}-${day}`;
}

// æŒ‰éˆ•äº‹ä»¶
document.getElementById("queryMonthBtn").addEventListener("click", () => sendQuery("æ˜ç´°"));
document.getElementById("queryMonthTypeBtn").addEventListener("click", () => sendQuery("åˆ†é¡"));
document.getElementById("queryMonthPayBtn").addEventListener("click", () => sendQuery("ä»˜æ¬¾"));
document.getElementById("queryMonthStoreBtn").addEventListener("click", () => sendQuery("åº—å®¶"));

async function sendQuery(command) {
  const startDate = document.getElementById("startDate").value;
  const endDate = document.getElementById("endDate").value;
  if (!startDate || !endDate) {
    alert("è«‹é¸æ“‡é–‹å§‹èˆ‡çµæŸæ—¥æœŸ");
    return;
  }
  const body = {
    type: "query",
    command: command,
    version: VERSION,
    startDate: startDate + " 00:00:00",
    endDate: endDate + " 23:59:59"
  };
  try {
    const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(body) });
    const json = await res.json();
    if (!json.ok) {
      document.getElementById("queryResult").innerHTML = `<p style="color:red">âŒ æŸ¥è©¢å¤±æ•—</p>`;
      return;
    }
    renderResult(command, json);
  } catch (err) {
    document.getElementById("queryResult").innerHTML = `<p style="color:red">âŒ æŸ¥è©¢å¤±æ•—ï¼š${err.message}</p>`;
  }
}

function renderResult(command, json) {
  let html = "";

  if (command === "æ˜ç´°" && json.rows) {
    // ===== æ˜ç´°è¡¨æ ¼ =====
    html += `<h5>ğŸ“Š é¸æ“‡æŸ¥è©¢æ˜ç´°;æ¨™é¡ŒæŒ‰ä¸‹å³å¯æ’åº</h5>`;
    html += `<table id="dataTable">
              <tr>
                <th>æ—¥æœŸ</th><th>åº—å®¶</th>
                <th class="numeric">æ”¶å…¥</th><th class="numeric">æ”¯å‡º</th>
                <th>å¹£åˆ¥</th><th class="numeric">é‡‘é¡</th>
                <th>ä»˜æ¬¾</th><th>åˆ†é¡</th><th>é™„è¨»</th><th>å‚™è¨»</th>
              </tr>`;
    json.rows.forEach(r => {
      const dateStr = r[4] ? new Date(r[4]).toLocaleDateString("zh-TW") : "";
      html += `<tr>
        <td>${dateStr}</td><td>${r[8]}</td>
        <td class="numeric">${Number(r[11]).toLocaleString()}</td>
        <td class="numeric">${Number(r[12]).toLocaleString()}</td>
        <td>${r[13]}</td><td class="numeric">${Number(r[5]).toLocaleString()}</td>
        <td>${r[7]}</td><td>${r[6]}</td><td>${r[9]}</td><td>${r[10]}</td>
      </tr>`;
    });
    html += `</table>`;
    html += `<div class="total">ğŸ“Œ ç¸½é¡ï¼š${Number(json.total||0).toLocaleString()} å…ƒï¼ˆå…± ${json.rows.length} ç­†ï¼‰</div>`;

    // ===== æ˜ç´°é•·æ¢åœ– =====
    const dateSum = {};
    json.rows.forEach(r => {
      const d = new Date(r[4]).toLocaleDateString("zh-TW");
      dateSum[d] = (dateSum[d] || 0) + Number(r[5]);
    });
    const sortedDates = Object.keys(dateSum).sort((a,b)=> new Date(a)-new Date(b));
    const sumValues = sortedDates.map(d=> dateSum[d]);
    renderChart("bar", sortedDates, sumValues, "é‡‘é¡");

    // ===== åŒ¯ç‡èµ°å‹¢åœ– =====
    const rateData = {};  // { currency: { date: maxRate } }
    json.rows.forEach(r => {
      const dateStr = new Date(r[4]).toLocaleDateString("zh-TW");
      const curr = r[13];
      const rate = parseFloat(r[14]);   // âš ï¸ ç¢ºèª r[14] æ˜¯å¦ç‚ºåŒ¯ç‡æ¬„ä½
      if (!curr || curr === "1" || isNaN(rate)) return;
      if (!rateData[curr]) rateData[curr] = {};
      if (!rateData[curr][dateStr] || rate > rateData[curr][dateStr]) {
        rateData[curr][dateStr] = rate;
      }
    });
    if (Object.keys(rateData).length > 0) {
      html += `<h5>ğŸ“ˆ åŒ¯ç‡èµ°å‹¢åœ–ï¼ˆæ¯æ—¥æœ€å¤§å€¼ï¼‰</h5>
               <canvas id="rateChart"></canvas>`;
      setTimeout(()=> renderRateChart(rateData), 0);
    }
  }

  // åˆ†é¡ã€ä»˜æ¬¾ã€åº—å®¶ â€¦ï¼ˆç•¥ï¼Œè·ŸåŸæœ¬ä¸€æ¨£ï¼‰

  document.getElementById("queryResult").innerHTML = html;
  const dataTable = document.getElementById("dataTable");
  if (dataTable) makeTableSortable(dataTable);
}

// åŒ¯ç‡èµ°å‹¢åœ–
function renderRateChart(rateData) {
  const ctx = document.getElementById("rateChart").getContext("2d");
  if (chartInstance) chartInstance.destroy();
  const allDates = [...new Set(
    Object.values(rateData).flatMap(obj => Object.keys(obj))
  )].sort((a,b)=> new Date(a)-new Date(b));
  const datasets = Object.keys(rateData).map((curr,i)=>({
    label: curr,
    data: allDates.map(d=> rateData[curr][d] || null),
    borderColor: `hsl(${i*360/Object.keys(rateData).length},70%,50%)`,
    fill: false,
    tension: 0.2
  }));
  chartInstance = new Chart(ctx,{
    type:"line",
    data:{ labels: allDates, datasets },
    options:{
      responsive:true,
      interaction:{ mode:"index", intersect:false },
      plugins:{ legend:{ position:"bottom" } },
      scales:{ y:{ title:{ display:true, text:"åŒ¯ç‡" } } }
    }
  });
}

// è¡¨æ ¼æ’åº
function makeTableSortable(table) {
  const headers = table.querySelectorAll("th");
  headers.forEach((th, colIndex)=>{
    th.style.cursor = "pointer";
    th.addEventListener("click", ()=>{
      const rows = Array.from(table.querySelectorAll("tr")).slice(1);
      const currentOrder = th.dataset.order || null;
      const newOrder = currentOrder === "asc" ? "desc" : "asc";
      th.dataset.order = newOrder;
      headers.forEach(h=>{
        h.classList.remove("sort-asc","sort-desc");
        h.innerHTML = h.innerHTML.replace(/[\u25B2\u25BC]/g,"");
      });
      th.classList.add(newOrder==="asc"?"sort-asc":"sort-desc");
      rows.sort((a,b)=>{
        let aVal = parseCellValue(a.cells[colIndex].innerText);
        let bVal = parseCellValue(b.cells[colIndex].innerText);
        return newOrder==="asc" ? aVal-bVal : bVal-aVal;
      });
      rows.forEach(r=>table.appendChild(r));
    });
  });
}
function parseCellValue(txt) {
  let v = txt.replace(/,/g,"").replace("%","");
  return isNaN(v)?txt:parseFloat(v);
}

// é€šç”¨ Chart
function renderChart(type, labels, values, labelText) {
  const ctx = document.getElementById("chartCanvas").getContext("2d");
  if (chartInstance) chartInstance.destroy();
  let backgroundColors = [];
  if (type === "pie") {
    backgroundColors = labels.map((_,i)=> `hsl(${i*360/labels.length},70%,60%)`);
  } else {
    backgroundColors = "rgba(54, 162, 235, 0.6)";
  }
  chartInstance = new Chart(ctx,{
    type: type,
    data: {
      labels: labels,
      datasets:[{
        label: labelText || "é‡‘é¡",
        data: values,
        backgroundColor: backgroundColors
      }]
    },
    options: { responsive:true }
  });
}
</script>
</body>
</html>
