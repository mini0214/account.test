<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>é›¶ç”¨é‡‘æ”¯å‡ºå¸³ç°¿</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <style>
    body { font-family: Arial, sans-serif; padding: 50px; }
    h3 { font-size: 50px; text-align: center; margin-bottom: 50px; }
    label, select, input { font-size: 50px; text-align: left; margin-bottom: 20px;  }
    button { font-size: 32px; text-align: center; margin: 5px; padding: 10px 20px; border-radius: 8px; cursor: pointer; background-color: #4CAF50; color: white; }
    button:hover { background-color: #0056b3; }
    table { font-size: 32px; border-collapse: collapse; width: 100%; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    .action-btn { background: #dc3545; margin: 0 2px; }
    .edit-btn { background: #28a745; }
    .action-btn:hover, .edit-btn:hover { opacity: 0.8; }
  </style>
</head>
<body>
  
    <h3>é<span style="color: gray;">è¨­</span>ä¸å¯.[<span id="version">V</span>]</h3>
    
    <label>é¡åˆ¥ï¼š</label>
    <select id="classify">
      <option value="type">åˆ†é¡ type</option>
      <option value="payment">ä»˜æ¬¾ payment</option>
    </select><br>

    <label>ç·¨è™Ÿï¼š</label>
    <input type="text" id="number" placeholder="è«‹è¼¸å…¥ç·¨è™Ÿ,æ’åºç”¨t08.p06" required><br>

    <label>åç¨±ï¼š</label>
    <input type="text" id="name" placeholder="è«‹è¼¸å…¥åç¨±" required><br>

    <label>å‚™è¨»ï¼š</label>
    <input type="text" id="note" placeholder="é¸å¡«"><br>

    <!-- å„²å­˜/æŸ¥è©¢æŒ‰éˆ•æ”¾å…¥å®¹å™¨ç½®ä¸­ -->
    <div style="text-align: center; margin-bottom: 20px;">
      <button onclick="saveOther()">ğŸ“¤ å„²å­˜</button>
      <button onclick="loadOther()">ğŸ“– æŸ¥è©¢</button>
    </div>

    <table id="otherTable">
      <thead>
        <tr><th>é¡åˆ¥</th><th>ç·¨è™Ÿ</th><th>åç¨±</th><th>å‚™è¨»</th><th>åŠŸèƒ½</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- âœ… ç­†æ•¸çµ±è¨ˆè¦æ”¾åœ¨ body è£¡ -->
    <div id="summary" class="total"></div>
    
<script>
let FALLBACK_GAS_SETTINGS_URL = "https://script.google.com/macros/s/AKfycbxllPV_s_TpLyE5hhUzgxJWkL9bdAa6MtS0ee95oO2n1uNs94H9Da8-H5nLos5kosh-/exec";
let API_URL = "";
let VERSION = "V";
let LIFF_IDo = "";
let editIndex = -1; // ä¿®æ”¹ç”¨

// ----------------------------------------------------
// âœ… è¨­å®šè®€å–
// ----------------------------------------------------
async function tryFetchText(url){
  const r = await fetch(url, { cache: 'no-store' });
  const text = await r.text();
  try { const j = JSON.parse(text); return { ok: true, json: j }; }
  catch(e){ return { ok: false, text }; }
}

async function loadSettings(){
  const res = await tryFetchText(FALLBACK_GAS_SETTINGS_URL + "?type=query&command=è¨­å®š");
  if (!res.ok) throw new Error("è¨­å®š GAS è®€å–å¤±æ•—ï¼š" + res.text);
  const data = res.json;
  if (!data.ok || !data.data) throw new Error("è¨­å®šæ ¼å¼éŒ¯èª¤");
  return data.data;
}
// ----------------------------------------------------
// âœ… åˆå§‹åŒ–
// ----------------------------------------------------
async function initApp(){
  try {
    const settings = await loadSettings();
    FALLBACK_GAS_SETTINGS_URL = (settings.SETTINGS_URL || FALLBACK_GAS_SETTINGS_URL).trim();
    API_URL = (settings.API_URL || "").trim();
    VERSION = (settings.D10 || "V").trim();
    LIFF_IDo = (settings.D13 || "").trim();
    
    document.getElementById("version").textContent = VERSION;
    console.log("âœ… è¨­å®šæˆåŠŸ:", { FALLBACK_GAS_SETTINGS_URL, API_URL, LIFF_IDo, VERSION });
    
    if (!LIFF_IDo) throw new Error("âŒ LIFF ID å°šæœªè¨­å®šï¼Œè«‹ç¢ºèªè¨­å®šè¡¨ D13");
    
    await liff.init({ liffId: LIFF_IDo });
    if (!liff.isLoggedIn()) liff.login();

    loadOther();
  } catch (err) {
    alert("âŒ åˆå§‹åŒ–å¤±æ•—ï¼š" + err.message);
    console.error(err);
  }
}
// ----------------------------------------------------
// 1ï¸âƒ£ å„²å­˜/ä¿®æ”¹ï¼ˆåŠ ä¸Štype/paymentç¶å®šæª¢æŸ¥ï¼‰
// ----------------------------------------------------
async function saveOther() {
  const payload = {
    type: "other",
    command: editIndex === -1 ? "add" : "update",
    classify: document.getElementById("classify").value,
    number: document.getElementById("number").value.trim(),
    name: document.getElementById("name").value.trim(),
    note: (document.getElementById("note")?.value || "").trim(),
    oldNumber: window.oldNumber || undefined // âœ… ä¿®æ”¹æ™‚è¦å¸¶ä¸ŠèˆŠçš„ç·¨è™Ÿ
  };

  if (!payload.classify || !payload.number || !payload.name) {
    alert("â—åˆ†é¡ã€ç·¨è™Ÿèˆ‡åç¨±ä¸å¾—ç‚ºç©º");
    return;
  }

  try {
    // å–å¾—åˆ†é¡èˆ‡ä»˜æ¬¾æ–¹å¼åˆ—è¡¨
    const [typeRes, paymentRes] = await Promise.all([
      fetch(API_URL + "?type=query&command=cashdate.type"),
      fetch(API_URL + "?type=query&command=cashdate.payment")
    ]);

    const typeData = await typeRes.json();
    const paymentData = await paymentRes.json();

    const allNames = [
      ...(typeData.types || []),
      ...(paymentData.payments || [])
    ];

    if (allNames.includes(payload.name)) {
      alert("âŒ åç¨±å·²å­˜åœ¨æ–¼ç³»çµ±åˆ†é¡æˆ–ä»˜æ¬¾æ–¹å¼ä¸­ï¼Œç„¡æ³•æ–°å¢/ä¿®æ”¹");
      return;
    }

    // âœ… é€å‡ºæ–°å¢/ä¿®æ”¹è«‹æ±‚
    const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
    const result = await res.json();

    if (result.ok) {
      alert(editIndex === -1 ? "âœ… å·²æ–°å¢è³‡æ–™" : "âœ… å·²ä¿®æ”¹è³‡æ–™");
      clearForm();
      loadOther();
    } else {
      alert("âŒ å¤±æ•—ï¼š" + (result.msg || result.error || JSON.stringify(result) || "æœªçŸ¥éŒ¯èª¤"));
    }

  } catch (err) {
    alert("âš ï¸ ç™¼ç”ŸéŒ¯èª¤ï¼š" + err);
  }
}
// ----------------------------------------------------
// 2ï¸âƒ£ æŸ¥è©¢ (æ’åºï¼šclassify â†’ number)
// ----------------------------------------------------
async function loadOther() {
  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({ type: "other", command: "query" })
    });
    const result = await res.json();
    
    const tbody = document.querySelector("#otherTable tbody");
    tbody.innerHTML = "";

    if (result.ok && Array.isArray(result.list)) {
      // âœ… æ’åºï¼šå…ˆä¾ classify æ’ï¼Œå†ä¾ number æ’
      result.list.sort((a, b) => {
        // classify æ’åº
        if (a.classify < b.classify) return -1;
        if (a.classify > b.classify) return 1;

        // classify ç›¸åŒæ™‚ä¾ number æ’ï¼ˆæ•¸å­—éƒ¨åˆ†æ¯”è¼ƒï¼‰
        const numA = parseInt(a.number.replace(/[^\d]/g, ""), 10);
        const numB = parseInt(b.number.replace(/[^\d]/g, ""), 10);
        return numA - numB;
      });

      // âœ… æ¸²æŸ“è¡¨æ ¼
      result.list.forEach((row, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.classify}</td>
          <td>${row.number}</td>
          <td>${row.name}</td>
          <td>${row.note || ""}</td>
          <td>
            <button class="edit-btn" onclick="editOther(${idx})">ğŸ“ ä¿®æ”¹</button>
            <button class="action-btn" onclick="deleteOther(${idx})">ğŸ—‘ï¸ åˆªé™¤</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // âœ… å­˜æœ€æ–°è³‡æ–™
      window.otherDataCache = result.list;
      
      // âœ… çµ±è¨ˆç­†æ•¸
      const typeRows = result.list.filter(r => r.classify === "type");
      const paymentRows = result.list.filter(r => r.classify === "payment");
      document.getElementById("summary").innerHTML = `
      <table>
        <tr>
          <td>ğŸ“‚ åˆ†é¡ï¼š${typeRows.length} ç­†ã€€</td>
          <td>ğŸ’³ ä»˜æ¬¾ï¼š${paymentRows.length} ç­†ã€€</td>
          <td>ğŸ“Œ ç¸½è¨ˆï¼š${result.list.length} ç­†  </td>
        </tr>
      </table>
      `;
    } else {
      document.getElementById("summary").innerHTML = "âš ï¸ æ²’æœ‰è³‡æ–™";
    }
  } catch (err) {
    alert("âš ï¸ æŸ¥è©¢å¤±æ•—ï¼š" + err.message);
    console.error(err);
  }
}
// ----------------------------------------------------
// 3ï¸âƒ£ ä¿®æ”¹
// ----------------------------------------------------
function editOther(idx) {
  const row = window.otherDataCache[idx];
  if (!row) return;
  document.getElementById("classify").value = row.classify;
  document.getElementById("number").value = row.number;
  document.getElementById("name").value = row.name;
  document.getElementById("note").value = row.note || "";
  editIndex = idx;
  window.oldNumber = row.number; // âœ… è¨˜éŒ„åŸå§‹ç·¨è™Ÿ
}
// ----------------------------------------------------
// 4ï¸âƒ£ åˆªé™¤ï¼ˆåŠ ä¸Štype/paymentç¶å®šæª¢æŸ¥ï¼‰
// ----------------------------------------------------
async function deleteOther(idx) {
  if (!confirm("â—ç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡æ–™å—ï¼Ÿ")) return;
  
  const row = window.otherDataCache[idx];
  if (!row) return;

  try {
    // ğŸ”¹ åŒæ™‚æŸ¥è©¢ã€Œåˆ†é¡(type)ã€èˆ‡ã€Œä»˜æ¬¾(payment)ã€æ¸…å–®
    const [typeRes, paymentRes] = await Promise.all([
      fetch(API_URL + "?type=query&command=cashdate.type"),
      fetch(API_URL + "?type=query&command=cashdate.payment")
    ]);

    const typeData = await typeRes.json();
    const paymentData = await paymentRes.json();

    const allNames = [
      ...(typeData.types || []),
      ...(paymentData.payments || [])
    ];

    // âœ… å¦‚æœé€™ç­†åç¨±å·²å­˜åœ¨æ–¼åˆ†é¡æˆ–ä»˜æ¬¾æ–¹å¼ï¼Œå°±ç¦æ­¢åˆªé™¤
    if (allNames.includes(row.name)) {
      alert(`âš ï¸ã€Œ${row.name}ã€å·²è¢«ä½¿ç”¨æ–¼åˆ†é¡æˆ–ä»˜æ¬¾æ¸…å–®ä¸­ï¼Œç„¡æ³•åˆªé™¤ï¼`);
      return;
    }

    // ğŸ”¹ åŸ·è¡Œåˆªé™¤
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({ type: "other", command: "delete", number: row.number })
    });

    const resDel = await res.json();
    if (resDel.ok) {
      alert("âœ… å·²åˆªé™¤è³‡æ–™");
      clearForm();
      loadOther();
    } else {
      alert("âŒ åˆªé™¤å¤±æ•—ï¼š" + (resDel.msg || "æœªçŸ¥éŒ¯èª¤"));
    }

  } catch (err) {
    alert("âš ï¸ åˆªé™¤éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼š" + err.message);
    console.error(err);
  }
}
// ----------------------------------------------------
// ğŸ§¹ æ¸…ç©ºè¡¨å–®
// ----------------------------------------------------
function clearForm() {
  document.getElementById("number").value = "";
  document.getElementById("name").value = "";
  document.getElementById("note").value = "";
  editIndex = -1;
  window.oldNumber = undefined;
}

initApp(); // ğŸš€ å•Ÿå‹•æ‡‰ç”¨
</script>
</body>
</html>


