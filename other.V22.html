<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>é›¶ç”¨é‡‘æ”¯å‡ºå¸³ç°¿</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <style>
    body { font-family: Arial, sans-serif; padding: 50px; }
    h3 { font-size: 50px; text-align: center; margin-bottom: 50px; }
    label, select, input { font-size: 50px; text-align: left; margin-bottom: 20px;  }
    button { font-size: 32px; text-align: center; margin: 5px; padding: 10px 20px; border-radius: 8px; cursor: pointer; background-color: #4CAF50; color: white; }
    button:hover { background-color: #0056b3; }
    table { font-size: 32px; border-collapse: collapse; width: 100%; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    .action-btn { background: #dc3545; margin: 0 2px; }
    .edit-btn { background: #28a745; }
    .action-btn:hover, .edit-btn:hover { opacity: 0.8; }
    .total { font-size: 28px; font-weight: bold; color: #d9534f; margin-top: 10px; }
  </style>
</head>
<body>
  
    <h3>âš™ï¸é<span style="color: gray;">è¨­</span>ä¸å¯.[<span id="version">V</span>]</h3>
    
    <label>é¡åˆ¥ï¼š</label>
    <select id="classify">
      <option value="currency">åŒ¯ç‡ currency</option>
      <option value="payment">ä»˜æ¬¾ payment</option>
      <option value="type">åˆ†é¡ type</option>
    </select><br>

    <label>ç·¨è™Ÿï¼š</label>
    <input type="text" id="number" placeholder="è«‹è¼¸å…¥ç·¨è™Ÿ,æ’åºç”¨c001..." required><br>

    <label>åç¨±ï¼š</label>
    <input type="text" id="name" placeholder="è«‹è¼¸å…¥åç¨±" required><br>

    <label>å‚™è¨»ï¼š</label>
    <input type="text" id="note" placeholder="é¸å¡«"><br>

    <label>åŒ¯ç‡ï¼š</label>
    <input type="text" id="exchange" placeholder="è½‰æ›å¹£åˆ¥å¿…å¡«"><br>

    <!-- å„²å­˜/æŸ¥è©¢æŒ‰éˆ•æ”¾å…¥å®¹å™¨ç½®ä¸­ -->
    <div style="text-align: center; margin-bottom: 20px;">
      <button onclick="saveOther()">ğŸ“¤ å„²å­˜</button>
      <button onclick="loadOther()">ğŸ“– æŸ¥è©¢</button>
    </div>

    <table id="otherTable">
      <thead>
        <tr><th>é¡åˆ¥</th><th>ç·¨è™Ÿ</th><th>åç¨±</th><th>å‚™è¨»</th><th>åŒ¯ç‡</th><th>åŠŸèƒ½</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- âœ… ç­†æ•¸çµ±è¨ˆè¦æ”¾åœ¨ body è£¡ -->
    <div id="summary" class="total"></div>
    
<script>
// ğŸš€ ç›´æ¥å¯«æ­»è¨­å®šå€¼ï¼Œçœå» loadSettings çš„ç¶²è·¯ç­‰å¾…æ™‚é–“
const API_URL = "https://script.google.com/macros/s/AKfycbwxqIKuk4VqHeib3Mi_xxE6yS5R8V55wyiQVIS6VgF6PEnNa93lVSoBBiX4OYksDuaiUw/exec";
const LIFF_IDo = "2008096451-Olb1l39P";
const VERSION = "V29_#196"; // æ‚¨çš„ç‰ˆæ¬¡

let userProfile = null;
let editIndex = -1; 
let otherDataCache = []; // ç”¨ä¾†å­˜æ”¾æŸ¥è©¢çµæœ

// ----------------------------------------------------
// âœ… å„ªåŒ–å¾Œçš„åˆå§‹åŒ–
// ----------------------------------------------------
async function initApp() {
  try {
    // 1. é¡¯ç¤ºç‰ˆæœ¬
    const versionEl = document.getElementById("version");
    if (versionEl) versionEl.textContent = VERSION;

    // 2. ğŸš€ åˆå§‹åŒ– LIFF
    await liff.init({ liffId: LIFF_IDo });

    if (!liff.isLoggedIn()) {
      liff.login();
      return; 
    }

    // 3. å·²ç™»å…¥ï¼Œä¸¦è¡ŒåŸ·è¡Œï¼šæŠ“å– Profile èˆ‡ è‡ªå‹•æŸ¥è©¢è³‡æ–™
    console.log("âœ… LIFF å·²é€£ç·šï¼Œè¼‰å…¥è³‡æ–™ä¸­...");
    const [profile] = await Promise.all([
      liff.getProfile(),
      loadOther() // é€²å…¥é é¢è‡ªå‹•åŸ·è¡Œä¸€æ¬¡æŸ¥è©¢ï¼Œè®“ä½¿ç”¨è€…çœ‹åˆ°ç¾æœ‰è³‡æ–™
    ]);

    userProfile = profile;
    console.log("âœ… æ­¡è¿ " + userProfile.displayName);

    // âš ï¸ æ³¨æ„ï¼šæ­¤è™•ä¸å†åŸ·è¡Œè¨­å®š date çš„å‹•ä½œï¼Œå› ç‚ºæ­¤é é¢æ²’æœ‰ date æ¬„ä½

  } catch (err) {
    console.error("åˆå§‹åŒ–å¤±æ•—è©³ç´°è³‡è¨Š:", err);
    if (err.message.includes("authorization")) {
      liff.logout();
      location.reload();
    } else {
      alert("âŒ åˆå§‹åŒ–å¤±æ•—ï¼š" + err.message);
    }
  }
}

// ----------------------------------------------------
// 1ï¸âƒ£ å„²å­˜/ä¿®æ”¹
// ----------------------------------------------------
async function saveOther() {
  const payload = {
    type: "other",
    command: editIndex === -1 ? "add" : "update",
    classify: document.getElementById("classify").value,
    number: document.getElementById("number").value.trim(),
    name: document.getElementById("name").value.trim(),
    note: (document.getElementById("note")?.value || "").trim(),
    exchange: (document.getElementById("exchange")?.value || "").trim(),
    oldNumber: window.oldNumber || undefined 
  };

  if (!payload.classify || !payload.number || !payload.name) {
    alert("â—åˆ†é¡ã€ç·¨è™Ÿèˆ‡åç¨±ä¸å¾—ç‚ºç©º");
    return;
  }

  if (payload.classify === "currency" && !payload.exchange) {
    alert("â—åŒ¯ç‡ currency é¡åˆ¥ï¼ŒåŒ¯ç‡æ¬„ä½å¿…å¡«ï¼");
    return;
  }
  
  try {
    // æª¢æŸ¥åç¨±æ˜¯å¦å·²è¢« cashdata ä½¿ç”¨ (ä¿ç•™åŸæœ¬é‚è¼¯)
    const [exchangeRes, typeRes, paymentRes] = await Promise.all([
      fetch(API_URL + "?type=query&command=cashdate.exchange"),
      fetch(API_URL + "?type=query&command=cashdate.type"),
      fetch(API_URL + "?type=query&command=cashdate.payment")
    ]);

    const exchangeData = await exchangeRes.json();
    const typeData = await typeRes.json();
    const paymentData = await paymentRes.json();

    const allNames = [
      ...(exchangeData.exchanges || []),
      ...(typeData.types || []),
      ...(paymentData.payments || [])
    ];

    const checkNames = (editIndex !== -1 && window.oldName) 
        ? allNames.filter(n => n !== window.oldName)
        : allNames;

    if (checkNames.includes(payload.name)) {
      alert(`âš ï¸ã€Œ${payload.name}ã€å·²å­˜åœ¨æ–¼ç³»çµ±æ­·å²è¨˜éŒ„ä¸­ï¼Œç„¡æ³•æ–°å¢/ä¿®æ”¹`);
      return;
    }

    const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
    const result = await res.json();

    if (result.ok) {
      alert(editIndex === -1 ? `âœ… å·²æ–°å¢ ${payload.name} æ­¤ç­†è³‡æ–™` : `âœ… å·²ä¿®æ”¹ ${payload.name} æ­¤ç­†è³‡æ–™`);
      clearForm();
      loadOther();
    } else {
      alert(`âŒ å¤±æ•—ï¼š${result.msg || "æœªçŸ¥éŒ¯èª¤"}`);
    }
  } catch (err) {
    alert(`âš ï¸ ç™¼ç”ŸéŒ¯èª¤ï¼š${err.message}`);
  }
}

// ----------------------------------------------------
// 2ï¸âƒ£ æŸ¥è©¢ (ä¿ç•™åŸæœ¬æ’åºèˆ‡çµ±è¨ˆåŠŸèƒ½)
// ----------------------------------------------------
async function loadOther() {
  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({ type: "other", command: "query" })
    });
    const result = await res.json();
    
    const tbody = document.querySelector("#otherTable tbody");
    tbody.innerHTML = "";

    if (result.ok && Array.isArray(result.list)) {
      // æ’åºé‚è¼¯
      result.list.sort((a, b) => {
        if (a.classify < b.classify) return -1;
        if (a.classify > b.classify) return 1;
        const numA = parseInt(a.number.replace(/[^\d]/g, ""), 10) || 0;
        const numB = parseInt(b.number.replace(/[^\d]/g, ""), 10) || 0;
        return numA - numB;
      });

      result.list.forEach((row, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.classify}</td>
          <td>${row.number}</td>
          <td>${row.name}</td>
          <td>${row.note || ""}</td>
          <td>${row.exchange || ""}</td>
          <td>
            <button class="edit-btn" onclick="editOther(${idx})">ğŸ“</button>
            <button class="action-btn" onclick="deleteOther(${idx})">ğŸ—‘ï¸</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      window.otherDataCache = result.list;
      
      // çµ±è¨ˆå€å¡Š
      const currencys = result.list.filter(r => r.classify === "currency");
      const typeRows = result.list.filter(r => r.classify === "type");
      const paymentRows = result.list.filter(r => r.classify === "payment");
      document.getElementById("summary").innerHTML = `
      <table>
        <tr>
          <td>ğŸ’° åŒ¯ç‡: ${currencys.length}</td>
          <td>ğŸ’³ ä»˜æ¬¾: ${paymentRows.length}</td>
          <td>ğŸ“‚ åˆ†é¡: ${typeRows.length}</td>
          <td>ğŸ“Œ ç¸½è¨ˆ: ${result.list.length}</td>
        </tr>
      </table>`;
    }
  } catch (err) {
    console.error("æŸ¥è©¢å¤±æ•—", err);
  }
}

// ----------------------------------------------------
// 3ï¸âƒ£ ä¿®æ”¹ / 4ï¸âƒ£ åˆªé™¤ / ğŸ§¹ æ¸…ç©º (åŠŸèƒ½çš†å®Œæ•´ä¿ç•™)
// ----------------------------------------------------
function editOther(idx) {
  const row = window.otherDataCache[idx];
  if (!row) return;
  document.getElementById("classify").value = row.classify;
  document.getElementById("number").value = row.number;
  document.getElementById("name").value = row.name;
  document.getElementById("note").value = row.note || "";
  document.getElementById("exchange").value = row.exchange || "";
  editIndex = idx;
  window.oldNumber = row.number;
  window.oldName = row.name;
  window.scrollTo(0, 0); // å›åˆ°é ‚éƒ¨æ–¹ä¾¿ä¿®æ”¹
}

async function deleteOther(idx) {
  const row = window.otherDataCache[idx];
  if (!row || !confirm(`â—ç¢ºå®šè¦åˆªé™¤ ${row.name} å—ï¼Ÿ`)) return;
  
  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({ type: "other", command: "delete", number: row.number })
    });
    const resDel = await res.json();
    if (resDel.ok) {
      alert("âœ… åˆªé™¤æˆåŠŸ");
      loadOther();
    }
  } catch (err) {
    alert("åˆªé™¤å¤±æ•—");
  }
}

function clearForm() {
  document.getElementById("number").value = "";
  document.getElementById("name").value = "";
  document.getElementById("note").value = "";
  document.getElementById("exchange").value = "";
  editIndex = -1;
  window.oldNumber = undefined;
  window.oldName = undefined;
}

// ğŸš€ å•Ÿå‹•
if (document.readyState === "complete" || document.readyState === "interactive") {
  initApp();
} else {
  window.addEventListener("load", initApp);
}
</script>
</body>
</html>





