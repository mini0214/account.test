<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>é›¶ç”¨é‡‘æ”¯å‡ºå¸³ç°¿</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <style>
    body { font-family: Arial, sans-serif; padding: 50px; }
    h3 { font-size: 50px; text-align: center; margin-bottom: 50px; }
    label, select, input { font-size: 50px; text-align: left; margin-bottom: 20px;  }
    button { font-size: 32px; text-align: center; margin: 5px; padding: 10px 20px; border-radius: 8px; cursor: pointer; background-color: #4CAF50; color: white; }
    button:hover { background-color: #0056b3; }
    table { font-size: 32px; border-collapse: collapse; width: 100%; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    .action-btn { background: #dc3545; margin: 0 2px; }
    .edit-btn { background: #28a745; }
    .action-btn:hover, .edit-btn:hover { opacity: 0.8; }
    .total { font-size: 28px; font-weight: bold; color: #d9534f; margin-top: 10px; }
  </style>
</head>
<body>
  
    <h3>âš™ï¸é<span style="color: gray;">è¨­</span>ä¸å¯.[<span id="version">V</span>]</h3>
    
    <label>é¡åˆ¥ï¼š</label>
    <select id="classify">
      <option value="currency">åŒ¯ç‡ currency</option>
      <option value="payment">ä»˜æ¬¾ payment</option>
      <option value="type">åˆ†é¡ type</option>
    </select><br>

    <label>ç·¨è™Ÿï¼š</label>
    <input type="text" id="number" placeholder="è«‹è¼¸å…¥ç·¨è™Ÿ,æ’åºç”¨c001..." required><br>

    <label>åç¨±ï¼š</label>
    <input type="text" id="name" placeholder="è«‹è¼¸å…¥åç¨±" required><br>

    <label>å‚™è¨»ï¼š</label>
    <input type="text" id="note" placeholder="é¸å¡«"><br>

    <label>åŒ¯ç‡ï¼š</label>
    <input type="text" id="exchange" placeholder="è½‰æ›å¹£åˆ¥å¿…å¡«"><br>

    <!-- å„²å­˜/æŸ¥è©¢æŒ‰éˆ•æ”¾å…¥å®¹å™¨ç½®ä¸­ -->
    <div style="text-align: center; margin-bottom: 20px;">
      <button onclick="saveOther()">ğŸ“¤ å„²å­˜</button>
      <button onclick="loadOther()">ğŸ“– æŸ¥è©¢</button>
    </div>

    <table id="otherTable">
      <thead>
        <tr><th>é¡åˆ¥</th><th>ç·¨è™Ÿ</th><th>åç¨±</th><th>å‚™è¨»</th><th>åŒ¯ç‡</th><th>åŠŸèƒ½</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- âœ… ç­†æ•¸çµ±è¨ˆè¦æ”¾åœ¨ body è£¡ -->
    <div id="summary" class="total"></div>
    
<script>
let FALLBACK_GAS_SETTINGS_URL = "https://script.google.com/macros/s/AKfycbw7BAhbPaHUND75cG4KTxAB5SAScYxVvC8gYuPiU1LXrVUL44kSKVGnrGotWJg_NwTe9Q/exec";
let API_URL = "";
let VERSION = "V";
let LIFF_IDo = "";
let editIndex = -1; // ä¿®æ”¹ç”¨

// ----------------------------------------------------
// âœ… è¨­å®šè®€å–
// ----------------------------------------------------
async function tryFetchText(url){
  const r = await fetch(url, { cache: 'no-store' });
  const text = await r.text();
  try { const j = JSON.parse(text); return { ok: true, json: j }; }
  catch(e){ return { ok: false, text }; }
}

async function loadSettings() {
  // 1. å…ˆè®€å–ä¸Šæ¬¡å­˜ä¸‹çš„è¨­å®š
  const cached = localStorage.getItem("expense_settings");
  if (cached) {
    const data = JSON.parse(cached);
    // ç›´æ¥å¥—ç”¨å¿«å–è³‡æ–™ï¼Œè®“ç¶²é æœ‰åŸºæœ¬è¨­å®šå¯ä»¥é‹ä½œ
    API_URL = (data.API_URL || "").trim();
    VERSION = (data.D10 || "V").trim();
    LIFF_IDo = (data.D13 || "").trim();
    document.getElementById("version").textContent = VERSION;
    
    // èƒŒæ™¯é»˜é»˜æ›´æ–°ï¼Œä¸æ“‹ä½ä½¿ç”¨è€…æ“ä½œ
    updateSettingsInBackground(); 
    return data;
  }

  // 2. å¦‚æœæ²’å¿«å–æ‰å¾ç¶²è·¯æŠ“ (ç¬¬ä¸€æ¬¡ä½¿ç”¨æ™‚)
  return await updateSettingsInBackground();
}

// æŠ½å–å‡ºä¾†çš„ç¶²è·¯æ›´æ–°å‡½å¼
async function updateSettingsInBackground() {
  const res = await tryFetchText(FALLBACK_GAS_SETTINGS_URL + "?type=query&command=è¨­å®š");
  if (res.ok && res.json.data) {
    const data = res.json.data;
    localStorage.setItem("expense_settings", JSON.stringify(data));
    API_URL = (data.API_URL || "").trim();
    VERSION = (data.D10 || "V").trim();
    LIFF_IDo = (data.D13 || "").trim();
    document.getElementById("version").textContent = VERSION;
    return data;
  }
}
// ----------------------------------------------------
// âœ… åˆå§‹åŒ–
// ----------------------------------------------------
async function initApp(){
  try {
    // ğŸ’¡ åŒæ™‚åŸ·è¡Œï¼šè¨­å®šè®€å–ã€LIFF åˆå§‹åŒ–
    // é€™æ¨£å…©å€‹ä»»å‹™æœƒåŒæ™‚é€²è¡Œï¼Œç¸½æ™‚é–“å–æ±ºæ–¼æœ€æ…¢çš„é‚£ä¸€å€‹ï¼Œè€Œä¸æ˜¯ç›¸åŠ 
    await Promise.all([
      loadSettings(),
      liff.init({ liffId: "2008096451-Olb1l39P" }).then(() => {
        if (!liff.isLoggedIn()) liff.login();
      })
    ]);

    // è¨­å®šè·‘å®Œå¾Œç«‹åˆ»æŠ“å–è³‡æ–™
    if (API_URL) loadOther();
    
  } catch (err) {
    console.error("åˆå§‹åŒ–å¤±æ•—", err);
  }
}
// ----------------------------------------------------
// 1ï¸âƒ£ å„²å­˜/ä¿®æ”¹ï¼ˆåŠ ä¸Šcurreny.type.paymentç¶å®šæª¢æŸ¥ï¼‰
// ----------------------------------------------------
async function saveOther() {
  const payload = {
    type: "other",
    command: editIndex === -1 ? "add" : "update",
    classify: document.getElementById("classify").value,
    number: document.getElementById("number").value.trim(),
    name: document.getElementById("name").value.trim(),
    note: (document.getElementById("note")?.value || "").trim(),
    exchange: (document.getElementById("exchange")?.value || "").trim(),
    oldNumber: window.oldNumber || undefined // âœ… ä¿®æ”¹æ™‚è¦å¸¶ä¸ŠèˆŠçš„ç·¨è™Ÿ
  };

  if (!payload.classify || !payload.number || !payload.name) {
    alert("â—åˆ†é¡ã€ç·¨è™Ÿèˆ‡åç¨±ä¸å¾—ç‚ºç©º");
    return;
  }

  // ğŸ”¹ å¦‚æœæ˜¯ currencyï¼Œexchange æ¬„ä½å¿…å¡«
  if (payload.classify === "currency" && !payload.exchange) {
    alert("â—åŒ¯ç‡ currency é¡åˆ¥ï¼ŒåŒ¯ç‡æ¬„ä½å¿…å¡«ï¼");
    return;
  }
  
  try {
    // å–å¾—åŒ¯ç‡.åˆ†é¡.ä»˜æ¬¾æ–¹å¼åˆ—è¡¨
    const [exchangeRes, typeRes, paymentRes] = await Promise.all([
      fetch(API_URL + "?type=query&command=cashdate.exchange"),
      fetch(API_URL + "?type=query&command=cashdate.type"),
      fetch(API_URL + "?type=query&command=cashdate.payment")
    ]);

    const exchangeData = await exchangeRes.json();
    //alert("ğŸ’° exchange query result: " + JSON.stringify(exchangeData)); //é¡¯ç¤ºcashdataçš„distinctçš„è³‡æ–™
    const typeData = await typeRes.json();
    //alert("ğŸ“‚ type query result: " + JSON.stringify(typeData)); //é¡¯ç¤ºcashdataçš„distinctçš„è³‡æ–™
    const paymentData = await paymentRes.json();
    //alert("ğŸ’³ payment query result: " + JSON.stringify(paymentData)); //é¡¯ç¤ºcashdataçš„distinctçš„è³‡æ–™

    const allNames = [
      ...(exchangeData.exchanges || []),
      ...(typeData.types || []),
      ...(paymentData.payments || [])
    ];

    // å¦‚æœæ­£åœ¨ä¿®æ”¹ï¼ŒæŠŠè‡ªå·±çš„èˆŠåç¨±æ’é™¤
    const checkNames = (editIndex !== -1 && window.oldName) 
        ? allNames.filter(n => n !== window.oldName)
        : allNames;

    // âš ï¸ æª¢æŸ¥åç¨±é‡è¤‡
    if (checkNames.includes(payload.name)) {
      alert(`âš ï¸ã€Œ${payload.name}ã€å·²å­˜åœ¨æ–¼ç³»çµ±åŒ¯ç‡.åˆ†é¡.ä»˜æ¬¾æ–¹å¼ä¸­ï¼Œç„¡æ³•æ–°å¢/ä¿®æ”¹`);
      return;
    }

    // âœ… é€å‡ºæ–°å¢/ä¿®æ”¹è«‹æ±‚
    const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
    const result = await res.json();

    if (result.ok) {
      alert(editIndex === -1 
        ? `âœ… å·²æ–°å¢ ${payload.name} æ­¤ç­†è³‡æ–™` 
        : `âœ… å·²ä¿®æ”¹ ${payload.name} æ­¤ç­†è³‡æ–™`);
      clearForm();
      loadOther();
    } else {
      alert(`âŒ å¤±æ•—ï¼š${result.msg || result.error || JSON.stringify(result) || "æœªçŸ¥éŒ¯èª¤"} (${payload.name})`);
    }

  } catch (err) {
    alert(`âš ï¸ ç™¼ç”ŸéŒ¯èª¤ï¼š${err} (${payload.name})`);
  }
}
// ----------------------------------------------------
// 2ï¸âƒ£ æŸ¥è©¢ (æ’åºï¼šclassify â†’ number)
// ----------------------------------------------------
async function loadOther() {
  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({ type: "other", command: "query" })
    });
    const result = await res.json();
    
    const tbody = document.querySelector("#otherTable tbody");
    tbody.innerHTML = "";

    if (result.ok && Array.isArray(result.list)) {
      // âœ… æ’åºï¼šå…ˆä¾ classify æ’ï¼Œå†ä¾ number æ’
      result.list.sort((a, b) => {
        // classify æ’åº
        if (a.classify < b.classify) return -1;
        if (a.classify > b.classify) return 1;

        // classify ç›¸åŒæ™‚ä¾ number æ’ï¼ˆæ•¸å­—éƒ¨åˆ†æ¯”è¼ƒï¼‰
        const numA = parseInt(a.number.replace(/[^\d]/g, ""), 10);
        const numB = parseInt(b.number.replace(/[^\d]/g, ""), 10);
        return numA - numB;
      });

      // âœ… æ¸²æŸ“è¡¨æ ¼
      result.list.forEach((row, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.classify}</td>
          <td>${row.number}</td>
          <td>${row.name}</td>
          <td>${row.note || ""}</td>
          <td>${row.exchange}</td>  <td>
            <button class="edit-btn" onclick="editOther(${idx})">ğŸ“ ä¿®æ”¹</button>
            <button class="action-btn" onclick="deleteOther(${idx})">ğŸ—‘ï¸ åˆªé™¤</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // âœ… å­˜æœ€æ–°è³‡æ–™
      window.otherDataCache = result.list;
      
      // âœ… çµ±è¨ˆç­†æ•¸
      const currencys = result.list.filter(r => r.classify === "currency");
      const typeRows = result.list.filter(r => r.classify === "type");
      const paymentRows = result.list.filter(r => r.classify === "payment");
      document.getElementById("summary").innerHTML = `
      <table>
        <tr class=".total">
          <td>åŒ¯ç‡ currency<br>ğŸ’° ${currencys.length} ç­†</td>     
          <td>ä»˜æ¬¾ payment<br>ğŸ’³ ${paymentRows.length} ç­†</td>
          <td>åˆ†é¡ type<br>ğŸ“‚ ${typeRows.length} ç­†</td>
          <td>ç¸½è¨ˆ<br>ğŸ“Œ ${result.list.length} ç­†</td>
        </tr>
      </table>
      `;
    } else {
      document.getElementById("summary").innerHTML = "âš ï¸ æ²’æœ‰è³‡æ–™";
    }
  } catch (err) {
    alert("âš ï¸ æŸ¥è©¢å¤±æ•—ï¼š" + err.message);
    console.error(err);
  }
}
// ----------------------------------------------------
// 3ï¸âƒ£ ä¿®æ”¹
// ----------------------------------------------------
function editOther(idx) {
  const row = window.otherDataCache[idx];
  if (!row) return;
  document.getElementById("classify").value = row.classify;
  document.getElementById("number").value = row.number;
  document.getElementById("name").value = row.name;
  document.getElementById("note").value = row.note;
  document.getElementById("exchange").value = row.exchange || "";
  editIndex = idx;
  window.oldNumber = row.number; // âœ… è¨˜éŒ„åŸå§‹ç·¨è™Ÿ
  window.oldName = row.name;     // âœ… æ–°å¢ä¿ç•™èˆŠåç¨±
}
// ----------------------------------------------------
// 4ï¸âƒ£ åˆªé™¤ï¼ˆåŠ ä¸Šcurrency/type/paymentç¶å®šæª¢æŸ¥ï¼‰
// ----------------------------------------------------
async function deleteOther(idx) {
  // 1ï¸âƒ£ å…ˆå®šç¾© rowï¼ˆå¾å¿«å–å–å¾—è³‡æ–™ï¼‰
  const row = window.otherDataCache[idx];
  if (!row) {
    alert("âŒ æ‰¾ä¸åˆ°è©²ç­†è³‡æ–™çš„å¿«å–");
    return;
  }

  // 2ï¸âƒ£ ç¾åœ¨ row å·²ç¶“å­˜åœ¨ï¼Œå¯ä»¥æ­£ç¢ºå¸¶å…¥ ${row.name}
  if (!confirm(`â—ç¢ºå®šè¦åˆªé™¤ ${row.name} é€™ç­†è³‡æ–™å—ï¼Ÿ`)) return;
  
  // 3ï¸âƒ£ å¾ŒçºŒé‚è¼¯ï¼šåŸ·è¡Œç¶å®šæª¢æŸ¥èˆ‡åˆªé™¤
  try {
    // ğŸ”¹ åŒæ™‚æŸ¥è©¢ã€ŒåŒ¯ç‡(currency)ã€.ã€Œåˆ†é¡(type)ã€.ã€Œä»˜æ¬¾(payment)ã€æ¸…å–®
    const [exchangeRes, typeRes, paymentRes] = await Promise.all([
      fetch(API_URL + "?type=query&command=cashdate.exchange"),
      fetch(API_URL + "?type=query&command=cashdate.type"),
      fetch(API_URL + "?type=query&command=cashdate.payment")
    ]);

    const exchangeData = await exchangeRes.json();   
    //alert("ğŸ’° exchange query result: " + JSON.stringify(exchangeData)); //é¡¯ç¤ºcashdataçš„distinctçš„è³‡æ–™
    const typeData = await typeRes.json();
    //alert("ğŸ“‚ type query result: " + JSON.stringify(typeData)); //é¡¯ç¤ºcashdataçš„distinctçš„è³‡æ–™
    const paymentData = await paymentRes.json();
    //alert("ğŸ’³ payment query result: " + JSON.stringify(paymentData)); //é¡¯ç¤ºcashdataçš„distinctçš„è³‡æ–™

    const allNames = [
      ...(exchangeData.exchanges || []), 
      ...(typeData.types || []),
      ...(paymentData.payments || [])
    ];

    // âœ… å¦‚æœé€™ç­†åç¨±å·²å­˜åœ¨æ–¼åŒ¯ç‡.åˆ†é¡.ä»˜æ¬¾æ–¹å¼ï¼Œå°±ç¦æ­¢åˆªé™¤
    if (allNames.includes(row.name)) {
      alert(`âš ï¸ã€Œ${row.name}ã€å·²è¢«ä½¿ç”¨æ–¼åŒ¯ç‡.åˆ†é¡.ä»˜æ¬¾æ–¹å¼ä¸­ï¼Œç„¡æ³•åˆªé™¤ï¼`);
      return;
    }

    // ğŸ”¹ åŸ·è¡Œåˆªé™¤
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({ type: "other", command: "delete", number: row.number })
    });

    const resDel = await res.json();
    if (resDel.ok) {
      alert(`âœ… ${row.name} åˆªé™¤æˆåŠŸï¼`);
      clearForm();
      loadOther();
    } else {
      alert(`âŒ ${row.name} åˆªé™¤å¤±æ•—ï¼š${resDel.msg || "æœªçŸ¥éŒ¯èª¤"} `);
    }

  } catch (err) {
    alert(`âš ï¸ åˆªé™¤éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼š${err.message} (${row.name})`);
    console.error(err);
  }
}
// ----------------------------------------------------
// ğŸ§¹ æ¸…ç©ºè¡¨å–®
// ----------------------------------------------------
function clearForm() {
  document.getElementById("number").value = "";
  document.getElementById("name").value = "";
  document.getElementById("note").value = "";
  document.getElementById("exchange").value = "";
  editIndex = -1;
  window.oldNumber = undefined;
  window.oldName = undefined; // âœ… æ¸…æ‰èˆŠåç¨±
}

initApp(); // ğŸš€ å•Ÿå‹•æ‡‰ç”¨
</script>
</body>
</html>




